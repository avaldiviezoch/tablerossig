<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MVCS · Inversiones 2025</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>

<style>
  :root{
    --azul:#1e6eb6;
    --azul-osc:#174f84;
    --celeste:#5ebad6;
    --rojo:#d00000;
    --ink:#0f172a;
    --muted:#64748b;
    --card:#ffffff;
    --page:#ffffff;
    --line:#e5e7eb;
    --shadow:0 12px 28px rgba(2,6,23,.06);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--page);color:var(--ink);font-family:'Nunito Sans',system-ui,Segoe UI,Roboto,Arial}

  .wrap{max-width:1100px;margin:26px auto 42px;padding:0 16px}

  /* ====== Título con subrayado rojo animado ====== */
  .titleRow{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .title{
    position:relative;margin:0;color:var(--azul);font-weight:900;
    font-size:28px;letter-spacing:.2px;
  }
  .title::after{
    content:"";position:absolute;left:0;bottom:-6px;height:4px;width:0%;
    border-radius:999px;background:linear-gradient(90deg,#ff4d4d, var(--rojo));
    box-shadow:0 2px 8px rgba(208,0,0,.35);
    transition:width .6s cubic-bezier(.22,1,.36,1);
  }
  .titleRow.on .title::after{ width:100%; }

  /* ====== Layout superior ====== */
  .top{
    display:grid;grid-template-columns:1.08fr .92fr;gap:18px;align-items:start;
  }
  @media (max-width:960px){ .top{grid-template-columns:1fr;gap:14px} }

  .blk{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    padding:18px 18px 14px;box-shadow:var(--shadow);
  }
  .p{color:#334155;font-size:14px;line-height:1.5;margin:0 0 10px}
  .src{font-size:12px;color:#6b7280}
  .note{font-size:11.5px;color:#6b7280;font-style:italic;margin-top:6px}

  /* KPIs derecha */
  .kpis{display:grid;gap:12px}
  .hero{
    display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--line);
    border-radius:var(--radius);padding:12px 14px;box-shadow:var(--shadow)
  }
  .ic32{flex:0 0 40px;width:40px;height:40px;border-radius:12px;background:#eef6ff;display:grid;place-items:center;overflow:hidden}
  .ic32 img{max-width:100%;max-height:100%}
  .hero .lbl{font-weight:800;color:#334155}
  .hero .num{font-weight:900;color:var(--azul);font-size:34px;line-height:1}

  .duo{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:520px){ .duo{grid-template-columns:1fr} }
  .mini{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    padding:12px 14px;box-shadow:var(--shadow);display:grid;gap:6px
  }
  .mini .cap{font-size:12px;font-weight:900;color:#64748b;letter-spacing:.2px}
  .mini .val{font-size:32px;font-weight:900;color:var(--azul);line-height:1}
  .mini .sub{font-size:14px;font-weight:900;color:var(--azul-osc)}

  /* Bandas celestes */
  .bar{
    margin:18px 0 12px;background:var(--celeste);color:#083a66;
    border-radius:999px;padding:10px 12px;text-align:center;
    font-weight:900;letter-spacing:.2px;text-shadow:0 1px 0 rgba(255,255,255,.25)
  }

  /* Grilla “Se espera generar” */
  .kpiGrid{
    display:grid;grid-template-columns:1fr 1fr;gap:12px
  }
  @media (max-width:720px){ .kpiGrid{grid-template-columns:1fr} }
  .kCard{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    padding:12px;box-shadow:var(--shadow);display:flex;align-items:center;gap:12px
  }
  .badge{
    flex:0 0 56px;width:56px;height:56px;border-radius:14px;background:#eef6ff;
    display:grid;place-items:center;overflow:hidden
  }
  .badge img{max-width:92%;max-height:92%}
  .m{display:flex;flex-direction:column;gap:4px}
  .m .v{font-size:32px;font-weight:900;color:var(--azul);line-height:1}
  .m .l{font-size:13px;font-weight:800;color:#65748b}

  /* Estados (8) */
  .grid8{
    display:grid;grid-template-columns:repeat(4,1fr);gap:12px
  }
  @media (max-width:900px){ .grid8{grid-template-columns:repeat(2,1fr)} }
  .tile{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:14px;display:grid;place-items:center;gap:6px;min-height:108px
  }
  .tile .v{font-size:32px;font-weight:900;color:var(--azul);line-height:1}
  .tile .t{font-size:12px;color:#64748b;font-weight:800;text-align:center}

  /* Aparición + efecto “tragamonedas” al entrar en vista */
  .fade{opacity:0;transform:translateY(6px);transition:.35s ease}
  .fade.on{opacity:1;transform:translateY(0)}
</style>
</head>
<body>

<div class="wrap" id="INV">

  <div class="titleRow"><h2 class="title">Inversiones</h2></div>

  <div class="top">
    <!-- Texto -->
    <article class="blk">
      <p class="p">Las inversiones planificadas para el 2025 reflejan el compromiso del MVCS con el cierre de brechas en infraestructura y saneamiento. Estas inversiones forman parte de la planificación estratégica del ministerio y responden a necesidades priorizadas en el territorio, especialmente en sectores vulnerables. La planificación contempla obras en saneamiento y vivienda y urbanismo, en coordinación con los gobiernos regionales y locales.</p>
      <div class="src"><b>Fuente:</b> Ministerio de Economía y Finanzas – MEF · Portal de datos Abiertos · <span id="lastUpdate">Actualizado al —</span></div>
      <div class="note">Incluye inversiones cuyo PIM sea mayor a 0</div>
    </article>

    <!-- KPIs -->
    <section class="kpis">
      <div class="hero fade" data-animate="count">
        <div class="ic32"><img src="https://lh3.googleusercontent.com/d/18tWhc-SzR8dEqrZZs8trBnqa6o9-Y-9P=w1000" alt="Inversiones"/></div>
        <div>
          <div class="lbl">A través de <span id="kpiCount" class="num">—</span> inversiones</div>
        </div>
      </div>

      <div class="duo">
        <div class="mini fade" data-animate="pim">
          <div class="cap">PIM</div>
          <div id="kpiPIM" class="val">—</div>
        </div>
        <div class="mini fade" data-animate="dev">
          <div class="cap">Devengado</div>
          <div id="kpiDev" class="val">—</div>
          <div id="kpiPct" class="sub">—</div>
        </div>
      </div>
    </section>
  </div>

  <div class="bar">Se espera generar</div>

  <section class="kpiGrid">
    <div class="kCard fade" data-animate="agua">
      <div class="badge"><img src="https://lh3.googleusercontent.com/d/1U1bT6XOwlWARi7SMsuyox3dSkHRB6CbO=w1000" alt="Agua"/></div>
      <div class="m">
        <div id="kAgua" class="v">—</div>
        <div class="l">Conexiones nuevas de agua</div>
      </div>
    </div>

    <div class="kCard fade" data-animate="alc">
      <div class="badge"><img src="https://lh3.googleusercontent.com/d/1FJzFJZKmLqvnDKHUjMWCKAic6RrP2K6j=w1000" alt="Alcantarillado"/></div>
      <div class="m">
        <div id="kAlc" class="v">—</div>
        <div class="l">Conexiones nuevas de alcantarillado</div>
      </div>
    </div>

    <div class="kCard fade" data-animate="pav">
      <div class="badge"><img src="https://lh3.googleusercontent.com/d/1Nov2kbITwZGC3DUR4kwj-yo9vjQZqVqB=w1000" alt="Pavimento"/></div>
      <div class="m">
        <div id="kPav" class="v">—</div>
        <div class="l">M2 de pavimento</div>
      </div>
    </div>

    <div class="kCard fade" data-animate="ver">
      <div class="badge"><img src="https://lh3.googleusercontent.com/d/1SKZkQW_boA1HSTxnQHwI17DSFM0wPmp5=w1000" alt="Vereda"/></div>
      <div class="m">
        <div id="kVer" class="v">—</div>
        <div class="l">M2 de vereda</div>
      </div>
    </div>
  </section>

  <div class="bar" style="margin-top:18px">Estados</div>

  <section class="grid8">
    <div class="tile fade" data-animate="e1"><div id="tObrasCon"  class="v">—</div><div class="t">Obras concluidas</div></div>
    <div class="tile fade" data-animate="e2"><div id="tObrasEjec" class="v">—</div><div class="t">Obras en ejecución</div></div>
    <div class="tile fade" data-animate="e3"><div id="tObrasIni"  class="v">—</div><div class="t">Obras por iniciar</div></div>
    <div class="tile fade" data-animate="e4"><div id="tObrasSel"  class="v">—</div><div class="t">Obras en proceso de selección</div></div>

    <div class="tile fade" data-animate="e5"><div id="tExpCon"   class="v">—</div><div class="t">Expedientes concluidos</div></div>
    <div class="tile fade" data-animate="e6"><div id="tExpElab"  class="v">—</div><div class="t">Expedientes en elaboración</div></div>
    <div class="tile fade" data-animate="e7"><div id="tExpSel"   class="v">—</div><div class="t">Expedientes en proceso de selección</div></div>
    <div class="tile fade" data-animate="e8"><div id="tExpConv"  class="v">—</div><div class="t">Expedientes por convocar</div></div>
  </section>
</div>

<script>
/* ==== Endpoints y formatos ==== */
const FS10="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/10/query";
const FS13="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
const FS_PT="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_Coord_MEF/FeatureServer/0/query";

const WHERE_SECTOR="sector_nombre = 'VIVIENDA CONSTRUCCION Y SANEAMIENTO'";
const WHERE_COUNT ="ano_eje = 2025 AND monto_pim > 0 AND tipo_act_proy_nombre = 'PROYECTO'";

const fmtInt=new Intl.NumberFormat("es-PE",{maximumFractionDigits:0});
const fmtCur=new Intl.NumberFormat("es-PE",{maximumFractionDigits:0});
const fmtPct=new Intl.NumberFormat("es-PE",{maximumFractionDigits:1});

/* ==== helpers ==== */
function animateNumber(el,target,ms=1400,fmt=fmtInt,suffix=""){
  if(!Number.isFinite(target)){ el.textContent="—"; return; }
  const start=performance.now();
  function frame(t){
    const p=Math.min(1,(t-start)/ms);
    const e=1-Math.pow(1-p,3);          // easeOutCubic = “tragamonedas” suave
    el.textContent=fmt.format(target*e)+suffix;
    if(p<1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}
function esri(url,params){
  const p=new URLSearchParams({f:"json",returnGeometry:"false",...params});
  return fetch(url+"?"+p,{cache:"no-store"}).then(r=>r.json());
}
async function stat(url,where,stats){
  const j=await esri(url,{where,outStatistics:JSON.stringify(stats)});
  if(j.error) throw new Error(j.error.message||"ArcGIS"); 
  return (j.features?.[0]?.attributes)||{};
}
async function countDistinct(url,where,field){
  const j=await esri(url,{where,outFields:field,returnDistinctValues:"true",returnCountOnly:"true"});
  return Number(j.count||0);
}

/* ==== datos ==== */
async function getInversiones(){
  return await countDistinct(FS13,WHERE_COUNT,"producto_proyecto");
}
async function getPIM(){
  try{ const a=await stat(FS10,WHERE_SECTOR,[{statisticType:"sum",onStatisticField:"sum_monto_pim",outStatisticFieldName:"v"}]); return +a.v||0; }
  catch{ const a=await stat(FS13,WHERE_SECTOR,[{statisticType:"sum",onStatisticField:"monto_pim",outStatisticFieldName:"v"}]); return +a.v||0; }
}
async function getDEV(){
  try{ const a=await stat(FS10,WHERE_SECTOR,[{statisticType:"sum",onStatisticField:"sum_monto_devengado",outStatisticFieldName:"v"}]); return +a.v||0; }
  catch{ const a=await stat(FS13,WHERE_SECTOR,[{statisticType:"sum",onStatisticField:"monto_devengado",outStatisticFieldName:"v"}]); return +a.v||0; }
}
async function getMaxDate(){
  const a=await stat(FS13,WHERE_SECTOR,[{statisticType:"max",onStatisticField:"fecha_proceso",outStatisticFieldName:"d"}]);
  const ts=+a.d||0; if(!ts) return "—";
  return new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"long",year:"numeric"}).format(new Date(ts));
}
async function getGenerar(){
  const a=await stat(FS_PT,"1=1",[
    {statisticType:"sum",onStatisticField:"cnx_nuevas_agua",outStatisticFieldName:"agua"},
    {statisticType:"sum",onStatisticField:"cnx_nuevas_alcantarillado_dse",outStatisticFieldName:"alc"},
    {statisticType:"sum",onStatisticField:"final_pavimento_m2_monitoreo",outStatisticFieldName:"pav"},
    {statisticType:"sum",onStatisticField:"final_vereda_m2_monitoreo",outStatisticFieldName:"ver"},
  ]);
  return {agua:+a.agua||0, alc:+a.alc||0, pav:+a.pav||0, ver:+a.ver||0};
}
function IN(list){return list.map(v=>`'${String(v).replaceAll("'","''")}'`).join(",");}
async function getEstados(){
  const OBRA=["OBRA (SALDO)","OBRA"];
  const EXP =["EXPEDIENTE TECNICO (SALDO)","OBRA (Expediente Saldo)","EXPEDIENTE TECNICO"];
  const W=(...x)=>x.filter(Boolean).join(" AND ");

  const q={
    e1:W(`etapa IN (${IN(OBRA)})`,`estado IN ('Transferencia','Post Ejecución','Concluido')`),
    e2:W(`etapa IN (${IN(OBRA)})`,`estado IN ('En Ejecución')`),
    e3:W(`etapa IN (${IN(OBRA)})`,`estado IN ('Actos Previos')`,`subestado = 'Por Iniciar'`),
    e4:W(`etapa IN (${IN(OBRA)})`,`estado IN ('Actos Previos')`,`subestado = 'Proceso de Selección'`),
    e5:W(`etapa IN (${IN(EXP)})`, `estado IN ('Concluido')`),
    e6:W(`etapa IN (${IN(EXP)})`, `estado IN ('En elaboración')`),
    e7:W(`etapa IN (${IN(EXP)})`, `estado IN ('Actos Previos')`,`subestado = 'Proceso de Selección'`),
    e8:W(`etapa IN (${IN(EXP)})`, `estado IN ('Actos Previos')`,`subestado = 'Por Convocar'`),
  };
  const r=await Promise.all([
    countDistinct(FS_PT,q.e1,"producto_proyecto"),
    countDistinct(FS_PT,q.e2,"producto_proyecto"),
    countDistinct(FS_PT,q.e3,"producto_proyecto"),
    countDistinct(FS_PT,q.e4,"producto_proyecto"),
    countDistinct(FS_PT,q.e5,"producto_proyecto"),
    countDistinct(FS_PT,q.e6,"producto_proyecto"),
    countDistinct(FS_PT,q.e7,"producto_proyecto"),
    countDistinct(FS_PT,q.e8,"producto_proyecto"),
  ]);
  return {e1:r[0],e2:r[1],e3:r[2],e4:r[3],e5:r[4],e6:r[5],e7:r[6],e8:r[7]};
}

/* ==== Carga de datos (una sola vez) ==== */
let snapshot=null;
(async function bootstrap(){
  try{
    const [inv,pim,dev,fecha,gen,est] = await Promise.all([
      getInversiones(), getPIM(), getDEV(), getMaxDate(), getGenerar(), getEstados()
    ]);
    snapshot={inv,pim,dev,fecha,gen,est};
    document.getElementById("lastUpdate").textContent="Actualizado al "+fecha;
  }catch(e){ console.error(e); }
})();

/* ==== Observer para activar animaciones al ver ==== */
const observer=new IntersectionObserver((entries)=>{
  entries.forEach(en=>{
    if(!en.isIntersecting) return;
    const el=en.target;
    el.classList.add('on');             // fade in
    // Si es el título, dispara el subrayado rojo
    if(el.classList.contains('titleRow')){ el.classList.add('on'); }

    if(!snapshot) return;

    // KPIs con efecto tragamonedas
    const a=el.getAttribute('data-animate');
    if(a==="count"){ animateNumber(document.getElementById('kpiCount'), snapshot.inv, 1400, fmtInt); }
    if(a==="pim"){   const t=document.getElementById('kpiPIM'); animateNumber(t, snapshot.pim, 1600, fmtCur); t.textContent="S/ "+t.textContent; }
    if(a==="dev"){   const t=document.getElementById('kpiDev'); animateNumber(t, snapshot.dev, 1600, fmtCur); t.textContent="S/ "+t.textContent;
                     const pct=(snapshot.pim>0)?(snapshot.dev/snapshot.pim*100):0; animateNumber(document.getElementById('kpiPct'), pct, 1600, fmtPct, "%"); }
    if(a==="agua"){  animateNumber(document.getElementById('kAgua'), snapshot.gen.agua, 1300, fmtInt); }
    if(a==="alc"){   animateNumber(document.getElementById('kAlc'),  snapshot.gen.alc,  1300, fmtInt); }
    if(a==="pav"){   animateNumber(document.getElementById('kPav'),  snapshot.gen.pav,  1300, fmtInt); }
    if(a==="ver"){   animateNumber(document.getElementById('kVer'),  snapshot.gen.ver,  1300, fmtInt); }
    if(a==="e1"){    animateNumber(document.getElementById('tObrasCon'),  snapshot.est.e1, 1200, fmtInt); }
    if(a==="e2"){    animateNumber(document.getElementById('tObrasEjec'), snapshot.est.e2, 1200, fmtInt); }
    if(a==="e3"){    animateNumber(document.getElementById('tObrasIni'),  snapshot.est.e3, 1200, fmtInt); }
    if(a==="e4"){    animateNumber(document.getElementById('tObrasSel'),  snapshot.est.e4, 1200, fmtInt); }
    if(a==="e5"){    animateNumber(document.getElementById('tExpCon'),    snapshot.est.e5, 1200, fmtInt); }
    if(a==="e6"){    animateNumber(document.getElementById('tExpElab'),   snapshot.est.e6, 1200, fmtInt); }
    if(a==="e7"){    animateNumber(document.getElementById('tExpSel'),    snapshot.est.e7, 1200, fmtInt); }
    if(a==="e8"){    animateNumber(document.getElementById('tExpConv'),   snapshot.est.e8, 1200, fmtInt); }

    observer.unobserve(el); // una sola vez por bloque
  });
},{threshold:.25});

document.querySelectorAll('.fade,[data-animate],.titleRow').forEach(n=>observer.observe(n));
</script>
</body>
</html>
