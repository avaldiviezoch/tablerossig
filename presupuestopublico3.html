<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Inversiones · PIM / Devengado + Se espera generar</title>

<!-- Fuente -->
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>

<style>
  :root{
    --ink:#263645;
    --muted:#5b6f82;
    --blue:#1e6eb6;     /* azul MVCS */
    --sky:#5ebad6;      /* celeste */
    --danger:#e11d2e;   /* subrayado rojo */
    --card:#ffffff;
    --line:#e8edf3;
    --shadow:0 14px 32px rgba(20,35,52,.08);
    --radius:18px;
  }
  html,body{margin:0;background:#fff;color:var(--ink);font-family:"Nunito Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial}

  .wrap{max-width:1100px;margin:28px auto;padding:0 20px}
  .grid{display:grid;gap:28px;grid-template-columns:1.15fr .85fr;align-items:start}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  /* Título con subrayado animado */
  .title{
    width:max-content; position:relative; color:var(--blue);
    font-weight:900; font-size:clamp(22px,3.2vw,30px); margin:0 0 16px; padding-bottom:12px;
  }
  .title::after{
    content:""; position:absolute; left:0; bottom:0; height:6px; border-radius:6px;
    background:linear-gradient(90deg,var(--danger),#ff7b7b);
    width:100%; transform:scaleX(0); transform-origin:left; transition:transform 3s cubic-bezier(.22,1,.36,1);
  }
  .title.inview::after{ transform:scaleX(1); }

  .lead{font-size:15px; line-height:1.7; color:#2d4458; margin:0 0 12px}
  .src{color:var(--muted); font-size:13px; line-height:1.6}
  .src em{display:block;margin-top:6px}

  /* Lado derecho */
  .topline{ display:flex; align-items:center; gap:12px; }
  .topline img{ width:40px; height:40px; object-fit:contain }
  .topline .txt{ color:#334b62; font-weight:800 }
  .topline .n{ color:var(--blue); font-weight:900; font-size:clamp(30px,4.8vw,44px) }

  .stack{ display:grid; gap:16px; margin-top:12px }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:18px 20px;
  }
  .k-label{ color:#6a7f95; font-weight:800; text-transform:uppercase; letter-spacing:.02em; font-size:13px }
  .k-value{ color:var(--blue); font-size:clamp(26px,4.6vw,36px); font-weight:900; line-height:1.15 }
  .k-sub{ color:var(--sky); font-weight:900; font-size:15px; margin-top:6px }

  /* Contadores */
  .num{ display:inline-block; font-variant-numeric:tabular-nums; letter-spacing:.02em }

  /* ===== Se espera generar ===== */
  .gen-wrap{max-width:1100px;margin:22px auto 40px;padding:0 20px}
  .gen-pill{
    display:block;width:100%;
    background:var(--sky);color:#fff;font-weight:900;text-align:center;
    padding:12px 18px;border-radius:999px;margin:6px 0 18px;letter-spacing:.2px;
    box-shadow:0 8px 18px rgba(14,116,144,.18);
  }
  .gen-grid{display:grid;gap:16px;grid-template-columns:1fr 1fr;}
  @media (max-width:900px){ .gen-grid{grid-template-columns:1fr} }

  .gen-card{
    display:grid; grid-template-columns:auto 1fr; gap:12px; align-items:center;
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:16px 18px;
  }
  .gen-left img{ width:56px; height:56px; object-fit:contain }
  .gen-label{ margin:0 0 6px; color:#4a5f74; font-size:15px; font-weight:900 }
  .gen-value{ color:var(--blue); font-weight:900; font-size:clamp(26px,4.2vw,36px); line-height:1.1 }
</style>
</head>
<body>

<!-- ===================== HERO: Inversiones / PIM / Devengado ===================== -->
<section class="wrap" id="sec-inversiones">
  <div class="grid">
    <!-- Izquierda: texto -->
    <div>
      <h2 class="title">Inversiones</h2>
      <p class="lead">
        Las inversiones planificadas para el 2025 reflejan el compromiso del MVCS con el cierre de brechas en
        infraestructura y brechas de saneamiento. Estas inversiones forman parte de la planificación estratégica del
        ministerio y responden a las necesidades priorizadas en el territorio, especialmente en sectores vulnerables.
        La planificación contempla obras en saneamiento y vivienda y urbanismo, en coordinación con los gobiernos
        regionales y locales.
      </p>
      <p class="src">
        <strong>Fuente:</strong> Ministerio de Economía y Finanzas – MEF<br/>
        Portal de datos Abiertos – <em id="lastUpdateHero">Actualizado al —</em>
        <em>Incluye inversiones cuyo PIM sea mayor a 0</em>
      </p>
    </div>

    <!-- Derecha: indicadores -->
    <div>
      <div class="topline">
        <img src="https://lh3.googleusercontent.com/d/18tWhc-SzR8dEqrZZs8trBnqa6o9-Y-9P=w1000" alt="Cámara inversiones">
        <span class="txt">A través de</span>
        <span class="n num" id="inv-count">0</span>
        <span class="txt">inversiones</span>
      </div>

      <div class="stack">
        <div class="card">
          <div class="k-label">PIM</div>
          <div class="k-value">S/ <span class="num" id="pim">0</span></div>
        </div>
        <div class="card">
          <div class="k-label">Devengado</div>
          <div class="k-value">S/ <span class="num" id="dev">0</span></div>
          <div class="k-sub"><span class="num" id="pct">0</span>%</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ======================= SE ESPERA GENERAR ======================= -->
<section class="gen-wrap" id="sec-generar">
  <div class="gen-pill">Se espera generar</div>

  <div class="gen-grid">
    <!-- Agua -->
    <article class="gen-card">
      <div class="gen-left">
        <img src="https://lh3.googleusercontent.com/d/1U1bT6XOwlWARi7SMsuyox3dSkHRB6CbO=w1000" alt="Conexiones de agua"/>
      </div>
      <div class="gen-right">
        <h3 class="gen-label">Conexiones nuevas de agua</h3>
        <div class="gen-value"><span class="num" id="k-agua">0</span></div>
      </div>
    </article>

    <!-- Alcantarillado -->
    <article class="gen-card">
      <div class="gen-left">
        <img src="https://lh3.googleusercontent.com/d/1FJzFJZKmLqvnDKHUjMWCKAic6RrP2K6j=w1000" alt="Conexiones de alcantarillado"/>
      </div>
      <div class="gen-right">
        <h3 class="gen-label">Conexiones nuevas de alcantarillado</h3>
        <div class="gen-value"><span class="num" id="k-alc">0</span></div>
      </div>
    </article>

    <!-- Pavimento -->
    <article class="gen-card">
      <div class="gen-left">
        <img src="https://lh3.googleusercontent.com/d/1Nov2kbITwZGC3DUR4kwj-yo9vjQZqVqB=w1000" alt="M2 de pavimento"/>
      </div>
      <div class="gen-right">
        <h3 class="gen-label">M2 de pavimento</h3>
        <div class="gen-value"><span class="num" id="k-pav">0</span></div>
      </div>
    </article>

    <!-- Vereda -->
    <article class="gen-card">
      <div class="gen-left">
        <img src="https://lh3.googleusercontent.com/d/1SKZkQW_boA1HSTxnQHwI17DSFM0wPmp5=w1000" alt="M2 de vereda"/>
      </div>
      <div class="gen-right">
        <h3 class="gen-label">M2 de vereda</h3>
        <div class="gen-value"><span class="num" id="k-ver">0</span></div>
      </div>
    </article>
  </div>
</section>

<script>
/* ========= ÚNICA FUENTE DE DATOS (la que te funciona) ========= */
const FS_URL = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_Coord_MEF/FeatureServer/0";

/* ========= Helpers ========= */
const fmtInt = new Intl.NumberFormat('es-PE', { maximumFractionDigits: 0 });
function animateNum(el, to, ms=1400){
  const start = performance.now(); const from = 0;
  function step(t){
    const p = Math.min(1, (t-start)/ms);
    const e = 1 - Math.pow(1-p, 4);
    el.textContent = fmtInt.format(Math.round(from + (to-from)*e));
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
function esriPOST(url, params){
  const body = new URLSearchParams({ f:"json", returnGeometry:"false", ...params });
  return fetch(url, { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body, cache:"no-store" })
    .then(r => r.json());
}

/* ========= Lecturas ========= */
async function countDistinct(field, where="1=1"){
  // Paginado porque returnCountOnly con distinct a veces no respeta filtros
  const page = 2000; let offset = 0; const vals = new Set();
  while(true){
    const j = await esriPOST(FS_URL + "/query", {
      where, outFields: field, returnDistinctValues:"true", orderByFields: field,
      resultRecordCount: page, resultOffset: offset
    });
    const rows = (j.features||[]).map(f=>f?.attributes?.[field]).filter(v=>v!=null && v!=="");
    rows.forEach(v => vals.add(v));
    if(!j.exceededTransferLimit || rows.length<page) break;
    offset += page;
  }
  return vals.size;
}

async function sumField(field, where="1=1"){
  // 1) intento rápido
  try{
    const j = await esriPOST(FS_URL + "/query", {
      where,
      outStatistics: JSON.stringify([{statisticType:"sum", onStatisticField: field, outStatisticFieldName:"s"}])
    });
    const s = Number(j.features?.[0]?.attributes?.s||0);
    if(s>0) return s;
    throw new Error("zero");
  }catch(_){
    // 2) suma manual robusta
    let tot=0, offset=0, page=2000;
    while(true){
      const j2 = await esriPOST(FS_URL + "/query", {
        where, outFields: field, resultRecordCount: page, resultOffset: offset
      });
      const feats = j2.features||[];
      for(const f of feats){
        let v = f.attributes?.[field];
        if(v==null || v==="") continue;
        if(typeof v === "string") v = v.replaceAll(" ", "").replaceAll(",", "");
        const n = Number(v);
        if(Number.isFinite(n)) tot += n;
      }
      if(!j2.exceededTransferLimit || feats.length<page) break;
      offset += page;
    }
    return tot;
  }
}

/* ========= Fecha más reciente (si existe campo fecha_proceso) ========= */
async function maxDate(){
  try{
    const j = await esriPOST(FS_URL + "/query", {
      where:"1=1",
      outStatistics: JSON.stringify([{statisticType:"max", onStatisticField:"fecha_proceso", outStatisticFieldName:"mx"}])
    });
    const ts = Number(j.features?.[0]?.attributes?.mx||0);
    if(!ts) return "—";
    return new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"long",year:"numeric"}).format(new Date(ts));
  }catch{ return "—"; }
}

/* ========= Cargar al entrar a vista ========= */
const hero = document.getElementById('sec-inversiones');
const gen  = document.getElementById('sec-generar');

const ioHero = new IntersectionObserver(async (entries)=>{
  for(const e of entries){
    if(!e.isIntersecting) continue;
    document.querySelector('#sec-inversiones .title').classList.add('inview');

    const [count, pim, dev, fdate] = await Promise.all([
      countDistinct("producto_proyecto", "1=1"),
      sumField("monto_pim", "1=1"),
      sumField("monto_devengado", "1=1"),
      maxDate()
    ]);
    const pct = (pim>0) ? Math.round((dev/pim)*100) : 0;

    animateNum(document.getElementById('inv-count'), count);
    animateNum(document.getElementById('pim'), Math.round(pim||0));
    animateNum(document.getElementById('dev'), Math.round(dev||0));
    animateNum(document.getElementById('pct'), pct);
    document.getElementById('lastUpdateHero').textContent = "Actualizado al " + fdate;

    ioHero.disconnect();
  }
},{threshold:0.25});
ioHero.observe(hero);

const ioGen = new IntersectionObserver(async (entries)=>{
  for(const e of entries){
    if(!e.isIntersecting) continue;

    const [agua, alc, pav, ver] = await Promise.all([
      sumField("cnx_nuevas_agua", "1=1"),
      sumField("cnx_nuevas_alcantarillado_dse", "1=1"),
      sumField("final_pavimento_m2_monitoreo", "1=1"),
      sumField("final_vereda_m2_monitoreo", "1=1")
    ]);

    animateNum(document.getElementById('k-agua'), Math.round(agua||0));
    animateNum(document.getElementById('k-alc'),  Math.round(alc||0));
    animateNum(document.getElementById('k-pav'),  Math.round(pav||0));
    animateNum(document.getElementById('k-ver'),  Math.round(ver||0));

    ioGen.disconnect();
  }
},{threshold:0.25});
ioGen.observe(gen);
</script>
</body>
</html>
