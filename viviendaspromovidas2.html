<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Viviendas Promovidas ¬∑ Burbuja Filtros flotante</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.29/"></script>

<style>
:root{
  --ink:#0b2532; --muted:#64748b; --card:#fff; --g-dark:#0f3f3a; --g-2:#7da39e;
  --line:#e6ecea; --panel:#f7fbfa; --bar:#0b3b38;
}
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  background:#eef5f3;
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
}

/* layout 1/3 mapa + 2/3 KPIs futuros */
.shell{
  display:grid;
  grid-template-columns: min(33vw,480px) 1fr;
  height:100vh;
  width:100vw;
}
#mapWrap{
  position:relative;
  height:100%;
  overflow:hidden;
  background:#000;
  border-right:1px solid var(--line);
  box-shadow:4px 0 24px rgba(2,6,23,.08);
}
#viewDiv{
  position:absolute;
  inset:0;
  z-index:1;
}

/* ===== BURBUJA flotante (global, fixed, sobre todo) ===== */
.bubbleWrap{
  position:fixed;
  left:16px;
  top:16px;
  z-index:999999;           /* s√∫per arriba */
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  user-select:none;
  touch-action:none;
  pointer-events:auto;      /* asegurarnos que s√≠ recibe click */
}
.bubbleBtn{
  width:48px;
  height:48px;
  border-radius:50%;
  background:#0b3b38;
  border:2px solid #0e4a43;
  color:#e6fffb;
  box-shadow:0 16px 32px rgba(0,0,0,.4);
  font-weight:900;
  font-size:13px;
  display:grid;
  place-items:center;
  cursor:pointer;
  line-height:1.1;
  pointer-events:auto;
}
.bubbleBtn:active{
  filter:brightness(1.08);
}

/* panel flotante */
.bubblePanel{
  position:absolute;
  min-width:250px;
  max-width:300px;
  color:#e6fffb;
  font-size:13px;
  font-weight:600;
  line-height:1.4;
  display:none;
  z-index:1000000;
  pointer-events:auto;
}
.bubblePanelInner{
  background:#0f2e29;
  border:1px solid #0e4a43;
  border-radius:14px;
  box-shadow:0 24px 40px rgba(0,0,0,.5);
  overflow:hidden;
}
.bubbleHead{
  padding:10px 12px;
  font-weight:800;
  font-size:13px;
  color:#e6fffb;
  background:#0b3b38;
  border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.bubbleHead .ttl{
  display:flex;
  align-items:center;
  gap:8px;
}
.bubbleBody{
  padding:12px 12px 14px;
  background:#0f2e29;
  display:grid;
  gap:12px;
}
.formRowGroup{
  display:grid;
  gap:10px;
}
.subBlockTitle{
  font-size:11px;
  font-weight:900;
  text-transform:uppercase;
  color:#cbe8e5;
  letter-spacing:.05em;
}
.fldGroup3{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:10px;
}
.fldGroup2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.fld{
  display:grid;
  gap:4px;
}
.fld label{
  font-size:11px;
  color:#cbe8e5;
  font-weight:700;
}
.fld select{
  width:100%;
  border-radius:10px;
  padding:9px 10px;
  border:1px solid #155149;
  background:#0f2e29;
  color:#e6fffb;
  min-height:40px;
  box-sizing:border-box;
  font-weight:600;
  font-size:12px;
}
.fld select:disabled{opacity:.5}
.bubbleFooter{
  display:flex;
  justify-content:flex-end;
  align-items:flex-end;
  height:100%;
}
.btnMini{
  background:#114d46;
  color:#ecfffb;
  border:1px solid #0d3a35;
  border-radius:10px;
  padding:7px 10px;
  cursor:pointer;
  font-weight:800;
  font-size:12px;
  box-shadow:0 6px 12px rgba(0,0,0,.4);
}
.btnMini:active{
  filter:brightness(1.08);
}

/* ====== Sidebar (KPIs) ===== */
.sidebar{
  background:var(--panel);
  display:flex;
  flex-direction:column;
  height:100%;
  overflow:hidden;
  padding:16px 16px 18px;
  box-sizing:border-box;
  position:relative;
  z-index:0; /* globo debe quedar encima del sidebar tambi√©n */
}
.topPlaceholder{
  flex:0 0 auto;
  background:#fff;
  border:2px dashed #cbd5d1;
  border-radius:16px;
  min-height:120px;
  margin-bottom:16px;
  box-shadow:0 10px 24px rgba(2,6,23,.04);
  color:#64748b;
  font-size:13px;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  line-height:1.4;
}
.heroLine{
  background:#fff;
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px 14px;
  box-shadow:0 10px 24px rgba(2,6,23,.06);
  margin-bottom:16px;
  font-weight:800;
  color:#0b3b38;
  font-size:14px;
  line-height:1.3;
}
.heroNum{
  display:block;
  font-size:32px;
  line-height:1;
  font-weight:900;
  color:#0f3f3a;
}

.bar{
  background:var(--bar);
  color:#e7fff9;
  font-weight:800;
  text-align:center;
  padding:10px 12px;
  border-radius:10px;
  margin:0 0 12px;
  font-size:13px;
}
.kpiScroll{
  flex:1 1 auto;
  min-height:0;
  overflow-y:auto;
  padding-right:6px;
  scrollbar-width:thin;
  display:grid;
  gap:12px;
}
.kpiCard{
  background:#fff;
  border:1px solid var(--line);
  border-radius:14px;
  box-shadow:0 10px 24px rgba(2,6,23,.06);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.kpiHead{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:800;
  color:#0b3b38;
  font-size:13px;
}
.kpiIcon{
  width:34px;
  height:34px;
  flex:0 0 34px;
  border-radius:50%;
  background:#7da39e;
  color:#fff;
  display:grid;
  place-items:center;
  font-weight:900;
  font-size:16px;
}
.kpiVal{
  font-size:28px;
  line-height:1;
  font-weight:900;
  color:#0f3f3a;
}
.kpiLbl{
  color:#64748b;
  font-weight:700;
  font-size:12px;
  line-height:1.3;
}

/* popup estilo tarjeta */
.esri-popup__header{display:none!important;}
.esri-popup__main-container{padding-top:0!important;}

@media(max-width:900px){
  html,body{
    height:auto;
    min-height:100vh;
    overflow-y:auto;
    overflow-x:hidden;
  }
  .shell{
    grid-template-columns:1fr;
    grid-template-rows:auto auto;
    height:auto;
    min-height:100vh;
  }
  #mapWrap{
    height:50vh;
    min-height:300px;
    border-right:0;
    border-bottom:1px solid var(--line);
    box-shadow:0 6px 24px rgba(2,6,23,.08);
  }
  .sidebar{
    height:auto;
    min-height:50vh;
  }
  .heroLine{font-size:12px;line-height:1.2;margin-bottom:8px;}
  .heroNum{font-size:26px;line-height:1;}
  .kpiHead{font-size:12px}
  .kpiVal {font-size:22px}
  .kpiLbl {font-size:11px}
  .kpiIcon{
    width:30px;
    height:30px;
    flex:0 0 30px;
    font-size:14px;
  }
}
</style>
</head>
<body>

<!-- BURBUJA GLOBAL (IMPORTANTE: est√° FUERA de .shell para que siempre est√© encima de todo) -->
<div id="bubbleWrap" class="bubbleWrap">
  <div id="bubbleBtn" class="bubbleBtn" title="Filtros (arr√°strame)">
    Filtros
  </div>

  <div id="bubblePanel" class="bubblePanel" role="dialog" aria-modal="false">
    <div class="bubblePanelInner" id="bubblePanelInner">
      <div class="bubbleHead">
        <div class="ttl"><span>Filtros</span></div>
      </div>

      <div class="bubbleBody">

        <!-- Ubigeo -->
        <div class="formRowGroup">
          <div class="subBlockTitle">Ubicaci√≥n</div>
          <div class="fldGroup3">
            <div class="fld">
              <label for="selDep">Departamento</label>
              <select id="selDep"><option value="">(Todos)</option></select>
            </div>
            <div class="fld">
              <label for="selProv">Provincia</label>
              <select id="selProv" disabled><option value="">(Todas)</option></select>
            </div>
            <div class="fld">
              <label for="selDist">Distrito</label>
              <select id="selDist" disabled><option value="">(Todos)</option></select>
            </div>
          </div>
        </div>

        <!-- Atributos Vivienda -->
        <div class="formRowGroup">
          <div class="subBlockTitle">Atributos Vivienda</div>
          <div class="fldGroup3">
            <div class="fld">
              <label for="selAnio">A√±o</label>
              <select id="selAnio"><option value="">(Todos)</option></select>
            </div>

            <div class="fld">
              <label for="selModalidad">Modalidad</label>
              <select id="selModalidad"><option value="">(Todos)</option></select>
            </div>

            <div class="fld">
              <label for="selModalidad1">Modalidad_1</label>
              <select id="selModalidad1"><option value="">(Todos)</option></select>
            </div>
          </div>

          <div class="fldGroup2">
            <div class="fld">
              <label for="selFlag">Gesti√≥n</label>
              <select id="selFlag">
                <option value="">General (todas)</option>
                <option value="1">Gesti√≥n anterior</option>
                <option value="2">Gesti√≥n actual</option>
              </select>
            </div>

            <div class="fld" style="align-self:end;">
              <div class="bubbleFooter">
                <button id="btnClear" class="btnMini" type="button">Limpiar</button>
              </div>
            </div>
          </div>
        </div>

      </div><!-- bubbleBody -->
    </div><!-- bubblePanelInner -->
  </div><!-- bubblePanel -->
</div><!-- bubbleWrap -->

<div class="shell">
  <!-- MAPA -->
  <div id="mapWrap">
    <div id="viewDiv" aria-label="Mapa de Viviendas Promovidas"></div>
  </div>

  <!-- KPIs -->
  <aside class="sidebar">
    <div class="topPlaceholder">
      Aqu√≠ ir√°n KPIs / tarjetas grandes / gr√°ficos.
    </div>

    <div class="heroLine">
      Viviendas promovidas
      <span class="heroNum" id="kpiTotalViv">‚Äî</span>
    </div>

    <div class="bar">Indicadores</div>

    <div class="kpiScroll">
      <div class="kpiCard">
        <div class="kpiHead">
          <div class="kpiIcon">üè†</div>
          <div>Total registros</div>
        </div>
        <div class="kpiVal" id="kpi1">‚Äî</div>
        <div class="kpiLbl">Cantidad de filas filtradas</div>
      </div>

      <div class="kpiCard">
        <div class="kpiHead">
          <div class="kpiIcon">üìÖ</div>
          <div>A√±o m√°s reciente</div>
        </div>
        <div class="kpiVal" id="kpi2">‚Äî</div>
        <div class="kpiLbl">M√°ximo "a√±o" dentro del filtro</div>
      </div>

      <div class="kpiCard">
        <div class="kpiHead">
          <div class="kpiIcon">üìà</div>
          <div>‚Äî</div>
        </div>
        <div class="kpiVal" id="kpi3">‚Äî</div>
        <div class="kpiLbl">Placeholder</div>
      </div>
    </div>
  </aside>
</div>

<script>
/* =======================
   ENDPOINTS
   ======================= */
const URL_BASE = "https://devportalgis.vivienda.gob.pe/servergis/rest/services/viv_promovidas_titulos_bfh_tablas/MapServer";
const URL_VIV  = URL_BASE + "/5"; // Viviendas Promovidas (puntos)
const LIM_BASE = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%9Aticos/MapServer".replace("%3F","?").replace("%9A",""); 
// arreglamos encoding raro en copia; m√°s seguro lo ponemos literal abajo:
const URL_DEP  = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer/0";
const URL_PROV = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer/1";
const URL_DIST = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer/2";

const fmt = new Intl.NumberFormat("es-PE");

/* =======================
   HELPERS
   ======================= */
function esc(v){ return String(v).replaceAll("'", "''"); }
function cacheBust(){ return String(Date.now()); }

function esriPOST(url, paramsObj){
  const body = new URLSearchParams({
    f:"json",
    ...paramsObj,
    __ts: cacheBust()
  });
  return fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
    body: body.toString(),
    cache:"no-store"
  })
  .then(r => { if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
  .then(j => {
    if(j.error){
      console.error("ArcGIS:", j.error);
      throw new Error(j.error.message||"ArcGIS");
    }
    return j;
  })
  .catch(err=>{
    console.error("esriPOST fail",err);
    return {};
  });
}

// carga valores distintos de un campo
async function loadDistinct(url, field){
  const page = 2000;
  let offset = 0;
  const vals = new Set();
  while(true){
    const j = await esriPOST(url+"/query", {
      where:"1=1",
      outFields: field,
      orderByFields: field,
      returnDistinctValues: "true",
      returnGeometry:"false",
      resultRecordCount: page,
      resultOffset: offset
    });
    const rows = (j.features||[])
      .map(f=> (f.attributes||{})[field])
      .filter(v=>v!=null && v!=="");
    rows.forEach(v=> vals.add(v));
    if(!j.exceededTransferLimit || rows.length<page) break;
    offset += page;
  }
  return [...vals];
}

function fillSelectStatic(sel, arr, firstLabel){
  sel.innerHTML = `<option value="">${firstLabel}</option>` +
    arr.sort().map(v=>`<option value="${v}">${v}</option>`).join("");
}
function fillSelectPairs(sel, arr, firstLabel){
  sel.innerHTML = `<option value="">${firstLabel}</option>` +
    arr.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
}

/* ========= DOM refs ========= */
const selDep        = document.getElementById("selDep");
const selProv       = document.getElementById("selProv");
const selDist       = document.getElementById("selDist");
const selAnio       = document.getElementById("selAnio");
const selModalidad  = document.getElementById("selModalidad");
const selModalidad1 = document.getElementById("selModalidad1");
const selFlag       = document.getElementById("selFlag");
const btnClear      = document.getElementById("btnClear");

const bubbleWrap   = document.getElementById("bubbleWrap");
const bubbleBtn    = document.getElementById("bubbleBtn");
const bubblePanel  = document.getElementById("bubblePanel");
const bubblePanelInner = document.getElementById("bubblePanelInner");

/* =======================
   BURBUJA: DRAG + TOGGLE
   ======================= */
(function setupDraggableAndToggle(){
  // protecci√≥n por si ya se inicializ√≥ antes
  if(bubbleWrap.__initialized) return;
  bubbleWrap.__initialized = true;

  let dragging=false, offX=0, offY=0, dragStartTime=0;

  function savePos(){
    const left = bubbleWrap.style.left || "16px";
    const top  = bubbleWrap.style.top  || "16px";
    localStorage.setItem("bubblePosFixed", JSON.stringify({left,top}));
  }
  function restorePos(){
    const raw = localStorage.getItem("bubblePosFixed");
    if(!raw) return;
    try{
      const pos = JSON.parse(raw);
      if(pos.left) bubbleWrap.style.left = pos.left;
      if(pos.top)  bubbleWrap.style.top  = pos.top;
    }catch(_){}
  }
  restorePos();

  function startDrag(x,y){
    dragging=true;
    dragStartTime=Date.now();
    const rect = bubbleWrap.getBoundingClientRect();
    offX = x - rect.left;
    offY = y - rect.top;
  }
  function moveDrag(x,y){
    if(!dragging) return;
    bubbleWrap.style.left = (x-offX)+"px";
    bubbleWrap.style.top  = (y-offY)+"px";
  }
  function endDrag(){
    if(!dragging) return false;
    dragging=false;
    savePos();
    const dt = Date.now()-dragStartTime;
    return dt < 200; // true => tap corto
  }

  function positionPanelAroundBubble(){
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const r = bubbleWrap.getBoundingClientRect();
    const openUp = (r.bottom + 260 > vh);

    bubblePanel.style.top = "";
    bubblePanel.style.bottom = "";
    bubblePanel.style.left = "";

    let left = r.left;
    const panelW = 300;
    if(left + panelW > vw-8){
      left = vw - panelW - 8;
    }
    if(left < 8){
      left = 8;
    }
    bubblePanel.style.left = (left - r.left) + "px";

    if(openUp){
      bubblePanel.style.bottom = "56px";
      bubblePanel.style.top = "auto";
      bubblePanelInner.style.borderRadius = "14px";
    }else{
      bubblePanel.style.top = "56px";
      bubblePanel.style.bottom = "auto";
      bubblePanelInner.style.borderRadius = "14px";
    }
  }

  function togglePanel(){
    if(bubblePanel.style.display==="block"){
      bubblePanel.style.display="none";
      return;
    }
    positionPanelAroundBubble();
    bubblePanel.style.display="block";
  }

  // mouse
  bubbleBtn.addEventListener("mousedown", e=>{
    startDrag(e.clientX,e.clientY);
    e.preventDefault();
  });
  window.addEventListener("mousemove", e=>{
    if(!dragging) return;
    moveDrag(e.clientX,e.clientY);
  });
  window.addEventListener("mouseup", ()=>{
    const isTap = endDrag();
    if(isTap){
      togglePanel();
    }
  });

  // touch
  bubbleBtn.addEventListener("touchstart", e=>{
    const t=e.touches[0];
    startDrag(t.clientX,t.clientY);
  }, {passive:true});
  window.addEventListener("touchmove", e=>{
    if(!dragging) return;
    const t=e.touches[0];
    moveDrag(t.clientX,t.clientY);
  }, {passive:true});
  window.addEventListener("touchend", ()=>{
    const isTap = endDrag();
    if(isTap){
      togglePanel();
    }
  });

  // cerrar / recolocar si viewport cambia
  window.addEventListener("resize", ()=>{
    if(bubblePanel.style.display==="block"){
      positionPanelAroundBubble();
    }
  });
  window.addEventListener("scroll", ()=>{
    if(bubblePanel.style.display==="block"){
      positionPanelAroundBubble();
    }
  });
})();

/* =======================
   MAP + LAYERS
   ======================= */
let view, vivLayer, limProvDraw, limDistDraw, limDeptDraw, initialViewpointPromise;
let limDeptSrc, limProvSrc, limDistSrc;

require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/widgets/ScaleBar",
  "esri/widgets/BasemapToggle"
], function(Map,MapView,FeatureLayer,ScaleBar,BasemapToggle){

  const map = new Map({ basemap:"satellite" });

  view = new MapView({
    container:"viewDiv",
    map,
    center:[-75.2,-9.3],
    zoom:5,
    padding:{ left:16, right:6, top:6, bottom:6 }
  });

  initialViewpointPromise = view.when().then(()=>view.viewpoint.clone());

  // s√≠mbolos glow
  function glowCIM(rgb){
    return {
      type:"cim",
      data:{
        type:"CIMSymbolReference",
        symbol:{
          type:"CIMLineSymbol",
          symbolLayers:[
            { type:"CIMSolidStroke", enable:true, width:6,   color:[...rgb,40]  },
            { type:"CIMSolidStroke", enable:true, width:3,   color:[...rgb,120] },
            { type:"CIMSolidStroke", enable:true, width:1.6, color:[...rgb,255] }
          ]
        }
      }
    };
  }

  // capas limites
  limDeptDraw = new FeatureLayer({
    url: URL_DEP,
    title:"L√≠mite Departamental (base)",
    popupEnabled:false,
    listMode:"hide",
    renderer:{
      type:"simple",
      symbol:{
        type:"cim",
        data:{
          type:"CIMSymbolReference",
          symbol:{
            type:"CIMLineSymbol",
            symbolLayers:[
              { type:"CIMSolidStroke", enable:true, width:2.4, color:[255,255,255,120] },
              { type:"CIMSolidStroke", enable:true, width:0.8, color:[0,0,0,180] }
            ]
          }
        }
      }
    }
  });

  limProvDraw = new FeatureLayer({
    url: URL_PROV,
    title:"L√≠mite Provincial (resaltado)",
    popupEnabled:false,
    listMode:"hide",
    visible:false,
    renderer:{ type:"simple", symbol:glowCIM([255,215,0]) }
  });

  limDistDraw = new FeatureLayer({
    url: URL_DIST,
    title:"L√≠mite Distrital (resaltado)",
    popupEnabled:false,
    listMode:"hide",
    visible:false,
    renderer:{ type:"simple", symbol:glowCIM([255,105,180]) }
  });

  map.add(limDeptDraw);
  map.add(limProvDraw);
  map.add(limDistDraw);

  // capa puntos viviendas
  vivLayer = new FeatureLayer({
    url: URL_VIV,
    title:"Viviendas Promovidas",
    outFields:["*"],
    popupEnabled:true,
    renderer:{
      type:"simple",
      symbol:{
        type:"simple-marker",
        style:"circle",
        size:8,
        color:[255,234,0,0.95],
        outline:{ color:[0,0,0,220], width:0.6 }
      }
    },
    popupTemplate:{
      title:"{distrito}",
      content: function(e){
        const a = e.graphic.attributes || {};
        const rows = [
          ["Departamento", a.departamento],
          ["Provincia",    a.provincia],
          ["Distrito",     a.distrito],
          ["A√±o",          a.anio],
          ["Modalidad",    a.modalidad],
          ["Modalidad_1",  a.modalidad_1],
          ["Gesti√≥n (flag_viviendas)", a.flag_viviendas],
          ["Viviendas",    a.viviendas]
        ];
        return `
        <div style="font:12.5px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:#0b2532;">
          <div style="background:#0b3b38;color:#e6fffb;padding:10px 12px;font-weight:900;border-radius:10px 10px 0 0;">
            Viviendas promovidas
          </div>
          <div style="border:1px solid #e6ecea;border-top:0;border-radius:0 0 10px 10px;padding:12px;background:#fff;">
            ${rows.map(([lbl,val])=>`
              <div style="display:flex;justify-content:space-between;gap:8px;margin-bottom:6px;font-size:12px;">
                <div style="color:#475569;font-weight:700;">${lbl}</div>
                <div style="color:#0b2532;font-weight:800;text-align:right;">${val==null||val===""?"‚Äî":val}</div>
              </div>
            `).join("")}
          </div>
        </div>`;
      }
    }
  });
  map.add(vivLayer);

  const toggle = new BasemapToggle({ view, nextBasemap:"osm" });
  view.ui.add(toggle, "bottom-right");
  view.ui.add(new ScaleBar({view,unit:"metric"}),"bottom-left");
  view.ui.move("zoom","bottom-right");

  /* =======================
     FUENTES para combos UBIGEO
     ======================= */
  limDeptSrc = new FeatureLayer({
    url: URL_DEP,
    outFields:["id_dpto","nom_dep"],
    listMode:"hide"
  });
  limProvSrc = new FeatureLayer({
    url: URL_PROV,
    outFields:["id_dep","id_prov","nom_prov"],
    listMode:"hide"
  });
  limDistSrc = new FeatureLayer({
    url: URL_DIST,
    outFields:["id_dpto","id_prov","id_dist","nom_dist"],
    listMode:"hide"
  });

  /* =======================
     COMBOS UBIGEO
     ======================= */
  async function loadDeps(){
    const q = limDeptSrc.createQuery();
    q.where="1=1";
    q.returnGeometry=false;
    q.outFields=["id_dpto","nom_dep"];
    q.orderByFields=["nom_dep ASC"];
    q.num=300;
    const r = await limDeptSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{
      const at=f.attributes||{};
      const id=at.id_dpto, name=at.nom_dep;
      if(id && !seen.has(id)){
        seen.add(id);
        rows.push({id,name});
      }
    });
    fillSelectPairs(selDep, rows, "(Todos)");
    selProv.innerHTML='<option value="">(Todas)</option>';
    selProv.disabled=true;
    selDist.innerHTML='<option value="">(Todos)</option>';
    selDist.disabled=true;
  }

  async function loadProvs(){
    const dep = selDep.value.trim();
    selProv.innerHTML='<option value="">(Todas)</option>';
    selDist.innerHTML='<option value="">(Todos)</option>';
    selDist.disabled=true;
    if(!dep){
      selProv.disabled=true;
      return;
    }
    const q = limProvSrc.createQuery();
    q.where=`id_dep='${esc(dep)}'`;
    q.returnGeometry=false;
    q.outFields=["id_dep","id_prov","nom_prov"];
    q.orderByFields=["nom_prov ASC"];
    q.num=1000;
    const r = await limProvSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{
      const at=f.attributes||{};
      const id=at.id_prov, name=at.nom_prov;
      if(id && !seen.has(id)){
        seen.add(id);
        rows.push({id,name});
      }
    });
    fillSelectPairs(selProv, rows, "(Todas)");
    selProv.disabled=false;
  }

  async function loadDists(){
    const prov = selProv.value.trim();
    selDist.innerHTML='<option value="">(Todos)</option>';
    if(!prov){
      selDist.disabled=true;
      return;
    }
    const q = limDistSrc.createQuery();
    q.where=`id_prov='${esc(prov)}'`;
    q.returnGeometry=false;
    q.outFields=["id_prov","id_dist","nom_dist"];
    q.orderByFields=["nom_dist ASC"];
    q.num=3000;
    const r = await limDistSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{
      const at=f.attributes||{};
      const id=at.id_dist, name=at.nom_dist;
      if(id && !seen.has(id)){
        seen.add(id);
        rows.push({id,name});
      }
    });
    fillSelectPairs(selDist, rows, "(Todos)");
    selDist.disabled=false;
  }

  /* =======================
     WHERE helpers
     ======================= */

  // helper para cl√°usulas num√©ricas vs texto
  function clauseEq(field, val, isNumber){
    if(val===""||val==null) return null;
    if(isNumber){
      return `${field}=${Number(val)}`;
    }else{
      return `${field}='${esc(String(val))}'`;
    }
  }

  // arma where para zoom/resaltado pol√≠tico
  function buildWhereUbigeoZoom(){
    const dep  = selDep.value.trim();
    const prov = selProv.value.trim();
    const dist = selDist.value.trim();

    if(dist){
      return { level:"dist", where:`id_dist='${esc(dist)}'` };
    }else if(prov){
      return { level:"prov", where:`id_prov='${esc(prov)}'` };
    }else if(dep){
      // OJO: en capa departamental el campo es id_dpto
      return { level:"dep", where:`id_dpto='${esc(dep)}'` };
    }else{
      return { level:null, where:null };
    }
  }

  // arma where para filtrar puntos (viveLayer)
  // mezcla ubigeo + atributos
  function buildWherePuntos(){
    const parts = ["1=1"];

    // ubigeo (en la capa viviendas_promovidas: id_dep, id_prov, id_dist)
    if(selDep.value.trim()!==""){
      parts.push(`id_dep='${esc(selDep.value.trim())}'`);
    }
    if(selProv.value.trim()!==""){
      parts.push(`id_prov='${esc(selProv.value.trim())}'`);
    }
    if(selDist.value.trim()!==""){
      parts.push(`id_dist='${esc(selDist.value.trim())}'`);
    }

    // atributos vivienda
    const cAnio   = clauseEq("anio", selAnio.value.trim(), true);        // num√©rico
    const cMod    = clauseEq("modalidad", selModalidad.value.trim(), false);   // texto
    const cMod1   = clauseEq("modalidad_1", selModalidad1.value.trim(), false);// texto
    const cFlag   = clauseEq("flag_viviendas", selFlag.value.trim(), true);    // num√©rico

    if(cAnio) parts.push(cAnio);
    if(cMod)  parts.push(cMod);
    if(cMod1) parts.push(cMod1);
    if(cFlag) parts.push(cFlag);

    return parts.join(" AND ");
  }

  /* =======================
     KPIs
     ======================= */
  async function updateKPIs(){
    try{
      const q = vivLayer.createQuery();
      q.where = vivLayer.definitionExpression || "1=1";
      q.returnGeometry = false;
      q.outFields = ["*"];
      const res = await vivLayer.queryFeatures(q);
      const feats = res.features || [];

      let totalViv = 0;
      let maxAnio = null;
      for(const f of feats){
        const a=f.attributes||{};
        if(a.viviendas!=null){
          const v=Number(a.viviendas);
          if(Number.isFinite(v)) totalViv+=v;
        }
        if(a.anio!=null && a.anio!==""){
          const y=Number(a.anio);
          if(Number.isFinite(y)){
            if(maxAnio==null || y>maxAnio) maxAnio=y;
          }
        }
      }

      document.getElementById("kpiTotalViv").textContent = fmt.format(totalViv);
      document.getElementById("kpi1").textContent        = fmt.format(feats.length);
      document.getElementById("kpi2").textContent        = maxAnio==null?"‚Äî":maxAnio;
      document.getElementById("kpi3").textContent        = "‚Äî";
    }catch(err){
      console.warn("updateKPIs fail",err);
      document.getElementById("kpiTotalViv").textContent = "‚Äî";
      document.getElementById("kpi1").textContent        = "‚Äî";
      document.getElementById("kpi2").textContent        = "‚Äî";
      document.getElementById("kpi3").textContent        = "‚Äî";
    }
  }

  /* =======================
     ZOOM / RESALTADO l√≠mites
     ======================= */
  async function applyBoundaryZoom(){
    const info = buildWhereUbigeoZoom();
    const level = info.level;
    const where = info.where;

    // reset visibles por defecto
    limProvDraw.visible=false;
    limProvDraw.definitionExpression=null;
    limDistDraw.visible=false;
    limDistDraw.definitionExpression=null;

    if(!level){
      const vp = await initialViewpointPromise;
      try{ await view.goTo(vp, { duration:700 }); }catch(_){}
      return;
    }

    // set highlight segun nivel
    if(level==="dist"){
      limDistDraw.definitionExpression = where;
      limDistDraw.visible=true;
    }else if(level==="prov"){
      limProvDraw.definitionExpression = where;
      limProvDraw.visible=true;
    }else{
      // dep -> usamos s√≥lo limDeptDraw base
    }

    // zoom al feature correspondiente
    let srcLayer;
    if(level==="dist"){
      srcLayer = limDistDraw;
    }else if(level==="prov"){
      srcLayer = limProvDraw;
    }else if(level==="dep"){
      srcLayer = limDeptDraw;
    }

    try{
      const q = srcLayer.createQuery();
      q.where = where;
      q.returnGeometry = true;
      q.outFields = ["*"];
      q.num = 1;
      const r = await srcLayer.queryFeatures(q);
      const g = r.features?.[0]?.geometry;
      if(g){
        await view.goTo(
          { target:g, padding:{ left:40,right:40,top:40,bottom:40 } },
          { duration:700, easing:"ease-in-out" }
        );
      }
    }catch(err){
      console.warn("applyBoundaryZoom fail", err);
    }
  }

  /* =======================
     FILTRO DE PUNTOS
     ======================= */
  async function applyPointFilterOnly(){
    vivLayer.definitionExpression = buildWherePuntos();
    await updateKPIs();
  }

  /* =======================
     REFRESH GENERAL
     ======================= */
  async function refreshAll(){
    await applyPointFilterOnly(); // actualiza puntos/KPIs con TODOS los filtros
    await applyBoundaryZoom();    // ajusta zoom/contornos si cambiaron dep/prov/dist
  }

  /* =======================
     LISTENERS
     ======================= */
  // Territorio: disparan recarga completa (puntos+zoom)
  selDep.addEventListener("change", async ()=>{
    await loadProvs();
    await refreshAll();
  });
  selProv.addEventListener("change", async ()=>{
    await loadDists();
    await refreshAll();
  });
  selDist.addEventListener("change", async ()=>{
    await refreshAll();
  });

  // Atributos vivienda: s√≥lo cambian puntos/KPIs
  selAnio.addEventListener("change", async ()=>{
    await applyPointFilterOnly();
  });
  selModalidad.addEventListener("change", async ()=>{
    await applyPointFilterOnly();
  });
  selModalidad1.addEventListener("change", async ()=>{
    await applyPointFilterOnly();
  });
  selFlag.addEventListener("change", async ()=>{
    await applyPointFilterOnly();
  });

  // Limpiar
  btnClear.addEventListener("click", async ()=>{
    selDep.value="";
    selProv.innerHTML='<option value="">(Todas)</option>';
    selProv.disabled=true;
    selDist.innerHTML='<option value="">(Todos)</option>';
    selDist.disabled=true;

    selAnio.value="";
    selModalidad.value="";
    selModalidad1.value="";
    selFlag.value="";

    limProvDraw.visible=false;
    limProvDraw.definitionExpression=null;
    limDistDraw.visible=false;
    limDistDraw.definitionExpression=null;

    await applyPointFilterOnly();  // resetea puntos/KPIs
    await applyBoundaryZoom();     // regresa al panorama inicial
  });

  /* =======================
     INIT
     ======================= */
  (async function init(){
    // ubigeo combos
    await loadDeps();

    // atributos combos desde capa viviendas
    const [anios,mods,mods1] = await Promise.all([
      loadDistinct(URL_VIV,"anio"),
      loadDistinct(URL_VIV,"modalidad"),
      loadDistinct(URL_VIV,"modalidad_1")
    ]);
    fillSelectStatic(selAnio, anios, "(Todos)");
    fillSelectStatic(selModalidad, mods, "(Todos)");
    fillSelectStatic(selModalidad1, mods1, "(Todos)");
    // selFlag ya est√° lleno fijo

    // primera carga: puntos y KPIs
    await applyPointFilterOnly();

    // panorama Per√∫
    const vp = await initialViewpointPromise;
    try{ await view.goTo(vp, { duration:0 }); }catch(_){}
  })();

});
</script>
</body>
</html>
