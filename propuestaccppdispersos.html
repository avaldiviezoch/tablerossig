<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Grado de dispersi√≥n de centros poblados</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.30/"></script>

<style>
  :root { --ink:#0b2532; --muted:#64748b; --line:#0e4a43; --panel:#f7fbfa; --brand:#0b3b38; --accent:#0f2e29; --sep:#e6ecea; }
  html,body{height:100%;margin:0;background:#eef5f3;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  body{display:grid;grid-template-rows:1fr;overflow:hidden}

  .shell{display:grid;grid-template-columns:65% 35%;height:100%;width:100%;overflow:hidden}
  #viewWrap{position:relative;height:100%;overflow:hidden}
  #viewDiv{position:relative;width:100%;height:100%}

  .floatTitle{
    position:absolute; left:50%; top:12px; transform:translateX(-50%);
    background:rgba(255,255,255,.92); border:1px solid #d8e1df; border-radius:14px;
    padding:8px 18px; z-index:1000; box-shadow:0 6px 14px rgba(0,0,0,.18);
    font-weight:1000; letter-spacing:.2px; color:#0b2532; user-select:none;
    backdrop-filter:saturate(1.2) blur(2px); font-size:16px; max-width:min(92vw,800px);
    text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  @media (max-width:700px){ .floatTitle{ font-size:14px; padding:6px 12px; } }

  .sidebar{background:var(--panel);border-left:1px solid var(--sep);box-shadow:-6px 0 24px rgba(2,6,23,.06);padding:14px 12px;display:grid;grid-template-rows:auto auto 1fr;gap:12px;min-height:0}
  .filtersBar{background:#fff;border:1px solid var(--sep);border-radius:16px;box-shadow:0 10px 22px rgba(2,6,23,.06);padding:12px;display:grid;gap:10px}
  .filtersGrid{display:grid;gap:10px;align-items:end;grid-template-columns:1fr}
  @media (min-width:560px){.filtersGrid{grid-template-columns:1fr 1fr}}
  @media (min-width:820px){.filtersGrid{grid-template-columns:1fr 1fr 1fr}}
  @media (min-width:1040px){.filtersGrid{grid-template-columns:1fr 1fr 1fr 1fr}}
  .fld{display:grid;gap:6px;min-width:0}
  .fld label{font-size:12px;color:#47606b;font-weight:900;letter-spacing:.2px}
  .fld select{padding:10px 12px;border:1px solid #cfe7e3;border-radius:12px;background:#e8f5f3;color:#0b3b38;font-weight:800;font-size:13.5px;outline:none;width:100%;min-width:0;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;-webkit-appearance:none;appearance:none}
  .fld select:disabled{opacity:.6}
  .chipBar{display:grid;gap:8px;border-top:1px dashed var(--sep);padding-top:8px}
  .chipTitle{font-size:12px;color:#47606b;font-weight:900;letter-spacing:.2px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none;border:1px solid #cfe7e3;background:#f2fbfa;color:#0b3b38;font-weight:800;font-size:13px;white-space:nowrap}
  .chip:hover{filter:brightness(1.02)}
  .chip.on{background:#0b3b38;color:#ecfffb;border-color:#0e4a43}
  .chip:focus{outline:2px solid #0e4a43; outline-offset:2px}
  .rowBtns{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .btn{background:#0b3b38;color:#ecfffb;border:1px solid #0e4a43;padding:9px 14px;border-radius:12px;font-weight:900;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .iconbtn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 12px;border-radius:12px;border:1px solid #0e4a43;background:#fff;color:#0b3b38;cursor:pointer}
  .iconbtn svg{width:18px;height:18px;display:block}
  .lowerGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;min-height:0}
  @media (max-width:900px){.shell{grid-template-columns:1fr}#viewWrap{height:54vh}.lowerGrid{grid-template-columns:1fr}}

  .listCard{background:#fff;border:1px solid var(--sep);border-radius:16px;box-shadow:0 10px 24px rgba(2,6,23,.06);overflow:hidden;display:grid;grid-template-rows:auto 1fr;min-height:0}
  .listCard header{padding:10px 12px;background:#fff;border-bottom:1px solid var(--sep)}
  .listCard h3{margin:0;font-size:14px;font-weight:1000;color:#0b3b38;letter-spacing:.2px}
  .list{overflow:auto;min-height:0}
  .item{padding:10px 12px;border-bottom:1px solid #edf2f7;cursor:pointer;transition:background .15s ease}
  .item:hover{background:#f5faf8}
  .title{font-weight:900;font-size:13.8px}
  .kv{font-size:12.2px;color:#334155;line-height:1.35}
  .kv b{color:#0b2532}
  .empty{padding:16px;text-align:center;color:#64748b;font-size:12.8px}
  .commentWrap{padding:12px;overflow:auto;display:grid;gap:10px;align-content:start}
  .commentWrap p{margin:0;font-size:13.6px;color:#243b41}
  .commentImg{width:70%;max-width:220px;height:auto;border-radius:12px;border:1px solid #e3ecea;justify-self:center;display:block}

  .fab-wrap{position:absolute;right:14px;top:14px;display:flex;flex-direction:column;gap:10px;z-index:7}
  .fab{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:#0b3b38;color:#e6fffb;border:1px solid #0e4a43;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.22);font-weight:900;user-select:none}
  .fab:hover{filter:brightness(1.06)}
  .bubble{position:absolute;right:70px;top:14px;min-width:300px;max-width:min(400px,88vw);background:#0f2e29;color:#dff7f3;border:1px solid #0e4a43;border-radius:16px;box-shadow:0 14px 32px rgba(0,0,0,.28);z-index:8;display:none}
  .bubble header{padding:10px 12px;background:#0b3b38;border-bottom:1px solid #0e4a43;border-radius:16px 16px 0 0;display:flex;align-items:center;justify-content:space-between;cursor:move;gap:8px}
  .bubble header .ttl{font-weight:900;letter-spacing:.2px}
  .bubble header .x{cursor:pointer;border:1px solid #0e4a43;background:#114d46;color:#e6fffb;border-radius:10px;padding:6px 10px;font-weight:800}
  .bubble .content{padding:10px 10px 12px}
  .scroll{max-height:65vh;overflow:auto;border-radius:10px;border:1px solid #0e4a43}
  #bubbleLegend{background:#fff;color:var(--ink);border:1px solid var(--sep)}
  #bubbleLegend header{background:#fff;color:var(--ink);border-bottom:1px solid var(--sep)}
  #bubbleLegend header .x{background:#fff;color:#0b3b38;border:1px solid var(--sep)}
  #bubbleLegend .scroll{border:1px solid var(--sep)}

  .mini-hm-wrap{padding:8px 10px;border-top:1px dashed var(--sep);margin-top:8px;display:grid;gap:6px}
  .mini-hm-bar{height:8px;border-radius:999px;border:1px solid #e3ecea;
    background: linear-gradient(90deg,
      rgba(255,214,235,0.9) 0%,
      rgba(255,153,204,0.95) 50%,
      rgba(255,77,166,0.98) 100%
    );
  }
  .mini-hm-note{font-size:11px;text-align:center;color:#475569}

  .toast{
    position:fixed; right:14px; bottom:14px; z-index:9999;
    background:#0b3b38; color:#ecfffb; border:1px solid #0e4a43;
    padding:10px 14px; border-radius:12px; box-shadow:0 10px 22px rgba(0,0,0,.22);
    opacity:0; transform:translateY(8px); transition:.25s ease;
    pointer-events:none; font-weight:800; letter-spacing:.2px;
  }
  .toast.show{opacity:1; transform:translateY(0)}

  /* ===== Tooltip √Åreas agrupadas ===== */
  .tooltip-card{
    position:fixed; left:0; top:0; transform:translate(12px,12px);
    background:#fff; color:var(--ink); border:1px solid var(--sep); border-radius:14px;
    box-shadow:0 14px 34px rgba(2,6,23,.18); padding:10px 12px; pointer-events:none; z-index:9;
    min-width:260px; max-width:min(520px,70vw); font-size:12.8px; backdrop-filter:saturate(110%) blur(2px);
  }
  .tooltip-card.hidden{ display:none; }
  .tooltip-card .hdr{ display:flex; align-items:center; gap:10px; padding-bottom:6px; margin-bottom:8px; border-bottom:1px solid var(--sep); }
  .tooltip-card .dot{ width:10px; height:10px; border-radius:999px; background:#8f1c7d; box-shadow:0 0 0 4px rgba(143,28,125,.10); }
  .tooltip-card .title{ font-weight:1000; font-size:13.8px; letter-spacing:.2px; }
  .tooltip-card .list{ display:flex; flex-direction:column; gap:6px; }
  .tooltip-card .entry{ display:flex; justify-content:space-between; gap:8px; }
  .tooltip-card .k{ color:#47606b; font-weight:800; }
  .tooltip-card .v{ font-weight:900; }
</style>
</head>
<body>

  <div class="shell">
    <div id="viewWrap">
      <!-- T√≠tulo flotante SIN "PNSR" -->
      <div class="floatTitle" title="Grado de dispersi√≥n de centros poblados">üõ∞ Grado de dispersi√≥n de centros poblados</div>
      <div id="viewDiv" aria-label="Mapa principal"></div>

      <!-- Tooltip din√°mico -->
      <div id="ttAreas" class="tooltip-card hidden" role="status" aria-live="polite"></div>

      <div class="fab-wrap">
        <div id="btnLayers" class="fab" title="Capas (L)">üóÇÔ∏è</div>
        <div id="btnLegend" class="fab" title="Leyenda (J)">üè∑Ô∏è</div>
      </div>

      <div id="bubbleLayers" class="bubble" style="top:14px;">
        <header data-drag="#bubbleLayers"><span class="ttl">Capas</span><button class="x" data-close="#bubbleLayers">Cerrar</button></header>
        <div class="content"><div class="scroll"><div id="layerListNode"></div></div></div>
      </div>

      <div id="bubbleLegend" class="bubble" style="top:190px;">
        <header data-drag="#bubbleLegend"><span class="ttl">Leyenda</span><button class="x" data-close="#bubbleLegend">Cerrar</button></header>
        <div class="content">
          <div class="scroll"><div id="legendNode"></div></div>
          <div class="mini-hm-wrap" aria-hidden="true">
            <div class="mini-hm-bar" title="Mapa de calor"></div>
            <div class="mini-hm-note">Mapa de calor de concentraciones de √Åreas agrupadas CCPP</div>
          </div>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <section class="filtersBar" aria-label="Filtros de ubicaci√≥n">
        <div class="filtersGrid">
          <div class="fld"><label for="selDep">Departamento</label><select id="selDep"><option value="">(Todos)</option></select></div>
          <div class="fld"><label for="selProv">Provincia</label><select id="selProv" disabled><option value="">(Todas)</option></select></div>
          <div class="fld"><label for="selDist">Distrito</label><select id="selDist" disabled><option value="">(Todos)</option></select></div>
          <div class="fld"><label for="selCP">Centro poblado</label><select id="selCP" disabled><option value="">(Todos)</option></select></div>
        </div>

        <div id="catChipsWrap" class="chipBar" aria-label="Grado de Dispersi√≥n del CCPP">
          <div class="chipTitle">Grado de Dispersi√≥n del CCPP</div>
          <div id="chipList" class="chips"></div>
        </div>

        <div class="rowBtns">
          <button id="btnClear" class="btn" type="button" title="Limpiar filtros (C)">Limpiar filtros</button>
          <button id="btnExcel" class="iconbtn" type="button" title="Exportar a Excel">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <rect x="3" y="3" width="14" height="18" rx="2" fill="#22c55e" stroke="#14532d" stroke-width="1"/>
              <path d="M6 9l3 6M9 9l-3 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
              <rect x="11" y="3" width="10" height="4" fill="#16a34a"/>
            </svg>
          </button>
        </div>
      </section>

      <section class="lowerGrid">
        <div class="listCard">
          <header><h3>Centros poblados (lista)</h3></header>
          <div class="list" id="cpList"><div class="empty">Cargando‚Ä¶</div></div>
        </div>
        <div class="listCard">
          <header><h3>Comentario</h3></header>
          <div class="commentWrap">
            <p>La herramienta muestra las <b>√°reas de concentraci√≥n</b> y las <b>viviendas rurales con y sin acceso a agua</b> (Censo 2017). Tambi√©n incluye viviendas sin dato de acceso y se complementa con informaci√≥n de <b>componentes y redes de agua del DATASS</b> (m√≥dulo 3 y 5).</p>
            <img class="commentImg" loading="lazy" alt="Esquema de criterios" src="https://lh3.googleusercontent.com/d/1OPw9CWsW8xmgL6sjGuZcyvAtz2qJi0RF=w1000"/>
          </div>
        </div>
      </section>
    </aside>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
require([
  "esri/Map","esri/views/MapView",
  "esri/layers/FeatureLayer","esri/layers/GraphicsLayer","esri/layers/GroupLayer",
  "esri/widgets/Legend","esri/widgets/LayerList","esri/widgets/ScaleBar",
  "esri/Graphic",
  "esri/renderers/UniqueValueRenderer","esri/renderers/SimpleRenderer","esri/renderers/HeatmapRenderer",
  "esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol"
], (
  Map,MapView,
  FeatureLayer,GraphicsLayer,GroupLayer,
  Legend,LayerList,ScaleBar,
  Graphic,
  UniqueValueRenderer,SimpleRenderer,HeatmapRenderer,
  SimpleFillSymbol,SimpleLineSymbol,SimpleMarkerSymbol
) => {

  /* ===== Utilidades ===== */
  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));
  const toggle = id => { const el=qs(id); el.style.display=(el.style.display==='block'?'none':'block'); saveBubblePos(el); };
  const esc = s => String(s).replace(/'/g,"''");
  const fmt=(n,d=0)=>(n==null||isNaN(n))?"‚Äî":new Intl.NumberFormat('es-PE',{ maximumFractionDigits:d }).format(Number(n));
  const debounce = (fn,ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
  const showToast = (msg)=>{ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); };

  /* ===== Persistencia de burbujas ===== */
  function saveBubblePos(el){
    if(!el || !el.id) return;
    localStorage.setItem("bubble:"+el.id, JSON.stringify({left:el.style.left||"", top:el.style.top||"", right:el.style.right||""}));
  }
  function restoreBubblePos(el){
    if(!el || !el.id) return;
    const raw=localStorage.getItem("bubble:"+el.id);
    if(!raw) return;
    try{
      const pos=JSON.parse(raw);
      if(pos.left){ el.style.left=pos.left; el.style.right="auto"; }
      if(pos.top){ el.style.top=pos.top; }
    }catch(_){}
  }

  /* ===== UI b√°sicas ===== */
  qs('#btnLayers').onclick=()=>toggle('#bubbleLayers');
  qs('#btnLegend').onclick=()=>toggle('#bubbleLegend');
  qsa('[data-close]').forEach(b=>b.onclick=()=>{qs(b.dataset.close).style.display='none'; saveBubblePos(qs(b.dataset.close));});
  function makeDraggable(header){
    const box=qs(header.dataset.drag); let ox=0,oy=0,drag=false;
    header.addEventListener('mousedown',e=>{drag=true;ox=e.clientX-(box.offsetLeft||0);oy=e.clientY-(box.offsetTop||0);e.preventDefault();});
    window.addEventListener('mousemove',e=>{if(!drag)return; box.style.left=(e.clientX-ox)+'px'; box.style.top=(e.clientY-oy)+'px'; box.style.right='auto';});
    window.addEventListener('mouseup',()=>{ if(drag) saveBubblePos(box); drag=false; });
  }
  qsa('[data-drag]').forEach(makeDraggable);
  restoreBubblePos(qs('#bubbleLayers'));
  restoreBubblePos(qs('#bubbleLegend'));

  /* ===== ENDPOINTS ===== */
  const CCPP = "https://pportalgis.vivienda.gob.pe/pfdserver1/rest/services/OGEI/CCPP_Dispersos/FeatureServer";
  const LIM_BASE = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer";
  const LIM0 = `${LIM_BASE}/0`, LIM1 = `${LIM_BASE}/1`, LIM2 = `${LIM_BASE}/2`;
  const CP_LAYER = `${CCPP}/4`;
  const VR_URL = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/viviendas_rurales/MapServer";

  /* ===== MAPA ===== */
  const map = new Map({ basemap: "satellite" });
  const view = new MapView({
    container: "viewDiv", map,
    center: [-75, -9], zoom: 5,
    constraints: { minZoom: 4, snapToZoom: false }
  });
  view.ui.add(new ScaleBar({ view, unit:"metric" }), "bottom-left");
  view.qualityProfile = "low";

  // Extent de Per√∫ y zoom m√°s cercano para que llene casi todo el mapa
  const peruExtent = { xmin: -81.6, ymin: -18.4, xmax: -68.6, ymax: 0.2, spatialReference: { wkid: 4326 } };
  view.when(async ()=>{
    try {
      await view.goTo({ target: peruExtent, padding:{ left:0,right:0,top:8,bottom:8 } }, { duration: 300 });
      // acercar un poco m√°s sin recortar (expand < 1 reduce el extent)
      await view.goTo({ target: view.extent.expand(0.92) }, { duration: 500 });
    } catch(_){}
  });

  /* ===== Simbolog√≠a ===== */
  const mk = (c,s=6)=> new SimpleMarkerSymbol({ style:"circle", color:c, size:s, outline:{ color:[255,255,255,210], width:1.1 } });
  const mkSolid = (c,s=5)=> new SimpleMarkerSymbol({ style:"circle", color:c, size:s, outline:null });
  const line = (c,w=1.2)=> new SimpleLineSymbol({ color:c, width:w });
  const poly = (fill, outline)=> new SimpleFillSymbol({ color:fill, outline });

  const CAT_PALETTE = [
    [255,215,  0, 0.98],
    [150,100, 50, 0.98],
    [128,  0,128, 0.98],
    [144,238,144, 0.98],
    [100,180,255, 0.98]
  ];

  /* === CAPAS base === */
  const lyrAreasAgrup = new FeatureLayer({
    url:`${CCPP}/6`,
    title:"√Åreas agrupadas (densidad y viviendas)",
    visible:false,
    outFields:["*"], popupEnabled:false,
    // Menos transparencia (m√°s visible): alpha 0.90
    renderer:new SimpleRenderer({
      symbol: poly([255,77,166,0.90], new SimpleLineSymbol({ color:[255,77,166,1.0], width:1.3 }))
    })
  });

  const lyrAmbito = new FeatureLayer({
    url:`${CCPP}/5`,
    title:"√Åmbito territorial de centros poblados",
    visible:false,
    // Contorno blanco delgado y fino, sin relleno
    renderer:new SimpleRenderer({
      symbol: new SimpleFillSymbol({
        color: [0,0,0,0],
        outline: new SimpleLineSymbol({
          color: [255,255,255,1],
          width: 1.2,
          style: "short-dot"
        })
      })
    })
  });

  /* === CCPP puntos === */
  const lyrCPGrado = new FeatureLayer({
    url: CP_LAYER,
    title:"Centro poblado (puntos / por grado)",
    visible:false,
    legendEnabled:false,
    minScale: 120000,
    renderer:new SimpleRenderer({ symbol: mk([200,200,200,0.95], 6.5) })
  });

  /* === L√≠mite departamental (base) === */
  const limDeptDraw = new FeatureLayer({
    url:LIM0, title:"L√≠mite Departamental (base)",
    visible:true,
    renderer:new SimpleRenderer({ symbol:{
      type:"cim", data:{ type:"CIMSymbolReference",
        symbol:{ type:"CIMLineSymbol", symbolLayers:[
          { type:"CIMSolidStroke", enable:true, width:2.4, color:[255,255,255,120] },
          { type:"CIMSolidStroke", enable:true, width:0.8, color:[0,0,0,180] }
        ] } }
    }}),
    blendMode:"normal"
  });

  /* === HEATMAP CCPP (visible al inicio) === */
  const lyrCPHeat = new FeatureLayer({
    url: CP_LAYER,
    title: "Heatmap de centros poblados",
    visible: true,
    legendEnabled: false,
    renderer: new HeatmapRenderer({
      blurRadius: 1.4, minDensity: 0.22, maxDensity: 0.82,
      colorStops: [
        { ratio: 0.00, color: [255, 214, 235, 0.00] },
        { ratio: 0.50, color: [255, 153, 204, 0.90] },
        { ratio: 1.00, color: [255,  77, 166, 1.00] }
      ]
    })
  });

  function applyScaleAdaptiveHeat(){
    const s = view.scale || 1e7;
    let blur, minD, maxD;
    if (s > 5_000_000) { blur = 1.1;  minD = 0.26; maxD = 0.92; }
    else if (s > 2_000_000){ blur = 1.6;  minD = 0.22; maxD = 0.82; }
    else if (s > 900_000){  blur = 2.2;  minD = 0.14; maxD = 0.64; }
    else {                   blur = 3.0;  minD = 0.10; maxD = 0.50; }
    const r = lyrCPHeat.renderer.clone ? lyrCPHeat.renderer.clone() : new HeatmapRenderer(lyrCPHeat.renderer);
    r.blurRadius = blur; r.minDensity = minD; r.maxDensity = maxD; lyrCPHeat.renderer = r;
  }

  /* === DATASS + Viviendas === */
  const lyrRedes   = new FeatureLayer({ url:`${CCPP}/3`, title:"Redes - DATASS",      visible:false, minScale:1500000, renderer:new SimpleRenderer({ symbol: line([95,210,255,0.95],1.4) }) });
  const lyrReserv  = new FeatureLayer({ url:`${CCPP}/2`, title:"Reservorio - DATASS", visible:false, minScale:1500000, renderer:new SimpleRenderer({ symbol: mk([46,204,64,0.95], 8) }) });
  const lyrCapt    = new FeatureLayer({ url:`${CCPP}/1`, title:"Captaci√≥n - DATASS",  visible:false, minScale:1500000, renderer:new SimpleRenderer({ symbol: mk([52,152,219,0.95], 8) }) });
  const lyrPTAP    = new FeatureLayer({ url:`${CCPP}/0`, title:"PTAP - DATASS",       visible:false, minScale:1500000, renderer:new SimpleRenderer({ symbol: mk([231,76,60,0.95], 7.5) }) });

  const grpDATASS = new GroupLayer({
    title: "Componentes DATASS",
    visible:false,
    visibilityMode: "independent",
    layers: [lyrPTAP, lyrCapt, lyrReserv, lyrRedes]
  });

  const lyrVivSinDato   = new FeatureLayer({ url:`${VR_URL}/6`, title:"Viviendas rurales (sin dato de acceso)", visible:false,  minScale:900000, renderer:new SimpleRenderer({ symbol: mkSolid([160,160,160,1], 4.8) }) });
  const lyrVivConAcceso = new FeatureLayer({ url:`${VR_URL}/1`, title:"Viviendas rurales (con acceso)",        visible:false,  minScale:900000, renderer:new SimpleRenderer({ symbol: mkSolid([30,110,182,1], 4.8) }) });
  const lyrVivSinAcceso = new FeatureLayer({ url:`${VR_URL}/2`, title:"Viviendas rurales (sin acceso)",        visible:false,  minScale:900000, renderer:new SimpleRenderer({ symbol: mkSolid([220,53,69,1], 4.8) }) });

  /* === L√çMITES resaltados (prov/dist) === */
  const glowCIM = (rgb=[255,255,255]) => ({
    type:"cim",
    data:{ type:"CIMSymbolReference",
      symbol:{ type:"CIMLineSymbol",
        symbolLayers:[
          { type:"CIMSolidStroke", enable:true, width:6,   color:[...rgb,40]  },
          { type:"CIMSolidStroke", enable:true, width:3,   color:[...rgb,120] },
          { type:"CIMSolidStroke", enable:true, width:1.6, color:[...rgb,255] }
        ] } }
  });
  const limProvDraw = new FeatureLayer({ url:LIM1, title:"L√≠mite Provincial", visible:false, renderer:new SimpleRenderer({ symbol:glowCIM([255,215,0]) }), blendMode:"screen" });
  const limDistDraw = new FeatureLayer({ url:LIM2, title:"L√≠mite Distrital",  visible:false, renderer:new SimpleRenderer({ symbol:glowCIM([255,105,180]) }), blendMode:"screen" });

  /* ORDEN DE DIBUJO */
  map.addMany([
    limDeptDraw,
    lyrAreasAgrup, lyrAmbito,
    lyrCPHeat,
    grpDATASS,
    lyrVivSinDato, lyrVivConAcceso, lyrVivSinAcceso,
    lyrCPGrado,
    limProvDraw, limDistDraw
  ]);

  /* === Leyenda (sin heatmap) === */
  const legend = new Legend({
    view,
    container:"legendNode",
    layerInfos: [
      { layer: lyrAreasAgrup, title: "√Åreas agrupadas (densidad y viviendas)" },
      { layer: lyrAmbito, title: "√Åmbito territorial de centros poblados" },
      { layer: lyrVivConAcceso, title: "Viviendas (con acceso)" },
      { layer: lyrVivSinAcceso, title: "Viviendas (sin acceso)" },
      { layer: lyrVivSinDato, title: "Viviendas (sin dato)" },
      { layer: lyrCPGrado, title: "CCPP por grado (filtro activo)" },
      { layer: limDeptDraw, title: "L√≠mite Departamental" },
      { layer: limProvDraw, title: "L√≠mite Provincial" },
      { layer: limDistDraw, title: "L√≠mite Distrital" }
    ]
  });

  new LayerList({ view, container:"layerListNode", listItemCreatedFunction:(e)=>{ e.item.panel={ content:"legend", open:false }; }});

  /* === Fuentes auxiliares === */
  const cpLayer = lyrAmbito; let layerView, hl;
  view.whenLayerView(cpLayer).then(lv=> layerView = lv);

  const limDeptSrc = new FeatureLayer({ url:LIM0, outFields:["id_dpto","nom_dep"], listMode:"hide" });
  const limProvSrc = new FeatureLayer({ url:LIM1, outFields:["id_dep","id_prov","nom_prov"], listMode:"hide" });
  const limDistSrc = new FeatureLayer({ url:LIM2, outFields:["id_dpto","id_prov","id_dist","nom_dist"], listMode:"hide" });
  const cpSrc      = new FeatureLayer({ url:CP_LAYER, outFields:["nom_ccpp","ubigeo"], listMode:"hide" });

  /* === UI DOM === */
  const $list=qs('#cpList');
  const $selDep=qs('#selDep');
  const $selProv=qs('#selProv');
  const $selDist=qs('#selDist');
  const $selCP=qs('#selCP');
  const $btnClear=qs('#btnClear');
  const $btnExcel=qs('#btnExcel');
  const $chipList=qs('#chipList');

  const selectedCats=new Set();
  let initialViewpoint=null; view.when(()=>{ initialViewpoint=view.viewpoint.clone(); });

  /* ===== Visibilidad por escala/selecci√≥n ===== */
  const PROV_VIS_SCALE = 1500000;
  const DIST_VIS_SCALE = 120000;

  function updateVisibilityByScaleAndSelection(){
    const provSelected = !!$selProv.value.trim();
    const provincial = provSelected || (view.scale <= PROV_VIS_SCALE);

    lyrAreasAgrup.visible = provincial;
    lyrAmbito.visible     = provincial;

    lyrVivConAcceso.visible = provincial;
    lyrVivSinAcceso.visible = provincial;
    lyrVivSinDato.visible   = provincial;
    grpDATASS.visible       = provincial;

    lyrCPHeat.visible      = !provincial;

    const distSelected = !!$selDist.value.trim() || !!$selCP.value.trim();
    lyrCPGrado.visible = distSelected || (view.scale <= DIST_VIS_SCALE);
  }

  view.watch('scale', ()=>{ applyScaleAdaptiveHeat(); updateVisibilityByScaleAndSelection(); });
  view.when(updateVisibilityByScaleAndSelection);

  /* ===== L√≠mites resaltados seg√∫n selecci√≥n ===== */
  async function updatePoliticalLimitVisibility(){
    const dep=$selDep.value.trim();
    const prov=$selProv.value.trim();
    const dist=$selDist.value.trim();

    limProvDraw.visible=false; limProvDraw.definitionExpression=null;
    limDistDraw.visible=false; limDistDraw.definitionExpression=null;

    if(dist){ limDistDraw.definitionExpression = `id_dist='${esc(dist)}'`; limDistDraw.visible=true; }
    else if(prov){ limProvDraw.definitionExpression = `id_prov='${esc(prov)}'`; limProvDraw.visible=true; }

    updateVisibilityByScaleAndSelection();
  }

  async function zoomToPolitical(){
    let src=null, where=null;
    const dist=$selDist.value.trim();
    const prov=$selProv.value.trim();
    const dep =$selDep.value.trim();

    if(dist){ src=limDistSrc; where=`id_dist='${esc(dist)}'`; }
    else if(prov){ src=limProvSrc; where=`id_prov='${esc(prov)}'`; }
    else if(dep){ src=limDeptSrc; where=`id_dpto='${esc(dep)}'`; }
    else{
      if(initialViewpoint){ try{ await view.goTo(initialViewpoint,{ duration:700 }); }catch(_){ } }
      return;
    }
    const q=src.createQuery(); q.where=where; q.returnGeometry=true; q.outFields=[]; q.num=1;
    const r=await src.queryFeatures(q);
    const g=r.features?.[0]?.geometry; if(!g) return;
    try{ await view.goTo({ target:g, padding:{ left:50,right:50,top:70,bottom:60 } }, { duration:700, easing:"ease-in-out" }); }catch(_){}
  }

  /* ===== Combos ===== */
  async function loadDeps(){
    const q=limDeptSrc.createQuery();
    q.where="1=1"; q.returnGeometry=false; q.outFields=["id_dpto","nom_dep"]; q.orderByFields=["nom_dep ASC"]; q.num=300; q.cacheHint=true;
    const r=await limDeptSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{ const id=f.attributes?.id_dpto, name=f.attributes?.nom_dep; if(id && !seen.has(id)){ seen.add(id); rows.push({id,name}); }});
    $selDep.innerHTML = `<option value="">(Todos)</option>` + rows.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
    $selProv.innerHTML=`<option value="">(Todas)</option>`; $selProv.disabled=true;
    $selDist.innerHTML=`<option value="">(Todos)</option>`; $selDist.disabled=true;
    $selCP.innerHTML  =`<option value="">(Todos)</option>`; $selCP.disabled=true;
  }
  async function loadProvs(){
    const dep=$selDep.value.trim();
    $selProv.innerHTML=`<option value="">(Todas)</option>`;
    $selDist.innerHTML=`<option value="">(Todos)</option>`; $selDist.disabled=true;
    $selCP.innerHTML  =`<option value="">(Todos)</option>`; $selCP.disabled=true;
    if(!dep){ $selProv.disabled=true; return; }
    const q=limProvSrc.createQuery();
    q.where=`id_dep='${esc(dep)}'`; q.returnGeometry=false; q.outFields=["id_prov","nom_prov"]; q.orderByFields=["nom_prov ASC"]; q.num=1000; q.cacheHint=true;
    const r=await limProvSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{ const id=f.attributes?.id_prov, name=f.attributes?.nom_prov; if(id && !seen.has(id)){ seen.add(id); rows.push({id,name}); }});
    $selProv.innerHTML += rows.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
    $selProv.disabled=false;
  }
  async function loadDists(){
    const prov=$selProv.value.trim();
    $selDist.innerHTML=`<option value="">(Todos)</option>`;
    $selCP.innerHTML  =`<option value="">(Todos)</option>`; $selCP.disabled=true;
    if(!prov){ $selDist.disabled=true; return; }
    const q=limDistSrc.createQuery();
    q.where=`id_prov='${esc(prov)}'`; q.returnGeometry=false; q.outFields=["id_dist","nom_dist"]; q.orderByFields=["nom_dist ASC"]; q.num=3000; q.cacheHint=true;
    const r=await limDistSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{ const id=f.attributes?.id_dist, name=f.attributes?.nom_dist; if(id && !seen.has(id)){ seen.add(id); rows.push({id,name}); }});
    $selDist.innerHTML += rows.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
    $selDist.disabled=false;
  }
  async function loadCPs(){
    const distId=$selDist.value.trim();
    $selCP.innerHTML=`<option value="">(Todos)</option>`;
    if(!distId){ $selCP.disabled=true; return; }
    const q=cpSrc.createQuery();
    q.where=`ubigeo='${esc(distId)}'`; q.returnGeometry=false; q.outFields=["nom_ccpp","ubigeo"]; q.orderByFields=["nom_ccpp ASC"]; q.num=5000; q.cacheHint=true;
    const r=await cpSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{ const name=f.attributes?.nom_ccpp, u=f.attributes?.ubigeo; if(name && u && !seen.has(name)){ seen.add(name); rows.push({ name, ubigeo:u }); }});
    $selCP.innerHTML += rows.map(o=>`<option value="${o.ubigeo}::${o.name.replace(/"/g,'&quot;')}">${o.name}</option>`).join("");
    $selCP.disabled = rows.length===0;
  }

  function parseCPValue(){ const v=$selCP.value.trim(); if(!v) return null; const [u,...nameParts]=v.split("::"); return {ubigeo:u,name:nameParts.join("::")}; }

  /* ===== Categor√≠as en puntos ===== */
  function buildCategoryRenderer(categories){
    const infos = categories.map((cat, i)=>({
      value: cat,
      label: cat,
      symbol: mk(CAT_PALETTE[i % CAT_PALETTE.length], 9.5)
    }));
    return new UniqueValueRenderer({
      field: "categ_cp",
      defaultSymbol: mk([160,160,160,0.9],7),
      uniqueValueInfos: infos
    });
  }

  /* ===== WHERE builders ===== */
  function buildWhereForAmbito(includeCats=true){
    const dep=$selDep.value.trim(), prov=$selProv.value.trim(), dist=$selDist.value.trim();
    const cpSel = parseCPValue(); const parts=["1=1"];
    if(dep)  parts.push(`id_dpto='${esc(dep)}'`);
    if(prov) parts.push(`id_prov='${esc(prov)}'`);
    if(dist) parts.push(`id_dist='${esc(dist)}'`);
    if(cpSel && cpSel.name) parts.push(`nom_cp='${esc(cpSel.name)}'`);
    if(includeCats && selectedCats.size>0){ const vals=[...selectedCats].map(s=>`'${esc(s)}'`).join(","); parts.push(`categoria_cp IN (${vals})`); }
    return parts.join(" AND ");
  }
  function buildWhereForPuntos(includeCats=true){
    const dep=$selDep.value.trim(), prov=$selProv.value.trim(), dist=$selDist.value.trim();
    const cpSel = parseCPValue(); const parts=["1=1"];
    if(dep)  parts.push(`SUBSTRING(ubigeo,1,2)='${esc(dep)}'`);
    if(prov) parts.push(`SUBSTRING(ubigeo,1,4)='${esc(prov)}'`);
    if(dist) parts.push(`ubigeo='${esc(dist)}'`);
    if(cpSel && cpSel.name) parts.push(`nom_ccpp='${esc(cpSel.name)}'`);
    if(includeCats && selectedCats.size>0){ const vals=[...selectedCats].map(s=>`'${esc(s)}'`).join(","); parts.push(`categ_cp IN (${vals})`); }
    return parts.join(" AND ");
  }

  /* ===== Estado URL ===== */
  function updateHashFromState(){
    const dep=$selDep.value||"", prov=$selProv.value||"", dist=$selDist.value||"", cp=$selCP.value||"";
    const cats=[...selectedCats].map(encodeURIComponent).join(",");
    const obj={dep,prov,dist,cp,cats};
    const hash = Object.entries(obj).map(([k,v])=>`${k}=${encodeURIComponent(v)}`).join("&");
    if(location.hash.slice(1)!==hash){ history.replaceState(null,"","#"+hash); }
  }
  function applyStateFromHash(){
    if(!location.hash) return null;
    const params = new URLSearchParams(location.hash.slice(1));
    const dep=params.get("dep")||"", prov=params.get("prov")||"", dist=params.get("dist")||"", cp=params.get("cp")||"", cats=params.get("cats")||"";
    return {dep,prov,dist,cp,cats:cats.split(",").filter(Boolean).map(decodeURIComponent)};
  }

  /* ===== Aplicar filtros ===== */
  function applyMapFilters(){
    const whereAmb = buildWhereForAmbito(true);
    const wherePts = buildWhereForPuntos(true);

    const needRefreshAmb = lyrAmbito.definitionExpression !== whereAmb;
    const needRefreshPts = (lyrCPGrado.definitionExpression !== wherePts) || (lyrCPHeat.definitionExpression !== wherePts);

    lyrAmbito.definitionExpression = whereAmb;
    lyrCPGrado.definitionExpression = wherePts;
    lyrCPHeat.definitionExpression  = wherePts;

    if(selectedCats.size>0){
      const cats = [...selectedCats];
      lyrCPGrado.renderer = buildCategoryRenderer(cats);
      lyrCPGrado.legendEnabled = true;
    }else{
      lyrCPGrado.renderer = new SimpleRenderer({ symbol: mk([200,200,200,0.95], 6.5) });
      lyrCPGrado.legendEnabled = false;
    }

    if(needRefreshAmb) lyrAmbito.refresh();
    if(needRefreshPts){ lyrCPGrado.refresh(); lyrCPHeat.refresh(); }

    updateVisibilityByScaleAndSelection();
    updateHashFromState();
  }
  const applyMapFiltersDebounced = debounce(applyMapFilters, 150);

  /* ===== Lista sobre √Åmbito ===== */
  let lastListFeatures = [];
  async function cargarLista(){
    const q=lyrAmbito.createQuery();
    q.where=buildWhereForAmbito(true);
    q.outFields=["objectid","nom_cp","categoria_cp","vivrur_tot","vivrur_agrup_p","sum_pobcensa","distnear_max","distnear_min"];
    q.returnGeometry=false; q.num=5000; q.orderByFields=["nom_cp ASC"]; q.cacheHint=true;
    const res=await lyrAmbito.queryFeatures(q);
    lastListFeatures = (res.features||[]).map(f=>f.attributes||{});
    pintarLista(lastListFeatures);
  }
  function pintarLista(rows){
    if(hl){ hl.remove(); hl=null; }
    if(!rows.length){ $list.innerHTML=`<div class="empty">Sin resultados</div>`; return; }
    $list.innerHTML = rows.map(a=>`
      <div class="item" data-oid="${a.objectid}" tabindex="0">
        <div class="title">${a.nom_cp ?? "‚Äî"} (${a.categoria_cp ?? "‚Äî"})</div>
        <div class="kv"><b>Vivienda rural total:</b> ${fmt(a.vivrur_tot)}</div>
        <div class="kv"><b>Vivienda rural concentrado:</b> ${fmt(a.vivrur_agrup_p,1)} %</div>
        <div class="kv"><b>Poblaci√≥n rural:</b> ${fmt(a.sum_pobcensa)}</div>
        <div class="kv"><b>Distancia m√°x. entre viv.:</b> ${fmt(a.distnear_max,2)} m</div>
        <div class="kv"><b>Distancia m√≠n. entre viv.:</b> ${fmt(a.distnear_min,2)} m</div>
      </div>`).join("");

    $list.querySelectorAll(".item").forEach(el=>{
      const go = async ()=>{
        const oid=Number(el.dataset.oid);
        if(layerView){ if(hl) hl.remove(); hl=layerView.highlight(oid); }
        await flyToFeatureByOID(oid);
      };
      el.addEventListener("click", go);
      el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); go(); }});
    });
  }
  async function flyToFeatureByOID(oid){
    const q=lyrAmbito.createQuery(); q.objectIds=[oid]; q.outFields=[]; q.returnGeometry=true;
    const r=await lyrAmbito.queryFeatures(q);
    const feat=r.features?.[0]; if(!feat) return;
    const geom=feat.geometry; const ext=geom.extent;
    try{
      if(ext && !ext.isEmpty){ await view.goTo({ target: ext.expand(1.7), padding:{ left:120,right:120,top:200,bottom:110 } }, { duration:900, easing:"ease-in-out" }); }
      else{ await view.goTo({ center: geom.centroid, scale:18000 }, { duration:900, easing:"ease-in-out" }); }
      const guideLayer = ensureGuideLayer(); flashGraphic(ext ? ext.center : geom, guideLayer);
    }catch(_){}
  }
  function ensureGuideLayer(){ if(!window.__guide){ window.__guide = new GraphicsLayer({ listMode:"hide" }); map.add(window.__guide); } return window.__guide; }
  function flashGraphic(geometry, guideLayer){
    const g=new Graphic({ geometry, symbol:new SimpleMarkerSymbol({ style:"circle", size:16, color:[255,255,255,0], outline:{ color:[255,230,0,1], width:2.2 } }) });
    guideLayer.removeAll(); guideLayer.add(g);
    let i=0; const int=setInterval(()=>{ const o=(i%2===0)?1:0.08; g.symbol.outline.color.a=o; guideLayer.refresh(); if(++i>10){ clearInterval(int); }},200);
  }

  /* ===== Chips ===== */
  async function refreshCategoryChips(){
    const q=lyrAmbito.createQuery();
    q.where=buildWhereForAmbito(false);
    q.returnGeometry=false; q.outFields=["categoria_cp"]; q.returnDistinctValues=true; q.orderByFields=["categoria_cp ASC"]; q.num=1000;
    const res=await lyrAmbito.queryFeatures(q);
    const values=(res.features||[]).map(f=>f.attributes?.["categoria_cp"]).filter(v=>v!=null && String(v).trim()!=="");
    const uniq=[...new Set(values)];
    [...selectedCats].forEach(c=>{ if(!uniq.includes(c)) selectedCats.delete(c); });
    $chipList.innerHTML = uniq.map(v=>{
      const active = selectedCats.has(v);
      return `<button type="button" class="chip ${active?"on":""}" data-val="${v.replace(/"/g,'&quot;')}" aria-pressed="${active}" aria-label="Filtrar por ${v}" tabindex="0">${v}</button>`;
    }).join("");
    $chipList.querySelectorAll(".chip").forEach(btn=>{
      const toggleChip = async ()=>{
        const val=btn.dataset.val;
        if(selectedCats.has(val)){ selectedCats.delete(val); btn.classList.remove("on"); btn.setAttribute("aria-pressed","false"); }
        else{ selectedCats.add(val); btn.classList.add("on"); btn.setAttribute("aria-pressed","true"); }
        await cargarLista(); applyMapFiltersDebounced();
      };
      btn.addEventListener("click", toggleChip);
      btn.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleChip(); }});
    });
  }

  /* ===== Tooltip √Åreas agrupadas por CLICK ===== */
  const $tt = document.getElementById('ttAreas');
  let lvAreas = null, hlArea = null, lastAreasOid = null, lastAreasAttrs = null;
  view.whenLayerView(lyrAreasAgrup).then(lv => { lvAreas = lv; });

  const garbageRx = /(shape|objectid|globalid|fid|geom|extent|bbox|shape_area|shape_length|st_area|st_length|gridcode|gridcorde|gridcord|__)/i;

  function prettyLabel(field){
    const base = (field.alias && field.alias !== field.name) ? field.alias : (field.name || "");
    let lbl = base.replace(/_/g," ").trim();
    lbl = lbl
      .replace(/\bcp\b/gi,"Centro poblado")
      .replace(/\bvivrur\b/gi,"Viviendas rurales")
      .replace(/\bcateg?\b/gi,"Categor√≠a")
      .replace(/\bpob\b/gi,"Poblaci√≥n")
      .replace(/\bsum\b/gi,"Total")
      .replace(/\btot\b/gi,"Total")
      .replace(/\bporc\b/gi,"Porcentaje")
      .replace(/\bkm2\b/gi,"km¬≤");
    return lbl.charAt(0).toUpperCase() + lbl.slice(1);
  }
  function decodeDomain(field, value){
    const dom = field?.domain?.codedValues;
    if(dom && dom.length){ const m = dom.find(cv => cv.code === value); return m ? m.name : value; }
    return value;
  }
  function fmtVal(field, value){
    if(value == null) return "‚Äî";
    if(field?.type === "date"){
      try{ return new Intl.DateTimeFormat("es-PE").format(new Date(value)); }catch(_){ return "‚Äî"; }
    }
    if(typeof value === "number"){
      const isPct = /(porc|porcentaje|_p$|percent)/i.test(field.name) || /(porc|porcentaje)/i.test(field.alias||"");
      const digits = isPct ? 1 : 2;
      return new Intl.NumberFormat("es-PE",{ maximumFractionDigits:digits }).format(value) + (isPct ? " %" : "");
    }
    return String(value);
  }
  function bestTitle(attrs, fields){
    const nameField = fields.find(f => /^(nom|nombre|name|titulo|title)/i.test(f.name));
    return (nameField && attrs[nameField.name]) ? attrs[nameField.name] : "√Årea agrupada";
  }
  async function fetchFullAttrsIfNeeded(graphic){
    const attrs = graphic.attributes || {};
    const oidField = lyrAreasAgrup.objectIdField;
    const oid = attrs?.[oidField];
    if(oid && lastAreasOid === oid && lastAreasAttrs) return lastAreasAttrs;
    if(!oid || Object.keys(attrs).length > 3) return attrs;
    try{
      const q = lyrAreasAgrup.createQuery();
      q.objectIds = [oid]; q.outFields = ["*"]; q.returnGeometry = false;
      const r = await lyrAreasAgrup.queryFeatures(q);
      const full = r.features?.[0]?.attributes || attrs;
      lastAreasOid = oid; lastAreasAttrs = full;
      return full;
    }catch(_){ return attrs; }
  }
  function buildTooltipHTML(attrs){
    const fields = (lyrAreasAgrup.fields || []).filter(f => !garbageRx.test(f.name) && !garbageRx.test(f.alias || ""));
    const title = bestTitle(attrs, fields);
    const rows = fields.map(f => {
      const raw = attrs[f.name];
      const val = decodeDomain(f, raw);
      return `<div class="entry"><span class="k">${prettyLabel(f)}</span><span class="v">${fmtVal(f, val)}</span></div>`;
    }).join("");
    return `<div class="hdr"><span class="dot" aria-hidden="true"></span><div class="title">${title}</div></div><div class="list">${rows}</div>`;
  }
  function showTooltipAt(x, y, html){
    $tt.innerHTML = html;
    $tt.classList.remove("hidden");
    const pad = 14;
    let left = x + pad, top = y + pad;
    const vw = window.innerWidth, vh = window.innerHeight;
    const r = $tt.getBoundingClientRect();
    if (left + r.width > vw - 8) left = x - r.width - pad;
    if (top + r.height > vh - 8) top = y - r.height - pad;
    $tt.style.left = left + "px";
    $tt.style.top  = top  + "px";
  }
  function hideTooltip(){ $tt.classList.add("hidden"); }

  // Mostrar/ocultar por CLICK
  view.on("click", async (evt) => {
    const { x, y, mapPoint } = evt;
    try{
      const hit = await view.hitTest({ x, y }, { include: lyrAreasAgrup });
      const g = hit?.results?.[0]?.graphic;
      if(g){
        if(lvAreas){
          if(hlArea){ try{ hlArea.remove(); }catch(_){ } hlArea = null; }
          try{ hlArea = lvAreas.highlight(g); }catch(_){}
        }
        const fullAttrs = await fetchFullAttrsIfNeeded(g);
        showTooltipAt(x, y, buildTooltipHTML(fullAttrs));
      }else{
        if(hlArea){ try{ hlArea.remove(); }catch(_){ } hlArea = null; }
        hideTooltip();
      }
    }catch(_){
      hideTooltip();
    }
  });

  /* ===== Manejadores ===== */
  const onDepChange  = debounce(async ()=>{ await loadProvs(); await refreshCategoryChips(); await cargarLista(); applyMapFilters(); await updatePoliticalLimitVisibility(); await zoomToPolitical(); }, 80);
  const onProvChange = debounce(async ()=>{ await loadDists(); await refreshCategoryChips(); await cargarLista(); applyMapFilters(); await updatePoliticalLimitVisibility(); await zoomToPolitical(); }, 80);
  const onDistChange = debounce(async ()=>{ await loadCPs();  await refreshCategoryChips(); await cargarLista(); applyMapFilters(); await updatePoliticalLimitVisibility(); await zoomToPolitical(); }, 80);
  $selDep.addEventListener('change', onDepChange);
  $selProv.addEventListener('change', onProvChange);
  $selDist.addEventListener('change', onDistChange);

  $selCP.addEventListener('change', async ()=>{
    await refreshCategoryChips(); await cargarLista(); applyMapFiltersDebounced();
    const v=$selCP.value.trim();
    if(!v){ await updatePoliticalLimitVisibility(); await zoomToPolitical(); return; }
    const [ubg, ...nameParts]=v.split("::"); const name=nameParts.join("::");

    const q=lyrCPGrado.createQuery();
    q.where=`ubigeo='${esc(ubg)}' AND nom_ccpp='${esc(name)}'`;
    q.returnGeometry=true; q.outFields=[]; q.num=1;
    const r=await lyrCPGrado.queryFeatures(q);
    const feat=r.features?.[0]; if(!feat){ await updatePoliticalLimitVisibility(); await zoomToPolitical(); return; }

    const dist=ubg.slice(0,6); $selDist.value = dist;
    updateVisibilityByScaleAndSelection();

    try{
      await view.goTo({ target: feat.geometry, scale: 16000 }, { duration:800, easing:"ease-in-out" });
      const guideLayer = ensureGuideLayer(); flashGraphic(feat.geometry, guideLayer);
    }catch(_){}
  });

  $btnClear.addEventListener('click', async ()=>{
    $selDep.value="";
    $selProv.innerHTML=`<option value="">(Todas)</option>`; $selProv.disabled=true;
    $selDist.innerHTML=`<option value="">(Todos)</option>`; $selDist.disabled=true;
    $selCP.innerHTML  =`<option value="">(Todos)</option>`; $selCP.disabled=true;
    selectedCats.clear();

    if (typeof hl !== 'undefined' && hl){ hl.remove(); hl=null; }
    if (window.__guide){ window.__guide.removeAll(); }

    limProvDraw.visible = false; limProvDraw.definitionExpression = null;
    limDistDraw.visible = false; limDistDraw.definitionExpression = null;

    await refreshCategoryChips();
    await cargarLista();
    applyMapFilters();
    updateVisibilityByScaleAndSelection();
    await updatePoliticalLimitVisibility();

    if(initialViewpoint){ try{ await view.goTo(initialViewpoint, { duration:700 }); }catch(_){ } }
    hideTooltip();
    if(hlArea){ try{ hlArea.remove(); }catch(_){ } hlArea = null; }
  });

  /* ===== Exportar Excel (.xls compatible) ===== */
  function exportExcel(){
    if(!lastListFeatures.length){ showToast("‚ÑπÔ∏è No hay datos para exportar"); return; }
    const headers = [
      {k:"nom_cp", t:"Centro poblado"},
      {k:"categoria_cp", t:"Categor√≠a"},
      {k:"vivrur_tot", t:"Viviendas rurales (tot.)"},
      {k:"vivrur_agrup_p", t:"Vivienda rural concentrado (%)"},
      {k:"sum_pobcensa", t:"Poblaci√≥n rural"},
      {k:"distnear_max", t:"Distancia m√°x. (m)"},
      {k:"distnear_min", t:"Distancia m√≠n. (m)"}
    ];
    const th = headers.map(h=>`<th style="background:#e2f6ef;border:1px solid #cfe7e3;padding:6px 8px;text-align:left;font-weight:bold">${h.t}</th>`).join("");
    const tr = lastListFeatures.map(a=>{
      return "<tr>" + headers.map(h=>{
        const v = (a[h.k] ?? "");
        return `<td style="border:1px solid #e5e7eb;padding:6px 8px">${v}</td>`;
      }).join("") + "</tr>";
    }).join("");

    const html = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns="http://www.w3.org/TR/REC-html40">
      <head><meta charset="utf-8"/></head>
      <body>
        <table>
          <thead><tr>${th}</tr></thead>
          <tbody>${tr}</tbody>
        </table>
      </body></html>`;

    const blob = new Blob([html], {type:"application/vnd.ms-excel"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
    a.href=url; a.download=`ccpp_dispersos_${ts}.xls`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
    showToast("üìä Excel exportado");
  }
  $btnExcel.addEventListener('click', exportExcel);

  /* ===== Atajos ===== */
  window.addEventListener('keydown', (e)=>{
    if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='SELECT' || e.target.isContentEditable)) return;
    if(e.key.toLowerCase()==='l'){ e.preventDefault(); toggle('#bubbleLayers'); }
    if(e.key.toLowerCase()==='j'){ e.preventDefault(); toggle('#bubbleLegend'); }
    if(e.key.toLowerCase()==='c'){ e.preventDefault(); $btnClear.click(); }
  });

  /* ===== Init ===== */
  (async function init(){
    await loadDeps();
    const state = applyStateFromHash();
    if(state){
      if(state.dep){ $selDep.value=state.dep; await loadProvs(); }
      if(state.prov){ $selProv.value=state.prov; await loadDists(); }
      if(state.dist){ $selDist.value=state.dist; await loadCPs(); }
      if(state.cp){ $selCP.value=state.cp; }
      state.cats.forEach(c=>selectedCats.add(c));
    }
    await refreshCategoryChips();
    await cargarLista();
    applyMapFilters();
    updateVisibilityByScaleAndSelection();
    await updatePoliticalLimitVisibility();
  })();

});
</script>
</body>
</html>
