<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Grado de dispersi√≥n de centros poblados - PNSR</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.30/"></script>

<style>
  :root{
    --ink:#0b2532; --muted:#64748b; --line:#0e4a43; --panel:#f7fbfa;
    --brand:#0b3b38; --accent:#0f2e29; --sep:#e6ecea;
  }
  html,body{height:100%;margin:0;background:#eef5f3;color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  body{display:grid;grid-template-rows:auto 1fr;overflow:hidden}

  .mainTitleBar{
    width:100%; background:#fff; border-bottom:1px solid var(--sep);
    box-shadow:0 2px 6px rgba(0,0,0,.08); padding:12px 10px;
    position:sticky; top:0; z-index:20;
  }
  .mainTitle{margin:0;text-align:center;font-weight:1000;
    font-size:clamp(22px, 3.6vh, 30px); color:var(--brand); letter-spacing:.3px;}

  .shell{display:grid;grid-template-columns:65% 35%;height:100%;width:100%;overflow:hidden}
  #viewWrap{position:relative;height:100%;overflow:hidden}
  #viewDiv{position:relative;width:100%;height:100%}

  .sidebar{
    background:var(--panel); border-left:1px solid var(--sep);
    box-shadow:-6px 0 24px rgba(2,6,23,.06); padding:14px 12px;
    display:grid; grid-template-rows:auto auto 1fr; gap:12px; min-height:0;
  }

  /* ====== BARRA DE FILTROS (los 4 arriba) ====== */
  .filtersBar{background:#fff;border:1px solid var(--sep);border-radius:16px;
    box-shadow:0 10px 22px rgba(2,6,23,.06);padding:12px;display:grid;gap:10px}
  .filtersGrid{
    display:grid;gap:10px;align-items:end; /* evita saltos */
    grid-template-columns:1fr; /* m√≥vil: 1 por fila */
  }
  @media (min-width:560px){.filtersGrid{grid-template-columns:1fr 1fr}}
  @media (min-width:820px){.filtersGrid{grid-template-columns:1fr 1fr 1fr}}
  @media (min-width:1040px){.filtersGrid{grid-template-columns:1fr 1fr 1fr 1fr}} /* 4 columnas */
  .fld{display:grid;gap:6px;min-width:0}
  .fld label{font-size:12px;color:#47606b;font-weight:900;letter-spacing:.2px}
  .fld select{
    padding:10px 12px;border:1px solid #cfe7e3;border-radius:12px;background:#e8f5f3;
    color:#0b3b38;font-weight:800;font-size:13.5px;outline:none;width:100%;
    min-width:0; /* permite encoger dentro del grid */
    text-overflow:ellipsis;white-space:nowrap;overflow:hidden; /* nombres largos con ‚Ä¶ */
    -webkit-appearance:none;appearance:none;
  }
  .fld select:disabled{opacity:.6}
  .rowBtns{display:flex;justify-content:flex-end}
  .btn{background:#0b3b38;color:#ecfffb;border:1px solid #0e4a43;
    padding:9px 14px;border-radius:12px;font-weight:900;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}

  /* ====== Tarjetas inferiores ====== */
  .lowerGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;min-height:0}
  @media (max-width:900px){.shell{grid-template-columns:1fr}
    #viewWrap{height:54vh}}
  @media (max-width:900px){.lowerGrid{grid-template-columns:1fr}}

  .listCard{background:#fff;border:1px solid var(--sep);border-radius:16px;
    box-shadow:0 10px 24px rgba(2,6,23,.06);overflow:hidden;display:grid;
    grid-template-rows:auto 1fr;min-height:0}
  .listCard header{padding:10px 12px;background:#fff;border-bottom:1px solid var(--sep)}
  .listCard h3{margin:0;font-size:14px;font-weight:1000;color:var(--brand);letter-spacing:.2px}
  .list{overflow:auto;min-height:0}
  .item{padding:10px 12px;border-bottom:1px solid #edf2f7;cursor:pointer;transition:background .15s ease}
  .item:hover{background:#f5faf8}
  .title{font-weight:900;font-size:13.8px}
  .kv{font-size:12.2px;color:#334155;line-height:1.35}
  .kv b{color:#0b2532}
  .empty{padding:16px;text-align:center;color:#64748b;font-size:12.8px}
  .commentWrap{padding:12px;overflow:auto;display:grid;gap:10px;align-content:start}
  .commentWrap p{margin:0;font-size:13.6px;color:#243b41}
  .commentImg{width:70%;max-width:220px;height:auto;border-radius:12px;border:1px solid #e3ecea;justify-self:center;display:block}

  /* Botones flotantes y burbujas */
  .fab-wrap{position:absolute;right:14px;top:14px;display:flex;flex-direction:column;gap:10px;z-index:7}
  .fab{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:var(--brand);
    color:#e6fffb;border:1px solid #0e4a43;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.22);font-weight:900;user-select:none}
  .fab:hover{filter:brightness(1.06)}

  .bubble{position:absolute;right:70px;top:14px;min-width:300px;max-width:min(400px,88vw);
    background:#0f2e29;color:#dff7f3;border:1px solid #0e4a43;border-radius:16px;box-shadow:0 14px 32px rgba(0,0,0,.28);z-index:8;display:none}
  .bubble header{padding:10px 12px;background:#0b3b38;border-bottom:1px solid #0e4a43;border-radius:16px 16px 0 0;
    display:flex;align-items:center;justify-content:space-between;cursor:move;gap:8px}
  .bubble header .ttl{font-weight:900;letter-spacing:.2px}
  .bubble header .x{cursor:pointer;border:1px solid #0e4a43;background:#114d46;color:#e6fffb;border-radius:10px;
    padding:6px 10px;font-weight:800}
  .bubble .content{padding:10px 10px 12px}
  .scroll{max-height:65vh;overflow:auto;border-radius:10px;border:1px solid #0e4a43}
  .esri-legend,.esri-layer-list{--esri-widget-padding:8px;--esri-widget-border-color:transparent;--esri-widget-shadow:none;
    background:transparent;color:#dff7f3;font-size:12.5px}
  .esri-legend__service-label,.esri-layer-list__item-label{color:#e6fffb!important}
</style>
</head>
<body>
  <header class="mainTitleBar">
    <h1 class="mainTitle">Grado de dispersi√≥n de centros poblados - PNSR</h1>
  </header>

  <div class="shell">
    <div id="viewWrap">
      <div id="viewDiv"></div>

      <div class="fab-wrap">
        <div id="btnLayers" class="fab" title="Capas">üóÇÔ∏è</div>
        <div id="btnLegend" class="fab" title="Leyenda">üè∑Ô∏è</div>
      </div>

      <div id="bubbleLayers" class="bubble" style="top:14px;">
        <header data-drag="#bubbleLayers"><span class="ttl">Capas</span><button class="x" data-close="#bubbleLayers">Cerrar</button></header>
        <div class="content"><div class="scroll"><div id="layerListNode"></div></div></div>
      </div>

      <div id="bubbleLegend" class="bubble" style="top:190px;">
        <header data-drag="#bubbleLegend"><span class="ttl">Leyenda</span><button class="x" data-close="#bubbleLegend">Cerrar</button></header>
        <div class="content"><div class="scroll"><div id="legendNode"></div></div></div>
      </div>
    </div>

    <aside class="sidebar">
      <!-- ======= TODOS LOS FILTROS ARRIBA (4 columnas) ======= -->
      <section class="filtersBar" aria-label="Filtros de ubicaci√≥n">
        <div class="filtersGrid">
          <div class="fld">
            <label for="selDep">Departamento</label>
            <select id="selDep"><option value="">(Todos)</option></select>
          </div>
          <div class="fld">
            <label for="selProv">Provincia</label>
            <select id="selProv" disabled><option value="">(Todas)</option></select>
          </div>
          <div class="fld">
            <label for="selDist">Distrito</label>
            <select id="selDist" disabled><option value="">(Todos)</option></select>
          </div>
          <div class="fld">
            <label for="selCP">Centro poblado</label>
            <select id="selCP" disabled><option value="">(Todos)</option></select>
          </div>
        </div>
        <div class="rowBtns">
          <button id="btnClear" class="btn" type="button">Limpiar filtros</button>
        </div>
      </section>

      <!-- (Se elimin√≥ la secci√≥n separada de indFilters; solo est√©tica, misma funcionalidad) -->

      <section class="lowerGrid">
        <div class="listCard">
          <header><h3>Centros poblados (lista)</h3></header>
          <div class="list" id="cpList"><div class="empty">Cargando‚Ä¶</div></div>
        </div>
        <div class="listCard">
          <header><h3>Comentario</h3></header>
          <div class="commentWrap">
            <p>La herramienta muestra las <b>√°reas de concentraci√≥n</b> y las <b>viviendas rurales sin acceso a agua</b> (Censo 2017). Asimismo, se complementa con informaci√≥n de <b>componentes y redes de agua del DATASS</b> (m√≥dulo 3 y 5).</p>
            <img class="commentImg" loading="lazy" alt="Esquema de criterios" src="https://lh3.googleusercontent.com/d/1OPw9CWsW8xmgL6sjGuZcyvAtz2qJi0RF=w1000"/>
          </div>
        </div>
      </section>
    </aside>
  </div>

<script>
require([
  "esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/layers/GraphicsLayer",
  "esri/widgets/Legend","esri/widgets/LayerList","esri/widgets/ScaleBar",
  "esri/Graphic",
  "esri/renderers/UniqueValueRenderer","esri/renderers/SimpleRenderer",
  "esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol"
], (Map,MapView,FeatureLayer,GraphicsLayer,Legend,LayerList,ScaleBar,Graphic,
    UniqueValueRenderer,SimpleRenderer,SimpleFillSymbol,SimpleLineSymbol,SimpleMarkerSymbol)=>{

  /* === Helpers UI: burbujas === */
  const toggle = id => { const el=document.querySelector(id); el.style.display = el.style.display==='block' ? 'none' : 'block'; };
  document.getElementById('btnLayers').onclick=()=>toggle('#bubbleLayers');
  document.getElementById('btnLegend').onclick=()=>toggle('#bubbleLegend');
  document.querySelectorAll('[data-close]').forEach(b=>b.onclick=()=>{ document.querySelector(b.dataset.close).style.display='none'; });
  function makeDraggable(header){
    const box=document.querySelector(header.dataset.drag); let ox=0,oy=0,drag=false;
    header.addEventListener('mousedown',e=>{drag=true;ox=e.clientX-box.offsetLeft;oy=e.clientY-box.offsetTop;e.preventDefault();});
    window.addEventListener('mousemove',e=>{if(!drag)return;box.style.left=(e.clientX-ox)+'px';box.style.top=(e.clientY-oy)+'px';box.style.right='auto';});
    window.addEventListener('mouseup',()=>drag=false);
    header.addEventListener('touchstart',e=>{const t=e.touches[0];drag=true;ox=t.clientX-box.offsetLeft;oy=e.touches[0].clientY-box.offsetTop;});
    window.addEventListener('touchmove',e=>{if(!drag)return;const t=e.touches[0];box.style.left=(t.clientX-ox)+'px';box.style.top=(t.clientY-oy)+'px';box.style.right='auto';},{passive:false});
    window.addEventListener('touchend',()=>drag=false);
  }
  document.querySelectorAll('[data-drag]').forEach(makeDraggable);

  /* ===== ENDPOINTS ===== */
  const CCPP = "https://pportalgis.vivienda.gob.pe/pfdserver1/rest/services/OGEI/CCPP_Dispersos/FeatureServer";
  const VR   = "https://dportalgis.vivienda.gob.pe/dfdserver/rest/services/OGEI/vivienda_rural/FeatureServer/0";
  const LIM_BASE = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer";
  const LIM0 = `${LIM_BASE}/0`; // deps: id_dpto, nom_dep
  const LIM1 = `${LIM_BASE}/1`; // provs: id_dep, id_prov, nom_prov
  const LIM2 = `${LIM_BASE}/2`; // dists: id_dpto, id_prov, id_dist (6 d√≠gitos), nom_dist 
  const CP_LAYER = `${CCPP}/4`; // Centro Poblado por grado de dispersi√≥n: nom_ccpp, ubigeo

  /* ===== MAPA ===== */
  const map = new Map({ basemap:"satellite" });
  const view = new MapView({
    container:"viewDiv",
    map,
    center:[-69.155,-16.274],
    scale:65000,
    constraints:{minZoom:4,snapToZoom:false}
  });
  view.ui.add(new ScaleBar({view,unit:"metric"}),"bottom-left");
  view.qualityProfile = "low";

  /* ===== Simbolog√≠a ===== */
  const mk=(c,s=6)=> new SimpleMarkerSymbol({style:"circle",color:c,size:s,outline:{color:[255,255,255,180],width:0.5}});
  const tri=(c,s=7)=> new SimpleMarkerSymbol({style:"triangle",color:c,size:s,outline:{color:[255,255,255,180],width:0.5}});
  const diam=(c,s=8)=> new SimpleMarkerSymbol({style:"diamond",color:c,size:s,outline:{color:[255,255,255,180],width:0.5}});
  const line=(c,w=1.2)=> new SimpleLineSymbol({color:c,width:w});
  const poly=(fill,outline)=> new SimpleFillSymbol({color:fill,outline});

  function glowCIM(rgb=[255,255,255]){const [r,g,b]=rgb;return{
    type:"cim",
    data:{type:"CIMSymbolReference",
      symbol:{type:"CIMLineSymbol",
        symbolLayers:[
          {type:"CIMSolidStroke",enable:true,width:6,color:[r,g,b,40]},
          {type:"CIMSolidStroke",enable:true,width:3,color:[r,g,b,120]},
          {type:"CIMSolidStroke",enable:true,width:1.6,color:[r,g,b,255]}
        ]}}};}

  /* ===== Rangos de visibilidad ===== */
  const SCALE_PROV = 1200000;
  const SCALE_RED  = 600000;

  // Capas CCPP
  const lyrAreasAgrup = new FeatureLayer({
    url:`${CCPP}/6`, title:"√Åreas agrupadas (densidad y viviendas)",
    visible:true, minScale:SCALE_PROV,
    renderer:new SimpleRenderer({ symbol: poly([212,124,242,0.35], new SimpleLineSymbol({color:[0,0,0,0.9], width:1.2, style:"short-dot"})) })
  });
  const lyrAmbito = new FeatureLayer({
    url:`${CCPP}/5`, title:"√Åmbito territorial de centros poblados",
    visible:true, minScale:SCALE_PROV,
    renderer:new SimpleRenderer({ symbol: poly([0,0,0,0], new SimpleLineSymbol({color:[0,0,0,0.9], width:1.2, style:"short-dot"})) })
  });
  const lyrCPGrado = new FeatureLayer({
    url:`${CCPP}/4`, title:"Centro poblado por grado de dispersi√≥n",
    visible:true, minScale:1000000,
    renderer:new SimpleRenderer({ symbol: mk([200,200,200,0.95], 5.5) })
  });
  const lyrRedes   = new FeatureLayer({
    url:`${CCPP}/3`, title:"Redes - DATASS",
    visible:true, minScale:SCALE_RED,
    renderer:new SimpleRenderer({ symbol: line([95,210,255,0.95], 1.4) })
  });
  const lyrReserv  = new FeatureLayer({
    url:`${CCPP}/2`, title:"Reservorio - DATASS",
    visible:true, minScale:SCALE_PROV,
    renderer:new SimpleRenderer({ symbol: diam([46,204,64,0.95], 8) })
  });
  const lyrCapt    = new FeatureLayer({
    url:`${CCPP}/1`, title:"Captaci√≥n - DTASS",
    visible:true, minScale:SCALE_PROV,
    renderer:new SimpleRenderer({ symbol: tri([52,152,219,0.95], 8) })
  });
  const lyrPTAP    = new FeatureLayer({
    url:`${CCPP}/0`, title:"PTAP - DATASS",
    visible:true, minScale:SCALE_PROV,
    renderer:new SimpleRenderer({ symbol: mk([231,76,60,0.95], 7.5) })
  });

  // Vivienda Rural
  const FIELD="dhabcual";
  const defExp = `${FIELD} IN ('Con Deficit Cualitativo','Sin Dcficit Cualitativo','Otro')`;
  const COL_DEF=[198,42,75,0.90], COL_SIN=[60,130,246,0.90], COL_OTR=[168,170,175,0.70];
  const mkGeom=(g,c)=> g==="polygon" ? poly(c,new SimpleLineSymbol({color:[255,255,255,1],width:0.5})) : (g==="polyline"?line(c,2):mk(c,7));
  function vrRenderer(g){ return new UniqueValueRenderer({ field:FIELD, defaultSymbol:null,
    uniqueValueInfos:[
      {value:"Con Deficit Cualitativo",label:"Con D√©ficit Cualitativo",symbol:mkGeom(g,COL_DEF)},
      {value:"Sin Dcficit Cualitativo",label:"Sin D√©ficit Cualitativo",symbol:mkGeom(g,COL_SIN)},
      {value:"Otro",label:"Otro",symbol:mkGeom(g,COL_OTR)}
    ]});
  }
  const viviendaRural = new FeatureLayer({
    url:VR, title:"Vivienda rural - Viviendas Rurales",
    outFields:["*"], definitionExpression:defExp, minScale:SCALE_PROV, maxScale:0, visible:true
  });
  viviendaRural.when(()=>{ viviendaRural.renderer = vrRenderer(viviendaRural.geometryType); });

  map.addMany([lyrAreasAgrup, viviendaRural, lyrPTAP, lyrCapt, lyrReserv, lyrRedes, lyrCPGrado, lyrAmbito]);

  // L√çMITES con brillo
  const limDeptDraw = new FeatureLayer({
    url:LIM0, title:"L√≠mite Departamental", visible:false,
    renderer:new SimpleRenderer({ symbol: glowCIM([0,255,255]) }), blendMode:"screen"
  });
  const limProvDraw = new FeatureLayer({
    url:LIM1, title:"L√≠mite Provincial", visible:false,
    renderer:new SimpleRenderer({ symbol: glowCIM([255,215,0]) }), blendMode:"screen"
  });
  const limDistDraw = new FeatureLayer({
    url:LIM2, title:"L√≠mite Distrital", visible:false,
    renderer:new SimpleRenderer({ symbol: glowCIM([255,105,180]) }), blendMode:"screen"
  });
  map.addMany([limDeptDraw, limProvDraw, limDistDraw]);

  // Widgets
  new Legend({ view, container:"legendNode" });
  try {
    new LayerList({ view, container:"layerListNode", selectionEnabled:true,
      listItemCreatedFunction:(e)=>{ e.item.panel = { content:"legend", open:false }; }
    });
  } catch (error) { console.error("Error initializing LayerList:", error); }

  /* ===== LISTA + FILTROS ===== */
  const cpLayer = lyrAmbito; // FeatureServer/5 (lista)
  let layerView, hl; view.whenLayerView(cpLayer).then(lv=>layerView=lv);

  // fuentes combos
  const limDeptSrc = new FeatureLayer({ url:LIM0, outFields:["id_dpto","nom_dep"], listMode:"hide" });
  const limProvSrc = new FeatureLayer({ url:LIM1, outFields:["id_dep","id_prov","nom_prov"], listMode:"hide" });
  const limDistSrc = new FeatureLayer({ url:LIM2, outFields:["id_dpto","id_prov","id_dist","nom_dist"], listMode:"hide" });
  const cpSrc = new FeatureLayer({ url:CP_LAYER, outFields:["nom_ccpp","ubigeo"], listMode:"hide" });

  // capa para ‚Äúflash‚Äù
  const guideLayer = new GraphicsLayer({ listMode:"hide" });
  map.add(guideLayer);

  const $list = document.getElementById('cpList');
  const $selDep  = document.getElementById('selDep');
  const $selProv = document.getElementById('selProv');
  const $selDist = document.getElementById('selDist');
  const $selCP   = document.getElementById('selCP');
  const $btnClear= document.getElementById('btnClear');

  let initialViewpoint = null;
  view.when(()=>{ initialViewpoint = view.viewpoint.clone(); });

  const fmt = (n, d=0)=> (n==null||isNaN(n)) ? "‚Äî" : new Intl.NumberFormat('es-PE',{maximumFractionDigits:d}).format(Number(n));

  /* ===== Combos ===== */
  async function loadDeps(){
    const q = limDeptSrc.createQuery();
    q.where = "1=1"; q.returnGeometry = false;
    q.outFields = ["id_dpto","nom_dep"]; q.orderByFields = ["nom_dep ASC"]; q.num = 300; q.cacheHint = true;
    const r = await limDeptSrc.queryFeatures(q);
    const seen = new Set(); const rows = [];
    (r.features||[]).forEach(f=>{
      const id = f.attributes?.id_dpto, name = f.attributes?.nom_dep;
      if(id && !seen.has(id)){ seen.add(id); rows.push({id, name}); }
    });
    $selDep.innerHTML = `<option value="">(Todos)</option>` + rows.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
    $selProv.innerHTML = `<option value="">(Todas)</option>`; $selProv.disabled = true;
    $selDist.innerHTML = `<option value="">(Todos)</option>`; $selDist.disabled = true;
    $selCP.innerHTML   = `<option value="">(Todos)</option>`; $selCP.disabled   = true;
  }

  async function loadProvs(){
    const dep = $selDep.value.trim();
    $selProv.innerHTML = `<option value="">(Todas)</option>`;
    $selDist.innerHTML = `<option value="">(Todos)</option>`; $selDist.disabled = true;
    $selCP.innerHTML   = `<option value="">(Todos)</option>`; $selCP.disabled   = true;
    if(!dep){ $selProv.disabled = true; return; }
    const q = limProvSrc.createQuery();
    q.where = `id_dep='${dep}'`; q.returnGeometry=false;
    q.outFields = ["id_prov","nom_prov"]; q.orderByFields = ["nom_prov ASC"]; q.num = 1000; q.cacheHint = true;
    const r = await limProvSrc.queryFeatures(q);
    const seen = new Set(), rows=[];
    (r.features||[]).forEach(f=>{
      const id = f.attributes?.id_prov, name=f.attributes?.nom_prov;
      if(id && !seen.has(id)){ seen.add(id); rows.push({id, name}); }
    });
    $selProv.innerHTML += rows.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
    $selProv.disabled = false;
  }

  async function loadDists(){
    const prov = $selProv.value.trim();
    $selDist.innerHTML = `<option value="">(Todos)</option>`;
    $selCP.innerHTML   = `<option value="">(Todos)</option>`; $selCP.disabled = true;
    if(!prov){ $selDist.disabled = true; return; }
    const q = limDistSrc.createQuery();
    q.where = `id_prov='${prov}'`; q.returnGeometry=false;
    q.outFields = ["id_dist","nom_dist"]; q.orderByFields = ["nom_dist ASC"]; q.num = 3000; q.cacheHint = true;
    const r = await limDistSrc.queryFeatures(q);
    const seen = new Set(), rows=[];
    (r.features||[]).forEach(f=>{
      const id = f.attributes?.id_dist, name=f.attributes?.nom_dist;
      if(id && !seen.has(id)){ seen.add(id); rows.push({id, name}); }
    });
    $selDist.innerHTML += rows.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
    $selDist.disabled = false;
  }

  // Cargar CCPP por ubigeo == id_dist
  async function loadCPs(){
    const distId = $selDist.value.trim();
    $selCP.innerHTML = `<option value="">(Todos)</option>`;
    if(!distId){ $selCP.disabled = true; return; }

    const q = cpSrc.createQuery();
    q.where = `ubigeo='${distId}'`;
    q.returnGeometry = false;
    q.outFields = ["nom_ccpp","ubigeo"];
    q.orderByFields = ["nom_ccpp ASC"]; q.num = 5000; q.cacheHint = true;

    const r = await cpSrc.queryFeatures(q);
    const seen = new Set(), rows=[];
    (r.features||[]).forEach(f=>{
      const name = f.attributes?.nom_ccpp;
      const u = f.attributes?.ubigeo;
      if(name && u && !seen.has(name)){ seen.add(name); rows.push({name, ubigeo:u}); }
    });

    $selCP.innerHTML += rows.map(o=>`<option value="${o.ubigeo}::${o.name.replace(/"/g,'&quot;')}">${o.name}</option>`).join("");
    $selCP.disabled = rows.length === 0;
  }

  /* ===== L√çMITES visibles solo del filtro ===== */
  function updatePoliticalLimitVisibility(){
    const dep  = $selDep.value.trim();
    const prov = $selProv.value.trim();
    const dist = $selDist.value.trim();

    [limDeptDraw, limProvDraw, limDistDraw].forEach(ly=>{
      ly.visible = false; ly.definitionExpression = null;
    });

    if(dist){ limDistDraw.definitionExpression = `id_dist='${dist}'`; limDistDraw.visible = true; return; }
    if(prov){ limProvDraw.definitionExpression = `id_prov='${prov}'`; limProvDraw.visible = true; return; }
    if(dep ){ limDeptDraw.definitionExpression = `id_dpto='${dep}'`; limDeptDraw.visible = true; return; }
  }

  async function zoomToPolitical(){
    let src=null, where=null;
    const dist = $selDist.value.trim();
    const prov = $selProv.value.trim();
    const dep  = $selDep.value.trim();

    if(dist){ src = limDistSrc; where = `id_dist='${dist}'`; }
    else if(prov){ src = limProvSrc; where = `id_prov='${prov}'`; }
    else if(dep){ src = limDeptSrc; where = `id_dpto='${dep}'`; }
    else{ return; }

    const q = src.createQuery();
    q.where = where; q.returnGeometry = true; q.outFields = []; q.num = 1;
    const r = await src.queryFeatures(q);
    const g = r.features?.[0]?.geometry;
    if(!g) return;

    try{
      await view.goTo({ target:g, padding:{ left:40,right:40,top:60,bottom:60 } }, { duration:900, easing:"ease-in-out" });
    }catch(_){}
  }

  function parseCPValue(){
    const v = $selCP.value.trim();
    if(!v) return null;
    const [u, ...nameParts] = v.split("::");
    const name = nameParts.join("::");
    return { ubigeo:u, name };
  }

  function buildWhere(){
    const dep  = $selDep.value.trim();
    const prov = $selProv.value.trim();
    const dist = $selDist.value.trim();
    const cpSel= parseCPValue();

    const parts = ["1=1"];
    if(dep)  parts.push(`id_dpto='${dep}'`);
    if(prov) parts.push(`id_prov='${prov}'`);
    if(dist) parts.push(`id_dist='${dist}'`);
    if(cpSel && cpSel.name){ parts.push(`nom_cp='${cpSel.name.replace(/'/g,"''")}'`); }
    return parts.join(" AND ");
  }

  async function cargarLista(){
    const q = cpLayer.createQuery();
    q.where = buildWhere();
    q.outFields = ["objectid","nom_cp","categoria_cp","vivrur_tot","vivrur_agrup_p","sum_pobcensa","distnear_max","distnear_min","id_dpto","id_prov","id_dist"];
    q.returnGeometry = false;
    q.num = 1000;
    q.orderByFields = ["nom_cp ASC"];
    q.cacheHint = true;
    const res = await cpLayer.queryFeatures(q);
    pintarLista(res.features || []);
  }

  async function flyToFeatureByOID(oid){
    const q = cpLayer.createQuery();
    q.objectIds=[oid]; q.outFields=[]; q.returnGeometry=true;
    const r = await cpLayer.queryFeatures(q);
    const feat = r.features?.[0]; if(!feat) return;

    const geom = feat.geometry;
    let target = geom.extent ? geom.extent.clone() : null;
    if(!target || target.isEmpty || (target.xmin===target.xmax && target.ymin===target.ymax)){
      const center = geom.centroid || view.center;
      try{ await view.goTo({ center, scale: 24000 }, { duration:1100, easing:"ease-in-out" }); }catch(_){}
      return;
    }
    try{
      await view.goTo({ target: target.expand(1.7), padding:{ left:120,right:120,top:200,bottom:110 } }, { duration:1100, easing:"ease-in-out", animate:true });
    }catch(_){}
  }

  function pintarLista(features){
    if(hl){ hl.remove(); hl=null; }
    if(!features.length){ $list.innerHTML = `<div class="empty">Sin resultados</div>`; return; }

    $list.innerHTML = features.map(f=>{
      const a=f.attributes||{};
      const titulo = `${a.nom_cp ?? "‚Äî"} (${a.categoria_cp ?? "‚Äî"})`;
      return `
        <div class="item" data-oid="${a.objectid}">
          <div class="title">${titulo}</div>
          <div class="kv"><b>Vivienda rural total:</b> ${fmt(a.vivrur_tot)}</div>
          <div class="kv"><b>Vivienda rural concentrado:</b> ${fmt(a.vivrur_agrup_p,1)} %</div>
          <div class="kv"><b>Poblaci√≥n rural:</b> ${fmt(a.sum_pobcensa)}</div>
          <div class="kv"><b>Distancia m√°xima entre viviendas:</b> ${fmt(a.distnear_max,2)} m.</div>
          <div class="kv"><b>Distancia m√≠nima entre viviendas:</b> ${fmt(a.distnear_min,2)} m.</div>
        </div>`;
    }).join("");

    $list.querySelectorAll(".item").forEach((el)=>{
      el.addEventListener("click", async ()=>{
        const oid = Number(el.dataset.oid);
        try{
          if(layerView){ if(hl) hl.remove(); hl = layerView.highlight(oid); }
          await flyToFeatureByOID(oid);
        }catch(_){}
      });
    });
  }

  function flashGraphic(geometry){
    const g = new Graphic({
      geometry,
      symbol: new SimpleMarkerSymbol({
        style:"circle", size:14,
        color:[255,255,255,0],
        outline:{ color:[255,255,0,1], width:2 }
      })
    });
    guideLayer.removeAll(); guideLayer.add(g);
    let i=0;
    const int = setInterval(()=>{
      const o = (i%2===0)? 1 : 0.05;
      g.symbol.outline.color.a = o;
      guideLayer.refresh();
      if(++i>8){ clearInterval(int); }
    }, 220);
  }

  $selDep.addEventListener('change', async ()=>{
    await loadProvs();
    await cargarLista();
    updatePoliticalLimitVisibility();
    await zoomToPolitical();
  });
  $selProv.addEventListener('change', async ()=>{
    await loadDists();
    await cargarLista();
    updatePoliticalLimitVisibility();
    await zoomToPolitical();
  });
  $selDist.addEventListener('change', async ()=>{
    await loadCPs();
    await cargarLista();
    updatePoliticalLimitVisibility();
    await zoomToPolitical();
  });

  $selCP.addEventListener('change', async ()=>{
    await cargarLista();
    updatePoliticalLimitVisibility();
    await zoomToPolitical();
    const sel = parseCPValue();
    if(!sel) return;

    const q = lyrCPGrado.createQuery();
    q.where = `ubigeo='${sel.ubigeo}' AND nom_ccpp='${sel.name.replace(/'/g,"''")}'`;
    q.returnGeometry = true; q.outFields = []; q.num = 1;
    const r = await lyrCPGrado.queryFeatures(q);
    const feat = r.features?.[0];
    if(!feat) return;

    try{
      await view.goTo({ target: feat.geometry, scale: 18000 }, { duration:900, easing:"ease-in-out" });
      flashGraphic(feat.geometry);
    }catch(_){}
  });

  $btnClear.addEventListener('click', async ()=>{
    $selDep.value = "";
    $selProv.innerHTML = `<option value="">(Todas)</option>`; $selProv.disabled = true;
    $selDist.innerHTML = `<option value="">(Todos)</option>`; $selDist.disabled = true;
    $selCP.innerHTML   = `<option value="">(Todos)</option>`; $selCP.disabled   = true;
    updatePoliticalLimitVisibility();
    await cargarLista();
    if(initialViewpoint){ try{ await view.goTo(initialViewpoint, { duration:900 }); }catch(_){ } }
    guideLayer.removeAll();
    if(hl){ hl.remove(); hl=null; }
  });

  (async function init(){
    await loadDeps();
    await cargarLista();
    updatePoliticalLimitVisibility();
  })();
});
</script>
</body>
</html>
