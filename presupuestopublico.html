<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Presupuesto público 2025 – MVCS</title>

<!-- Fuente institucional -->
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>

<style>
:root{
  --accent-red:#d00000;
  --txt-main:#ffffff;
  --azul-mvcs:#1e6eb6;
  --celeste-pim:#5ebad6;
  --gris-fondo:#f8f9fa;
  --gris-borde:#d1d5db;
  --gris-texto:#1e293b;
  --gris-sec:#4b5563;
  --bg-page:#e5e7eb;
  --bg-white:#ffffff;
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:'Nunito Sans',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg-page);
  color:#111;
  line-height:1.5;
}

/* ================= HERO (NUEVA VERSIÓN MEJORADA) ================= */
.hero{
  position:relative;
  width:100%;
  height:100vh;
  min-height:640px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  background:#000;
}
.hero::before{
  content:"";
  position:absolute;
  inset:0;
  background-image:url("https://lh3.googleusercontent.com/d/1Dm-riCsGjefQDoFktMgwsSRQNI_T8YaT=w1600");
  background-size:cover;
  background-position:center;
  z-index:0;
}
.hero::after{
  content:"";
  position:absolute;
  inset:0;
  z-index:1;
  background:linear-gradient(to bottom,rgba(0,0,0,0) 60%,rgba(0,0,0,0.45) 85%,rgba(0,0,0,0.7) 100%);
}

.hero-header{
  position:relative;
  z-index:5;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  flex-wrap:wrap;
  row-gap:1rem;
  padding:1.2rem 3rem 0;
  color:var(--txt-main);
}
.hero-header img{height:48px;object-fit:contain;}
nav.hero-nav{display:flex;flex-wrap:wrap;gap:2.2rem;justify-content:center;}
nav.hero-nav a{color:var(--txt-main);text-decoration:none;font-weight:600;font-size:0.95rem;transition:.3s;}
nav.hero-nav a:hover{color:#ffdddd;}

.hero-content{
  position:relative;
  z-index:5;
  width:100%;
  height:100%;
  padding:0 4rem 5rem;
  color:var(--txt-main);
  display:grid;
  grid-template-columns:minmax(0,1fr) minmax(420px,36%);
  column-gap:5rem;
  align-items:center;
  justify-items:center;
  transform:translateY(4cm);
}
.hero-left{
  max-width:min(880px,90%);
  align-self:center;
  justify-self:start;
  margin-left:1.5rem;
  text-shadow:0 2px 12px rgba(0,0,0,.35);
}
.hero-title{
  font-family:'Nunito Sans',sans-serif;
  font-size:clamp(52px,8vw,88px);
  font-weight:900;
  line-height:1.02;
  position:relative;
  margin-bottom:1rem;
  color:var(--txt-main);
}
.hero-underline{
  position:absolute;
  bottom:-10px;
  left:0;
  height:6px;
  background:var(--accent-red);
  width:0;
  animation:underline 3.5s ease-out forwards;
}
@keyframes underline{from{width:0;}to{width:100%;}}
.hero-sub{
  font-size:1.05rem;
  color:rgba(255,255,255,0.9);
  font-weight:700;
  margin-top:.9rem;
  text-shadow:0 2px 10px rgba(0,0,0,.35);
}
.hero-right{
  max-width:540px;
  justify-self:start;
  font-size:1.22rem;
  line-height:1.65;
  font-weight:400;
  color:var(--txt-main);
  text-align:left;
  text-shadow:0 2px 10px rgba(0,0,0,.35);
}
.hero-right b{font-weight:800;}

/* RESPONSIVE HERO */
@media(max-width:1000px){
  .hero-content{
    grid-template-columns:1fr;
    row-gap:2rem;
    padding:0 2rem 4rem;
    transform:translateY(2cm);
  }
  .hero-left{justify-self:start;margin-left:0;}
  .hero-right{justify-self:start;max-width:680px;font-size:1.1rem;}
}

/* ================= PIM (contador grande) ================= */
.pim-block{
  background:var(--gris-fondo);
  border-top:1px solid var(--gris-borde);
  padding:3rem 1rem 3.5rem;
  text-align:center;
  color:var(--gris-texto);
}
.pim-title{
  font-size:1rem;
  font-weight:700;
  margin-bottom:1rem;
  color:var(--gris-texto);
  text-align:center;
}
.pim-center-wrap{display:grid;place-items:center;margin-bottom:1.25rem;}
.pim-row{display:inline-flex;align-items:flex-end;gap:.8rem;transform-origin:center bottom;}
.pim-prefix{font-weight:800;color:var(--azul-mvcs);transform:translateY(-6%);font-size:clamp(32px,3vw,52px);opacity:0;transition:.35s ease;}
.pim-amount{font-weight:900;color:var(--azul-mvcs);font-size:clamp(50px,5vw,88px);opacity:0;transform:translateY(8px);transition:.35s ease;}
.pim-amount.ready{opacity:1;transform:translateY(0);} .pim-prefix.ready{opacity:1;transform:translateY(0);}
.data-source{font-size:.85rem;line-height:1.4;color:var(--gris-sec);text-align:center;font-weight:400;font-style:normal;}
.data-source b{color:#000;font-weight:700;font-style:normal;}
.data-source em{font-style:italic;color:#555;font-weight:400;}

/* ================= ÁREAS DE ACCIÓN ================= */
.areas-wrapper{
  background:var(--bg-white);
  border-top:1px solid var(--gris-borde);
  padding:5rem 2rem 6rem;
}
.areas-header{text-align:center;margin-bottom:3rem;}
.areas-title{display:inline-block;font-size:1.7rem;font-weight:800;color:var(--azul-mvcs);position:relative;padding-bottom:.6rem;}
.areas-title::after{content:"";position:absolute;left:0;bottom:0;height:4px;width:100%;background:var(--accent-red);}
.areas-grid{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:3rem 3rem;align-items:center;}
.col-left,.col-right{display:flex;flex-direction:column;justify-content:center;gap:2.5rem;opacity:0;transition:all .7s ease;}
.col-left{transform:translateX(-50px);} .col-right{transform:translateX(50px);} .col-left.visible,.col-right.visible{opacity:1;transform:translateX(0);}
.area-block-text{font-size:1rem;line-height:1.6;color:#1f2937;text-align:justify;}
.area-block-text b{font-weight:700;} .area-block-text ul{margin-top:.6rem;margin-bottom:1.2rem;padding-left:1.25rem;}
.area-block-text li{list-style:disc;margin-bottom:.3rem;}
.area-img{width:100%;background:#fff;overflow:hidden;border-radius:8px;box-shadow:0 6px 14px rgba(0,0,0,0.08);}
.area-img img{width:100%;height:auto;display:block;object-fit:cover;}

/* ================= INVERSIÓN (gráfico barras) ================= */
.inv-wrapper{
  background:var(--bg-white);
  /* border-bottom:1px solid var(--gris-borde); ← ELIMINADO */
  padding:3rem 1rem 3rem 1rem;
  text-align:center;
  color:var(--gris-texto);
}
.inv-h2{font-size:1rem;font-weight:700;margin-bottom:1.25rem;color:var(--gris-texto);text-align:center;}
.inv-chart-zone{max-width:900px;margin:0 auto;display:flex;flex-direction:column;align-items:center;}
.inv-chart-wrap{position:relative;width:100%;height:180px;margin-bottom:1rem;}
#chart{width:100%;height:100%;display:block;}
.inv-tip{position:absolute;pointer-events:none;background:#fff;border:1px solid #d1d5db;border-radius:8px;box-shadow:0 10px 28px rgba(0,0,0,.15);padding:.6rem .75rem;font-size:12px;line-height:1.4;color:#1e293b;font-weight:400;min-width:180px;max-width:260px;opacity:0;transform:translate(-50%,-110%);transition:opacity .12s ease;text-align:left;}
.inv-tip-row{display:flex;justify-content:space-between;gap:.75rem;white-space:nowrap;}
.inv-tip-key{color:#6b7280;font-weight:400;} .inv-tip-val{color:#1e293b;font-weight:800;}
.inv-legend{display:flex;flex-wrap:wrap;justify-content:center;gap:1.25rem;font-size:.8rem;font-weight:600;color:#1e1e1e;margin-bottom:1rem;}
.inv-leg-item{display:flex;align-items:center;gap:.5rem;white-space:nowrap;}
.inv-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.inv-dot-dev{background:var(--azul-mvcs);} .inv-dot-pim{background:var(--celeste-pim);}
.inv-source{font-size:.85rem;line-height:1.4;color:var(--gris-sec);text-align:center;font-weight:400;font-style:normal;}
.inv-source strong{color:#000;font-weight:700;font-style:normal;}
.inv-source span#lastUpdate{font-style:italic;color:#555;font-weight:400;}

/* ====== CÓMO VAMOS (banner azul con ciudadana) ====== */
/* .status-spacer eliminado completamente */
/* .status-spacer{height:40px;background:#fff;border-top:1px solid var(--gris-borde)} ← ELIMINADO */

.status-hero{
  position:relative;width:100%;
  background-image:url("https://lh3.googleusercontent.com/d/1k1_vSVxnS7PYTiqV8M2Y5_Xli6qHmPzO=w1600");
  background-size:cover;background-position:center;
  color:#fff;overflow:visible;
  /* border-bottom:1px solid var(--gris-borde); ← MANTENIDO solo si se desea al final */
  padding:4rem 1rem 4rem;
}
.status-hero::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.45));
}
.status-inner{
  position:relative;z-index:3;max-width:1200px;margin:0 auto;
  display:flex;align-items:center;justify-content:space-between;
  gap:2rem;flex-wrap:wrap;padding-left:4vw;
}
.status-left{flex:1 1 620px;text-align:left;position:relative;z-index:5;}
.status-title{font-weight:900;font-size:clamp(24px,2.8vw,36px);color:#fff;line-height:1.2;margin-bottom:0.25rem;text-shadow:0 2px 4px rgba(0,0,0,.45)}
.status-title .u{position:relative;display:inline-block;padding-bottom:6px}
.status-title .u::after{content:"";position:absolute;left:0;bottom:0;height:4px;background:var(--accent-red);width:0;animation:underline 1.8s ease-out forwards;}
.status-subtitle{font-size:.9rem;font-weight:800;opacity:.95;margin-bottom:1.2rem;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.45)}
.dev-row{display:flex;align-items:baseline;justify-content:flex-start;gap:.4rem;flex-wrap:nowrap}
.dev-prefix{font-weight:900;color:#fff;line-height:1;font-size:clamp(40px,5vw,70px);opacity:0;transform:translateY(8px);transition:.35s ease;text-shadow:0 4px 8px rgba(0,0,0,.55)}
.dev-amount{font-weight:900;color:#fff;line-height:1.03;font-size:clamp(56px,8vw,110px);letter-spacing:.01em;white-space:nowrap;opacity:0;transform:translateY(8px);transition:.35s ease;text-shadow:0 4px 8px rgba(0,0,0,.55)}
.dev-percent{font-weight:900;color:#fff;margin-top:.85rem;font-size:clamp(18px,1.8vw,28px);opacity:0;transform:translateY(8px);transition:.35s ease;text-shadow:0 3px 6px rgba(0,0,0,.55)}
.dev-source{margin-top:1rem;font-size:.85rem;line-height:1.35;color:#dbe2ea;text-shadow:0 2px 4px rgba(0,0,0,.7)}
.dev-source b{color:#fff}.dev-source em{color:#fff;font-style:italic}
.ready{opacity:1 !important;transform:none !important}
.status-figure{
  position:absolute;right:0;bottom:-20px;z-index:2;
  width:min(40%,460px);max-width:480px;pointer-events:none;
  opacity:0;transform:translate(15%,5%);animation:ladyIn .9s ease-out .2s forwards;
}
.status-figure img{width:100%;height:auto;display:block;object-fit:contain;filter:drop-shadow(0 16px 26px rgba(0,0,0,.6))}
@keyframes ladyIn{to{opacity:1;transform:translate(0,-4%)}}

/* Responsive ajustes del banner */
@media (max-width:1100px) and (min-width:521px){
  .status-inner{padding-left:3vw}
  .status-left{z-index:5;text-align:left}
  .status-figure{width:46%;right:-10px;bottom:-12px;z-index:1;opacity:0.95}
}
@media(max-width:1000px){
  .hero-left{left:3rem;bottom:5rem;}
  .hero-title{font-size:3.6rem;}
  .hero-right{right:3rem;top:62%;max-width:440px;font-size:1.05rem;}
  .areas-grid{grid-template-columns:1fr;gap:3rem;}
  .col-left,.col-right{opacity:1;transform:none;}
}
@media(max-width:520px){
  .status-inner{flex-direction:column;align-items:center;text-align:center;padding-left:0;padding-bottom:8rem}
  .status-left{text-align:center}
  .dev-row{justify-content:center}
  .status-figure{width:200px;right:5px;bottom:-8px}
}
</style>
</head>
<body>

<!-- HERO (NUEVO DISEÑO) -->
<section class="hero">
  <header class="hero-header">
    <img src="https://lh3.googleusercontent.com/d/1EjnXS6iO0TkdAzQyg3rstHw4XL7Mk59g=w1000" alt="MVCS Logo"/>
    <nav class="hero-nav">
      <a href="#areas">Áreas de acción</a>
      <a href="#avance">¿Cómo vamos?</a>
      <a href="#desempeño">Desempeño financiero</a>
      <a href="#inversiones">Inversiones</a>
      <a href="#proyectos">Grandes proyectos</a>
      <a href="#multitemporal">Imágenes multitemporales</a>
    </nav>
  </header>

  <div class="hero-content">
    <div class="hero-left">
      <h1 class="hero-title">
        Presupuesto<br>público 2025
        <span class="hero-underline"></span>
      </h1>
      <div class="hero-sub">Ministerio de Vivienda, Construcción y Saneamiento</div>
    </div>

    <div class="hero-right">
      <p>
        El presupuesto sectorial fomentará la economía local,
        la generación de puestos de trabajo, y acelerará el
        <b>cierre de brechas de agua potable, saneamiento, vivienda,
        equipamiento urbano y formalización predial.</b>
      </p>
    </div>
  </div>
</section>

<!-- BLOQUE PIM -->
<section class="pim-block" id="pim">
  <h2 class="pim-title">Presupuesto Institucional Modificado 2025</h2>

  <div class="pim-center-wrap">
    <div class="pim-row" id="pim-row">
      <div class="pim-prefix" id="pim-cur">S/</div>
      <div class="pim-amount" id="pim-val">0</div>
    </div>
  </div>

  <p class="data-source">
    <b>Fuente:</b> Ministerio de Economía y Finanzas – MEF<br/>
    Portal de Datos Abiertos – <em id="pim-lastUpdate">Actualizado al —</em>
  </p>
</section>

<!-- ÁREAS DE ACCIÓN -->
<section class="areas-wrapper" id="areas">
  <div class="areas-header">
    <h2 class="areas-title">Áreas de acción</h2>
  </div>

  <div class="areas-grid">
    <div class="col-left" id="col-left">
      <div class="area-block-text">
        <p><b>Ejecución de obras de agua potable y saneamiento a nivel nacional,</b> a través del:</p>
        <ul>
          <li>Programa Nacional de Saneamiento Urbano (PNSU).</li>
          <li>Programa Nacional de Saneamiento Rural (PNSR).</li>
          <li>Programa Agua Segura para Lima y Callao (PASLC).</li>
        </ul>
        <p>
          Reactivación de proyectos de agua y saneamiento urbano, en beneficio de la población; y el financiamiento de la elaboración de estudios de preinversión para ejecutarse a nivel nacional.
        </p>
      </div>

      <div class="area-img">
        <img src="https://lh3.googleusercontent.com/d/1XE4OUAOoZiEEKayGMRe9C0BSTCm0Do9u=w1000" alt="Proyecto rural de vivienda"/>
      </div>
    </div>

    <div class="col-right" id="col-right">
      <div class="area-img">
        <img src="https://lh3.googleusercontent.com/d/1Rlix_IzbFNm1s9DyFFlHNW-7nnYcz-5e=w1000" alt="Obras de agua y saneamiento urbano"/>
      </div>

      <div class="area-block-text">
        <p><b>Promoción de viviendas urbanas,</b> a través del:</p>
        <ul>
          <li>Bono Familiar Habitacional de Techo Propio.</li>
          <li>Bono del Buen Pagador del Crédito Mivivienda.</li>
          <li>Bono de Arrendamiento de Viviendas para Emergencias (BAE).</li>
          <li>Viviendas Wasiymi para las zonas rurales, destinadas a atender a personas en situación de pobreza o pobreza extrema que viven en zonas de heladas y friaje.</li>
        </ul>
      </div>
    </div>
  </div>
</section>

<!-- INVERSIÓN POR ACTIVIDAD / PROYECTO -->
<section class="inv-wrapper" id="avance">
  <div class="inv-chart-zone">
    <h2 class="inv-h2 pim-title">Inversión pública por actividad / proyecto 2025</h2>

    <div class="inv-chart-wrap" id="wrap">
      <canvas id="chart"></canvas>
      <div id="tip" class="inv-tip"></div>
    </div>

    <div class="inv-legend">
      <span class="inv-leg-item">
        <span class="inv-dot inv-dot-dev"></span>
        <span>Monto devengado</span>
      </span>
      <span class="inv-leg-item">
        <span class="inv-dot inv-dot-pim"></span>
        <span>Monto PIM</span>
      </span>
    </div>

    <p class="inv-source data-source">
      <b>Fuente:</b> Ministerio de Economía y Finanzas – MEF<br/>
      Portal de Datos Abiertos – <span id="lastUpdate"><em>Actualizado al —</em></span>
    </p>
  </div>
</section>

<!-- ===== Banner azul con ciudadana (¿Cómo vamos?) ===== -->
<!-- <div class="status-spacer"></div> ← ELIMINADO -->
<section class="status-hero" id="como-vamos">
  <div class="status-figure">
    <img src="https://lh3.googleusercontent.com/d/16r2oP5b4bTadCXGsHO3EiiZbll7yrCdY=w1000" alt="Ciudadana beneficiaria">
  </div>

  <div class="status-inner">
    <div class="status-left">
      <h2 class="status-title"><span class="u">¿Cómo vamos?</span></h2>
      <div class="status-subtitle">Presupuesto Devengado 2025</div>

      <div class="dev-row">
        <span class="dev-prefix" id="cur">S/</span>
        <span class="dev-amount" id="val">0</span>
      </div>

      <div class="dev-percent" id="percent">0%</div>

      <div class="dev-source">
        <b>Fuente:</b> Ministerio de Economía y Finanzas – MEF<br>
        Portal de Datos Abiertos – <em id="lastUpdateDev">Actualizado al —</em>
      </div>
    </div>
  </div>
</section>

<script>
/* =======================
   BLOQUE PIM (contador animado desde BD)
   ======================= */
const SERVICE_PIM="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
const WHERE_PIM="sector_nombre = 'VIVIENDA CONSTRUCCION Y SANEAMIENTO' AND ano_eje = 2025";

async function fetchPIMandMaxDate(){
  const outStats=JSON.stringify([
    {statisticType:"sum",onStatisticField:"monto_pim",outStatisticFieldName:"sum_pim"},
    {statisticType:"max",onStatisticField:"fecha_proceso",outStatisticFieldName:"max_fp"}
  ]);
  const qs=new URLSearchParams({where:WHERE_PIM,outStatistics:outStats,returnGeometry:"false",f:"json"});
  const res=await fetch(SERVICE_PIM+"?"+qs.toString(),{cache:"no-store"});
  const json=await res.json();
  const attrs=json.features?.[0]?.attributes||{};
  return{total:Number(attrs.sum_pim)||0,lastTs:(attrs.max_fp!=null)?Number(attrs.max_fp):null};
}
function animateNumber(el,target,ms=1700){
  const fmt=new Intl.NumberFormat('es-PE');
  const start=performance.now();
  function tick(t){
    const p=Math.min(1,(t-start)/ms);
    const eased=1-Math.pow(1-p,3);
    const cur=Math.round(target*eased);
    el.textContent=fmt.format(cur);
    if(p<1)requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}
function formatEsDate(ts){
  if(!Number.isFinite(ts))return"—";
  const d=new Date(ts);
  return new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"long",year:"numeric"}).format(d);
}
(async()=>{
  const valEl=document.getElementById('pim-val');
  const curEl=document.getElementById('pim-cur');
  const lastEl=document.getElementById('pim-lastUpdate');
  try{
    const{total,lastTs}=await fetchPIMandMaxDate();
    requestAnimationFrame(()=>{valEl.classList.add('ready');curEl.classList.add('ready');});
    animateNumber(valEl,total);
    lastEl.textContent="Actualizado al "+formatEsDate(lastTs);
  }catch(e){
    valEl.textContent="—";
    lastEl.textContent="Actualizado al —";
  }
})();

/* =======================
   ÁREAS DE ACCIÓN efecto llegada
   ======================= */
const leftEl=document.getElementById('col-left');
const rightEl=document.getElementById('col-right');
function revealOnScroll(){
  const vh=window.innerHeight;
  if(leftEl.getBoundingClientRect().top < vh*0.8) leftEl.classList.add('visible');
  if(rightEl.getBoundingClientRect().top < vh*0.8) rightEl.classList.add('visible');
}
window.addEventListener('scroll',revealOnScroll,{passive:true});
window.addEventListener('load',revealOnScroll,{passive:true});

/* =======================
   GRÁFICO INVERSIÓN (datos vivos desde BD)
   ======================= */
const URL13="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
const YEAR=2025;
function fmtM(v){const n=Number(v)||0;return (n/1e6).toFixed(3).replace(/\B(?=(\d{3})+(?!\d))/g,'.').replace(/(\.\d*?)0+$/,'$1').replace(/\.$/,'')+" M";}
function fmtPct(p){return `${Math.round((p||0))}%`;}

async function fetchStats(){
  const params=new URLSearchParams({
    f:"json",
    where:`ano_eje = ${YEAR}`,
    returnGeometry:"false",
    groupByFieldsForStatistics:"tipo_act_proy_nombre",
    outFields:"tipo_act_proy_nombre",
    orderByFields:"tipo_act_proy_nombre",
    outStatistics:JSON.stringify([
      {"statisticType":"sum","onStatisticField":"monto_pim","outStatisticFieldName":"sum_pim"},
      {"statisticType":"sum","onStatisticField":"monto_devengado","outStatisticFieldName":"sum_dev"}
    ])
  });
  const res=await fetch(URL13,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:params.toString(),cache:"no-store"});
  if(!res.ok) throw new Error("HTTP "+res.status);
  const j=await res.json(); if(j.error) throw new Error(j.error.message||"Error ArcGIS");
  const rows=(j.features||[]).map(f=>f.attributes||{});
  const order=["PROYECTO","ACTIVIDAD"];
  rows.sort((a,b)=>{const ai=order.indexOf(a.tipo_act_proy_nombre);const bi=order.indexOf(b.tipo_act_proy_nombre);return (ai<0?99:ai)-(bi<0?99:bi);});
  return rows.map(r=>{const pim=Number(r.sum_pim)||0;const dev=Number(r.sum_dev)||0;return{cat:r.tipo_act_proy_nombre||"—",pim,dev,pct:pim>0?(dev/pim*100):0};});
}
async function fetchMaxDate(){
  const params=new URLSearchParams({f:"json",where:`ano_eje = ${YEAR}`,returnGeometry:"false",outStatistics:JSON.stringify([{"statisticType":"max","onStatisticField":"fecha_proceso","outStatisticFieldName":"max_fp"}])});
  const res=await fetch(URL13+"?"+params.toString(),{cache:"no-store"});
  if(!res.ok) throw new Error("HTTP "+res.status);
  const j=await res.json(); const at=j.features?.[0]?.attributes||{}; return Number(at.max_fp)||null;
}
function formatEsDate2(ts){if(!Number.isFinite(ts)) return "—"; const d=new Date(ts); return new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"long",year:"numeric"}).format(d);}

function renderChart(data){
  const wrap=document.getElementById("wrap");
  const canvas=document.getElementById("chart");
  const tip=document.getElementById("tip");
  const ctx=canvas.getContext("2d");
  let dims={}, scale={}, bars=[];
  function roundRect(ctx,x,y,w,h,r){const rr=Math.min(r,h/2,w/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.arcTo(x+w,y,x+w,y+h,rr);ctx.arcTo(x+w,y+h,x,y+h,rr);ctx.arcTo(x,y+h,x,y,rr);ctx.arcTo(x,y,x+w,y,rr);ctx.closePath();}
  function buildScale(){
    const dpr=Math.max(1,window.devicePixelRatio||1);
    const W=wrap.clientWidth, H=wrap.clientHeight;
    canvas.width=W*dpr; canvas.height=H*dpr; canvas.style.width=W+"px"; canvas.style.height=H+"px"; ctx.setTransform(dpr,0,0,dpr,0,0);
    dims={W,H};
    const pad={t:20,r:20,b:40,l:90};
    const maxVal=Math.max(1,...data.map(d=>d.pim));
    const pow=Math.pow(10,Math.floor(Math.log10(maxVal)));
    const XMAX=Math.ceil(maxVal/(pow/2))*(pow/2);
    scale={pad,max:XMAX,x:(val)=>pad.l+(W-pad.l-pad.r)*(val/XMAX),y:(i)=>{const n=data.length;const band=(H-pad.t-pad.b)/Math.max(1,n);return pad.t+band*(i+0.5);},bandH:(H-pad.t-pad.b)/Math.max(1,data.length)};
    const barH=Math.min(32,scale.bandH*0.6);
    bars=data.map((d,i)=>{const cy=scale.y(i);const yTop=cy-barH/2;const pimW=scale.x(d.pim)-scale.x(0);const devW=scale.x(d.dev)-scale.x(0);return{cat:d.cat,pim:d.pim,dev:d.dev,pct:d.pct,cy,barH,pimRect:{x:scale.x(0),y:yTop,w:pimW,h:barH},devRect:{x:scale.x(0),y:yTop,w:devW,h:barH}};});
  }
  function draw(){
    ctx.clearRect(0,0,dims.W,dims.H);
    ctx.strokeStyle="#d1d5db"; ctx.lineWidth=1; ctx.setLineDash([3,5]);
    const ticks=6; for(let t=0;t<=ticks;t++){const v=scale.max*(t/ticks);const x=scale.x(v);ctx.beginPath();ctx.moveTo(x,scale.pad.t);ctx.lineTo(x,dims.H-scale.pad.b);ctx.stroke();}
    ctx.setLineDash([]);
    ctx.font="700 13px 'Nunito Sans',system-ui"; ctx.fillStyle="#1f2937"; ctx.textAlign="right"; ctx.textBaseline="middle";
    bars.forEach(b=>{const label=b.cat.charAt(0)+b.cat.slice(1).toLowerCase();ctx.fillText(label, scale.pad.l-10, b.cy);});
    bars.forEach(b=>{
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--celeste-pim').trim() || "#5ebad6"; roundRect(ctx,b.pimRect.x,b.pimRect.y,b.pimRect.w,b.pimRect.h,16); ctx.fill();
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--azul-mvcs').trim() || "#1e6eb6"; roundRect(ctx,b.devRect.x,b.devRect.y,b.devRect.w,b.devRect.h,16); ctx.fill();
      ctx.fillStyle="#ffffff"; ctx.font="700 12px 'Nunito Sans',system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
      if(b.devRect.w>40){const devTxt=fmtM(b.dev); const devMidX=b.devRect.x+b.devRect.w/2; ctx.fillText(devTxt,devMidX,b.cy);}
      const restW=b.pimRect.w-b.devRect.w;
      if(restW>40){const pimTxt=fmtM(b.pim); const restMidX=b.devRect.x+b.devRect.w+restW/2; ctx.fillText(pimTxt,restMidX,b.cy);}
      ctx.font="700 12px 'Nunito Sans',system-ui"; ctx.textAlign="left"; ctx.textBaseline="middle"; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--azul-mvcs').trim() || "#1e6eb6"; const pctText=fmtPct(b.pct); const pctX=b.pimRect.x+b.pimRect.w+8; ctx.fillText(pctText,pctX,b.cy);
    });
  }
  function hitTest(mx,my){for(const b of bars){const r=b.devRect;if(mx>=r.x&&mx<=r.x+r.w&&my>=r.y&&my<=r.y+r.h)return{b,kind:"dev"};const p=b.pimRect;if(mx>=p.x&&mx<=p.x+p.w&&my>=p.y&&my<=p.y+p.h)return{b,kind:"pim"};}return null;}
  function attachTooltip(){
    canvas.addEventListener("mousemove",e=>{const rect=canvas.getBoundingClientRect();const mx=e.clientX-rect.left;const my=e.clientY-rect.top;const h=hitTest(mx,my);if(!h){tip.style.opacity=0;return;}const b=h.b;tip.innerHTML=`
      <div class="inv-tip-row"><span class="inv-tip-key">Categoría</span><span class="inv-tip-val">${b.cat}</span></div>
      <div class="inv-tip-row"><span class="inv-tip-key">Monto PIM</span><span class="inv-tip-val">${(b.pim).toLocaleString('es-PE')}</span></div>
      <div class="inv-tip-row"><span class="inv-tip-key">Monto devengado</span><span class="inv-tip-val">${(b.dev).toLocaleString('es-PE')}</span></div>
      <div class="inv-tip-row"><span class="inv-tip-key">Avance</span><span class="inv-tip-val">${fmtPct(b.pct)}</span></div>`;
      tip.style.left=(mx+14)+"px"; tip.style.top =(my-14)+"px"; tip.style.opacity=1;},{passive:true});
    canvas.addEventListener("mouseleave",()=>{tip.style.opacity=0;},{passive:true});
  }
  function redrawAll(){buildScale();draw();}
  redrawAll(); attachTooltip(); window.addEventListener("resize",redrawAll,{passive:true});
}
(async function(){
  try{
    const [rows,lastTs]=await Promise.all([fetchStats(),fetchMaxDate()]);
    renderChart(rows);
    const lu=document.getElementById("lastUpdate"); lu.innerHTML=`<em>Actualizado al ${formatEsDate2(lastTs)}</em>`;
  }catch(err){
    console.error(err);
    document.getElementById("wrap").innerHTML='<div style="display:grid;place-items:center;height:100%;color:#6b7280;font-size:14px;font-family:Nunito Sans,system-ui;">Error al cargar datos</div>';
  }
})();

/* ===== Devengado (banner azul) desde BD ===== */
async function fetchDevengadoData(){
  const outStats = JSON.stringify([
    { statisticType: "sum", onStatisticField: "monto_devengado", outStatisticFieldName: "sum_dev" },
    { statisticType: "sum", onStatisticField: "monto_pim",       outStatisticFieldName: "sum_pim" },
    { statisticType: "max", onStatisticField: "fecha_proceso",   outStatisticFieldName: "max_fp"  }
  ]);
  const qs = new URLSearchParams({
    where: WHERE_PIM,
    outStatistics: outStats,
    returnGeometry: "false",
    f: "json"
  });
  const url = SERVICE_PIM + "?" + qs.toString();
  const res = await fetch(url, { cache: "no-store" });
  const json = await res.json();
  const a = json.features?.[0]?.attributes || {};
  return { dev: Number(a.sum_dev||0), pim: Number(a.sum_pim||0), lastTs: (a.max_fp != null) ? Number(a.max_fp) : null };
}
function animateNumberFmt(el, target, ms, fmt, suffix=""){
  const start = performance.now();
  function tick(t){
    const p = Math.min(1, (t - start) / ms);
    const eased = 1 - Math.pow(1 - p, 3);
    const cur = target * eased;
    el.textContent = fmt.format(cur) + suffix;
    if(p < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}
(async function initDev(){
  const val = document.getElementById('val');
  const cur = document.getElementById('cur');
  const percentEl = document.getElementById('percent');
  const last = document.getElementById('lastUpdateDev');
  try{
    const { dev, pim, lastTs } = await fetchDevengadoData();
    const perc = pim > 0 ? (dev / pim * 100) : 0;
    [val,cur,percentEl].forEach(el=>el.classList.add('ready'));
    const fmtInt  = new Intl.NumberFormat('es-PE', { maximumFractionDigits: 0 });
    const fmtPerc = new Intl.NumberFormat('es-PE', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    animateNumberFmt(val, dev, 1700, fmtInt);
    animateNumberFmt(percentEl, perc, 1700, fmtPerc, "%");
    last.textContent = "Actualizado al " + formatEsDate(lastTs);
  }catch(e){
    val.textContent="—"; percentEl.textContent="—"; last.textContent="Actualizado al —"; [val,cur,percentEl].forEach(el=>el.classList.add('ready'));
  }
})();
</script>
</body>
</html>
