<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MVCS – Presupuesto y Rankings 2025</title>
  <!-- Cargamos la misma fuente de ambos documentos una sola vez -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
  <!-- ArcGIS API for the map section -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>

  <!--
    Unificamos los estilos de ambas páginas dentro de un único bloque.  Se conservan
    las variables CSS de cada documento para evitar conflictos.  El orden de
    definición mantiene la semántica original de cada sección.  Si aparecen
    variables con nombres distintos no habrá colisión.
  -->
  <style>
    /* ============ Estilos de la página de Presupuesto público ============ */
    :root{
      --accent-red:#d00000;
      --txt-main:#ffffff;
      --azul-mvcs:#1e6eb6;
      --celeste-pim:#5ebad6;
      --gris-fondo:#f8f9fa;
      --gris-borde:#d1d5db;
      --gris-texto:#1e293b;
      --gris-sec:#4b5563;
      /* Fondo general de la página ahora será blanco para evitar zonas grises */
      --bg-page:#ffffff;
      --bg-white:#ffffff;
    }

    /* RESET */
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:'Nunito Sans',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg-page);
      color:#111;
      line-height:1.5;
    }

    /* ================= HERO ================= */
    .hero{
      position:relative;
      width:100%;
      height:100vh;
      min-height:640px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      background:#000;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:0;
      background-image:url("https://lh3.googleusercontent.com/d/1Dm-riCsGjefQDoFktMgwsSRQNI_T8YaT=w1600");
      background-size:cover;
      background-position:center;
      z-index:0;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:0;
      z-index:1;
      background:linear-gradient(to bottom,rgba(0,0,0,0) 60%,rgba(0,0,0,0.45) 85%,rgba(0,0,0,0.7) 100%);
    }

    .hero-header{
      position:relative;
      z-index:5;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      row-gap:1rem;
      padding:1.2rem 3rem 0;
      color:var(--txt-main);
    }
    .hero-header img{height:48px;object-fit:contain;}
    nav.hero-nav{display:flex;flex-wrap:wrap;gap:2.2rem;justify-content:center;}
    nav.hero-nav a{color:var(--txt-main);text-decoration:none;font-weight:600;font-size:0.95rem;transition:.3s;}
    nav.hero-nav a:hover{color:#ffdddd;}

    .hero-content{
      position:relative;
      z-index:5;
      width:100%;
      height:100%;
      padding:0 4rem 5rem;
      color:var(--txt-main);
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(420px,36%);
      column-gap:5rem;
      align-items:center;
      justify-items:center;
      transform:translateY(4cm);
    }
    .hero-left{
      max-width:min(880px,90%);
      align-self:center;
      justify-self:start;
      margin-left:1.5rem;
      text-shadow:0 2px 12px rgba(0,0,0,.35);
    }
    .hero-title{
      font-family:'Nunito Sans',sans-serif;
      font-size:clamp(52px,8vw,88px);
      font-weight:900;
      line-height:1.02;
      position:relative;
      margin-bottom:1rem;
      color:var(--txt-main);
    }
    .hero-underline{
      position:absolute;
      bottom:-10px;
      left:0;
      height:6px;
      background:var(--accent-red);
      width:0;
      animation:underline 3.5s ease-out forwards;
    }
    @keyframes underline{from{width:0;}to{width:100%;}}
    .hero-sub{
      font-size:1.05rem;
      color:rgba(255,255,255,0.9);
      font-weight:700;
      margin-top:.9rem;
      text-shadow:0 2px 10px rgba(0,0,0,.35);
    }
    .hero-right{
      max-width:540px;
      justify-self:start;
      font-size:1.22rem;
      line-height:1.65;
      font-weight:400;
      color:var(--txt-main);
      text-align:left;
      text-shadow:0 2px 10px rgba(0,0,0,.35);
    }
    .hero-right b{font-weight:800;}

    /* RESPONSIVE HERO */
    @media(max-width:1000px){
      .hero-content{
        grid-template-columns:1fr;
        row-gap:2rem;
        padding:0 2rem 4rem;
        transform:translateY(2cm);
      }
      .hero-left{justify-self:start;margin-left:0;}
      .hero-right{justify-self:start;max-width:680px;font-size:1.1rem;}
    }

    /* ============= BLOQUE PIM ============= */
    .pim-block{
      background:var(--gris-fondo);
      border-top:1px solid var(--gris-borde);
      padding:3rem 1rem 3.5rem;
      text-align:center;
      color:var(--gris-texto);
    }
    .pim-title{
      font-size:1rem;
      font-weight:700;
      margin-bottom:1rem;
      color:var(--gris-texto);
      text-align:center;
    }
    .pim-center-wrap{display:grid;place-items:center;margin-bottom:1.25rem;}
    .pim-row{display:inline-flex;align-items:flex-end;gap:.8rem;transform-origin:center bottom;}
    .pim-prefix{font-weight:800;color:var(--azul-mvcs);transform:translateY(-6%);font-size:clamp(32px,3vw,52px);opacity:0;transition:.35s ease;}
    .pim-amount{font-weight:900;color:var(--azul-mvcs);font-size:clamp(50px,5vw,88px);opacity:0;transform:translateY(8px);transition:.35s ease;}
    .pim-amount.ready{opacity:1;transform:translateY(0);} .pim-prefix.ready{opacity:1;transform:translateY(0);}
    .data-source{font-size:.85rem;line-height:1.4;color:var(--gris-sec);text-align:center;font-weight:400;font-style:normal;}
    .data-source b{color:#000;font-weight:700;font-style:normal;}
    .data-source em{font-style:italic;color:#555;font-weight:400;}

    /* ============ ÁREAS DE ACCIÓN ============ */
    .areas-wrapper{
      background:var(--bg-white);
      border-top:1px solid var(--gris-borde);
      padding:5rem 2rem 6rem;
    }
    .areas-header{text-align:center;margin-bottom:3rem;}
    .areas-title{display:inline-block;font-size:1.7rem;font-weight:800;color:var(--azul-mvcs);position:relative;padding-bottom:.6rem;}
    .areas-title::after{content:"";position:absolute;left:0;bottom:0;height:4px;width:100%;background:var(--accent-red);}
    .areas-grid{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:3rem 3rem;align-items:center;}
    .col-left,.col-right{display:flex;flex-direction:column;justify-content:center;gap:2.5rem;opacity:0;transition:all .7s ease;}
    .col-left{transform:translateX(-50px);} .col-right{transform:translateX(50px);} .col-left.visible,.col-right.visible{opacity:1;transform:translateX(0);}
    .area-block-text{font-size:1rem;line-height:1.6;color:#1f2937;text-align:justify;}
    .area-block-text b{font-weight:700;} .area-block-text ul{margin-top:.6rem;margin-bottom:1.2rem;padding-left:1.25rem;}
    .area-block-text li{list-style:disc;margin-bottom:.3rem;}
    .area-img{width:100%;background:#fff;overflow:hidden;border-radius:8px;box-shadow:0 6px 14px rgba(0,0,0,0.08);}
    .area-img img{width:100%;height:auto;display:block;object-fit:cover;}

    /* ============ INVERSIÓN POR ACTIVIDAD / PROYECTO ============ */
    .inv-wrapper{
      background:var(--bg-white);
      padding:3rem 1rem 3rem 1rem;
      text-align:center;
      color:var(--gris-texto);
    }
    .inv-h2{font-size:1rem;font-weight:700;margin-bottom:1.25rem;color:var(--gris-texto);text-align:center;}
    .inv-chart-zone{max-width:900px;margin:0 auto;display:flex;flex-direction:column;align-items:center;}
    .inv-chart-wrap{position:relative;width:100%;height:180px;margin-bottom:1rem;}
    #chart{width:100%;height:100%;display:block;}
    .inv-tip{position:absolute;pointer-events:none;background:#fff;border:1px solid #d1d5db;border-radius:8px;box-shadow:0 10px 28px rgba(0,0,0,.15);padding:.6rem .75rem;font-size:12px;line-height:1.4;color:#1e293b;font-weight:400;min-width:180px;max-width:260px;opacity:0;transform:translate(-50%,-110%);transition:opacity .12s ease;text-align:left;}
    .inv-tip-row{display:flex;justify-content:space-between;gap:.75rem;white-space:nowrap;}
    .inv-tip-key{color:#6b7280;font-weight:400;} .inv-tip-val{color:#1e293b;font-weight:800;}
    .inv-legend{display:flex;flex-wrap:wrap;justify-content:center;gap:1.25rem;font-size:.8rem;font-weight:600;color:#1e1e1e;margin-bottom:1rem;}
    .inv-leg-item{display:flex;align-items:center;gap:.5rem;white-space:nowrap;}
    .inv-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
    .inv-dot-dev{background:var(--azul-mvcs);} .inv-dot-pim{background:var(--celeste-pim);}
    .inv-source{font-size:.85rem;line-height:1.4;color:var(--gris-sec);text-align:center;font-weight:400;font-style:normal;}
    .inv-source strong{color:#000;font-weight:700;font-style:normal;}
    .inv-source span#lastUpdate{font-style:italic;color:#555;font-weight:400;}

    /* ====== CÓMO VAMOS (banner azul con ciudadana) ====== */
    .status-hero{
      position:relative;width:100%;
      background-image:url("https://lh3.googleusercontent.com/d/1k1_vSVxnS7PYTiqV8M2Y5_Xli6qHmPzO=w1600");
      background-size:cover;background-position:center;
      color:#fff;overflow:visible;
      padding:4rem 1rem 4rem;
    }
    .status-hero::after{
      content:"";position:absolute;inset:0;
      background:linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.45));
    }
    .status-inner{
      position:relative;z-index:3;max-width:1200px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      gap:2rem;flex-wrap:wrap;padding-left:4vw;
    }
    .status-left{flex:1 1 620px;text-align:left;position:relative;z-index:5;}
    .status-title{font-weight:900;font-size:clamp(24px,2.8vw,36px);color:#fff;line-height:1.2;margin-bottom:0.25rem;text-shadow:0 2px 4px rgba(0,0,0,.45)}
    .status-title .u{position:relative;display:inline-block;padding-bottom:6px}
    .status-title .u::after{content:"";position:absolute;left:0;bottom:0;height:4px;background:var(--accent-red);width:0;animation:underline 1.8s ease-out forwards;}
    .status-subtitle{font-size:.9rem;font-weight:800;opacity:.95;margin-bottom:1.2rem;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.45)}
    .dev-row{display:flex;align-items:baseline;justify-content:flex-start;gap:.4rem;flex-wrap:nowrap}
    .dev-prefix{font-weight:900;color:#fff;line-height:1;font-size:clamp(40px,5vw,70px);opacity:0;transform:translateY(8px);transition:.35s ease;text-shadow:0 4px 8px rgba(0,0,0,.55)}
    .dev-amount{font-weight:900;color:#fff;line-height:1.03;font-size:clamp(56px,8vw,110px);letter-spacing:.01em;white-space:nowrap;opacity:0;transform:translateY(8px);transition:.35s ease;text-shadow:0 4px 8px rgba(0,0,0,.55)}
    .dev-percent{font-weight:900;color:#fff;margin-top:.85rem;font-size:clamp(18px,1.8vw,28px);opacity:0;transform:translateY(8px);transition:.35s ease;text-shadow:0 3px 6px rgba(0,0,0,.55)}
    .dev-source{margin-top:1rem;font-size:.85rem;line-height:1.35;color:#dbe2ea;text-shadow:0 2px 4px rgba(0,0,0,.7)}
    .dev-source b{color:#fff}.dev-source em{color:#fff;font-style:italic}
    .ready{opacity:1 !important;transform:none !important}
    .status-figure{
      position:absolute;right:0;bottom:-20px;z-index:2;
      width:min(40%,460px);max-width:480px;pointer-events:none;
      opacity:0;
      transform:translate(15%,5%);
      transition:opacity .9s ease-out .2s, transform .9s ease-out .2s;
    }
    .status-figure.animated{
      opacity:1;
      transform:translate(0,-4%);
    }
    .status-figure img{width:100%;height:auto;display:block;object-fit:contain;filter:drop-shadow(0 16px 26px rgba(0,0,0,.6))}
    @media (max-width:1100px) and (min-width:521px){
      .status-inner{padding-left:3vw}
      .status-left{z-index:5;text-align:left}
      .status-figure{width:46%;right:-10px;bottom:-12px;z-index:1;opacity:0.95}
    }
    @media(max-width:1000px){
      .hero-left{left:3rem;bottom:5rem;}
      .hero-title{font-size:3.6rem;}
      .hero-right{right:3rem;top:62%;max-width:440px;font-size:1.05rem;}
      .areas-grid{grid-template-columns:1fr;gap:3rem;}
      .col-left,.col-right{opacity:1;transform:none;}
    }
    @media(max-width:520px){
      .status-inner{flex-direction:column;align-items:center;text-align:center;padding-left:0;padding-bottom:8rem}
      .status-left{text-align:center}
      .dev-row{justify-content:center}
      .status-figure{width:200px;right:5px;bottom:-8px}
    }

    /* ================= Estilos del módulo de Rankings y Desempeño ================ */
    :root{
      /* definiciones adicionales para la sección de rankings */
      --azul:#1e6eb6;
      --azul-osc:#174f84;
      --turquesa:#5ebad6;
      --gap-header:#f3f4f6;
      --rojo:#d00000;
      --ink:#0f172a;
      --muted:#64748b;
      --card:#ffffff;
      --plomo:#f3f4f6;
      --line:#e5e7eb;
      --chip-ok:#16a34a; --chip-mid:#f59e0b; --chip-bad:#ef4444;
      --shadow-card: 0 10px 22px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.05);

    /* Variables de apoyo para la sección de inversiones */
    --blue: var(--azul);
    --sky: var(--turquesa);
    --danger: var(--rojo);
    --shadow: var(--shadow-card);
    --radius: 18px;
    }
    .wrap{max-width:1180px;margin:28px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr;gap:16px} }
    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:28px 24px 22px;
      box-shadow:var(--shadow-card);
      display:flex; flex-direction:column; align-items:center; text-align:center;
    }
    .card p.lead{
      margin:0 0 14px 0; color:#374151; font-size:15px; line-height:1.4; max-width:36ch;
    }
    .kpi{ display:flex; align-items:flex-start; gap:8px; margin:4px 0 10px; }
    .kpi .num{ font-weight:900; font-size:72px; line-height:1; color:var(--azul); }
    .kpi .suf{ position:relative; top:-16px; font-weight:900; font-size:34px; line-height:1; color:var(--azul); }
    .labelPuesto{ margin-top:-6px; font-size:40px; font-weight:900; color:var(--azul); }
    .actions{display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:10px}
    .btn{
      appearance:none; border:2px solid var(--rojo);
      background:transparent; color:var(--rojo); font-weight:800;
      padding:10px 14px; border-radius:999px; cursor:pointer;
      transition:.18s ease; font-size:14px;
    }
    .btn:hover{filter:brightness(.98)}
    /* Estilo para el contenedor de tarjetas de ranking con fondo blanco y sombra */
    #ranking-cards{
      /* Bloque de ranking: contenedor blanco con sombra para agrupar las tarjetas */
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow-card);
      padding:28px 24px;
      margin-top:28px;
      margin-bottom:28px;
    }

    /*
      ==== Estilos para sección de inversiones (pim/devengado) ==== 
      Los estilos originales del módulo de inversiones se adaptan aquí para evitar
      interferir con otras partes del sitio. Utilizan identificadores únicos
      (#sec-inversiones, #sec-generar, #sec-estados) para aislar su alcance.
    */
    #sec-inversiones{
      /* envuelve título y tarjetas */
      max-width:1100px;
      margin:28px auto;
      padding:0 20px;
      display:block;
    }
    #sec-inversiones .grid{
      display:grid;
      gap:28px;
      grid-template-columns:1.15fr .85fr;
      align-items:start;
    }
    @media (max-width:980px){
      #sec-inversiones .grid{grid-template-columns:1fr;}
    }
    #sec-inversiones .title{
      width:max-content;
      position:relative;
      color:var(--azul);
      font-weight:900;
      font-size:clamp(22px,3.2vw,30px);
      margin:0 0 16px;
      padding-bottom:12px;
    }
    #sec-inversiones .title::after{
      content:"";
      position:absolute;
      left:0;
      bottom:0;
      height:6px;
      border-radius:6px;
      background:linear-gradient(90deg,var(--rojo),#ff7b7b);
      width:100%;
      transform:scaleX(0);
      transform-origin:left;
      transition:transform 3s cubic-bezier(.22,1,.36,1);
    }
    #sec-inversiones .title.inview::after{transform:scaleX(1);}
    #sec-inversiones .lead{
      font-size:15px;
      line-height:1.7;
      color:#2d4458;
      margin:0 0 12px;
    }
    #sec-inversiones .src{
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    #sec-inversiones .src em{display:block;margin-top:6px;}
    /* lado derecho */
    #sec-inversiones .topline{
      display:flex;
      align-items:center;
      gap:12px;
    }
    #sec-inversiones .topline img{width:40px;height:40px;object-fit:contain;}
    #sec-inversiones .topline .txt{color:#334b62;font-weight:800;}
    #sec-inversiones .topline .n{color:var(--azul);font-weight:900;font-size:clamp(30px,4.8vw,44px);} 
    #sec-inversiones .stack{display:grid;gap:16px;margin-top:12px;}
    #sec-inversiones .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 20px;
    }
    #sec-inversiones .k-label{color:#6a7f95;font-weight:800;text-transform:uppercase;letter-spacing:.02em;font-size:13px;}
    #sec-inversiones .k-value{color:var(--azul);font-size:clamp(26px,4.6vw,36px);font-weight:900;line-height:1.15;}
    #sec-inversiones .k-sub{color:var(--sky);font-weight:900;font-size:15px;margin-top:6px;}
    #sec-inversiones .num{display:inline-block;font-variant-numeric:tabular-nums;letter-spacing:.02em;}

    /* contenedor para el lado derecho de inversiones (tarjetas agrupadas) */
    #sec-inversiones .inv-right-card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px 24px;
    }
    #sec-inversiones .inv-right-card .stack{
      margin-top:16px;
    }

    /* se espera generar y estados */
    .gen-wrap{
      max-width:1100px;
      margin:16px auto 36px;
      padding:0 20px;
      font-family:"Nunito Sans",system-ui,Segoe UI,Roboto,Arial;
    }
    .gen-pill{
      display:block;
      width:100%;
      background:var(--sky);
      color:#fff;
      font-weight:900;
      text-align:center;
      padding:10px 14px;
      border-radius:999px;
      margin:4px 0 18px;
      letter-spacing:.2px;
    }
    #sec-estados .gen-pill{background:var(--azul);}
    .gen-grid{display:grid;gap:16px;grid-template-columns:1fr 1fr;}
    @media (max-width:900px){
      .gen-grid{grid-template-columns:1fr;}
    }
    #sec-estados .gen-grid{grid-template-columns:repeat(4,1fr);}
    @media (max-width:900px){#sec-estados .gen-grid{grid-template-columns:repeat(2,1fr);} }
    .gen-card{
      display:grid;
      grid-template-columns:auto 1fr;
      gap:12px;
      align-items:center;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px 18px;
    }
    #sec-estados .gen-card{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:20px 16px;
    }
    #sec-estados .gen-card .gen-label{
      margin:0 0 8px;
      font-size:14px;
      line-height:1.3;
    }
    #sec-estados .gen-card .gen-value{
      font-size:clamp(28px,4.5vw,36px);
    }
    .gen-left img{width:56px;height:56px;object-fit:contain;}
    .gen-label{margin:0 0 6px;color:#4a5f74;font-size:15px;font-weight:900;}
    .gen-value{color:var(--azul);font-weight:900;font-size:clamp(26px,4.2vw,36px);line-height:1.1;}
    /* área de tabla compartida */
    .tableSection{ max-width:1180px; margin:18px auto 8px; padding:0 16px; }
    .tableShell{
      background:#fff; border:1px solid var(--line); border-radius:14px;
      box-shadow:0 14px 28px rgba(2,6,23,.08); overflow:hidden;
      max-height:0; transition:max-height .28s ease;
    }
    .tableShell.open{ max-height:320px; }
    .status{ padding:10px; font-weight:700; color:var(--muted) }
    .status.error{ color:#b91c1c }
    .scroller{ overflow:auto; max-height:320px; }
    table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; font-size:13px }
    thead th{
      position:sticky; top:0; z-index:2;
      background:var(--turquesa); color:#ffffff;
      font-weight:800; letter-spacing:.2px;
      padding:12px 10px; text-align:center; border-bottom:2px solid #ffffff00;
      border-right:6px solid var(--gap-header);
    }
    thead th:first-child{ border-top-left-radius:14px; }
    thead th:last-child{ border-right:none; border-top-right-radius:14px; }
    tbody td{ padding:10px 8px; border-bottom:1px solid var(--line); text-align:center }
    tbody tr:nth-child(odd){ background:#f9fcfb }
    td.num{ font-variant-numeric:tabular-nums }
    col.c-rk{width:8%} col.c-sec{width:36%} col.c-pia{width:14%} col.c-pim{width:14%} col.c-dev{width:18%} col.c-avz{width:10%}
    /* bloque desempeño (franja plomo) */
    .perf{
      background:var(--plomo);
      border-top:1px solid var(--line);
      padding:48px 16px 54px;
      margin-top:24px;
    }
    .perf .box{max-width:980px;margin:0 auto;text-align:center}
    .perf h2{
      font-size:30px; color:var(--azul); font-weight:900; margin:0 0 12px 0;
      display:inline-block; position:relative;
    }
    .perf h2::after{ content:""; position:absolute; left:0; right:0; bottom:-6px; height:4px; background:var(--rojo); }
    .perf p{max-width:78ch;margin:12px auto 16px;color:#374151}
    .perf .actions{margin-top:10px}
    /* tabla por ejecutora (full-bleed, fondo blanco) */
    .exec-wrap{
      width:100vw;
      margin-left:calc(50% - 50vw);
      margin-right:calc(50% - 50vw);
      background:#fff;
    }
    .card-flat{
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      border-left:0;border-right:0;
      border-radius:0;
      box-shadow:0 14px 28px rgba(2,6,23,.08);
      overflow:hidden;
    }
    .header-flat{padding:12px 16px 8px;text-align:center;background:#fff}
    .title-flat{margin:0;font-weight:800;font-size:19px;color:var(--ink)}
    .legend{margin:8px 0 12px 0;display:flex;justify-content:center;gap:14px;font-size:12.5px;color:#111827;font-weight:600}
    .legend .dot{width:.62rem;height:.62rem;border-radius:999px;display:inline-block;margin-right:.38rem;vertical-align:-.1rem}
    .table-wrap{max-height:70vh;overflow:auto}
    .table-exec{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;font-size:13.5px}
    .table-exec thead th{
      position:sticky;top:0;z-index:40;
      background:var(--turquesa);color:#fff;font-weight:800;padding:11px 8px;text-align:center;
      border-bottom:2px solid #ffffff00;border-right:6px solid var(--gap-header);
    }
    .table-exec thead th.sticky-left{left:0;z-index:50;text-align:left;background:var(--turquesa);box-shadow:6px 0 8px -6px rgba(0,0,0,.18)}
    .table-exec th+th,.table-exec td+td{border-left:1px solid var(--line)}
    .table-exec tbody td,.table-exec tbody th{padding:9px 7px;border-bottom:1px solid var(--line);background:#fff;vertical-align:middle}
    .table-exec tbody tr:nth-child(odd){background:#f9fcfb}
    .num{text-align:right;white-space:nowrap;font-variant-numeric:tabular-nums}
    .pct{text-align:center;white-space:nowrap;font-variant-numeric:tabular-nums}
    .table-exec tbody td.sticky,
    .table-exec tbody th.sticky{
      position:sticky;left:0;z-index:45;background:#fff;box-shadow:6px 0 8px -6px rgba(0,0,0,.18);text-align:left
    }
    .btn-expand{
      border:0;background:transparent;font-weight:800;cursor:pointer;
      padding:4px 0;border-radius:8px;text-align:left;color:var(--ink);
      display:inline-flex;align-items:flex-start;gap:6px;max-width:100%;
    }
    .chev{
      --chev-color:#ea580c;--chev-glow:rgba(234,88,12,.45);
      width:1.35rem;height:1.35rem;position:relative;display:grid;place-items:center;flex-shrink:0;
    }
    .chev .arrow{
      position:absolute;width:16px;height:16px;opacity:0;
      filter:drop-shadow(0 5px 10px var(--chev-glow));
      animation:chevDrip 1.8s ease-in-out infinite
    }
    .chev .arrow:nth-child(2){animation-delay:.22s}
    .chev .arrow:nth-child(3){animation-delay:.44s}
    @keyframes chevDrip{
      0%{transform:translateY(-8px) scale(.95);opacity:0}
      20%{transform:translateY(-2px) scale(1);opacity:1}
      60%{transform:translateY(6px) scale(1.04);opacity:.95}
      100%{transform:translateY(12px) scale(1);opacity:0}
    }
    .btn-expand:hover .chev{--chev-color:#ff6b1a;--chev-glow:rgba(255,107,26,.5)}
    .btn-expand[aria-expanded="true"] .chev{--chev-color:#0ea5e9;--chev-glow:rgba(14,165,233,.45)}
    .infoBtn{
      position:relative;display:inline-flex;align-items:center;justify-content:center;
      width:34px;height:34px;border-radius:10px;cursor:pointer;text-decoration:none;
      background:radial-gradient(circle at 30% 30%, #38bdf8 0%, #0284c7 60%, #01497a 100%);
      border:1.5px solid rgba(255,255,255,0.4);
      box-shadow:0 0 14px rgba(56,189,248,.7), 0 6px 16px rgba(2,132,199,.4);
      overflow:hidden;transition:transform .2s ease;
    }
    .infoBtn:hover{transform:scale(1.08)}
    .infoBtn svg{width:20px;height:20px;stroke:#fff;stroke-width:2.2;fill:none}

    /*
      Los puntos de avance en la tabla de ejecutoras necesitan un tamaño y forma
      consistente.  Definimos la clase .dot para que cualquier span con este
      nombre tenga un diámetro pequeño, redondo y con margen derecho.  El color
      de fondo se define en línea mediante style o mediante clases
      (.bad/.mid/.ok), por lo que no se establece aquí.
    */
    .dot{
      display:inline-block;
      width:.58rem;
      height:.58rem;
      border-radius:999px;
      vertical-align:-.08rem;
      margin-right:.32rem;
    }

    /* ===================== MAP SECTION STYLES ===================== */
    #map-section .wrap{
      max-width:1200px;margin:0 auto;padding:28px 20px 10px;box-sizing:border-box;
    }
    #map-section .intro{ text-align:center;margin:0 auto 18px;color:var(--ink); }
    #map-section .intro h2{
      color:var(--azul);
      font-weight:900;font-size:clamp(22px,3.2vw,28px);
      display:inline-block;position:relative;margin:0 0 18px;
      padding-bottom:10px;
    }
    #map-section .intro h2::after{
      content:"";position:absolute;left:0;bottom:0;height:4px;width:100%;
      background:var(--rojo);
      transform:scaleX(0);transform-origin:left center;
      transition:transform .7s cubic-bezier(.22,.9,.3,1);border-radius:999px;
    }
    #map-section .intro h2.in-view::after{ transform:scaleX(1); }
    #map-section .intro p{
      margin:0 auto 10px;max-width:900px;line-height:1.55;color:#4b5563;
      font-size:clamp(14px,1.5vw,16.5px);
    }
    #map-section .page{ display:grid;place-items:center;padding:0 20px 0;box-sizing:border-box; }
    #map-section .map-card{
      width:min(1200px,92vw);height:min(72vh,760px);
      background:var(--card);border:1px solid var(--line);border-radius:16px;
      box-shadow:var(--shadow-card);position:relative;overflow:hidden;
    }
    #map-section #map-viewDiv{ position:absolute;inset:0; }
    #map-section .search-wrap{ position:absolute;top:14px;right:14px;z-index:6; }
    #map-section .search-fab{
      width:44px;height:44px;border-radius:999px;cursor:pointer;
      border:1px solid #e5e7eb;background:#ffffff;display:grid;place-items:center;
      box-shadow:0 8px 20px rgba(2,6,23,.18);
    }
    #map-section .search-fab svg{ width:22px;height:22px;display:block; }
    #map-section .search-fab .ring{ stroke:var(--rojo);stroke-width:3;fill:none; }
    #map-section .search-fab .handle{ stroke:var(--rojo);stroke-width:3;stroke-linecap:round; }
    #map-section .search-content{
      display:none;position:absolute;top:100%;right:0;margin-top:8px;
      background:#fff;border:1px solid var(--line);border-radius:14px;
      box-shadow:0 10px 24px rgba(2,6,23,.12);padding:10px;width:320px;
    }
    #map-section .search-content.open{ display:block; }
    #map-section .search-input-wrap{ display:flex;align-items:center;gap:8px; }
    #map-section .search-input{
      flex:1;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-weight:700;
    }
    #map-section .clear-btn{
      border:none;background:#f3f4f6;border:1px solid #e5e7eb;
      width:36px;height:36px;border-radius:10px;cursor:pointer;font-size:18px;line-height:0;
      display:grid;place-items:center;
    }
    #map-section .suggestions{ list-style:none;padding:6px 0 0;margin:6px 0 0;max-height:240px;overflow-y:auto; }
    #map-section .suggestions li{ padding:8px 10px;cursor:pointer;border-bottom:1px solid #f2f2f2;font-weight:700;color:var(--ink); }
    #map-section .suggestions li:hover{ background:#f0f7f6; }
    #map-section .filter-wrap{ position:absolute;top:14px;left:14px;z-index:6; }
    #map-section .filter-btn{
      background:#ffffff;color:var(--azul);
      border:1px solid var(--line);padding:8px 12px;border-radius:10px;
      font-weight:900;cursor:pointer;box-shadow:0 8px 20px rgba(2,6,23,.12);
      font-size:14px;
    }
    #map-section .filter-btn:hover{ border-color:#d5dae1;color:var(--azul-osc); }
    #map-section .filter-panel{
      display:none;position:absolute;top:100%;left:0;margin-top:8px;
      background:#fff;border:1px solid var(--line);border-radius:14px;
      box-shadow:0 10px 24px rgba(2,6,23,.12);width:260px;overflow:hidden;
    }
    #map-section .filter-panel.open{ display:block; }
    #map-section .fp-head{ background:var(--azul);color:#ffffff;padding:8px 10px;font-weight:900;font-size:13px; }
    #map-section .fp-body{ padding:8px 10px;max-height:180px;overflow:auto; }
    #map-section .fp-body label{ display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12.5px;color:var(--ink);cursor:pointer; }
    #map-section .fp-body input[type="checkbox"]{ accent-color:var(--azul); }
    #map-section .fp-body input[type="checkbox"]:checked + span{ color:var(--rojo);font-weight:900; }
    #map-section .reset-wrap{ position:absolute;bottom:14px;left:14px;z-index:6; }
    #map-section .reset-btn{
      width:44px;height:44px;border-radius:999px;cursor:pointer;
      border:1px solid #e5e7eb;background:#ffffff;display:grid;place-items:center;
      box-shadow:0 8px 20px rgba(2,6,23,.18);font-size:20px;color:var(--rojo);
      transition:transform .2s ease,background .2s ease;
    }
    #map-section .reset-btn:hover{ background:#fdf2f2;transform:scale(1.08); }
    #map-section .table-section{ padding:12px 20px 28px; }
    #map-section .table-wrap{ max-width:1200px;margin:0 auto; }
    #map-section .title-row{ display:flex;align-items:center;justify-content:center;margin:10px 0 10px 0; }
    #map-section .title-row h3{ margin:0;font-weight:900;font-size:clamp(18px,2.8vw,22px);color:var(--azul);letter-spacing:.2px; }
    #map-section .status{ font-weight:800;color:#334155;margin:8px 0 12px;font-size:13px;text-align:center; }
    #map-section .tableWrap{
      background:#fff;border:1px solid var(--line);
      border-radius:var(--radius);box-shadow:var(--shadow-card);
      position:relative;overflow:hidden;
    }
    #map-section .scrollY{ overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch; }
    #map-section .scrollY::-webkit-scrollbar{ width:10px; }
    #map-section .scrollY::-webkit-scrollbar-track{ background:#f1f5f9; }
    #map-section .scrollY::-webkit-scrollbar-thumb{ background:#cbd5e1;border-radius:6px;border:2px solid #f1f5f9; }
    #map-section .scrollY:hover::-webkit-scrollbar-thumb{ background:#94a3b8; }
    @media (max-width:900px){
      #map-section .scrollY{ overflow-x:auto; }
      #map-section .scrollY::-webkit-scrollbar{ height:10px;width:10px; }
    }
    #map-section table{ width:100%;min-width:1100px;border-collapse:separate;border-spacing:0;table-layout:fixed; }
    #map-section thead th{
      position:sticky;top:0;z-index:2;
      background:var(--turquesa);color:#fff;
      font-weight:800;letter-spacing:.2px;
      padding:8px 6px;text-align:center;font-size:12.5px;
    }
    #map-section tbody td{
      border-top:1px solid var(--line);border-right:1px solid var(--line);
      padding:7px;vertical-align:top;
      font-size:12px;line-height:1.35;text-align:center;
      word-break:break-word;hyphens:auto;
    }
    #map-section tbody td:last-child,
    #map-section thead th:last-child{ border-right:none; }
    #map-section tbody tr:nth-child(odd){ background:var(--row-alt); }
    #map-section .num{ font-variant-numeric:tabular-nums;text-align:center;white-space:nowrap; }
    #map-section .inv-cell{ position:relative;overflow:visible; }
    #map-section .ellip-text{ display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center; }
    #map-section .inv-cell[data-tip]::after{
      content:attr(data-tip);position:absolute;left:50%;bottom:100%;
      transform:translate(-50%,-6px);
      background:var(--azul);color:#fff;padding:6px 8px;border-radius:8px;max-width:560px;
      white-space:normal;line-height:1.25;font-size:11.5px;pointer-events:none;z-index:50;
      border:1px solid rgba(8,31,28,.35);box-shadow:0 6px 14px rgba(0,0,0,.18);
      opacity:0;visibility:hidden;transition:opacity .12s ease,visibility .12s ease;
    }
    #map-section .inv-cell[data-tip]::before{
      content:"";position:absolute;left:50%;bottom:100%;
      transform:translate(-50%,-2px);
      border:6px solid transparent;border-top-color:var(--azul);
      z-index:51;opacity:0;visibility:hidden;transition:opacity .12s ease,visibility .12s ease;
    }
    #map-section .inv-cell:hover::after,
    #map-section .inv-cell:hover::before{ opacity:1;visibility:visible; }
    #map-section a.chipLink{ color:var(--rojo);font-weight:900;text-decoration:none;font-size:12px; }
    #map-section a.chipLink:hover{ text-decoration:underline; }
    #map-section .pill{ background:#f3f4f6;color:#334155;padding:3px 6px;border-radius:999px;font-weight:800;display:inline-block;font-size:11.5px; }
  </style>
</head>
<body>
  <!-- ========== Sección original: Presupuesto público 2025 ========== -->
  <section class="hero">
    <header class="hero-header">
      <img src="https://lh3.googleusercontent.com/d/1EjnXS6iO0TkdAzQyg3rstHw4XL7Mk59g=w1000" alt="MVCS Logo"/>
      <nav class="hero-nav">
        <a href="#areas">Áreas de acción</a>
        <a href="#avance">¿Cómo vamos?</a>
        <a href="#desempeno">Desempeño financiero</a>
        <a href="#inversiones">Inversiones</a>
        <a href="#proyectos">Grandes proyectos</a>
        <a href="#multitemporal">Imágenes multitemporales</a>
      </nav>
    </header>
    <div class="hero-content">
      <div class="hero-left">
        <h1 class="hero-title">
          Presupuesto<br>público 2025
          <span class="hero-underline"></span>
        </h1>
        <div class="hero-sub">Ministerio de Vivienda, Construcción y Saneamiento</div>
      </div>
      <div class="hero-right">
        <p>
          El presupuesto sectorial fomentará la economía local,
          la generación de puestos de trabajo, y acelerará el
          <b>cierre de brechas de agua potable, saneamiento, vivienda,
          equipamiento urbano y formalización predial.</b>
        </p>
      </div>
    </div>
  </section>
  <!-- BLOQUE PIM -->
  <section class="pim-block" id="pim">
    <h2 class="pim-title">Presupuesto Institucional Modificado 2025</h2>
    <div class="pim-center-wrap">
      <div class="pim-row" id="pim-row">
        <div class="pim-prefix" id="pim-cur">S/</div>
        <div class="pim-amount" id="pim-val">0</div>
      </div>
    </div>
    <p class="data-source">
      <b>Fuente:</b> Ministerio de Economía y Finanzas – MEF<br/>
      Portal de Datos Abiertos – <em id="pim-lastUpdate">Actualizado al —</em>
    </p>
  </section>
  <!-- ÁREAS DE ACCIÓN -->
  <section class="areas-wrapper" id="areas">
    <div class="areas-header">
      <h2 class="areas-title">Áreas de acción</h2>
    </div>
    <div class="areas-grid">
      <div class="col-left" id="col-left">
        <div class="area-block-text">
          <p><b>Ejecución de obras de agua potable y saneamiento a nivel nacional,</b> a través del:</p>
          <ul>
            <li>Programa Nacional de Saneamiento Urbano (PNSU).</li>
            <li>Programa Nacional de Saneamiento Rural (PNSR).</li>
            <li>Programa Agua Segura para Lima y Callao (PASLC).</li>
          </ul>
          <p>
            Reactivación de proyectos de agua y saneamiento urbano, en beneficio de la población; y el financiamiento de la elaboración de estudios de preinversión para ejecutarse a nivel nacional.
          </p>
        </div>
        <div class="area-img">
          <img src="https://lh3.googleusercontent.com/d/1XE4OUAOoZiEEKayGMRe9C0BSTCm0Do9u=w1000" alt="Proyecto rural de vivienda"/>
        </div>
      </div>
      <div class="col-right" id="col-right">
        <div class="area-img">
          <img src="https://lh3.googleusercontent.com/d/1Rlix_IzbFNm1s9DyFFlHNW-7nnYcz-5e=w1000" alt="Obras de agua y saneamiento urbano"/>
        </div>
        <div class="area-block-text">
          <p><b>Promoción de viviendas urbanas,</b> a través del:</p>
          <ul>
            <li>Bono Familiar Habitacional de Techo Propio.</li>
            <li>Bono del Buen Pagador del Crédito Mivivienda.</li>
            <li>Bono de Arrendamiento de Viviendas para Emergencias (BAE).</li>
            <li>Viviendas Wasiymi para las zonas rurales, destinadas a atender a personas en situación de pobreza o pobreza extrema que viven en zonas de heladas y friaje.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>
  <!-- INVERSIÓN POR ACTIVIDAD / PROYECTO -->
  <section class="inv-wrapper" id="avance">
    <div class="inv-chart-zone">
      <h2 class="inv-h2 pim-title">Inversión pública por actividad / proyecto 2025</h2>
      <div class="inv-chart-wrap" id="wrap">
        <canvas id="chart"></canvas>
        <div id="tip" class="inv-tip"></div>
      </div>
      <div class="inv-legend">
        <span class="inv-leg-item">
          <span class="inv-dot inv-dot-dev"></span>
          <span>Monto devengado</span>
        </span>
        <span class="inv-leg-item">
          <span class="inv-dot inv-dot-pim"></span>
          <span>Monto PIM</span>
        </span>
      </div>
      <p class="inv-source data-source">
        <b>Fuente:</b> Ministerio de Economía y Finanzas – MEF<br/>
        Portal de Datos Abiertos – <span id="lastUpdate"><em>Actualizado al —</em></span>
      </p>
    </div>
  </section>
  <!-- Banner ¿Cómo vamos? -->
  <section class="status-hero" id="como-vamos">
    <div class="status-figure">
      <img src="https://lh3.googleusercontent.com/d/16r2oP5b4bTadCXGsHO3EiiZbll7yrCdY=w1000" alt="Ciudadana beneficiaria">
    </div>
    <div class="status-inner">
      <div class="status-left">
        <h2 class="status-title"><span class="u">¿Cómo vamos?</span></h2>
        <div class="status-subtitle">Presupuesto Devengado 2025</div>
        <div class="dev-row">
          <span class="dev-prefix" id="cur">S/</span>
          <span class="dev-amount" id="val">0</span>
        </div>
        <div class="dev-percent" id="percent">0%</div>
        <div class="dev-source">
          <b>Fuente:</b> Ministerio de Economía y Finanzas – MEF<br/>
          Portal de Datos Abiertos – <em id="lastUpdateDev">Actualizado al —</em>
        </div>
      </div>
    </div>
  </section>
  <!-- ========== Sección Rankings y Desempeño por Ejecutora ========== -->
  <!-- Sección de ranking de puestos: envolvemos la grid en un contenedor con fondo blanco -->
  <div class="wrap" id="ranking-cards">
    <div class="grid" id="cards">
      <article class="card" data-key="left">
        <p class="lead">El Ministerio de Vivienda, Construcción y Saneamiento se encuentra en el ranking entre sectores en el:</p>
        <div class="kpi" aria-live="polite">
          <span class="num" id="kpi-left">—</span><span class="suf">°</span>
        </div>
        <div class="labelPuesto">puesto</div>
        <div class="actions">
          <button class="btn" data-action="toggle" data-side="left">Ver tabla</button>
          <button class="btn" data-action="excel" data-side="left">Exportar a Excel</button>
        </div>
      </article>
      <article class="card" data-key="right">
        <p class="lead">A nivel de inversiones, el ministerio se encuentra en el ranking entre sectores en el:</p>
        <div class="kpi" aria-live="polite">
          <span class="num" id="kpi-right">—</span><span class="suf">°</span>
        </div>
        <div class="labelPuesto">puesto</div>
        <div class="actions">
          <button class="btn" data-action="toggle" data-side="right">Ver tabla</button>
          <button class="btn" data-action="excel" data-side="right">Exportar a Excel</button>
        </div>
      </article>
    </div>
  </div>
  <!-- Área de tabla compartida -->
  <section class="tableSection">
    <div id="tableShell" class="tableShell" aria-live="polite">
      <div id="state" class="status" role="status">—</div>
      <div class="scroller" id="scroller" style="display:none">
        <table id="tbl">
          <colgroup>
            <col class="c-rk"><col class="c-sec"><col class="c-pia"><col class="c-pim"><col class="c-dev"><col class="c-avz">
          </colgroup>
          <thead>
            <tr>
              <th>RANKING</th>
              <th>Sector</th>
              <th>PIA</th>
              <th>PIM</th>
              <th>Devengado</th>
              <th>Avance(%)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>
  <!-- Bloque desempeño (franja plomo) -->
  <section class="perf" id="desempeno">
    <div class="box">
      <h2>Desempeño financiero por ejecutora</h2>
      <p>
        El presupuesto asignado, comprometido y ejecutado, permite identificar avances y
        desafíos en la gestión de recursos, promoviendo así una gestión eficiente y transparente
        de los recursos públicos asignados para viviendas, infraestructura urbana y saneamiento.
      </p>
      <div class="actions">
        <button id="btnShowExec" class="btn">Ver tabla</button>
        <button id="btnExcelExec" class="btn">Exportar a Excel</button>
      </div>
    </div>
  </section>
  <!-- Tabla por ejecutora -->
  <div class="exec-wrap" id="execWrap" style="display:none">
    <div class="card-flat">
      <div class="header-flat">
        <h3 class="title-flat">Ejecución presupuestal — MVCS (2025) por Pliego y Unidad Ejecutora</h3>
        <div class="legend">
          <span><span class="dot" style="background:#ef4444"></span><strong>Rojo</strong> &lt; 33%</span>
          <span><span class="dot" style="background:#f59e0b"></span><strong>Ámbar</strong> 33%–67%</span>
          <span><span class="dot" style="background:#16a34a"></span><strong>Verde</strong> ≥ 67%</span>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table-exec" id="tblExec">
          <colgroup>
            <col style="width:320px">
            <col style="width:130px"><col style="width:130px"><col style="width:110px">
            <col style="width:130px"><col style="width:130px"><col style="width:110px">
            <col style="width:130px"><col style="width:130px"><col style="width:110px">
          </colgroup>
          <thead>
            <tr>
              <th class="sticky-left">PLIEGO/EJECUTORAS</th>
              <th>PIM ACTIVIDADES<br/>Y PROYECTOS</th>
              <th>DEVENGADO</th>
              <th>AVANCE %</th>
              <th>PIM PROYECTO</th>
              <th>DEVENGADO<br/>PROYECTO</th>
              <th>AVANCE<br/>PROYECTO</th>
              <th>PIM ACTIVIDAD</th>
              <th>DEVENGADO<br/>ACTIVIDAD</th>
              <th>AVANCE<br/>ACTIVIDAD</th>
            </tr>
          </thead>
          <tbody id="tbodyExec"></tbody>
          <tfoot id="tfootExec"></tfoot>
        </table>
      </div>
    </div>
  </div>
  <!-- =================== Scripts combinados =================== -->
  
  <!-- ======================= NUEVO MÓDULO DE INVERSIONES ======================= -->
  <!-- Sección Inversiones (PIM/Devengado) -->
  <section class="wrap" id="sec-inversiones">
    <div class="grid">
      <!-- Izquierda: descripción del módulo -->
      <div>
        <h2 class="title">Inversiones</h2>
        <p class="lead">
          Las inversiones planificadas para el 2025 reflejan el compromiso del MVCS con el cierre de brechas en
          infraestructura y brechas de saneamiento. Estas inversiones forman parte de la planificación estratégica del
          ministerio y responden a las necesidades priorizadas en el territorio, especialmente en sectores vulnerables.
          La planificación contempla obras en saneamiento y vivienda y urbanismo, en coordinación con los gobiernos
          regionales y locales.
        </p>
        <p class="src">
          <strong>Fuente:</strong> Ministerio de Economía y Finanzas – MEF<br/>
          Portal de datos Abiertos – Actualizado al 19 de octubre de 2025
          <em>Incluye inversiones cuyo PIM sea mayor a 0</em>
        </p>
      </div>
      <!-- Derecha: indicadores de inversión agrupados en un contenedor blanco -->
      <div>
        <div class="inv-right-card">
          <div class="topline">
            <img src="https://lh3.googleusercontent.com/d/18tWhc-SzR8dEqrZZs8trBnqa6o9-Y-9P=w1000" alt="Cámara inversiones"/>
            <span class="txt">A través de</span>
            <span class="n num" id="inv-count">0</span>
            <span class="txt">inversiones</span>
          </div>
          <div class="stack">
            <div class="card">
              <div class="k-label">PIM</div>
              <div class="k-value">S/ <span class="num" id="inv-pim">0</span></div>
            </div>
            <div class="card">
              <div class="k-label">Devengado</div>
              <div class="k-value">S/ <span class="num" id="inv-dev">0</span></div>
              <div class="k-sub"><span class="num" id="inv-pct">0</span>%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sección Se espera generar -->
  <section class="gen-wrap" id="sec-generar">
    <div class="gen-pill">Se espera generar</div>
    <div class="gen-grid">
      <!-- Agua -->
      <article class="gen-card">
        <div class="gen-left">
          <img src="https://lh3.googleusercontent.com/d/1U1bT6XOwlWARi7SMsuyox3dSkHRB6CbO=w1000" alt="Conexiones de agua"/>
        </div>
        <div class="gen-right">
          <h3 class="gen-label">Conexiones nuevas de agua</h3>
          <div class="gen-value"><span class="num" id="k-agua">0</span></div>
        </div>
      </article>
      <!-- Alcantarillado -->
      <article class="gen-card">
        <div class="gen-left">
          <img src="https://lh3.googleusercontent.com/d/1FJzFJZKmLqvnDKHUjMWCKAic6RrP2K6j=w1000" alt="Conexiones de alcantarillado"/>
        </div>
        <div class="gen-right">
          <h3 class="gen-label">Conexiones nuevas de alcantarillado</h3>
          <div class="gen-value"><span class="num" id="k-alc">0</span></div>
        </div>
      </article>
      <!-- Pavimento -->
      <article class="gen-card">
        <div class="gen-left">
          <img src="https://lh3.googleusercontent.com/d/1Nov2kbITwZGC3DUR4kwj-yo9vjQZqVqB=w1000" alt="M2 de pavimento"/>
        </div>
        <div class="gen-right">
          <h3 class="gen-label">M2 de pavimento</h3>
          <div class="gen-value"><span class="num" id="k-pav">0</span></div>
        </div>
      </article>
      <!-- Vereda -->
      <article class="gen-card">
        <div class="gen-left">
          <img src="https://lh3.googleusercontent.com/d/1SKZkQW_boA1HSTxnQHwI17DSFM0wPmp5=w1000" alt="M2 de vereda"/>
        </div>
        <div class="gen-right">
          <h3 class="gen-label">M2 de vereda</h3>
          <div class="gen-value"><span class="num" id="k-ver">0</span></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Sección Estados -->
  <section class="gen-wrap" id="sec-estados">
    <div class="gen-pill">Estados</div>
    <div class="gen-grid">
      <!-- Fila 1 -->
      <article class="gen-card">
        <div class="gen-right">
          <h3 class="gen-label">Obras concluidas</h3>
          <div class="gen-value"><span class="num" id="est-obras-concluidas">0</span></div>
        </div>
      </article>
      <article class="gen-card">
        <div class="gen-right">
          <h3 class="gen-label">Obras en ejecución</h3>
          <div class="gen-value"><span class="num" id="est-obras-ejec">0</span></div>
        </div>
      </article>
      <article class="gen-card">
        <div class="gen-right">
          <h3 class="gen-label">Obras por iniciar</h3>
          <div class="gen-value"><span class="num" id="est-obras-iniciar">0</span></div>
        </div>
      </article>
      <article class="gen-card">
        <div class="gen-right">
          <h3 class="gen-label">Obras en proceso de selección</h3>
          <div class="gen-value"><span class="num" id="est-obras-sel">0</span></div>
        </div>
      </article>
      <!-- Fila 2 -->
      <article class="gen-card">
        <div class="gen-right">
          <h3 class="gen-label">Expedientes concluidos</h3>
          <div class="gen-value"><span class="num" id="est-exp-concluidos">0</span></div>
        </div>
      </article>
      <article class="gen-card">
        <div class="gen-right">
          <h3 class="gen-label">Expedientes en elaboración</h3>
          <div class="gen-value"><span class="num" id="est-exp-elab">0</span></div>
        </div>
      </article>
      <article class="gen-card">
        <div class="gen-right">
          <h3 class="gen-label">Expedientes en proceso de selección</h3>
          <div class="gen-value"><span class="num" id="est-exp-sel">0</span></div>
        </div>
      </article>
      <article class="gen-card">
        <div class="gen-right">
          <h3 class="gen-label">Obras en proceso de selección</h3>
          <div class="gen-value"><span class="num" id="est-obras-sel2">0</span></div>
        </div>
      </article>
    </div>
  </section>

  <script>
  /* ----------- Scripts del bloque PIM e inversión ----------- */
  const SERVICE_PIM="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
  const WHERE_PIM="sector_nombre = 'VIVIENDA CONSTRUCCION Y SANEAMIENTO' AND ano_eje = 2025";
  async function fetchPIMandMaxDate(){
    const outStats=JSON.stringify([
      {statisticType:"sum",onStatisticField:"monto_pim",outStatisticFieldName:"sum_pim"},
      {statisticType:"max",onStatisticField:"fecha_proceso",outStatisticFieldName:"max_fp"}
    ]);
    const qs=new URLSearchParams({where:WHERE_PIM,outStatistics:outStats,returnGeometry:"false",f:"json"});
    const res=await fetch(SERVICE_PIM+"?"+qs.toString(),{cache:"no-store"});
    const json=await res.json();
    const attrs=json.features?.[0]?.attributes||{};
    return{total:Number(attrs.sum_pim)||0,lastTs:(attrs.max_fp!=null)?Number(attrs.max_fp):null};
  }
  function animateNumber(el,target,ms=1700){
    const fmt=new Intl.NumberFormat('es-PE');
    const start=performance.now();
    function tick(t){
      const p=Math.min(1,(t-start)/ms);
      const eased=1-Math.pow(1-p,3);
      const cur=Math.round(target*eased);
      el.textContent=fmt.format(cur);
      if(p<1)requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }
  function formatEsDate(ts){
    if(!Number.isFinite(ts))return"—";
    const d=new Date(ts);
    return new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"long",year:"numeric"}).format(d);
  }
  (async()=>{
    const valEl=document.getElementById('pim-val');
    const curEl=document.getElementById('pim-cur');
    const lastEl=document.getElementById('pim-lastUpdate');
    try{
      const{total,lastTs}=await fetchPIMandMaxDate();
      requestAnimationFrame(()=>{valEl.classList.add('ready');curEl.classList.add('ready');});
      animateNumber(valEl,total);
      lastEl.textContent="Actualizado al "+formatEsDate(lastTs);
    }catch(e){
      valEl.textContent="—";
      lastEl.textContent="Actualizado al —";
    }
  })();
  /* -------- Áreas de acción animación -------- */
  const leftEl=document.getElementById('col-left');
  const rightEl=document.getElementById('col-right');
  function revealOnScroll(){
    const vh=window.innerHeight;
    if(leftEl.getBoundingClientRect().top < vh*0.8) leftEl.classList.add('visible');
    if(rightEl.getBoundingClientRect().top < vh*0.8) rightEl.classList.add('visible');
  }
  window.addEventListener('scroll',revealOnScroll,{passive:true});
  window.addEventListener('load',revealOnScroll,{passive:true});
  /* -------- Inversión pública (gráfico barras) -------- */
  const URL13="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
  const YEAR=2025;
  function fmtM(v){const n=Number(v)||0;return (n/1e6).toFixed(3).replace(/\B(?=(\d{3})+(?!\d))/g,'.').replace(/(\.\d*?)0+$/,'$1').replace(/\.$/,'')+" M";}
  function fmtPctChart(p){return `${Math.round((p||0))}%`;}
  async function fetchStats(){
    const params=new URLSearchParams({
      f:"json",
      where:`ano_eje = ${YEAR}`,
      returnGeometry:"false",
      groupByFieldsForStatistics:"tipo_act_proy_nombre",
      outFields:"tipo_act_proy_nombre",
      orderByFields:"tipo_act_proy_nombre",
      outStatistics:JSON.stringify([
        {"statisticType":"sum","onStatisticField":"monto_pim","outStatisticFieldName":"sum_pim"},
        {"statisticType":"sum","onStatisticField":"monto_devengado","outStatisticFieldName":"sum_dev"}
      ])
    });
    const res=await fetch(URL13,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:params.toString(),cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j=await res.json(); if(j.error) throw new Error(j.error.message||"Error ArcGIS");
    const rows=(j.features||[]).map(f=>f.attributes||{});
    const order=["PROYECTO","ACTIVIDAD"];
    rows.sort((a,b)=>{const ai=order.indexOf(a.tipo_act_proy_nombre);const bi=order.indexOf(b.tipo_act_proy_nombre);return (ai<0?99:ai)-(bi<0?99:bi);});
    return rows.map(r=>{const pim=Number(r.sum_pim)||0;const dev=Number(r.sum_dev)||0;return{cat:r.tipo_act_proy_nombre||"—",pim,dev,pct:pim>0?(dev/pim*100):0};});
  }
  async function fetchMaxDate(){
    const params=new URLSearchParams({f:"json",where:`ano_eje = ${YEAR}`,returnGeometry:"false",outStatistics:JSON.stringify([{"statisticType":"max","onStatisticField":"fecha_proceso","outStatisticFieldName":"max_fp"}])});
    const res=await fetch(URL13+"?"+params.toString(),{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j=await res.json(); const at=j.features?.[0]?.attributes||{}; return Number(at.max_fp)||null;
  }
  function formatEsDate2(ts){if(!Number.isFinite(ts)) return "—"; const d=new Date(ts); return new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"long",year:"numeric"}).format(d);}
  function renderChart(data){
    const wrap=document.getElementById("wrap");
    const canvas=document.getElementById("chart");
    const tip=document.getElementById("tip");
    const ctx=canvas.getContext("2d");
    let dims={}, scale={}, bars=[];
    function roundRect(ctx,x,y,w,h,r){const rr=Math.min(r,h/2,w/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.arcTo(x+w,y,x+w,y+h,rr);ctx.arcTo(x+w,y+h,x,y+h,rr);ctx.arcTo(x,y+h,x,y,rr);ctx.arcTo(x,y,x+w,y,rr);ctx.closePath();}
    function buildScale(){
      const dpr=Math.max(1,window.devicePixelRatio||1);
      const W=wrap.clientWidth, H=wrap.clientHeight;
      canvas.width=W*dpr; canvas.height=H*dpr; canvas.style.width=W+"px"; canvas.style.height=H+"px"; ctx.setTransform(dpr,0,0,dpr,0,0);
      dims={W,H};
      const pad={t:20,r:20,b:40,l:90};
      const maxVal=Math.max(1,...data.map(d=>d.pim));
      const pow=Math.pow(10,Math.floor(Math.log10(maxVal)));
      const XMAX=Math.ceil(maxVal/(pow/2))*(pow/2);
      scale={pad,max:XMAX,x:(val)=>pad.l+(W-pad.l-pad.r)*(val/XMAX),y:(i)=>{const n=data.length;const band=(H-pad.t-pad.b)/Math.max(1,n);return pad.t+band*(i+0.5);},bandH:(H-pad.t-pad.b)/Math.max(1,data.length)};
      const barH=Math.min(32,scale.bandH*0.6);
      bars=data.map((d,i)=>{const cy=scale.y(i);const yTop=cy-barH/2;const pimW=scale.x(d.pim)-scale.x(0);const devW=scale.x(d.dev)-scale.x(0);return{cat:d.cat,pim:d.pim,dev:d.dev,pct:d.pct,cy,barH,pimRect:{x:scale.x(0),y:yTop,w:pimW,h:barH},devRect:{x:scale.x(0),y:yTop,w:devW,h:barH}};});
    }
    function draw(){
      ctx.clearRect(0,0,dims.W,dims.H);
      ctx.strokeStyle="#d1d5db"; ctx.lineWidth=1; ctx.setLineDash([3,5]);
      const ticks=6; for(let t=0;t<=ticks;t++){const v=scale.max*(t/ticks);const x=scale.x(v);ctx.beginPath();ctx.moveTo(x,scale.pad.t);ctx.lineTo(x,dims.H-scale.pad.b);ctx.stroke();}
      ctx.setLineDash([]);
      ctx.font="700 13px 'Nunito Sans',system-ui"; ctx.fillStyle="#1f2937"; ctx.textAlign="right"; ctx.textBaseline="middle";
      bars.forEach(b=>{const label=b.cat.charAt(0)+b.cat.slice(1).toLowerCase();ctx.fillText(label, scale.pad.l-10, b.cy);});
      bars.forEach(b=>{
        ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--celeste-pim').trim() || "#5ebad6"; roundRect(ctx,b.pimRect.x,b.pimRect.y,b.pimRect.w,b.pimRect.h,16); ctx.fill();
        ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--azul-mvcs').trim() || "#1e6eb6"; roundRect(ctx,b.devRect.x,b.devRect.y,b.devRect.w,b.devRect.h,16); ctx.fill();
        ctx.fillStyle="#ffffff"; ctx.font="700 12px 'Nunito Sans',system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
        if(b.devRect.w>40){const devTxt=fmtM(b.dev); const devMidX=b.devRect.x+b.devRect.w/2; ctx.fillText(devTxt,devMidX,b.cy);} 
        const restW=b.pimRect.w-b.devRect.w;
        if(restW>40){const pimTxt=fmtM(b.pim); const restMidX=b.devRect.x+b.devRect.w+restW/2; ctx.fillText(pimTxt,restMidX,b.cy);} 
        ctx.font="700 12px 'Nunito Sans',system-ui"; ctx.textAlign="left"; ctx.textBaseline="middle"; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--azul-mvcs').trim() || "#1e6eb6"; const pctText=fmtPctChart(b.pct); const pctX=b.pimRect.x+b.pimRect.w+8; ctx.fillText(pctText,pctX,b.cy);
      });
    }
    function hitTest(mx,my){for(const b of bars){const r=b.devRect;if(mx>=r.x&&mx<=r.x+r.w&&my>=r.y&&my<=r.y+r.h)return{b,kind:"dev"};const p=b.pimRect;if(mx>=p.x&&mx<=p.x+p.w&&my>=p.y&&my<=p.y+p.h)return{b,kind:"pim"};}return null;}
    function attachTooltip(){
      canvas.addEventListener("mousemove",e=>{const rect=canvas.getBoundingClientRect();const mx=e.clientX-rect.left;const my=e.clientY-rect.top;const h=hitTest(mx,my);if(!h){tip.style.opacity=0;return;}const b=h.b;tip.innerHTML=`
        <div class="inv-tip-row"><span class="inv-tip-key">Categoría</span><span class="inv-tip-val">${b.cat}</span></div>
        <div class="inv-tip-row"><span class="inv-tip-key">Monto PIM</span><span class="inv-tip-val">${(b.pim).toLocaleString('es-PE')}</span></div>
        <div class="inv-tip-row"><span class="inv-tip-key">Monto devengado</span><span class="inv-tip-val">${(b.dev).toLocaleString('es-PE')}</span></div>
        <div class="inv-tip-row"><span class="inv-tip-key">Avance</span><span class="inv-tip-val">${fmtPctChart(b.pct)}</span></div>`;
        tip.style.left=(mx+14)+"px"; tip.style.top =(my-14)+"px"; tip.style.opacity=1;},{passive:true});
      canvas.addEventListener("mouseleave",()=>{tip.style.opacity=0;},{passive:true});
    }
    function redrawAll(){buildScale();draw();}
    redrawAll(); attachTooltip(); window.addEventListener("resize",redrawAll,{passive:true});
  }
  (async function(){
    try{
      const [rows,lastTs]=await Promise.all([fetchStats(),fetchMaxDate()]);
      renderChart(rows);
      const lu=document.getElementById("lastUpdate"); lu.innerHTML=`<em>Actualizado al ${formatEsDate2(lastTs)}</em>`;
    }catch(err){
      console.error(err);
      document.getElementById("wrap").innerHTML='<div style="display:grid;place-items:center;height:100%;color:#6b7280;font-size:14px;font-family:Nunito Sans,system-ui;">Error al cargar datos</div>';
    }
  })();
  /* ---- ¿Cómo vamos? devengado + imagen ---- */
  const statusSection = document.querySelector('.status-hero');
  const figure = document.querySelector('.status-figure');
  let devData = null;
  async function fetchDevengadoData(){
    const outStats = JSON.stringify([
      { statisticType: "sum", onStatisticField: "monto_devengado", outStatisticFieldName: "sum_dev" },
      { statisticType: "sum", onStatisticField: "monto_pim",       outStatisticFieldName: "sum_pim" },
      { statisticType: "max", onStatisticField: "fecha_proceso",   outStatisticFieldName: "max_fp"  }
    ]);
    const qs = new URLSearchParams({
      where: WHERE_PIM,
      outStatistics: outStats,
      returnGeometry: "false",
      f: "json"
    });
    const url = SERVICE_PIM + "?" + qs.toString();
    const res = await fetch(url, { cache: "no-store" });
    const json = await res.json();
    const a = json.features?.[0]?.attributes || {};
    return { dev: Number(a.sum_dev||0), pim: Number(a.sum_pim||0), lastTs: (a.max_fp != null) ? Number(a.max_fp) : null };
  }
  function animateNumberFmt(el, target, ms, fmt, suffix=""){
    const start = performance.now();
    function tick(t){
      const p = Math.min(1, (t - start) / ms);
      const eased = 1 - Math.pow(1 - p, 3);
      const cur = target * eased;
      el.textContent = fmt.format(cur) + suffix;
      if(p < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting && !devData) {
        (async () => {
          try {
            const { dev, pim, lastTs } = await fetchDevengadoData();
            devData = { dev, pim, lastTs };
            const val = document.getElementById('val');
            const cur = document.getElementById('cur');
            const percentEl = document.getElementById('percent');
            const last = document.getElementById('lastUpdateDev');
            const perc = pim > 0 ? (dev / pim * 100) : 0;
            [val, cur, percentEl].forEach(el => el.classList.add('ready'));
            const fmtInt = new Intl.NumberFormat('es-PE', { maximumFractionDigits: 0 });
            const fmtPerc = new Intl.NumberFormat('es-PE', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
            animateNumberFmt(val, dev, 1700, fmtInt);
            animateNumberFmt(percentEl, perc, 1700, fmtPerc, "%");
            last.textContent = "Actualizado al " + formatEsDate(lastTs);
            requestAnimationFrame(() => {
              figure.classList.add('animated');
            });
          } catch (e) {
            document.getElementById('val').textContent = "—";
            document.getElementById('percent').textContent = "—";
            document.getElementById('lastUpdateDev').textContent = "Actualizado al —";
            [document.getElementById('val'), document.getElementById('cur'), document.getElementById('percent')].forEach(el => el.classList.add('ready'));
          }
        })();
      }
    });
  }, { threshold: 0.3 });
  observer.observe(statusSection);
  /* ----------- Módulo Rankings y tablas compartidas ----------- */
  const ENDPOINT_LEFT  = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/MapServer/9";
  const ENDPOINT_RIGHT = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/MapServer/10";
  const KPI_SECTOR = "VIVIENDA CONSTRUCCION Y SANEAMIENTO";
  let currentSide = null;
  let cacheRows   = { left: null, right: null };
  function cacheBust(){ return String(Date.now()); }
  function esriPOST(url, obj){
    const body = new URLSearchParams({ f:"json", returnGeometry:"false", ...obj, __ts:cacheBust() });
    return fetch(url+"/query", { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body })
      .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
      .then(j=>{ if(j.error) throw new Error(j.error.message||"ArcGIS"); return j; });
  }
  function fmtMoney(n){ return new Intl.NumberFormat("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(n)||0); }
  function fmtPct(n){ const v=Number(n); return isFinite(v) ? new Intl.NumberFormat("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(v) : "—"; }
  function escQuotes(v){ return String(v).replaceAll("'","''"); }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]||c)); }
  async function loadKPI(side){
    const url = side==="left" ? ENDPOINT_LEFT : ENDPOINT_RIGHT;
    try{
      const outStatistics = JSON.stringify([{statisticType:"min",onStatisticField:"rankin",outStatisticFieldName:"min_rankin"}]);
      const where = `sector_nombre='${escQuotes(KPI_SECTOR)}'`;
      const j = await esriPOST(url, { where, outStatistics, groupByFieldsForStatistics:"" });
      const num = j.features?.[0]?.attributes?.min_rankin ?? null;
      document.getElementById("kpi-"+side).textContent = (num!=null) ? Number(num).toLocaleString('es-PE') : "—";
    }catch(e){
      document.getElementById("kpi-"+side).textContent = "—";
      console.error("KPI "+side, e);
    }
  }
  const OUT_FIELDS = ["rankin","sector_nombre","sum_monto_pia","sum_monto_pim","sum_monto_devengado","avance"].join(",");
  async function fetchRows(side){
    const url = side==="left" ? ENDPOINT_LEFT : ENDPOINT_RIGHT;
    const page=2000; let offset=0; const rows=[];
    while(true){
      const j = await esriPOST(url, {
        where:"1=1", outFields:OUT_FIELDS, orderByFields:"rankin ASC",
        resultRecordCount:page, resultOffset:offset
      });
      (j.features||[]).forEach(f=>{
        const a=f.attributes||{};
        rows.push({rk:a.rankin??null, sec:a.sector_nombre??"", pia:+a.sum_monto_pia||0, pim:+a.sum_monto_pim||0, dev:+a.sum_monto_devengado||0, avz:+a.avance});
      });
      if(!j.exceededTransferLimit || (j.features||[]).length<page) break;
      offset += page;
    }
    return rows;
  }
  function renderTable(rows){
    const tb = document.getElementById("tbody");
    tb.innerHTML = rows.map(r=>`
      <tr>
        <td class="num">${r.rk ?? "—"}</td>
        <td>${escapeHtml(r.sec||"—")}</td>
        <td class="num">${fmtMoney(r.pia)}</td>
        <td class="num">${fmtMoney(r.pim)}</td>
        <td class="num">${fmtMoney(r.dev)}</td>
        <td class="num">${fmtPct(r.avz)}</td>
      </tr>
    `).join("");
  }
  async function toggleTable(side){
    const shell = document.getElementById("tableShell");
    const scroller = document.getElementById("scroller");
    const stateEl = document.getElementById("state");
    const buttons = document.querySelectorAll('button[data-action="toggle"]');
    if (shell.classList.contains("open") && currentSide===side){
      shell.classList.remove("open"); stateEl.textContent = "—"; scroller.style.display = "none"; currentSide = null;
      buttons.forEach(b=> b.textContent="Ver tabla");
      return;
    }
    buttons.forEach(b=> b.textContent = (b.dataset.side===side) ? "Ocultar tabla" : "Ver tabla");
    shell.classList.add("open"); stateEl.classList.remove("error"); stateEl.textContent = "Cargando datos…"; scroller.style.display = "none";
    try{
      const rows = cacheRows[side] || await fetchRows(side);
      cacheRows[side] = rows; renderTable(rows);
      stateEl.textContent = `Listo (${rows.length.toLocaleString('es-PE')} filas)`;
      scroller.style.display = "block"; currentSide = side;
    }catch(e){
      console.error(e); stateEl.classList.add("error"); stateEl.textContent = "No se pudo cargar la tabla."; scroller.style.display = "none";
    }
  }
  function toCSV(rows){
    const sep=";"; const header=["RANKING","Sector","PIA","PIM","Devengado","Avance(%)"];
    const esc=v=>`"${String(v??"").replace(/"/g,'""')}"`;
    const lines = rows.map(r=>[r.rk,r.sec,r.pia,r.pim,r.dev,r.avz].map(esc).join(sep));
    return header.join(sep)+"\n"+lines.join("\n");
  }
  function downloadCSV(side){
    const rows = cacheRows[side];
    if(!rows || !rows.length) return;
    const csv=toCSV(rows);
    const bom=new Uint8Array([0xEF,0xBB,0xBF]);
    const blob=new Blob([bom,csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download = side==="left" ? "ranking_general_sector.csv" : "ranking_inversiones_sector.csv";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href),1200);
  }
  document.querySelectorAll('button[data-action="toggle"]').forEach(btn=> btn.addEventListener('click', ()=> toggleTable(btn.dataset.side)));
  document.querySelectorAll('button[data-action="excel"]').forEach(btn=> btn.addEventListener('click', ()=> {
    const side = btn.dataset.side;
    if(!cacheRows[side]){ toggleTable(side).then(()=> downloadCSV(side)); } else{ downloadCSV(side); }
  }));
  loadKPI("left"); loadKPI("right");
  /* ----------- Ejecutoras (desempeño por pliego) ----------- */
  const SERVICE="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
  const BASE_WHERE="sector_nombre = 'VIVIENDA CONSTRUCCION Y SANEAMIENTO' AND ano_eje = 2025";
  const INFO_LINKS={ "MINISTERIO DE VIVIENDA, CONSTRUCCION Y SANEAMIENTO": "https://pportalgis.vivienda.gob.pe/pportal/apps/storymaps/stories/750c7c6b13bf477287b8db07c865f1b1" };
  const nf=new Intl.NumberFormat('es-PE');
  const pctStr=(r)=>isFinite(r)?(r*100).toFixed(2)+' %':'0.00 %';
  function buildParams(extra){
    return new URLSearchParams({
      where:`${BASE_WHERE}${extra? ' AND '+extra:''}`,
      groupByFieldsForStatistics:"pliego_nombre,ejecutora_nombre",
      outStatistics:JSON.stringify([
        {statisticType:"sum",onStatisticField:"monto_pim",outStatisticFieldName:"sum_pim"},
        {statisticType:"sum",onStatisticField:"monto_devengado",outStatisticFieldName:"sum_dev"}
      ]),
      returnGeometry:"false", f:"json"
    }).toString();
  }
  async function queryStats(extra){
    const res=await fetch(`${SERVICE}?${buildParams(extra)}`,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const json=await res.json();
    if(json.error) throw new Error(json.error.message||'Error servicio');
    return (json.features||[]).map(f=>{
      const a=f.attributes||{};
      return { pliego:String(a.pliego_nombre||'').trim()||'(Sin pliego)', ejecutora:String(a.ejecutora_nombre||'').trim()||'(Sin ejecutora)', pim:Number(a.sum_pim||0), dev:Number(a.sum_dev||0) };
    });
  }
  function mergeStats(total,proy,act){
    const key=r=>`${r.pliego}|||${r.ejecutora}`;
    const it=new Map(), ip=new Map(), ia=new Map();
    total.forEach(r=>it.set(key(r),r)); proy.forEach(r=>ip.set(key(r),r)); act.forEach(r=>ia.set(key(r),r));
    const rows=[...new Set([...it.keys(),...ip.keys(),...ia.keys()])].map(k=>{
      const t=it.get(k)||{}, p=ip.get(k)||{}, a=ia.get(k)||{};
      return { pliego:t.pliego||p.pliego||a.pliego||'', ejecutora:t.ejecutora||p.ejecutora||a.ejecutora||'', pim:t.pim||0, dev:t.dev||0, pim_proy:p.pim||0, dev_proy:p.dev||0, pim_act:a.pim||0, dev_act:a.dev||0 };
    });
    const byP=new Map();
    for(const r of rows){ if(!byP.has(r.pliego)) byP.set(r.pliego,[]); byP.get(r.pliego).push(r); }
    for(const arr of byP.values()){ arr.sort((x,y)=>x.ejecutora.localeCompare(y.ejecutora,'es')); }
    return new Map([...byP.entries()].sort((a,b)=>a[0].localeCompare(b[0],'es')));
  }
  function renderExec(grouped){
    const tbody=document.getElementById('tbodyExec'); tbody.innerHTML='';
    let tot={pim:0,dev:0,pim_proy:0,dev_proy:0,pim_act:0,dev_act:0};
    for(const [pliego,items] of grouped.entries()){
      const s=items.reduce((a,r)=>({
        pim:a.pim+r.pim, dev:a.dev+r.dev,
        pim_proy:a.pim_proy+r.pim_proy, dev_proy:a.dev_proy+r.dev_proy,
        pim_act:a.pim_act+r.pim_act, dev_act:a.dev_act+r.dev_act
      }),{pim:0,dev:0,pim_proy:0,dev_proy:0,pim_act:0,dev_act:0});
      Object.keys(tot).forEach(k=>tot[k]+=s[k]);
      const av = s.pim>0 ? s.dev/s.pim : 0;
      const avp = s.pim_proy>0 ? s.dev_proy/s.pim_proy : 0;
      const ava = s.pim_act>0 ? s.dev_act/s.pim_act : 0;
      const gid = 'g_' + Math.random().toString(36).slice(2,9);
      const story = (pliego.toUpperCase().includes("MINISTERIO DE VIVIENDA")) ?
        `<a class="infoBtn" href="${INFO_LINKS['MINISTERIO DE VIVIENDA, CONSTRUCCION Y SANEAMIENTO']}" target="_blank" rel="noopener" title="Ver StoryMap">
           <svg viewBox="0 0 24 24"><path d="M14 3h7v7"/><path d="M10 14 21 3"/><path d="M21 14v7h-7"/><path d="M3 10 14 21"/></svg>
         </a>` : '';
      const groupHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <button class="btn-expand" aria-expanded="false" aria-controls="${gid}">
          <span class="chev">
            <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path></svg>
            <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path></svg>
            <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path></svg>
          </span>
          <span style="white-space:normal;word-break:break-word;">${pliego}</span>
        </button>
        ${story}
      </div>`;
      const dot = v => `<span class="dot" style="background:${v<0.33?'#ef4444':v<0.67?'#f59e0b':'#16a34a'}"></span>`;
      const addRow=(cells,isHead=false)=>{
        const tr=document.createElement('tr');
        tr.className=isHead?'group':'';
        cells.forEach(c=>{
          const el=document.createElement(isHead?'th':'td');
          if(c.cls) el.className=c.cls;
          el.innerHTML=c.html; tr.appendChild(el);
        });
        tbody.appendChild(tr);
      };
      addRow([
        {html:groupHTML, cls:'sticky'},
        {html:nf.format(s.pim),cls:'num'},{html:nf.format(s.dev),cls:'num'},
        {html:`${dot(av)}${pctStr(av)}`,cls:'pct'},
        {html:nf.format(s.pim_proy),cls:'num'},{html:nf.format(s.dev_proy),cls:'num'},
        {html:`${dot(avp)}${pctStr(avp)}`,cls:'pct'},
        {html:nf.format(s.pim_act),cls:'num'},{html:nf.format(s.dev_act),cls:'num'},
        {html:`${dot(ava)}${pctStr(ava)}`,cls:'pct'}
      ],true);
      for(const r of items){
        const av2 = r.pim>0 ? r.dev/r.pim : 0;
        const avp2 = r.pim_proy>0 ? r.dev_proy/r.pim_proy : 0;
        const ava2 = r.pim_act>0 ? r.dev_act/r.pim_act : 0;
        const tr=document.createElement('tr');
        tr.className='item'; tr.setAttribute('data-parent',gid); tr.style.display='none';
        tr.innerHTML=`
          <td class="sticky" style="padding-left:24px;white-space:normal;word-break:break-word;">${r.ejecutora}</td>
          <td class="num">${nf.format(r.pim)}</td><td class="num">${nf.format(r.dev)}</td>
          <td class="pct">${dot(av2)}${pctStr(av2)}</td>
          <td class="num">${nf.format(r.pim_proy)}</td><td class="num">${nf.format(r.dev_proy)}</td>
          <td class="pct">${dot(avp2)}${pctStr(avp2)}</td>
          <td class="num">${nf.format(r.pim_act)}</td><td class="num">${nf.format(r.dev_act)}</td>
          <td class="pct">${dot(ava2)}${pctStr(ava2)}</td>`;
        tbody.appendChild(tr);
      }
    }
    const tfoot=document.getElementById('tfootExec');
    const tav = tot.pim>0 ? tot.dev/tot.pim : 0;
    const tavp = tot.pim_proy>0 ? tot.dev_proy/tot.pim_proy : 0;
    const tava = tot.pim_act>0 ? tot.dev_act/tot.pim_act : 0;
    const dot = v => `<span class="dot" style="background:${v<0.33?'#ef4444':v<0.67?'#f59e0b':'#16a34a'}"></span>`;
    tfoot.innerHTML=`<tr>
      <td class="sticky" style="font-weight:900;text-align:left">Total</td>
      <td class="num">${nf.format(tot.pim)}</td><td class="num">${nf.format(tot.dev)}</td>
      <td class="pct">${dot(tav)}${pctStr(tav)}</td>
      <td class="num">${nf.format(tot.pim_proy)}</td><td class="num">${nf.format(tot.dev_proy)}</td>
      <td class="pct">${dot(tavp)}${pctStr(tavp)}</td>
      <td class="num">${nf.format(tot.pim_act)}</td><td class="num">${nf.format(tot.dev_act)}</td>
      <td class="pct">${dot(tava)}${pctStr(tava)}</td>
    </tr>`;
    tbody.querySelectorAll('.btn-expand').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id=btn.getAttribute('aria-controls');
        const open=btn.getAttribute('aria-expanded')==='true';
        btn.setAttribute('aria-expanded',String(!open));
        tbody.querySelectorAll(`tr.item[data-parent="${id}"]`).forEach(tr=> tr.style.display=open?'none':'');
      });
    });
  }
  async function loadExecutors(){
    try{
      const [all,proy,act]=await Promise.all([
        queryStats("1=1"),
        queryStats("tipo_act_proy_nombre = 'PROYECTO'"),
        queryStats("tipo_act_proy_nombre = 'ACTIVIDAD'")
      ]);
      renderExec(mergeStats(all,proy,act));
    }catch(err){
      console.error(err);
      document.getElementById('tbodyExec').innerHTML=`<tr><td colspan="10" style="text-align:center;color:#b91c1c;padding:18px">Error al cargar datos</td></tr>`;
    }
  }
  function exportTableToExcel(){
    const table=document.getElementById('tblExec'); if(!table) return;
    const clone=table.cloneNode(true);
    clone.querySelectorAll('td.num, th.num').forEach(td=> td.setAttribute('style',(td.getAttribute('style')||'')+'; mso-number-format:"\\#\\,\\#\\#0";'));
    const html=`<!DOCTYPE html><html><head><meta charset="utf-8">
    <style>table{border-collapse:collapse}th,td{border:1px solid #d1d5db;padding:6px 8px;white-space:nowrap}
    th{background:#5ebad6;color:#fff;font-weight:800}</style>
    </head><body>${clone.outerHTML}</body></html>`;
    const blob=new Blob([html],{type:'application/vnd.ms-excel;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='ejecutoras_mvcs_2025.xls';
    document.body.appendChild(a); a.click(); a.remove();
  }
  const btnShowExec = document.getElementById('btnShowExec');
  btnShowExec.addEventListener('click',()=>{
    const wrap=document.getElementById('execWrap');
    const isHidden = wrap.style.display==='none';
    if(isHidden){ wrap.style.display='block'; loadExecutors(); btnShowExec.textContent='Ocultar tabla'; }
    else{ wrap.style.display='none'; btnShowExec.textContent='Ver tabla'; }
  });
  document.getElementById('btnExcelExec').addEventListener('click',exportTableToExcel);
  </script>

  <!-- =================== Script del módulo de Inversiones =================== -->
  <script>
  /* ========= Helpers específicos del módulo de inversiones ========= */
  const FS_URL_INV = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_Coord_MEF/FeatureServer/0";

  // Formateador para enteros
  const fmtInv = new Intl.NumberFormat('es-PE', { maximumFractionDigits: 0 });
  // Animación numérica con easing
  function animateNumInv(el, to, ms=1400){
    const start = performance.now();
    const from = 0;
    function step(t){
      const p = Math.min(1, (t-start)/ms);
      const e = 1 - Math.pow(1-p, 4); // easeOutQuart
      el.textContent = fmtInv.format(Math.round(from + (to-from)*e));
      if(p < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }
  // Consulta POST a servicios ArcGIS (versión para inversiones) evitando conflicto con esriPOST global
  function esriPOST_INV(url, params){
    const body = new URLSearchParams({ f:"json", returnGeometry:"false", ...params });
    return fetch(url, { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body, cache:"no-store" })
      .then(r => r.json());
  }
  /* ========= Inversiones (conteo + PIM/DEV) ========= */
  async function loadInvestmentsCountInv(where="1=1"){ 
    const page = 2000; let offset = 0; const set = new Set();
    while(true){
      const j = await esriPOST_INV(FS_URL_INV + "/query", {
        where, outFields:"producto_proyecto", returnDistinctValues:"true",
        orderByFields:"producto_proyecto", resultRecordCount:page, resultOffset:offset
      });
      const rows = (j.features||[]).map(f => f?.attributes?.producto_proyecto).filter(Boolean);
      rows.forEach(v => set.add(v));
      if(!j.exceededTransferLimit || rows.length < page) break;
      offset += page;
    }
    return set.size;
  }
  async function loadPIMDevInv(where="1=1"){ 
    // primer intento utilizando outStatistics
    try{
      const j = await esriPOST_INV(FS_URL_INV + "/query", {
        where,
        outStatistics: JSON.stringify([
          { statisticType:"sum", onStatisticField:"monto_pim",        outStatisticFieldName:"sPIM" },
          { statisticType:"sum", onStatisticField:"monto_devengado",  outStatisticFieldName:"sDEV" }
        ])
      });
      const a = j.features?.[0]?.attributes || {};
      const pim = Number(a.sPIM||0), dev = Number(a.sDEV||0);
      if(pim === 0 && dev === 0) throw new Error("zeros");
      return { pim, dev };
    }catch(_){
      // fallback iterando páginas
      let pim=0, dev=0, offset=0, page=2000;
      while(true){
        const j = await esriPOST_INV(FS_URL_INV + "/query", {
          where, outFields:"monto_pim,monto_devengado", resultRecordCount:page, resultOffset:offset
        });
        const feats = j.features||[];
        for(const f of feats){
          const at = f.attributes || {};
          pim += Number(at.monto_pim)||0;
          dev += Number(at.monto_devengado)||0;
        }
        if(!j.exceededTransferLimit || feats.length < page) break;
        offset += page;
      }
      return { pim, dev };
    }
  }
  // Observer para activar conteo de inversiones
  const inversionesSection = document.getElementById('sec-inversiones');
  const inversionesObserver = new IntersectionObserver(async (entries) => {
    for(const e of entries){
      if(!e.isIntersecting) continue;
      // activar subrayado animado
      document.querySelector('#sec-inversiones .title').classList.add('inview');
      // cargar datos
      const [count, sums] = await Promise.all([
        loadInvestmentsCountInv("1=1"),
        loadPIMDevInv("1=1")
      ]);
      const pim = Math.round(sums.pim || 0);
      const dev = Math.round(sums.dev || 0);
      const pct = (pim > 0) ? Math.round((dev/pim)*100) : 0;
      animateNumInv(document.getElementById('inv-count'), count);
      animateNumInv(document.getElementById('inv-pim'), pim);
      animateNumInv(document.getElementById('inv-dev'), dev);
      animateNumInv(document.getElementById('inv-pct'), pct);
      inversionesObserver.disconnect();
    }
  }, { threshold: 0.25 });
  inversionesObserver.observe(inversionesSection);

  /* ===== "Se espera generar" ========= */
  // Utilidades compartidas en el módulo
  const invUtil = {
    FS_URL: FS_URL_INV,
    fmt: new Intl.NumberFormat('es-PE', { maximumFractionDigits: 0 }),
    esriPOST: esriPOST_INV,
    animateNum: (el, to, ms=1200) => {
      const start = performance.now(), from = 0;
      function step(t){
        const p = Math.min(1,(t-start)/ms);
        const e = 1 - Math.pow(1-p,4);
        el.textContent = invUtil.fmt.format(Math.round(from + (to-from)*e));
        if(p<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
  };
  async function sumFieldInv(field, where="1=1"){ 
    // intenta por outStatistics y luego fallback
    try{
      const j = await esriPOST_INV(FS_URL_INV + "/query", {
        where,
        outStatistics: JSON.stringify([{ statisticType:"sum", onStatisticField: field, outStatisticFieldName:"s" }])
      });
      const v = Number(j.features?.[0]?.attributes?.s || 0);
      if(v > 0) return v;
      throw new Error("zero");
    }catch(_){
      let tot = 0, offset = 0, page = 2000;
      while(true){
        const j2 = await esriPOST_INV(FS_URL_INV + "/query", {
          where, outFields: field, resultRecordCount: page, resultOffset: offset
        });
        const feats = j2.features||[];
        for(const f of feats){ tot += Number(f.attributes?.[field] || 0); }
        if(!j2.exceededTransferLimit || feats.length < page) break;
        offset += page;
      }
      return tot;
    }
  }
  // Observer para activar se espera generar
  (() => {
    const sec = document.getElementById('sec-generar');
    const io2 = new IntersectionObserver(async (ents) => {
      for(const e of ents){
        if(!e.isIntersecting) continue;
        const where = "1=1";
        const [agua, alc, pav, ver] = await Promise.all([
          sumFieldInv("cnx_nuevas_agua", where),
          sumFieldInv("cnx_nuevas_alcantarillado_dse", where),
          sumFieldInv("final_pavimento_m2_monitoreo", where),
          sumFieldInv("final_vereda_m2_monitoreo", where)
        ]);
        invUtil.animateNum(document.getElementById('k-agua'), Math.round(agua||0));
        invUtil.animateNum(document.getElementById('k-alc'),  Math.round(alc||0));
        invUtil.animateNum(document.getElementById('k-pav'),  Math.round(pav||0));
        invUtil.animateNum(document.getElementById('k-ver'),  Math.round(ver||0));
        io2.disconnect();
      }
    }, { threshold: 0.25 });
    io2.observe(sec);
  })();

  /* ===== ESTADOS (8 contadores) ===== */
  function IN_INV(list){ return list.map(v => `\'${v.replaceAll("'", "''")}\'`).join(","); }
  async function countDistinctProductosInv(where){
    const page = 2000; let offset = 0; const set = new Set();
    while(true){
      const j = await esriPOST_INV(FS_URL_INV + "/query", {
        where, outFields:"producto_proyecto", returnDistinctValues:"true",
        orderByFields:"producto_proyecto", resultRecordCount:page, resultOffset:offset
      });
      const rows = (j.features||[]).map(f => f?.attributes?.producto_proyecto).filter(Boolean);
      rows.forEach(v => set.add(v));
      if(!j.exceededTransferLimit || rows.length < page) break;
      offset += page;
    }
    return set.size;
  }
  (async function estadosInv(){
    const OBRA = ["OBRA (SALDO)","OBRA"];
    const EXP  = ["EXPEDIENTE TECNICO (SALDO)","OBRA (Expediente Saldo)","EXPEDIENTE TECNICO"];
    const W = (...conds) => ["1=1", ...conds.filter(Boolean)].join(" AND ");
    const q = {
      obrasConcluidas:  W(`etapa IN (${IN_INV(OBRA)})`, `estado IN ('Transferencia','Post Ejecución','Concluido')`),
      obrasEjec:        W(`etapa IN (${IN_INV(OBRA)})`, `estado IN ('En Ejecución')`),
      obrasIniciar:     W(`etapa IN (${IN_INV(OBRA)})`, `estado IN ('Actos Previos')`, `subestado = 'Por Iniciar'`),
      obrasSel:         W(`etapa IN (${IN_INV(OBRA)})`, `estado IN ('Actos Previos')`, `subestado = 'Proceso de Selección'`),
      expConcluidos:    W(`etapa IN (${IN_INV(EXP)})`,  `estado IN ('Concluido')`),
      expElab:          W(`etapa IN (${IN_INV(EXP)})`,  `estado IN ('En elaboración')`),
      expSel:           W(`etapa IN (${IN_INV(EXP)})`,  `estado IN ('Actos Previos')`, `subestado = 'Proceso de Selección'`),
      obrasSel2:        W(`etapa IN (${IN_INV(OBRA)})`, `estado IN ('Actos Previos')`, `subestado = 'Proceso de Selección'`)
    };
    const [
      nObC, nObE, nObI, nObPS,
      nExC, nExE, nExPS, nObPS2
    ] = await Promise.all([
      countDistinctProductosInv(q.obrasConcluidas),
      countDistinctProductosInv(q.obrasEjec),
      countDistinctProductosInv(q.obrasIniciar),
      countDistinctProductosInv(q.obrasSel),
      countDistinctProductosInv(q.expConcluidos),
      countDistinctProductosInv(q.expElab),
      countDistinctProductosInv(q.expSel),
      countDistinctProductosInv(q.obrasSel2)
    ]);
    animateNumInv(document.getElementById("est-obras-concluidas"), nObC);
    animateNumInv(document.getElementById("est-obras-ejec"),        nObE);
    animateNumInv(document.getElementById("est-obras-iniciar"),     nObI);
    animateNumInv(document.getElementById("est-obras-sel"),         nObPS);
    animateNumInv(document.getElementById("est-exp-concluidos"),    nExC);
    animateNumInv(document.getElementById("est-exp-elab"),          nExE);
    animateNumInv(document.getElementById("est-exp-sel"),           nExPS);
    animateNumInv(document.getElementById("est-obras-sel2"),        nObPS2);
  })();
  </script>
  <!-- ========= SECCIÓN MAPA & TABLA DE PROYECTOS ========= -->
  <section id="map-section">
    <!-- Intro del mapa -->
    <section class="wrap intro">
      <h2 id="map-introTitle">¿Dónde se ubican nuestras inversiones?</h2>
      <p>
        El mapa interactivo muestra la ubicación geográfica de los proyectos de inversión del ministerio a nivel nacional,
        clasificados por tipo y estado (en ejecución, concluidos o por iniciar). Puedes filtrar por región, provincia o distrito para
        identificar las intervenciones en tu localidad. Esta herramienta facilita la rendición de cuentas y la participación
        ciudadana en el seguimiento de obras públicas.
      </p>
      <p>
        La visualización facilita el análisis territorial, permitiendo detectar posibles brechas de infraestructura, priorizar zonas
        críticas y garantizar una cobertura equitativa de los servicios de agua y saneamiento en todas las regiones del país.
      </p>
      <p>
        <a href="#map-viewDiv">¡Explora el mapa y conoce cómo las inversiones del MVCS han mejorado la calidad de vida de tu comunidad!</a>
      </p>
    </section>

    <!-- Contenedor del mapa -->
    <section class="page">
      <div class="map-card">
        <div id="map-viewDiv" aria-label="Mapa con límites y puntos"></div>
        <!-- Filtro por programas -->
        <div class="filter-wrap">
          <button class="filter-btn" id="map-filterBtn">Programas</button>
          <div class="filter-panel" id="map-filterPanel">
            <div class="fp-head"><span>Filtrar por Programa</span></div>
            <div class="fp-body" id="map-progList"></div>
          </div>
        </div>
        <!-- Buscador por nombre de proyecto -->
        <div class="search-wrap">
          <button class="search-fab" id="map-searchBtn" title="Buscar">
            <svg viewBox="0 0 24 24" aria-hidden="true"><circle class="ring" cx="10" cy="10" r="6.5"></circle><line class="handle" x1="14.8" y1="14.8" x2="20" y2="20"></line></svg>
          </button>
          <div class="search-content" id="map-searchContent">
            <div class="search-input-wrap">
              <input type="text" class="search-input" id="map-searchInput" placeholder="Buscar por nombre de proyecto…"/>
              <button class="clear-btn" id="map-clearSearch">X</button>
            </div>
            <ul class="suggestions" id="map-suggestions"></ul>
          </div>
        </div>
        <!-- Botón Reset -->
        <div class="reset-wrap">
          <button class="reset-btn" id="map-resetBtn" title="Restaurar mapa">↺</button>
        </div>
      </div>
    </section>

    <!-- Tabla de proyectos pegada al mapa -->
    <section class="table-section">
      <div class="table-wrap">
        <div class="title-row"><h3>Detalles con inversión PIM 2025</h3></div>
        <div class="wrap" style="padding:0 0 0 0; max-width:unset;"></div>
        <div class="tableWrap">
          <div class="scrollY" id="map-scrollY">
            <table id="map-tbl" aria-live="polite">
              <colgroup>
                <col class="cui"><col class="inv"><col class="dep"><col class="pro"><col class="dis">
                <col class="pim"><col class="dev"><col class="det"><col class="pdf">
              </colgroup>
              <thead>
                <tr>
                  <th>CUI</th>
                  <th>Inversión</th>
                  <th>Departamento</th>
                  <th>Provincia</th>
                  <th>Distrito</th>
                  <th>PIM</th>
                  <th>Devengado</th>
                  <th>Detalle proyecto</th>
                  <th>Ayuda memoria</th>
                </tr>
              </thead>
              <tbody id="map-tbody"></tbody>
            </table>
          </div>
        </div>
        <div id="map-state" class="status" style="text-align:center;">Cargando datos…</div>
      </div>
    </section>
  </section>

  <!-- Script del mapa: aislado para evitar conflictos -->
  <script>
  (function(){
    /* Subrayado animado al entrar en vista (intro del mapa) */
    (function underlineOnView(){
      const title = document.getElementById('map-introTitle');
      const obs = new IntersectionObserver(e => e.forEach(en => en.isIntersecting && title.classList.add('in-view')), { threshold: 0.35 });
      if(title) obs.observe(title);
    })();

    /* ===== Config común y utilidades para la sección de mapa ===== */
    const MAP_FS_URL    = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_Coord_MEF/FeatureServer/0";
    const MAP_LIMITES_URL = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer/0";
    const moneyFmtMap = new Intl.NumberFormat('es-PE', { maximumFractionDigits: 0 });
    function moneyMap(n){ return "S/. " + moneyFmtMap.format(Number(n||0)); }
    function safeMap(v){ return (v==null || v === "") ? "—" : String(v); }
    function escMap(v){ return String(v).replaceAll("'", "''"); }
    function escHtmlMap(s){ return String(s).replace(/[&<>"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c] || c)); }
    function esriPOSTMap(url, paramsObj){
      const body = new URLSearchParams({ f:"json", returnGeometry:"false", ...paramsObj, __ts: Date.now() });
      return fetch(url, { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body, cache:"no-store" })
        .then(r => r.ok ? r.json() : Promise.reject())
        .catch(() => ({}));
    }
    async function loadDistinctMap(field, where = "1=1"){ const page=2000; let offset=0; const vals=new Set(); while(true){ const j=await esriPOSTMap(MAP_FS_URL+"/query", { where, outFields: field, orderByFields: field, returnDistinctValues:"true", resultRecordCount: page, resultOffset: offset }); const rows=(j.features||[]).map(f => (f.attributes||{})[field]).filter(v=>v!=null && v!==""); rows.forEach(v => vals.add(v)); if(!j.exceededTransferLimit || rows.length < page) break; offset += page; } return [...vals]; }

    /* ====== Inicialización del mapa con ArcGIS ====== */
    require([
      "esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/widgets/BasemapToggle",
      "esri/widgets/ScaleBar","esri/geometry/Extent","esri/layers/GraphicsLayer","esri/Graphic"
    ], (Map, MapView, FeatureLayer, BasemapToggle, ScaleBar, Extent, GraphicsLayer, Graphic) => {
      const map = new Map({ basemap: "satellite" });
      const view = new MapView({
        container: "map-viewDiv",
        map,
        center: [-75.2, -9.3], zoom: 5,
        padding: { left:8, right:8, top:8, bottom:8 }, constraints:{ minZoom: 3 }
      });
      view.ui.add(new BasemapToggle({ view, nextBasemap: "osm" }), "bottom-right");
      view.ui.add(new ScaleBar({ view, unit: "metric" }), "bottom-left");
      view.ui.move("zoom", "bottom-right");
      const peruExtent = new Extent({ xmin:-81.6, ymin:-18.5, xmax:-68.5, ymax:-0.03, spatialReference:{ wkid:4326 } });
      view.when(() => view.goTo({ target: peruExtent.expand(0.96) }));

      const fxLayer = new GraphicsLayer({ listMode:"hide" });
      map.add(fxLayer);
      const limites = new FeatureLayer({ url: MAP_LIMITES_URL, popupEnabled: false, listMode: "hide" });
      limites.when(() => {
        limites.renderer = { type: "simple", symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [255,255,255,230], width: 1.2 } } };
      });
      map.add(limites);

      const layer = new FeatureLayer({
        url: MAP_FS_URL,
        outFields: ["*"],
        title: "Proyectos MEF",
        renderer: { type: "simple", symbol: { type: "simple-marker", color: [255,234,0,0.95], size: 7, outline: { color: [0,0,0,220], width: 0.6 } } },
        popupTemplate: {
          title: "",
          content: e => {
            const a = e.graphic.attributes || {};
            const url1 = a.url_ssp?.trim(), url2 = a.url_pdf?.trim();
            return `
              <div class="pop-card">
                <div class="pop-hdr">${safeMap(a.producto_proyecto_nombre)}</div>
                <div class="pop-grid">
                  <div class="lbl">Programa</div><div class="val">${safeMap(a.programa)}</div>
                  <div class="lbl">Departamento</div><div class="val">${safeMap(a.departamento)}</div>
                  <div class="lbl">Provincia</div><div class="val">${safeMap(a.provincia)}</div>
                  <div class="lbl">Distrito</div><div class="val">${safeMap(a.distrito)}</div>
                  <div class="lbl">Monto PIM</div><div class="val">${moneyMap(a.monto_pim)}</div>
                  <div class="lbl">Monto Devengado</div><div class="val">${moneyMap(a.monto_devengado)}</div>
                </div>
                <div class="pop-chipwrap">
                  <div class="chip">Etapa: ${safeMap(a.etapa)}</div>
                  <div class="chip">Estado: ${safeMap(a.estado)}</div>
                </div>
                <div class="pop-actions">
                  ${url1 ? `<a class="pop-btn" href="${url1}" target="_blank" rel="noopener">Detalle</a>` : ""}
                  ${url2 ? `<a class="pop-btn" href="${url2}" target="_blank" rel="noopener">PDF</a>` : ""}
                </div>
              </div>`;
          }
        }
      });
      map.add(layer);

      /* Filtro por Programa */
      const filterBtn   = document.getElementById('map-filterBtn');
      const filterPanel = document.getElementById('map-filterPanel');
      const progList    = document.getElementById('map-progList');
      function buildWherePrograms(){
        const checked = progList.querySelectorAll('input[type="checkbox"]:checked');
        const progs = Array.from(checked).map(cb => cb.value.trim()).filter(Boolean);
        return progs.length === 0 ? "1=1" : `programa IN (${progs.map(p => `'${escMap(p)}'`).join(",")})`;
      }
      async function loadPrograms(){
        progList.innerHTML = '<div style="padding:6px;font-size:12px;color:#6b7280;">Cargando...</div>';
        const progs = await loadDistinctMap("programa");
        progList.innerHTML = '';
        progs.forEach(p => {
          const id = 'map_p_' + Math.random().toString(36).substr(2, 6);
          const label = document.createElement('label');
          label.innerHTML = `<input id="${id}" type="checkbox" value="${p}"> <span>${p}</span>`;
          progList.appendChild(label);
        });
        progList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => {
            layer.definitionExpression = buildWherePrograms();
            view.whenLayerView(layer).then(lv => lv.queryExtent().then(r => r.count > 0 && view.goTo(r.extent)));
          });
        });
      }
      filterBtn.addEventListener('click', e => {
        e.stopPropagation();
        filterPanel.classList.toggle('open');
        if (filterPanel.classList.contains('open') && progList.children.length === 0) loadPrograms();
      });
      document.addEventListener('click', e => {
        if (!document.querySelector('#map-section .filter-wrap').contains(e.target)) filterPanel.classList.remove('open');
      });

      /* Reset */
      const resetBtn = document.getElementById('map-resetBtn');
      resetBtn.addEventListener('click', () => {
        progList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        layer.definitionExpression = "1=1";
        view.goTo(peruExtent.expand(0.96));
        document.getElementById('map-searchInput').value = '';
        document.getElementById('map-suggestions').innerHTML = '';
        view.popup.close();
      });

      /* Buscador */
      const searchBtn     = document.getElementById('map-searchBtn');
      const searchContent = document.getElementById('map-searchContent');
      const searchInput   = document.getElementById('map-searchInput');
      const clearSearch   = document.getElementById('map-clearSearch');
      const suggestions   = document.getElementById('map-suggestions');
      let allProjects     = [];
      searchBtn.addEventListener('click', e => {
        e.stopPropagation();
        searchContent.classList.toggle('open');
        if (searchContent.classList.contains('open')) searchInput.focus();
      });
      document.addEventListener('click', e => {
        if (!document.querySelector('#map-section .search-wrap').contains(e.target)) searchContent.classList.remove('open');
      });
      clearSearch.addEventListener('click', () => {
        searchInput.value = '';
        suggestions.innerHTML = '';
        searchInput.focus();
      });
      searchInput.addEventListener('input', () => {
        const val = searchInput.value.toLowerCase().trim();
        suggestions.innerHTML = '';
        if (val.length < 2) return;
        const matches = allProjects.filter(n => n.toLowerCase().includes(val)).slice(0, 20);
        matches.forEach(name => {
          const li = document.createElement('li');
          li.textContent = name;
          li.onclick = () => {
            searchInput.value = name;
            suggestions.innerHTML = '';
            searchContent.classList.remove('open');
            performSearchExact(name);
          };
          suggestions.appendChild(li);
        });
      });
      searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && searchInput.value.trim().length >= 2) {
          performSearchLike(searchInput.value.trim());
          searchContent.classList.remove('open');
        }
      });
      let layerView = null, currentHighlight = null;
      view.when(async () => {
        layerView = await view.whenLayerView(layer);
        allProjects = (await loadDistinctMap('producto_proyecto_nombre')).filter(Boolean);
      });
      function rippleAt(point){
        [0,160,320].forEach(d => setTimeout(() => {
          const g = new Graphic({ geometry: point, symbol: { type:'simple-marker', style:'circle', size:10, color:[255,255,0,0], outline:{ color:[255,255,0,1], width:2 } } });
          fxLayer.add(g);
          let s=0;
          const iv=setInterval(() => {
            s++;
            const o = Math.max(0,1-s/14);
            g.symbol = { type:'simple-marker', style:'circle', size:10+s*6, color:[255,255,0,0], outline:{ color:[255,255,0,o], width: Math.max(1,2-s*0.08) } };
            if (s > 14) { clearInterval(iv); fxLayer.remove(g); }
          }, 40);
        }, d));
      }
      function doHighlight(g){ if(currentHighlight) currentHighlight.remove(); currentHighlight = layerView.highlight(g); setTimeout(() => currentHighlight?.remove(), 5000); }
      async function performSearchExact(name){
        const base = layer.definitionExpression || '1=1';
        const q = layer.createQuery();
        q.where = `(${base}) AND producto_proyecto_nombre = '${escMap(name)}'`;
        q.returnGeometry = true;
        q.outFields = ['*'];
        const res = await layer.queryFeatures(q);
        if (res.features.length > 0) {
          const f = res.features[0];
          await view.goTo({ target: f.geometry, zoom: 15 });
          doHighlight(f);
          rippleAt(f.geometry);
          view.popup.open({ features: [f], location: f.geometry });
        }
      }
      async function performSearchLike(text){
        const base = layer.definitionExpression || '1=1';
        const q = layer.createQuery();
        q.where = `(${base}) AND producto_proyecto_nombre LIKE '%${escMap(text)}%'`;
        q.returnGeometry = true;
        q.outFields = ['*'];
        q.num = 1;
        const res = await layer.queryFeatures(q);
        if (res.features.length > 0) {
          const f = res.features[0];
          await view.goTo({ target: f.geometry, zoom: 15 });
          doHighlight(f);
          rippleAt(f.geometry);
          view.popup.open({ features: [f], location: f.geometry });
        }
      }
      /* ======= Tabla (debajo del mapa) ======= */
      async function loadRowsMap(){
        const state   = document.getElementById('map-state');
        const tb      = document.getElementById('map-tbody');
        state.textContent = 'Cargando datos…';
        const page = 2000; let offset=0; const out=[];
        while(true){
          const j = await esriPOSTMap(MAP_FS_URL+"/query", {
            where: 'monto_pim>0',
            outFields: [
              'producto_proyecto','producto_proyecto_nombre','departamento','provincia','distrito','monto_pim','monto_devengado','url_ssp','url_pdf'
            ].join(','),
            orderByFields: 'monto_pim DESC',
            resultRecordCount: page,
            resultOffset: offset
          });
          (j.features||[]).forEach(f => {
            const a = f.attributes || {};
            out.push({
              cui: a.producto_proyecto ?? '',
              inv: a.producto_proyecto_nombre ?? '',
              dep: a.departamento ?? '',
              pro: a.provincia ?? '',
              dis: a.distrito ?? '',
              pim: Number(a.monto_pim) || 0,
              dev: Number(a.monto_devengado) || 0,
              ssp: (a.url_ssp || '').trim(),
              pdf: (a.url_pdf || '').trim()
            });
          });
          if(!j.exceededTransferLimit || (j.features||[]).length < page) break;
          offset += page;
        }
        tb.innerHTML = out.map(r => `
          <tr>
            <td class="num">${r.cui || '—'}</td>
            <td class="inv-cell" data-tip="${escHtmlMap(r.inv)}">
              <span class="ellip-text" title="${escHtmlMap(r.inv)}">${escHtmlMap(r.inv)}</span>
            </td>
            <td>${escHtmlMap(r.dep) || '—'}</td>
            <td>${escHtmlMap(r.pro) || '—'}</td>
            <td>${escHtmlMap(r.dis) || '—'}</td>
            <td class="num">${moneyMap(r.pim)}</td>
            <td class="num">${moneyMap(r.dev)}</td>
            <td>${r.ssp ? `<a class="chipLink" href="${r.ssp}" target="_blank" rel="noopener">Ver detalle</a>` : `<span class="pill">—</span>`}</td>
            <td>${r.pdf ? `<a class="chipLink" href="${r.pdf}" target="_blank" rel="noopener">Ver PDF</a>` : `<span class="pill">—</span>`}</td>
          </tr>
        `).join('');
        requestAnimationFrame(() => {
          const scrollYEl = document.getElementById('map-scrollY');
          const theadEl   = document.querySelector('#map-tbl thead');
          const firstRow  = document.querySelector('#map-tbl tbody tr');
          if(scrollYEl && theadEl && firstRow){
            const hHead = theadEl.getBoundingClientRect().height;
            const hRow  = firstRow.getBoundingClientRect().height || 26;
            scrollYEl.style.maxHeight = (hHead + hRow*10) + 'px';
          }
        });
        state.innerHTML = `<strong>Lista (${out.length.toLocaleString('es-PE')} filas)</strong>`;
      }
      view.when(loadRowsMap);
    });
  })();
  </script>

<!-- Start of inserted charts section -->
<style>
/* Scoped styles for chart section */
#charts-section {
  --ink: #0b2532;
  --muted: #64748b;
  --line: #e5e7eb;
  --grid: #eef2f7;
  --brand: #1e6eb6;
}
#charts-section .wrap{max-width:1180px;margin:28px auto;padding:0 16px;box-sizing:border-box}
#charts-section .p{margin:.6rem 0 1rem;line-height:1.6;color:#3f4754;font-size:clamp(13px,1.7vw,15px)}
#charts-section .center{text-align:center}
#charts-section h3{margin:18px 0 10px;text-align:center;font-weight:900;letter-spacing:.2px;font-size:clamp(16px,2.2vw,20px);color:var(--brand)}
#charts-section .card{
  background:#fff;
  border:1px solid var(--line);
  border-radius:18px;
  padding:28px 24px 22px;
  box-shadow:0 10px 22px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.05);
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  margin:28px 0;
}
#charts-section .legend{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;min-height:28px;margin:6px 0 10px}
#charts-section .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-weight:800;font-size:12px;cursor:pointer}
#charts-section .pill[aria-pressed="false"]{opacity:.35;background:#f8fafc}
#charts-section .dot{width:9px;height:9px;border-radius:50%;box-shadow:0 0 0 2px #fff inset,0 0 0 1px #0001}
#charts-section .plot{
  position:relative;
  overflow:hidden;
  border-radius:18px;
  border:1px solid #f3f4f6;
  width:100%;
  height:420px;
  margin:12px 0 12px;
}
/* Responsive adjustments: reduce min-height on small screens */
@media (max-width:700px){#charts-section .plot{height:300px}}
@media (max-width:420px){#charts-section .plot{height:240px}}
#charts-section canvas{display:block;width:100%;height:100%}
#charts-section .empty{display:grid;place-items:center;height:100%;color:#64748b;font-size:clamp(12px,1.6vw,14px);padding:12px;text-align:center}
#charts-section .tip1{position:absolute;pointer-events:none;background:#0b2532;color:#fff;padding:7px 9px;border-radius:8px;font-size:12px;line-height:1.25;box-shadow:0 10px 24px rgba(2,6,23,.18);opacity:0;max-width:min(320px,60vw)}
#charts-section .tip1 h4{margin:0 0 5px 0;font-size:12px;letter-spacing:.02em;opacity:.9}
#charts-section .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
#charts-section .tip2{position:absolute;pointer-events:none;color:#0b2532;background:#fff;border:1px solid #e5e7eb;box-shadow:0 10px 24px rgba(2,6,23,.12),0 2px 6px rgba(2,6,23,.08);border-radius:10px;padding:9px 10px;font-size:12px;line-height:1.25;opacity:0;max-width:min(360px,72vw);z-index:1000}
#charts-section .tip2 .chip{display:inline-flex;align-items:center;gap:6px;font-weight:800;padding:3px 8px;border-radius:999px;background:#f8fafc;border:1px solid #e5e7eb;font-size:11px}
#charts-section .tip2 .chip .d{width:9px;height:9px;border-radius:50%}
#charts-section .grid{margin-top:6px;display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
#charts-section .k{color:#4b5563}
#charts-section .v{font-weight:700;text-align:right;white-space:nowrap}
#charts-section .hr{margin:6px 0;height:1px;background:#eef2f7;grid-column:1/-1}
#charts-section .long{grid-column:1/-1;text-align:left;font-weight:600}
#charts-section .tag{margin-left:6px;color:#6b7280;font-weight:700;font-style:italic}
#charts-section .panel{position:absolute;right:14px;top:14px;display:flex;flex-direction:column;gap:10px;z-index:12}
#charts-section .zoom-btn{width:44px;height:44px;border-radius:12px;border:1px solid #d9dee6;background:#fff;cursor:pointer;display:grid;place-items:center;font-size:22px;font-weight:800;color:#374151;box-shadow:0 4px 14px rgba(0,0,0,.12)}
#charts-section .zoom-btn:hover{background:#f8fafc;transform:translateY(-1px)}
#charts-section .filter{position:relative}
#charts-section .fbtn{width:44px;height:44px;border-radius:12px;border:1px solid #d9dee6;background:#fff;cursor:pointer;display:grid;place-items:center;box-shadow:0 4px 14px rgba(0,0,0,.12);color:#374151}
#charts-section .fpanel{position:absolute;right:0;top:52px;min-width:260px;max-width:min(360px,80vw);background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 18px 50px rgba(2,6,23,.16),0 6px 16px rgba(2,6,23,.10);padding:10px;display:none;z-index:20}
#charts-section .fpanel[aria-hidden="false"]{display:block}
#charts-section .fh{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
#charts-section .ft{font-weight:800;font-size:13px;color:#0b2532}
#charts-section .factions{display:flex;gap:6px}
#charts-section .factions button{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:4px 8px;font-size:11px;cursor:pointer}
#charts-section .flist{margin-top:2px;max-height:260px;overflow:auto;border-top:1px dashed #e5e7eb;padding-top:8px}
#charts-section .fi{display:flex;align-items:center;gap:8px;font-size:12px;padding:4px 2px}
#charts-section .fi input{width:14px;height:14px}
#charts-section .ffoot{margin-top:8px;font-size:11px;color:#64748b;text-align:right}
</style>
<div id="charts-section">
  <div class="wrap">
    <p class="p center">La evolución de la Ejecución Física por Programa muestra el avance físico…</p>
    <!-- ====== Gráfico 1 ====== -->
    <div class="card" id="g1">
      <h3>Evolución del avance de ejecución física por programa</h3>
      <div class="legend" id="c1-legend" role="toolbar" aria-label="Programas"></div>
      <div class="plot" id="c1-wrap" aria-live="polite">
        <canvas id="c1-canvas"></canvas>
        <div id="c1-empty" class="empty" style="display:none">Sin datos que cumplan los filtros.</div>
        <div id="c1-tip" class="tip1" role="status"></div>
      </div>
    </div>

    <p class="p center">El Devengado vs. Monto de Inversión compara cuánto del presupuesto total…</p>

    <!-- ====== Gráfico 2 ====== -->
    <div class="card" id="g2">
      <h3>Devengado acumulado vs. monto de inversión</h3>
      <div class="legend" id="c2-legend" role="toolbar" aria-label="Nivel de avance"></div>

      <div class="plot" id="c2-wrap" aria-live="polite">
        <div class="panel">
          <button class="zoom-btn" id="c2-zoomIn" title="Acercar">+</button>
          <button class="zoom-btn" id="c2-zoomOut" title="Alejar">−</button>
          <button class="zoom-btn" id="c2-zoomReset" title="Restablecer">↺</button>

          <div class="filter">
            <button id="c2-progBtn" class="fbtn" title="Filtrar por programa" aria-haspopup="true" aria-expanded="false" aria-controls="c2-progPanel">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="c2-progPanel" class="fpanel" role="dialog" aria-hidden="true" aria-label="Filtrar por programa">
              <div class="fh">
                <div class="ft">Programas</div>
                <div class="factions">
                  <button type="button" id="c2-fpAll">Todos</button>
                  <button type="button" id="c2-fpNone">Limpiar</button>
                </div>
              </div>
              <div id="c2-fpList" class="flist" role="listbox"></div>
              <div class="ffoot"><span id="c2-fpCount">0</span> seleccionados</div>
            </div>
          </div>
        </div>

        <canvas id="c2-canvas"></canvas>
        <div id="c2-empty" class="empty" style="display:none">Sin datos que cumplan los filtros.</div>
        <div id="c2-tip" class="tip2" role="status"></div>
      </div>
    </div>
  </div>
</div>
<script>
/* Chart Section Script */
(async () => {
  // Helper for ArcGIS POST requests with pagination
  async function fetchAllPOST(url, baseParams){
    const page=2000; let offset=0; const out=[];
    while(true){
      const params=new URLSearchParams({...baseParams,returnGeometry:"false",f:"json",resultRecordCount:page,resultOffset:offset});
      const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:params.toString(),cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const j=await res.json(); const feats=j.features??[]; out.push(...feats.map(f=>f.attributes||{}));
      if(!j.exceededTransferLimit && feats.length<page) break; offset+=page;
    } return out;
  }

  // Compute left padding for y-axis based on tick labels and label sizes
  function computeLeftPads(ctx, yTickStrings, axisFontPx){
    let tickW = 0;
    yTickStrings.forEach(s => { const w = ctx.measureText(String(s)).width; if (w > tickW) tickW = w; });
    const inner = 12;
    const gapLabelToTicks = 12;
    const gapTicksToPlot  = 12;
    const labelBand = axisFontPx + 26;
    const padLeft = Math.ceil(inner + labelBand + gapLabelToTicks + tickW + gapTicksToPlot);
    const labelCenterX = inner + (labelBand / 2);
    return { padLeft, labelCenterX };
  }

  /* ========= Gráfico 1 ========= */
  (function(){
    const LYR1="https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/story_monitoreo_inversiones/FeatureServer/1/query";
    const LYR13="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
    const WHERE_1="etapa IN ('OBRA','OBRA (SALDO)')";
    const WHERE_13="monto_pim > 0 AND producto_proyecto IS NOT NULL AND producto_proyecto <> 2193247";

    const BINS=[{label:"0",match:v=>Number(v)===0},{label:"0–20",match:v=>v>0&&v<20},{label:"20–40",match:v=>v>=20&&v<40},{label:"40–60",match:v=>v>=40&&v<60},{label:"60–80",match:v=>v>=60&&v<80},{label:"80–100",match:v=>v>=80&&v<=100}];
    const COLORS={PASLC:"#E69F00",PMIB:"#D55E00",PNC:"#56B4E9",PNSR:"#0072B2",PNSU:"#009E73"};
    const fallback=["#9b59b6","#7f8c8d","#8e44ad","#2c3e50","#95a5a6"];
    const colorFor=(p,i)=>COLORS[p]||fallback[i%fallback.length];

    function num(x){ if(x==null) return NaN; return typeof x==="number"?x:parseFloat(String(x).replace(",", ".")); }
    function binLabel(v){ const n=num(v); if(!isFinite(n)) return null; for(const b of BINS){ if(b.match(n)) return b.label; } return null; }

    async function loadSeries(){
      const ids13=await fetchAllPOST(LYR13,{where:WHERE_13,outFields:"producto_proyecto"});
      const valid=new Set(ids13.map(a=>a.producto_proyecto).filter(v=>v!=null));
      if(!valid.size) return [];
      const rows1=await fetchAllPOST(LYR1,{where:WHERE_1,outFields:"icodunificado,programa,avancefisicoreal"});
      const by=new Map();
      rows1.filter(r=>valid.has(r.icodunificado)).forEach(r=>{
        const prog=(r.programa??"").toString().trim(); const bin=binLabel(r.avancefisicoreal);
        if(!prog||!bin) return; if(!by.has(prog)) by.set(prog,new Map());
        const m=by.get(prog); m.set(bin,(m.get(bin)||0)+1);
      });
      const series=[]; for(const [prog,counts] of by){ series.push({programa:prog,data:BINS.map(b=>counts.get(b.label)||0)}); }
      return series.sort((a,b)=>a.programa.localeCompare(b.programa,'es'));
    }

    function drawCR(ctx,pts){
      if(pts.length<2) return; const p=i=>pts[Math.max(0,Math.min(pts.length-1,i))];
      ctx.moveTo(pts[0].x,pts[0].y);
      for(let i=0;i<pts.length-1;i++){
        const p0=p(i-1),p1=p(i),p2=p(i+1),p3=p(i+2),t=0.5;
        const cp1x=p1.x+(p2.x-p0.x)*(t/6), cp1y=p1.y+(p2.y-p0.y)*(t/6);
        const cp2x=p2.x-(p3.x-p1.x)*(t/6), cp2y=p2.y-(p3.y-p1.y)*(t/6);
        ctx.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,p2.x,p2.y);
      }
    }

    function makeChart(series){
      const wrap=document.getElementById("c1-wrap");
      const canvas=document.getElementById("c1-canvas");
      const ctx=canvas.getContext("2d");
      const empty=document.getElementById("c1-empty");
      const legend=document.getElementById("c1-legend");
      const tip=document.getElementById("c1-tip");
      if(!series.length){ empty.style.display="grid"; return; }
      empty.style.display="none";

      const visible=new Map(series.map(s=>[s.programa,true]));
      legend.innerHTML="";
      series.forEach((s,i)=>{
        const b=document.createElement("button");
        b.className="pill"; b.type="button"; b.setAttribute("aria-pressed","true");
        b.innerHTML=`<span class="dot" style="background:${colorFor(s.programa,i)}"></span>${s.programa}`;
        b.onclick=()=>{ const cur=visible.get(s.programa); visible.set(s.programa,!cur); b.setAttribute("aria-pressed",String(!cur)); draw(); };
        legend.appendChild(b);
      });

      let HIT=[];

      function draw(){
        const dpr=Math.max(1,window.devicePixelRatio||1);
        const W=wrap.clientWidth, H=wrap.clientHeight;
        canvas.width=W*dpr; canvas.height=H*dpr; canvas.style.width=W+"px"; canvas.style.height=H+"px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,W,H); HIT=[];
        ctx.font="12px system-ui";

        const yMaxData=Math.max(1,...series.flatMap(s=>visible.get(s.programa)?s.data:[0]));
        const yMax=Math.max(5,Math.ceil((yMaxData*1.12)/5)*5);
        const yTicks=[0,1,2,3,4,5].map(t=>Math.round(yMax/5*t));
        const yTickStrings=yTicks.map(v=>String(v));

        const { padLeft, labelCenterX } = computeLeftPads(ctx, yTickStrings, 12);
        const pad={t:26,r:12,b:48,l:padLeft};
        const xStep=(W-pad.l-pad.r)/(BINS.length-1);
        const x=i=>pad.l+xStep*i, y=v=>pad.t+(H-pad.t-pad.b)*(1-v/yMax);

        ctx.textAlign="right"; ctx.textBaseline="middle"; ctx.fillStyle="#0b2532";
        yTicks.forEach(val=>{ const yy=y(val); ctx.strokeStyle=val===0?"#e5e7eb":"#f3f4f6"; ctx.beginPath(); ctx.moveTo(pad.l,yy); ctx.lineTo(W-pad.r,yy); ctx.stroke(); ctx.fillText(String(val),pad.l-12,yy); });
        ctx.textAlign="center"; ctx.textBaseline="top"; BINS.forEach((b,i)=> ctx.fillText(b.label,x(i),y(0)+8));

        ctx.save(); ctx.font="700 12px system-ui"; ctx.textAlign="center"; ctx.textBaseline="top"; ctx.fillText("Avance físico",(pad.l+(W-pad.r))/2,y(0)+26); ctx.restore();
        ctx.save(); ctx.translate(labelCenterX, pad.t+(H-pad.t-pad.b)/2); ctx.rotate(-Math.PI/2); ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.font="700 12px system-ui"; ctx.fillText("Recuento por inversión",0,0); ctx.restore();

        const R=3;
        series.forEach((s,idx)=>{
          if(!visible.get(s.programa)) return;
          const col=colorFor(s.programa,idx);
          const pts=s.data.map((v,i)=>({x:x(i),y:y(v),bin:BINS[i].label,val:v,programa:s.programa,color:col}));
          ctx.strokeStyle=col; ctx.lineWidth=2; ctx.beginPath(); drawCR(ctx,pts); ctx.stroke();
          ctx.fillStyle=col; pts.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,R,0,2*Math.PI); ctx.fill(); HIT.push({x:p.x,y:p.y,r:Math.max(R+5,9),data:p}); });
        });
      }

      function placeTip(wx,wy){
        tip.style.visibility="hidden"; tip.style.display="block"; tip.style.opacity=0;
        const rect=wrap.getBoundingClientRect(), trect=tip.getBoundingClientRect(), m=8;
        let left=wx+10, top=wy-trect.height-10; if(top<m) top=wy+12; if(left+trect.width>rect.width-m) left=wx-trect.width-10;
        left=Math.max(m,Math.min(rect.width-trect.width-m,left)); top=Math.max(m,Math.min(rect.height-trect.height-m,top));
        tip.style.left=left+"px"; tip.style.top=top+"px"; tip.style.visibility="visible"; tip.style.opacity=1;
      }

      canvas.addEventListener("mousemove",(e)=>{
        const cR=canvas.getBoundingClientRect(), wR=wrap.getBoundingClientRect();
        const cx=e.clientX-cR.left, cy=e.clientY-cR.top, wx=e.clientX-wR.left, wy=e.clientY-wR.top;
        let best=null, d2b=Infinity; for(const h of HIT){ const dx=cx-h.x, dy=cy-h.y, d2=dx*dx+dy*dy; if(d2<h.r*h.r&&d2<d2b){best=h; d2b=d2;} }
        if(best){
          const b=best.data;
          tip.innerHTML=`<h4>${b.programa}</h4><div class="row"><span>Rango</span><strong>${b.bin}</strong></div><div class="row"><span>Inversiones</span><strong>${b.val}</strong></div>`;
          placeTip(wx,wy);
        }else{ tip.style.opacity=0; }
      });
      canvas.addEventListener("mouseleave",()=> tip.style.opacity=0 );

      draw(); window.addEventListener("resize",draw,{passive:true});
    }

    (async function(){ try{ const s=await loadSeries(); makeChart(s); } catch(e){ console.error(e); document.getElementById("c1-empty").style.display="grid"; } })();
  })();

  /* ========= Gráfico 2 ========= */
  (function(){
    const LYR13="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
    const LYR1 ="https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/story_monitoreo_inversiones/FeatureServer/1/query";
    const WHERE_13="monto_pim > 0 AND producto_proyecto IS NOT NULL AND producto_proyecto <> 2193247";
    const WHERE_1 ="etapa IN ('OBRA','OBRA (SALDO)') AND montoactualizadopip_decimal > 0 AND devengadoacumulado >= 0";

    const CATS=[{key:"Bajo (0%–30%)",short:"Bajo",color:"#dc2626",match:p=>p<=30},{key:"Medio (30%–70%)",short:"Medio",color:"#f59e0b",match:p=>p>30&&p<70},{key:"Alto (70%–100%)",short:"Alto",color:"#22c55e",match:p=>p>=70}];
    const pct=(d,i)=>{const x=+d,y=+i;return(!isFinite(x)||!isFinite(y)||y<=0)?0:(x/y)*100};
    const cat=p=>{for(const c of CATS){if(c.match(p))return c.short}return "Bajo";}
    const fmtMoney=n=>"S/. "+(Number(n)||0).toLocaleString("es-PE",{maximumFractionDigits:0,minimumFractionDigits:0});
    const fmtK=v=>{v=+v||0;const a=Math.abs(v);if(a>=1e9)return(v/1e9).toFixed(1).replace(/\.0$/,'')+" B";if(a>=1e6)return(v/1e6).toFixed(1).replace(/\.0$/,'')+" M";if(a>=1e3)return(v/1e3).toFixed(1).replace(/\.0$/,'')+" k";return v.toLocaleString('es-PE')}
    const fmtPct=p=>(Math.round(p*10)/10).toLocaleString('es-PE')+"%";
    const normProg=p=>(p??"(Sin programa)").toString().trim()||"(Sin programa)";

    async function loadPts(){
      const r13=await fetchAllPOST(LYR13,{where:WHERE_13,outFields:"producto_proyecto"});
      const ids=[...new Set(r13.map(r=>r.producto_proyecto).filter(v=>v!=null))];
      if(!ids.length) return [];
      const chunk=900; let r1=[];
      for(let i=0;i<ids.length;i+=chunk){
        const slice=ids.slice(i,i+chunk);
        const where=`${WHERE_1} AND icodunificado IN (${slice.join(",")})`;
        const part=await fetchAllPOST(LYR1,{where,outFields:"icodunificado,devengadoacumulado,montoactualizadopip_decimal,nombreproyecto,beneficiarios,programa"});
        r1.push(...part);
      }
      return r1.map(r=>{
        const x=+r.devengadoacumulado||0, y=+r.montoactualizadopip_decimal||0, b=+r.beneficiarios||0, p=pct(x,y);
        return {x,y,bens:b,pct:p,nivel:cat(p),icod:r.icodunificado??"",nombre:(r.nombreproyecto??"").toString().trim(),prog:normProg(r.programa)};
      }).filter(d=>d.y>0);
    }

    function makeChart(points){
      const wrap=document.getElementById("c2-wrap");
      const canvas=document.getElementById("c2-canvas");
      const ctx=canvas.getContext("2d");
      const empty=document.getElementById("c2-empty");
      const tip=document.getElementById("c2-tip");
      const legend=document.getElementById("c2-legend");
      if(!points.length){ empty.style.display="grid"; return; }
      empty.style.display="none";

      const progs=[...new Set(points.map(p=>p.prog))].sort((a,b)=>a.localeCompare(b,'es'));
      let selected=new Set(progs);

      const btn=document.getElementById('c2-progBtn');
      const panel=document.getElementById('c2-progPanel');
      const list=document.getElementById('c2-fpList');
      const all=document.getElementById('c2-fpAll');
      const none=document.getElementById('c2-fpNone');
      const cnt=document.getElementById('c2-fpCount');
      const upd=()=> cnt.textContent=selected.size;
      function render(){ list.innerHTML=""; for(const p of progs){ const id='p_'+btoa(encodeURIComponent(p)).replace(/=+/g,''); const el=document.createElement('label'); el.className='fi'; el.setAttribute('role','option'); el.innerHTML=`<input type="checkbox" id="${id}" ${selected.has(p)?'checked':''} data-prog="${p}"><span>${p}</span>`; list.appendChild(el);} }
      function open(){ panel.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); render(); upd(); }
      function close(){ panel.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); }
      btn.addEventListener('click', ()=> (panel.getAttribute('aria-hidden')==='false')?close():open());
      document.addEventListener('click',(e)=>{ if(!panel.contains(e.target)&&!btn.contains(e.target)) close(); });
      window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close(); });
      list.addEventListener('change',(e)=>{ const cb=e.target; if(cb && cb.matches('input[type="checkbox"][data-prog]')){ const p=cb.getAttribute('data-prog'); cb.checked?selected.add(p):selected.delete(p); upd(); draw(); }});
      all.addEventListener('click',()=>{ selected=new Set(progs); upd(); render(); draw(); });
      none.addEventListener('click',()=>{ selected.clear(); upd(); render(); draw(); });

      const vis=new Map(CATS.map(c=>[c.short,true]));
      legend.innerHTML=""; CATS.forEach(c=>{
        const b=document.createElement("button"); b.className="pill"; b.type="button"; b.setAttribute("aria-pressed","true");
        b.innerHTML=`<span class="dot" style="background:${c.color}"></span>${c.key}`;
        b.onclick=()=>{ const cur=vis.get(c.short); vis.set(c.short,!cur); b.setAttribute("aria-pressed",String(!cur)); draw(); };
        legend.appendChild(b);
      });

      const maxB=Math.max(1,...points.map(p=>p.bens||0));
      const rScale=b=>{const t=Math.sqrt((b||0)/maxB); return 4 + t*18;};

      let dims={},scale={},plot={},HIT=[],view={minX:0,maxX:1,minY:0,maxY:1,dataMaxX:1,dataMaxY:1},hasAny=true;

      function ext(){ const act=points.filter(p=>selected.has(p.prog)&&vis.get(p.nivel)); hasAny=act.length>0; view.dataMaxX=Math.max(1,...act.map(p=>p.x),1); view.dataMaxY=Math.max(1,...act.map(p=>p.y),1); if(view.maxX===1&&view.maxY===1){view.minX=0;view.maxX=view.dataMaxX;view.minY=0;view.maxY=view.dataMaxY;} }

      function compute(){
        const dpr=Math.max(1,window.devicePixelRatio||1);
        const W=wrap.clientWidth,H=wrap.clientHeight;
        canvas.width=W*dpr; canvas.height=H*dpr; canvas.style.width=W+"px"; canvas.style.height=H+"px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
        dims={W,H}; ctx.font="12px system-ui";

        const numTicks=5; const yVals=[]; for(let i=0;i<=numTicks;i++){ const v=view.minY+(view.maxY-view.minY)*i/numTicks; yVals.push(v); }
        const yStrings=yVals.map(v=>fmtK(v));

        const { padLeft, labelCenterX } = computeLeftPads(ctx, yStrings, 12);

        const pad={t:24,r:14,b:56,l:padLeft};
        plot={x:pad.l,y:pad.t,w:W-pad.l-pad.r,h:H-pad.t-pad.b};
        scale={
          pad, plot, labelCenterX,
          x:v=>pad.l+plot.w*((v-view.minX)/((view.maxX-view.minX)||1)),
          y:v=>pad.t+plot.h*(1-(v-view.minY)/((view.maxY-view.minY)||1)),
          invX:px=>view.minX+(view.maxX-view.minX)*((px-pad.l)/(plot.w||1)),
          invY:py=>view.minY+(view.maxY-view.minY)*(1-(py-pad.t)/(plot.h||1))
        };
      }

      function axes(){
        const {pad,labelCenterX}=scale; const {W,H}=dims; ctx.clearRect(0,0,W,H);
        ctx.textAlign="right"; ctx.textBaseline="middle"; ctx.font="12px system-ui"; ctx.fillStyle="#0b2532";
        const yT=5;
        for(let i=0;i<=yT;i++){
          const v = view.minY + (view.maxY - view.minY) * i / yT;
          const yy = scale.y(v);
          ctx.strokeStyle = i===0 ? "#e5e7eb" : "#f3f4f6";
          ctx.beginPath(); ctx.moveTo(pad.l, yy); ctx.lineTo(pad.l + scale.plot.w, yy); ctx.stroke();
          ctx.fillText(fmtK(v), pad.l - 12, yy);
        }
        ctx.textAlign="center"; ctx.textBaseline="top"; const xT=5; const y0=H - pad.b;
        for(let i=0;i<=xT;i++){
          const v = view.minX + (view.maxX - view.minX) * i / xT;
          const xx = scale.x(v);
          ctx.strokeStyle="#e5e7eb";
          ctx.beginPath(); ctx.moveTo(xx, pad.t); ctx.lineTo(xx, y0); ctx.stroke();
          ctx.fillText(fmtK(v), xx, y0 + 14);
        }
        ctx.save(); ctx.fillStyle="#0b2532"; ctx.font="700 12px system-ui";
        ctx.translate(labelCenterX, pad.t + scale.plot.h/2);
        ctx.rotate(-Math.PI/2); ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText("Monto de inversión", 0, 0);
        ctx.restore();

        ctx.textAlign="center"; ctx.textBaseline="bottom"; ctx.font="700 12px system-ui";
        ctx.fillText("Devengado acumulado", pad.l + scale.plot.w/2, H - 8);
      }

      const inPlot=(px,py)=> px>=plot.x && px<=plot.x+plot.w && py>=plot.y && py<=plot.y+plot.h;

      function drawPts(){
        HIT=[]; ctx.save(); ctx.beginPath(); ctx.rect(plot.x,plot.y,plot.w,plot.h); ctx.clip();
        points.forEach(p=>{
          if(!selected.has(p.prog) || !vis.get(p.nivel)) return;
          const color = p.nivel==="Bajo" ? "#dc2626" : (p.nivel==="Medio" ? "#f59e0b" : "#22c55e");
          const x=scale.x(p.x), y=scale.y(p.y), r=rScale(p.bens);
          if(!isFinite(x)||!isFinite(y)) return;
          ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
          if(inPlot(x,y)) HIT.push({x,y,r:Math.max(r+2,9),data:p,color,key:p.nivel});
        });
        ctx.restore();
      }

      function clamp(){ const minX=(view.dataMaxX)/1000, minY=(view.dataMaxY)/1000; if(view.maxX-view.minX<minX){ const cx=(view.minX+view.maxX)/2; view.minX=cx-minX/2; view.maxX=cx+minX/2; } if(view.maxY-view.minY<minY){ const cy=(view.minY+view.maxY)/2; view.minY=cy-minY/2; view.maxY=cy+minY/2; } view.minX=Math.max(0,view.minX); view.maxX=Math.min(view.dataMaxX,view.maxX); view.minY=Math.max(0,view.minY); view.maxY=Math.min(view.dataMaxY,view.maxY); }
      function zoom(f,cx=null,cy=null){ if(cx===null) cx=(view.minX+view.maxX)/2; if(cy===null) cy=(view.minY+view.maxY)/2; const w=(view.maxX-view.minX)*f, h=(view.maxY-view.minY)*f; view.minX=cx-w/2; view.maxX=cx+w/2; view.minY=cy-h/2; view.maxY=cy+h/2; clamp(); draw(); }
      function pan(dx,dy){ const sx=view.maxX-view.minX, sy=view.maxY-view.minY; view.minX-=dx*sx; view.maxX-=dx*sx; view.minY+=dy*sy; view.maxY+=dy*sy; clamp(); draw(); }
      function reset(){ view.minX=0; view.maxX=view.dataMaxX; view.minY=0; view.maxY=view.dataMaxY; draw(); }
      function draw(){ ext(); empty.style.display=hasAny?'none':'grid'; compute(); axes(); if(hasAny) drawPts(); }

      document.getElementById('c2-zoomIn').addEventListener('click',()=>zoom(0.75));
      document.getElementById('c2-zoomOut').addEventListener('click',()=>zoom(1.25));
      document.getElementById('c2-zoomReset').addEventListener('click',reset);

      canvas.addEventListener('wheel',(e)=>{ e.preventDefault(); const r=canvas.getBoundingClientRect(); const mx=e.clientX-r.left,my=e.clientY-r.top; if(!inPlot(mx,my)) return; const dx=scale.invX(mx), dy=scale.invY(my); const f=e.deltaY>0?1.2:1/1.2; zoom(f,dx,dy); },{passive:false});

      let drag=false,lx=0,ly=0;
      canvas.addEventListener('mousedown',(e)=>{ const r=canvas.getBoundingClientRect(); const mx=e.clientX-r.left,my=e.clientY-r.top; if(!inPlot(mx,my)) return; drag=true; lx=e.clientX; ly=e.clientY; canvas.style.cursor='grabbing'; tip.style.opacity=0; });
      window.addEventListener('mousemove',(e)=>{ if(!drag) return; const dx=(e.clientX-lx)/(scale.plot.w||1), dy=(e.clientY-ly)/(scale.plot.h||1); pan(dx,dy); lx=e.clientX; ly=e.clientY; });
      window.addEventListener('mouseup',()=>{ drag=false; canvas.style.cursor='default'; });

      function hit(mx,my){ if(!inPlot(mx,my)) return null; for(let i=HIT.length-1;i>=0;i--){ const h=HIT[i],dx=mx-h.x,dy=my-h.y; if(dx*dx+dy*dy<=h.r*h.r) return h; } return null; }
      function placeTip(mx,my){ const wR=wrap.getBoundingClientRect(), tR=tip.getBoundingClientRect(), m=10; let left=mx+12, top=my-tR.height-12; if(left+tR.width>wR.width-m) left=mx-tR.width-12; if(left<m) left=m; if(top<m) top=my+18; if(top+tR.height>wR.height-m) top=wR.height-tR.height-m; tip.style.left=left+"px"; tip.style.top=top+"px"; }
      canvas.addEventListener('mousemove',(e)=>{ const r=canvas.getBoundingClientRect(); const mx=e.clientX-r.left,my=e.clientY-r.top; const h=hit(mx,my); canvas.style.cursor=h?'pointer':(inPlot(mx,my)?'crosshair':'default'); if(h){ const d=h.data; tip.innerHTML=`<span class="chip"><span class="d" style="background:${h.color}"></span>${h.key}</span><div class="grid"><div class="k">Devengado acumulado <span class="tag">(<b><i>X</i></b>)</span></div><div class="v">${fmtMoney(d.x)}</div><div class="k">Monto de inversión <span class="tag">(<b><i>Y</i></b>)</span></div><div class="v">${fmtMoney(d.y)}</div><div class="k">Beneficiarios <span class="tag">(<b><i>tamaño</i></b>)</span></div><div class="v">${(d.bens||0).toLocaleString('es-PE')}</div><div class="k">% Avance <span class="tag">(<b><i>color</i></b>)</span></div><div class="v">${fmtPct(d.pct)}</div>${d.prog?`<div class="k">Programa</div><div class="v">${d.prog}</div>`:''}${d.icod?`<div class="k">CUI</div><div class="v">${d.icod}</div>`:''}${d.nombre?`<div class="hr"></div><div class="long">${d.nombre}</div>`:''}</div>`; tip.style.display='block'; tip.style.opacity='0'; placeTip(mx,my); tip.style.opacity='1'; } else { tip.style.opacity='0'; tip.style.display='none'; } });
      canvas.addEventListener('mouseleave',()=>{ tip.style.opacity='0'; tip.style.display='none'; });

      draw(); window.addEventListener('resize',draw,{passive:true});
    }

    (async function(){ try{ const pts=await loadPts(); makeChart(pts); } catch(err){ console.error(err); const el=document.getElementById("c2-empty"); el.style.display="grid"; el.textContent="Error al cargar datos"; } })();
  })();
})();
</script>
<!-- End of inserted charts section -->
</body>
</html>
