<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Grado de dispersión de centros poblados - PNSR</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.30/"></script>

<style>
  :root{ --ink:#0b2532; --muted:#64748b; --line:#0e4a43; --panel:#f7fbfa; --brand:#0b3b38; --accent:#0f2e29; --sep:#e6ecea; }
  html,body{height:100%;margin:0;background:#eef5f3;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  body{display:grid;grid-template-rows:auto 1fr;overflow:hidden}
  .mainTitleBar{width:100%;background:#fff;border-bottom:1px solid var(--sep);box-shadow:0 2px 6px rgba(0,0,0,.08);padding:12px 10px;position:sticky;top:0;z-index:20}
  .mainTitle{margin:0;text-align:center;font-weight:1000;font-size:clamp(22px,3.6vh,30px);color:var(--brand);letter-spacing:.3px}
  .shell{display:grid;grid-template-columns:65% 35%;height:100%;width:100%;overflow:hidden}
  #viewWrap{position:relative;height:100%;overflow:hidden}
  #viewDiv{position:relative;width:100%;height:100%}
  .sidebar{background:var(--panel);border-left:1px solid var(--sep);box-shadow:-6px 0 24px rgba(2,6,23,.06);padding:14px 12px;display:grid;grid-template-rows:auto auto 1fr;gap:12px;min-height:0}
  .filtersBar{background:#fff;border:1px solid var(--sep);border-radius:16px;box-shadow:0 10px 22px rgba(2,6,23,.06);padding:12px;display:grid;gap:10px;min-height:146px;contain:layout}
  .filtersGrid{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px;align-items:start}
  @media (max-width:900px){ .filtersGrid{grid-template-columns:1fr 1fr} }
  .fld{display:grid;gap:6px;min-width:0}
  .fld label{white-space:nowrap;font-size:12px;color:#47606b;font-weight:900;letter-spacing:.2px}
  .fld select{padding:10px 12px;border:1px solid #cfe7e3;border-radius:12px;background:#e8f5f3;color:#0b3b38;font-weight:800;font-size:13.5px;outline:none;height:42px;line-height:20px;width:100%;min-width:0}
  .fld select:disabled{opacity:.6}
  .rowBtns{display:flex;justify-content:flex-end}
  .btn{background:#0b3b38;color:#ecfffb;border:1px solid #0e4a43;padding:9px 14px;border-radius:12px;font-weight:900;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .indPanel{background:#fff;border:1px solid var(--sep);border-radius:16px;box-shadow:0 10px 22px rgba(2,6,23,.06);padding:12px;min-height:min(16vh,140px);display:grid;place-items:center;color:#93a1ad;font-weight:800}
  .indPanel::before{content:"(Espacio para Indicadores)";}
  .lowerGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;min-height:0}
  @media (max-width:900px){ .lowerGrid{grid-template-columns:1fr} }
  .card{background:#fff;border:1px solid var(--sep);border-radius:16px;box-shadow:0 10px 24px rgba(2,6,23,.06);overflow:hidden;display:grid;grid-template-rows:auto 1fr;min-height:0}
  .card header{padding:10px 12px;background:#fff;border-bottom:1px solid var(--sep)}
  .card h3{margin:0;font-size:14px;font-weight:1000;color:var(--brand);letter-spacing:.2px}
  .list{overflow:auto;min-height:0}
  .item{padding:10px 12px;border-bottom:1px solid #edf2f7;cursor:pointer;transition:background .15s ease}
  .item:hover{background:#f5faf8}
  .title{font-weight:900;font-size:13.8px}
  .kv{font-size:12.2px;color:#334155;line-height:1.35}
  .kv b{color:#0b2532}
  .empty{padding:16px;text-align:center;color:#64748b;font-size:12.8px}
  .commentWrap{padding:12px;overflow:auto;display:grid;gap:10px;align-content:start}
  .commentWrap p{margin:0;font-size:13.6px;color:#243b41}
  .commentImg{width:70%;max-width:220px;height:auto;border-radius:12px;border:1px solid #e3ecea;justify-self:center;display:block}
</style>
</head>
<body>
  <header class="mainTitleBar">
    <h1 class="mainTitle">Grado de dispersión de centros poblados - PNSR</h1>
  </header>

  <div class="shell">
    <div id="viewWrap"><div id="viewDiv"></div></div>

    <aside class="sidebar">
      <section class="filtersBar" aria-label="Filtros de ubicación">
        <div class="filtersGrid">
          <div class="fld">
            <label for="selDep">Departamento</label>
            <select id="selDep"><option value="">(Todos)</option></select>
          </div>
          <div class="fld">
            <label for="selProv">Provincia</label>
            <select id="selProv" disabled><option value="">(Todas)</option></select>
          </div>
          <div class="fld">
            <label for="selDist">Distrito</label>
            <select id="selDist" disabled><option value="">(Todos)</option></select>
          </div>
          <div class="fld">
            <label for="selCCPP">Centro poblado</label>
            <select id="selCCPP" disabled><option value="">(Seleccione un ámbito)</option></select>
          </div>
        </div>
        <div class="rowBtns"><button id="btnClear" class="btn" type="button">Limpiar filtros</button></div>
      </section>

      <section class="indPanel" aria-label="Indicadores (pendiente)"></section>

      <section class="lowerGrid">
        <div class="card">
          <header><h3>Centros poblados (lista)</h3></header>
          <div class="list" id="cpList"><div class="empty">Cargando…</div></div>
        </div>
        <div class="card">
          <header><h3>Comentario</h3></header>
          <div class="commentWrap">
            <p>La herramienta muestra las <b>áreas de concentración</b> y las <b>viviendas rurales sin acceso a agua</b> (Censo 2017). Asimismo, se complementa con información de <b>componentes y redes de agua del DATASS</b> (módulo 3 y 5).</p>
            <img class="commentImg" loading="lazy" alt="Esquema de criterios" src="https://lh3.googleusercontent.com/d/1OPw9CWsW8xmgL6sjGuZcyvAtz2qJi0RF=w1000"/>
          </div>
        </div>
      </section>
    </aside>
  </div>

<script>
require([
  "esri/Map","esri/views/MapView",
  "esri/layers/FeatureLayer","esri/layers/GraphicsLayer",
  "esri/widgets/ScaleBar",
  "esri/renderers/UniqueValueRenderer","esri/renderers/SimpleRenderer",
  "esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol",
  "esri/Graphic","esri/geometry/geometryEngine"
], (Map,MapView,FeatureLayer,GraphicsLayer,ScaleBar,UniqueValueRenderer,SimpleRenderer,SimpleFillSymbol,SimpleLineSymbol,SimpleMarkerSymbol,Graphic,geometryEngine)=>{

  /* ===== ENDPOINTS ===== */
  const CCPP = "https://pportalgis.vivienda.gob.pe/pfdserver1/rest/services/OGEI/CCPP_Dispersos/FeatureServer";
  const CP_GRADO = `${CCPP}/4`; // CCPP (nom_ccpp/ubigeo)
  const VR   = "https://dportalgis.vivienda.gob.pe/dfdserver/rest/services/OGEI/vivienda_rural/FeatureServer/0";
  const LIM_BASE = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer";
  const LIM0 = `${LIM_BASE}/0`; // deps
  const LIM1 = `${LIM_BASE}/1`; // provs
  const LIM2 = `${LIM_BASE}/2`; // dists

  /* ===== MAPA ===== */
  const map = new Map({ basemap:"satellite" });
  const view = new MapView({
    container:"viewDiv",
    map,
    center:[-69.155,-16.274],
    scale:65000,
    constraints:{minZoom:4,snapToZoom:false}
  });
  view.ui.add(new ScaleBar({view,unit:"metric"}),"bottom-left");
  view.qualityProfile = "low";

  /* ===== Simbología auxiliar ===== */
  const mk=(c,s=6)=> new SimpleMarkerSymbol({style:"circle",color:c,size:s,outline:{color:[255,255,255,180],width:0.5}});
  const tri=(c,s=7)=> new SimpleMarkerSymbol({style:"triangle",color:c,size:s,outline:{color:[255,255,255,180],width:0.5}});
  const diam=(c,s=8)=> new SimpleMarkerSymbol({style:"diamond",color:c,size:s,outline:{color:[255,255,255,180],width:0.5}});
  const line=(c,w=1.2)=> new SimpleLineSymbol({color:c,width:w});
  const poly=(fill,outline)=> new SimpleFillSymbol({color:fill,outline});

  function glowCIM(colorRGB=[255,255,255]){
    const [r,g,b]=colorRGB;
    return { type:"cim", data:{ type:"CIMSymbolReference", symbol:{
      type:"CIMLineSymbol", symbolLayers:[
        { type:"CIMSolidStroke", enable:true, width:6,  color:[r,g,b,40]  },
        { type:"CIMSolidStroke", enable:true, width:3,  color:[r,g,b,120] },
        { type:"CIMSolidStroke", enable:true, width:1.6,color:[r,g,b,255] }
      ]}}};
  }

  /* ===== Capas ===== */
  const SCALE_PROV = 1200000;
  const SCALE_RED  = 600000;

  const lyrAreasAgrup = new FeatureLayer({
    url:`${CCPP}/6`, title:"Áreas agrupadas (densidad y viviendas)",
    visible:true, minScale:SCALE_PROV,
    renderer:new SimpleRenderer({
      symbol: poly([212,124,242,0.50], new SimpleLineSymbol({color:[0,0,0,0.9], width:1.2, style:"short-dot"}))
    })
  });

  const lyrAmbito = new FeatureLayer({
    url:`${CCPP}/5`, title:"Ámbito territorial de centros poblados",
    visible:true, minScale:SCALE_PROV,
    renderer:new SimpleRenderer({ symbol: poly([0,0,0,0], new SimpleLineSymbol({color:[0,0,0,0.9], width:1.2, style:"short-dot"})) })
  });

  const lyrCPGrado = new FeatureLayer({
    url:CP_GRADO, title:"Centro poblado por grado de dispersión",
    visible:true, minScale:1000000,
    renderer:new SimpleRenderer({ symbol: mk([200,200,200,0.95], 5.5) })
  });

  const lyrRedes  = new FeatureLayer({ url:`${CCPP}/3`, title:"Redes - DATASS",   visible:true, minScale:SCALE_RED,  renderer:new SimpleRenderer({ symbol: line([95,210,255,0.95], 1.4) }) });
  const lyrReserv = new FeatureLayer({ url:`${CCPP}/2`, title:"Reservorio - DATASS",visible:true, minScale:SCALE_PROV, renderer:new SimpleRenderer({ symbol: diam([46,204,64,0.95], 8) }) });
  const lyrCapt   = new FeatureLayer({ url:`${CCPP}/1`, title:"Captación - DTASS", visible:true, minScale:SCALE_PROV, renderer:new SimpleRenderer({ symbol: tri([52,152,219,0.95], 8) }) });
  const lyrPTAP   = new FeatureLayer({ url:`${CCPP}/0`, title:"PTAP - DATASS",     visible:true, minScale:SCALE_PROV, renderer:new SimpleRenderer({ symbol: mk([231,76,60,0.95], 7.5) }) });

  const viviendaRural = new FeatureLayer({
    url:VR, title:"Vivienda rural - Viviendas Rurales",
    outFields:["*"], definitionExpression:"1=1", minScale:SCALE_PROV, maxScale:0, visible:true
  });
  viviendaRural.when(()=>{
    const FIELD="dhabcual";
    const COL_DEF=[198,42,75,0.90], COL_SIN=[60,130,246,0.90], COL_OTR=[168,170,175,0.70];
    const mkGeom=(g,c)=> g==="polygon" ? poly(c,new SimpleLineSymbol({color:[255,255,255,1],width:0.5})) : (g==="polyline"?line(c,2):mk(c,7));
    viviendaRural.renderer = new UniqueValueRenderer({
      field:FIELD, defaultSymbol:null,
      uniqueValueInfos:[
        {value:"Con Deficit Cualitativo",label:"Con Déficit Cualitativo",symbol:mkGeom(viviendaRural.geometryType,COL_DEF)},
        {value:"Sin Dcficit Cualitativo",label:"Sin Déficit Cualitativo",symbol:mkGeom(viviendaRural.geometryType,COL_SIN)},
        {value:"Otro",label:"Otro",symbol:mkGeom(viviendaRural.geometryType,COL_OTR)}
      ]
    });
  });

  map.addMany([lyrAreasAgrup, viviendaRural, lyrPTAP, lyrCapt, lyrReserv, lyrRedes, lyrCPGrado, lyrAmbito]);

  // LÍMITES con brillo
  const limDeptDraw = new FeatureLayer({ url:LIM0, title:"Límite Departamental", visible:false, renderer:new SimpleRenderer({ symbol: glowCIM([0,255,255]) }), blendMode:"screen" });
  const limProvDraw = new FeatureLayer({ url:LIM1, title:"Límite Provincial",  visible:false, renderer:new SimpleRenderer({ symbol: glowCIM([255,215,0]) }), blendMode:"screen" });
  const limDistDraw = new FeatureLayer({ url:LIM2, title:"Límite Distrital",   visible:false, renderer:new SimpleRenderer({ symbol: glowCIM([255,105,180]) }), blendMode:"screen" });
  map.addMany([limDeptDraw, limProvDraw, limDistDraw]);

  /* ===== LISTA + FILTROS ===== */
  const cpLayer = lyrAmbito;
  let layerView, hl; view.whenLayerView(cpLayer).then(lv=>layerView=lv);

  // fuentes para combos
  const limDeptSrc = new FeatureLayer({ url:LIM0, outFields:["id_dpto","nom_dep"], listMode:"hide" });
  const limProvSrc = new FeatureLayer({ url:LIM1, outFields:["id_dep","id_prov","nom_prov"], listMode:"hide" });
  const limDistSrc = new FeatureLayer({ url:LIM2, outFields:["id_prov","id_dist","nom_dist"], listMode:"hide" });

  // fuente CCPP (para el combo)
  const ccppSrc = new FeatureLayer({ url:CP_GRADO, outFields:["*"], listMode:"hide" });

  // capa para resaltar CCPP seleccionado (pulso)
  const focusLayer = new GraphicsLayer({ listMode:"hide" });
  map.add(focusLayer);
  let pulseTimer = null;

  const $list   = document.getElementById('cpList');
  const $selDep = document.getElementById('selDep');
  const $selProv= document.getElementById('selProv');
  const $selDist= document.getElementById('selDist');
  const $selCCPP= document.getElementById('selCCPP');
  const $btnClear= document.getElementById('btnClear');

  const PAD = { left: 120, right: 120, top: 200, bottom: 110 };
  const fmt = (n, d=0)=> (n==null||isNaN(n)) ? "—" : new Intl.NumberFormat('es-PE',{maximumFractionDigits:d}).format(Number(n));

  /* ====== CARGA COMBOS DPTO/PROV/DIST ====== */
  async function loadDeps(){
    const q = limDeptSrc.createQuery();
    q.where="1=1"; q.returnGeometry=false; q.outFields=["id_dpto","nom_dep"]; q.orderByFields=["nom_dep ASC"]; q.num=300; q.cacheHint=true;
    const r = await limDeptSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{ const id=f.attributes?.id_dpto, name=f.attributes?.nom_dep; if(id&&!seen.has(id)){ seen.add(id); rows.push({id,name}); }});
    $selDep.innerHTML = `<option value="">(Todos)</option>` + rows.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
    $selProv.innerHTML = `<option value="">(Todas)</option>`; $selProv.disabled=true;
    $selDist.innerHTML = `<option value="">(Todos)</option>`; $selDist.disabled=true;
    await populateCCPPOptions(); // al inicio
  }

  async function loadProvs(){
    const dep = $selDep.value.trim();
    $selProv.innerHTML = `<option value="">(Todas)</option>`;
    $selDist.innerHTML = `<option value="">(Todos)</option>`; $selDist.disabled=true;
    if(!dep){ $selProv.disabled=true; await populateCCPPOptions(); return; }
    const q = limProvSrc.createQuery();
    q.where = `id_dep='${dep}'`; q.returnGeometry=false; q.outFields=["id_prov","nom_prov"]; q.orderByFields=["nom_prov ASC"]; q.num=1000; q.cacheHint=true;
    const r = await limProvSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{ const id=f.attributes?.id_prov, name=f.attributes?.nom_prov; if(id&&!seen.has(id)){ seen.add(id); rows.push({id,name}); }});
    $selProv.innerHTML += rows.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
    $selProv.disabled=false;
    await populateCCPPOptions();
  }

  async function loadDists(){
    const prov = $selProv.value.trim();
    $selDist.innerHTML = `<option value="">(Todos)</option>`;
    if(!prov){ $selDist.disabled=true; await populateCCPPOptions(); return; }
    const q = limDistSrc.createQuery();
    q.where = `id_prov='${prov}'`; q.returnGeometry=false; q.outFields=["id_dist","nom_dist"]; q.orderByFields=["nom_dist ASC"]; q.num=3000; q.cacheHint=true;
    const r = await limDistSrc.queryFeatures(q);
    const seen=new Set(), rows=[];
    (r.features||[]).forEach(f=>{ const id=f.attributes?.id_dist, name=f.attributes?.nom_dist; if(id&&!seen.has(id)){ seen.add(id); rows.push({id,name}); }});
    $selDist.innerHTML += rows.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
    $selDist.disabled=false;
    await populateCCPPOptions();
  }

  /* ===== Mostrar SOLO el límite seleccionado ===== */
  function updatePoliticalLimitVisibility(){
    const dep  = $selDep.value.trim();
    const prov = $selProv.value.trim();
    const dist = $selDist.value.trim();
    [limDeptDraw, limProvDraw, limDistDraw].forEach(ly=>{ ly.visible=false; ly.definitionExpression=null; });
    if(dist){ limDistDraw.definitionExpression = `id_dist='${dist}'`; limDistDraw.visible=true; return; }
    if(prov){ limProvDraw.definitionExpression = `id_prov='${prov}'`; limProvDraw.visible=true; return; }
    if(dep){  limDeptDraw.definitionExpression = `id_dpto='${dep}'`; limDeptDraw.visible=true; }
  }

  /* ===== Zoom completo al límite seleccionado ===== */
  async function zoomToPolitical(){
    let src=null, where=null;
    const dist=$selDist.value.trim(), prov=$selProv.value.trim(), dep=$selDep.value.trim();
    if(dist){ src=limDistSrc; where=`id_dist='${dist}'`; }
    else if(prov){ src=limProvSrc; where=`id_prov='${prov}'`; }
    else if(dep){ src=limDeptSrc; where=`id_dpto='${dep}'`; }
    else { return; }

    const q = src.createQuery(); q.where=where; q.returnGeometry=true; q.outFields=[]; q.num=1;
    const r = await src.queryFeatures(q); const g = r.features?.[0]?.geometry; if(!g) return;
    try{
      await view.goTo({ target:g, padding:{left:40,right:40,top:60,bottom:60} }, { duration:900, easing:"ease-in-out" });
    }catch(_){}
  }

  /* ===== Lista (desde ámbito) ===== */
  function buildWhere(){
    const dep=$selDep.value.trim(), prov=$selProv.value.trim(), dist=$selDist.value.trim();
    const parts=["1=1"]; if(dep) parts.push(`id_dpto='${dep}'`); if(prov) parts.push(`id_prov='${prov}'`); if(dist) parts.push(`id_dist='${dist}'`);
    return parts.join(" AND ");
  }

  async function cargarLista(){
    const q = cpLayer.createQuery();
    q.where = buildWhere();
    q.outFields = ["objectid","OBJECTID","nom_cp","NOM_CP","categoria_cp","vivrur_tot","vivrur_agrup_p","sum_pobcensa","distnear_max","distnear_min","id_dpto","id_prov","id_dist"];
    q.returnGeometry=false; q.num=2000; q.orderByFields=["nom_cp ASC","NOM_CP ASC"]; q.cacheHint=true;
    const res = await cpLayer.queryFeatures(q);
    pintarLista(res.features||[]);
  }

  async function flyToFeatureByOID(oid){
    const q = cpLayer.createQuery();
    q.objectIds=[oid]; q.outFields=[]; q.returnGeometry=true;
    const r = await cpLayer.queryFeatures(q);
    const feat = r.features?.[0]; if(!feat) return;
    const geom = feat.geometry;
    let target = geom.extent ? geom.extent.clone() : null;
    if(!target || target.isEmpty || (target.xmin===target.xmax && target.ymin===target.ymax)){
      const center = geom.centroid || view.center;
      try{ await view.goTo({ center, scale: 18000 }, { duration:1100, easing:"ease-in-out" }); }catch(_){}
      return;
    }
    const w=Math.max(target.width,target.height);
    const expand = w<500?3:w<2000?2.2:w<8000?1.7:1.45;
    try{ await view.goTo({ target: target.expand(expand), padding: {left:120,right:120,top:200,bottom:110} }, { duration:1100, easing:"ease-in-out", animate:true }); }catch(_){}
  }

  function pintarLista(features){
    if(hl){ hl.remove(); hl=null; }
    if(!features.length){ $list.innerHTML = `<div class="empty">Sin resultados</div>`; return; }
    const fmt=(n,d=0)=> (n==null||isNaN(n)) ? "—" : new Intl.NumberFormat('es-PE',{maximumFractionDigits:d}).format(Number(n));
    $list.innerHTML = features.map(f=>{
      const a=f.attributes||{}; const OID=a.objectid ?? a.OBJECTID;
      const nombre=a.nom_cp ?? a.NOM_CP ?? "—"; const titulo=`${nombre} (${a.categoria_cp ?? "—"})`;
      return `<div class="item" data-oid="${OID}">
        <div class="title">${titulo}</div>
        <div class="kv"><b>Vivienda rural total:</b> ${fmt(a.vivrur_tot)}</div>
        <div class="kv"><b>Vivienda rural concentrado:</b> ${fmt(a.vivrur_agrup_p,1)} %</div>
        <div class="kv"><b>Población rural:</b> ${fmt(a.sum_pobcensa)}</div>
        <div class="kv"><b>Distancia máxima entre viviendas:</b> ${fmt(a.distnear_max,2)} m.</div>
        <div class="kv"><b>Distancia mínima entre viviendas:</b> ${fmt(a.distnear_min,2)} m.</div>
      </div>`;
    }).join("");

    $list.querySelectorAll(".item").forEach((el)=>{
      el.addEventListener("click", async ()=>{
        const oid = Number(el.dataset.oid);
        try{
          if(layerView){ if(hl) hl.remove(); hl = layerView.highlight(oid); }
          await flyToFeatureByOID(oid);
        }catch(_){}
      });
    });
  }

  /* ====== NUEVO: obtengo geometría del ámbito (dep/prov/dist) ====== */
  async function getSelectedBoundaryGeometry(){
    const dist=$selDist.value.trim(), prov=$selProv.value.trim(), dep=$selDep.value.trim();
    let src=null, where=null;
    if(dist){ src=limDistSrc; where=`id_dist='${dist}'`; }
    else if(prov){ src=limProvSrc; where=`id_prov='${prov}'`; }
    else if(dep){ src=limDeptSrc; where=`id_dpto='${dep}'`; }
    else { return null; }
    const q = src.createQuery(); q.where=where; q.returnGeometry=true; q.outFields=[]; q.num=1;
    const r = await src.queryFeatures(q);
    return r.features?.[0]?.geometry ?? null;
  }

  /* ====== CCPP: ahora filtro por geometría (intersects) ====== */
  async function populateCCPPOptions(){
    const geom = await getSelectedBoundaryGeometry();
    if(!geom){
      $selCCPP.innerHTML = `<option value="">(Seleccione un ámbito)</option>`;
      $selCCPP.disabled = true;
      return;
    }
    const q = ccppSrc.createQuery();
    q.geometry = geom;
    q.spatialRelationship = "intersects";
    q.returnGeometry = false;
    q.outFields = ["OBJECTID","objectid","NOM_CCPP","nom_ccpp"];
    q.orderByFields = ["nom_ccpp ASC","NOM_CCPP ASC"];
    q.num = 2000; q.cacheHint = true;

    try{
      const r = await ccppSrc.queryFeatures(q);
      const feats = r.features||[];
      if(!feats.length){
        $selCCPP.innerHTML = `<option value="">(Sin CCPP en el ámbito)</option>`;
        $selCCPP.disabled = true;
        return;
      }
      $selCCPP.innerHTML = `<option value="">(Todos)</option>` + feats.map(f=>{
        const a=f.attributes||{};
        const oid = a.objectid ?? a.OBJECTID;              // valor seguro para query por OID
        const name = a.nom_ccpp ?? a.NOM_CCPP ?? "(s/n)";
        return `<option value="${oid}">${name}</option>`;
      }).join("");
      $selCCPP.disabled = false;
    }catch(e){
      console.error(e);
      $selCCPP.innerHTML = `<option value="">(Error al cargar)</option>`;
      $selCCPP.disabled = true;
    }
  }

  /* ===== Pulso visual ===== */
  function clearPulse(){ if(pulseTimer){ clearInterval(pulseTimer); pulseTimer=null; } focusLayer.removeAll(); }
  function pulseAt(point){
    clearPulse();
    const core = new Graphic({ geometry: point, symbol: new SimpleMarkerSymbol({ style:"circle", size:10, color:[255,255,0,1], outline:{ color:[255,255,255,1], width:1 }}) });
    const ring = new Graphic({ geometry: point, symbol: new SimpleMarkerSymbol({ style:"circle", size:10, color:[255,255,0,0.05], outline:{ color:[255,255,0,0.6], width:2 }}) });
    focusLayer.addMany([ring, core]);
    let sz=10, op=0.6;
    pulseTimer = setInterval(()=>{ sz+=2.2; if(sz>46){ sz=10; op=0.6; } op-=0.04; if(op<0.05) op=0.6; ring.symbol.size=sz; ring.symbol.outline.color.a=op; focusLayer.refresh(); },45);
  }

  /* ===== Zoom panorámico + señal al CCPP ===== */
  async function zoomToSelectedCCPP(){
    const oid = Number($selCCPP.value||"");
    if(!oid){ clearPulse(); return; }

    // Intento por OBJECTID
    let q = ccppSrc.createQuery(); q.objectIds=[oid]; q.returnGeometry=true; q.outFields=["NOM_CCPP","nom_ccpp"];
    let r = await ccppSrc.queryFeatures(q);
    let f = r.features?.[0];

    // Fallback si el servicio no acepta objectIds (raro pero pasa)
    if(!f){
      const nameOpt = $selCCPP.selectedOptions[0]?.textContent ?? "";
      q = ccppSrc.createQuery();
      q.where = `(UPPER(nom_ccpp)='${nameOpt.toUpperCase().replace(/'/g,"''")}' OR UPPER(NOM_CCPP)='${nameOpt.toUpperCase().replace(/'/g,"''")}')`;
      q.returnGeometry=true; q.outFields=["*"]; q.num=1;
      r = await ccppSrc.queryFeatures(q);
      f = r.features?.[0];
    }
    if(!f) return;

    // Sincroniza límites con el polígono del CCPP (por intersección espacial)
    try{
      const cgeom = f.geometry;
      const center = cgeom.centroid || (cgeom.extent ? cgeom.extent.center : null);

      // Buscar distrito que lo contiene para alinear combos
      const qd = limDistSrc.createQuery();
      qd.geometry = cgeom; qd.spatialRelationship="intersects"; qd.returnGeometry=false; qd.outFields=["id_dist","id_prov","id_dpto"]; qd.num=1;
      const rd = await limDistSrc.queryFeatures(qd);
      const ad = rd.features?.[0]?.attributes;
      if(ad){
        $selDep.value  = ad.id_dpto || "";
        await loadProvs();
        $selProv.value = ad.id_prov || "";
        await loadDists();
        $selDist.value = ad.id_dist || "";
      }
      updatePoliticalLimitVisibility();
      await zoomToPolitical();   // encuadre amplio del ámbito

      // Luego zoom al CCPP (panorámico)
      if(cgeom.extent && !cgeom.extent.isEmpty){
        const ex = cgeom.extent.expand(1.9);
        await view.goTo({ target: ex, padding:{left:80,right:80,top:90,bottom:90} }, { duration:900 });
      }else if(center){
        await view.goTo({ center, scale: 9000 }, { duration:900 });
      }
      if(center){ pulseAt(center); }
    }catch(_){}
  }

  // Eventos de límites
  $selDep.addEventListener('change', async()=>{ await loadProvs(); await cargarLista(); updatePoliticalLimitVisibility(); await zoomToPolitical(); await populateCCPPOptions(); clearPulse(); });
  $selProv.addEventListener('change', async()=>{ await loadDists(); await cargarLista(); updatePoliticalLimitVisibility(); await zoomToPolitical(); await populateCCPPOptions(); clearPulse(); });
  $selDist.addEventListener('change', async()=>{ await cargarLista(); updatePoliticalLimitVisibility(); await zoomToPolitical(); await populateCCPPOptions(); clearPulse(); });

  // Evento CCPP
  $selCCPP.addEventListener('change', zoomToSelectedCCPP);

  // Botón limpiar
  let initialViewpoint=null; view.when(()=>{ initialViewpoint = view.viewpoint.clone(); });
  $btnClear.addEventListener('click', async ()=>{
    $selDep.value = "";
    $selProv.innerHTML = `<option value="">(Todas)</option>`; $selProv.disabled = true;
    $selDist.innerHTML = `<option value="">(Todos)</option>`; $selDist.disabled = true;
    $selCCPP.innerHTML = `<option value="">(Seleccione un ámbito)</option>`; $selCCPP.disabled = true;
    updatePoliticalLimitVisibility();
    await cargarLista(); clearPulse();
    if(initialViewpoint){ try{ await view.goTo(initialViewpoint, { duration: 900 }); }catch(_){ } }
  });

  /* ===== Zoom inicial a CUTURAPI (Puno) ===== */
  const limDistSrcForZoom = new FeatureLayer({ url:LIM2, outFields:["nom_dist","NOM_DIST"], listMode:"hide" });
  async function zoomToCuturapi(){
    try{
      const q = limDistSrcForZoom.createQuery();
      q.where = "UPPER(nom_dist) LIKE '%CUTURAPI%' OR UPPER(NOM_DIST) LIKE '%CUTURAPI%'";
      q.returnGeometry = true; q.num = 1;
      const r = await limDistSrcForZoom.queryFeatures(q);
      const g = r.features?.[0]?.geometry;
      if(!g) return;
      limDistDraw.definitionExpression = "UPPER(nom_dist) LIKE '%CUTURAPI%' OR UPPER(NOM_DIST) LIKE '%CUTURAPI%'";
      limDistDraw.visible = true;
      await view.goTo({ target: g, padding:{left:50,right:50,top:70,bottom:70} }, { duration: 900 });
      const center = g.extent ? g.extent.center : view.center;
      await view.goTo({ center, scale: 12000 }, { duration: 600 });
    }catch(e){}
  }

  // init
  (async function init(){
    await loadDeps();
    await cargarLista();
    updatePoliticalLimitVisibility();
    await zoomToCuturapi();
    await populateCCPPOptions();
  })();
});
</script>
</body>
</html>
