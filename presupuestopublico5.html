<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ejecución física y devengado — MVCS</title>
<style>
  :root{ --ink:#0b2532; --muted:#64748b; --line:#e5e7eb; --grid:#eef2f7; --brand:#1e6eb6; }
  html,body{margin:0;background:#fff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:960px;margin:0 auto;padding:18px 14px 28px;box-sizing:border-box}
  .p{margin:.6rem 0 1rem;line-height:1.6;color:#3f4754;font-size:clamp(13px,1.7vw,15px)}
  .center{text-align:center}
  h3{margin:18px 0 10px;text-align:center;font-weight:900;letter-spacing:.2px;
     font-size:clamp(16px,2.2vw,20px);color:var(--brand)}
  .card{margin:8px 0 24px}
  .legend{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;min-height:28px;margin:6px 0 10px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-weight:800;font-size:12px;cursor:pointer}
  .pill[aria-pressed="false"]{opacity:.35;background:#f8fafc}
  .dot{width:9px;height:9px;border-radius:50%;box-shadow:0 0 0 2px #fff inset,0 0 0 1px #0001}
  .plot{position:relative;overflow:hidden;border-radius:10px;border:1px solid #f3f4f6;aspect-ratio:16/9;margin:8px 0 6px}
  @media (max-width:700px){.plot{aspect-ratio:4/3}}
  @media (max-width:420px){.plot{aspect-ratio:1/1}}
  canvas{display:block;width:100%;height:100%}
  .empty{display:grid;place-items:center;height:100%;color:#64748b;font-size:clamp(12px,1.6vw,14px);padding:12px;text-align:center}

  /* Tooltip g1 */
  .tip1{position:absolute;pointer-events:none;background:#0b2532;color:#fff;padding:7px 9px;border-radius:8px;font-size:12px;line-height:1.25;box-shadow:0 10px 24px rgba(2,6,23,.18);opacity:0;max-width:min(320px,60vw)}
  .tip1 h4{margin:0 0 5px 0;font-size:12px;letter-spacing:.02em;opacity:.9}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between}

  /* Tooltip g2 */
  .tip2{position:absolute;pointer-events:none;color:#0b2532;background:#fff;border:1px solid #e5e7eb;box-shadow:0 10px 24px rgba(2,6,23,.12),0 2px 6px rgba(2,6,23,.08);border-radius:10px;padding:9px 10px;font-size:12px;line-height:1.25;opacity:0;max-width:min(360px,72vw);z-index:1000}
  .tip2 .chip{display:inline-flex;align-items:center;gap:6px;font-weight:800;padding:3px 8px;border-radius:999px;background:#f8fafc;border:1px solid #e5e7eb;font-size:11px}
  .tip2 .chip .d{width:9px;height:9px;border-radius:50%}
  .grid{margin-top:6px;display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
  .k{color:#4b5563}.v{font-weight:700;text-align:right;white-space:nowrap}
  .hr{margin:6px 0;height:1px;background:#eef2f7;grid-column:1/-1}
  .long{grid-column:1/-1;text-align:left;font-weight:600}
  .tag{margin-left:6px;color:#6b7280;font-weight:700;font-style:italic}

  /* Botones grandes g2 */
  .panel{position:absolute;right:14px;top:14px;display:flex;flex-direction:column;gap:10px;z-index:12}
  .zoom-btn{width:44px;height:44px;border-radius:12px;border:1px solid #d9dee6;background:#fff;cursor:pointer;display:grid;place-items:center;font-size:22px;font-weight:800;color:#374151;box-shadow:0 4px 14px rgba(0,0,0,.12)}
  .zoom-btn:hover{background:#f8fafc;transform:translateY(-1px)}
  .filter{position:relative}
  .fbtn{width:44px;height:44px;border-radius:12px;border:1px solid #d9dee6;background:#fff;cursor:pointer;display:grid;place-items:center;box-shadow:0 4px 14px rgba(0,0,0,.12);color:#374151}
  .fpanel{position:absolute;right:0;top:52px;min-width:260px;max-width:min(360px,80vw);background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 18px 50px rgba(2,6,23,.16),0 6px 16px rgba(2,6,23,.10);padding:10px;display:none;z-index:20}
  .fpanel[aria-hidden="false"]{display:block}
  .fh{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .ft{font-weight:800;font-size:13px;color:#0b2532}
  .factions{display:flex;gap:6px}
  .factions button{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:4px 8px;font-size:11px;cursor:pointer}
  .flist{margin-top:2px;max-height:260px;overflow:auto;border-top:1px dashed #e5e7eb;padding-top:8px}
  .fi{display:flex;align-items:center;gap:8px;font-size:12px;padding:4px 2px}
  .fi input{width:14px;height:14px}
  .ffoot{margin-top:8px;font-size:11px;color:#64748b;text-align:right}
</style>
</head>
<body>
<div class="wrap">

  <p class="p center">La evolución de la Ejecución Física por Programa muestra el avance físico…</p>

  <!-- ====== Gráfico 1 ====== -->
  <div class="card" id="g1">
    <h3>Evolución del avance de ejecución física por programa</h3>
    <div class="legend" id="c1-legend" role="toolbar" aria-label="Programas"></div>
    <div class="plot" id="c1-wrap" aria-live="polite">
      <canvas id="c1-canvas"></canvas>
      <div id="c1-empty" class="empty" style="display:none">Sin datos que cumplan los filtros.</div>
      <div id="c1-tip" class="tip1" role="status"></div>
    </div>
  </div>

  <p class="p center">El Devengado vs. Monto de Inversión compara cuánto del presupuesto total…</p>

  <!-- ====== Gráfico 2 ====== -->
  <div class="card" id="g2">
    <h3>Devengado acumulado vs. monto de inversión</h3>
    <div class="legend" id="c2-legend" role="toolbar" aria-label="Nivel de avance"></div>

    <div class="plot" id="c2-wrap" aria-live="polite">
      <div class="panel">
        <button class="zoom-btn" id="c2-zoomIn" title="Acercar">+</button>
        <button class="zoom-btn" id="c2-zoomOut" title="Alejar">−</button>
        <button class="zoom-btn" id="c2-zoomReset" title="Restablecer">↺</button>

        <div class="filter">
          <button id="c2-progBtn" class="fbtn" title="Filtrar por programa" aria-haspopup="true" aria-expanded="false" aria-controls="c2-progPanel">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linejoin="round"/>
            </svg>
          </button>
          <div id="c2-progPanel" class="fpanel" role="dialog" aria-hidden="true" aria-label="Filtrar por programa">
            <div class="fh">
              <div class="ft">Programas</div>
              <div class="factions">
                <button type="button" id="c2-fpAll">Todos</button>
                <button type="button" id="c2-fpNone">Limpiar</button>
              </div>
            </div>
            <div id="c2-fpList" class="flist" role="listbox"></div>
            <div class="ffoot"><span id="c2-fpCount">0</span> seleccionados</div>
          </div>
        </div>
      </div>

      <canvas id="c2-canvas"></canvas>
      <div id="c2-empty" class="empty" style="display:none">Sin datos que cumplan los filtros.</div>
      <div id="c2-tip" class="tip2" role="status"></div>
    </div>
  </div>

</div>

<script>
/* ===== ArcGIS util ===== */
async function fetchAllPOST(url, baseParams){
  const page=2000; let offset=0; const out=[];
  while(true){
    const params=new URLSearchParams({...baseParams,returnGeometry:"false",f:"json",resultRecordCount:page,resultOffset:offset});
    const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:params.toString(),cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j=await res.json(); const feats=j.features??[]; out.push(...feats.map(f=>f.attributes||{}));
    if(!j.exceededTransferLimit && feats.length<page) break; offset+=page;
  } return out;
}

/* ===== Cálculo de márgenes: rótulo y ticks separados ===== */
function computeLeftPads(ctx, yTickStrings, axisFontPx){
  // ancho máximo de los números
  let tickW = 0;
  yTickStrings.forEach(s => { const w = ctx.measureText(String(s)).width; if (w > tickW) tickW = w; });
  const inner = 12;                // respiración a la izquierda total
  const gapLabelToTicks = 12;      // separación entre rótulo y números
  const gapTicksToPlot  = 12;      // separación entre números y eje/grilla
  const labelBand = axisFontPx + 26; // banda dedicada al rótulo vertical (más amplia)
  const padLeft = Math.ceil(inner + labelBand + gapLabelToTicks + tickW + gapTicksToPlot);
  const labelCenterX = inner + (labelBand / 2); // rótulo centrado en su banda, lejos de los ticks
  return { padLeft, labelCenterX };
}

/* ========= Gráfico 1 ========= */
(function(){
  const LYR1="https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/story_monitoreo_inversiones/FeatureServer/1/query";
  const LYR13="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
  const WHERE_1="etapa IN ('OBRA','OBRA (SALDO)')";
  const WHERE_13="monto_pim > 0 AND producto_proyecto IS NOT NULL AND producto_proyecto <> 2193247";

  const BINS=[{label:"0",match:v=>Number(v)===0},{label:"0–20",match:v=>v>0&&v<20},{label:"20–40",match:v=>v>=20&&v<40},{label:"40–60",match:v=>v>=40&&v<60},{label:"60–80",match:v=>v>=60&&v<80},{label:"80–100",match:v=>v>=80&&v<=100}];
  const COLORS={PASLC:"#E69F00",PMIB:"#D55E00",PNC:"#56B4E9",PNSR:"#0072B2",PNSU:"#009E73"};
  const fallback=["#9b59b6","#7f8c8d","#8e44ad","#2c3e50","#95a5a6"];
  const colorFor=(p,i)=>COLORS[p]||fallback[i%fallback.length];

  function num(x){ if(x==null) return NaN; return typeof x==="number"?x:parseFloat(String(x).replace(",", ".")); }
  function binLabel(v){ const n=num(v); if(!isFinite(n)) return null; for(const b of BINS){ if(b.match(n)) return b.label; } return null; }

  async function loadSeries(){
    const ids13=await fetchAllPOST(LYR13,{where:WHERE_13,outFields:"producto_proyecto"});
    const valid=new Set(ids13.map(a=>a.producto_proyecto).filter(v=>v!=null));
    if(!valid.size) return [];
    const rows1=await fetchAllPOST(LYR1,{where:WHERE_1,outFields:"icodunificado,programa,avancefisicoreal"});
    const by=new Map();
    rows1.filter(r=>valid.has(r.icodunificado)).forEach(r=>{
      const prog=(r.programa??"").toString().trim(); const bin=binLabel(r.avancefisicoreal);
      if(!prog||!bin) return; if(!by.has(prog)) by.set(prog,new Map());
      const m=by.get(prog); m.set(bin,(m.get(bin)||0)+1);
    });
    const series=[]; for(const [prog,counts] of by){ series.push({programa:prog,data:BINS.map(b=>counts.get(b.label)||0)}); }
    return series.sort((a,b)=>a.programa.localeCompare(b.programa,'es'));
  }

  function drawCR(ctx,pts){
    if(pts.length<2) return; const p=i=>pts[Math.max(0,Math.min(pts.length-1,i))];
    ctx.moveTo(pts[0].x,pts[0].y);
    for(let i=0;i<pts.length-1;i++){
      const p0=p(i-1),p1=p(i),p2=p(i+1),p3=p(i+2),t=0.5;
      const cp1x=p1.x+(p2.x-p0.x)*(t/6), cp1y=p1.y+(p2.y-p0.y)*(t/6);
      const cp2x=p2.x-(p3.x-p1.x)*(t/6), cp2y=p2.y-(p3.y-p1.y)*(t/6);
      ctx.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,p2.x,p2.y);
    }
  }

  function makeChart(series){
    const wrap=document.getElementById("c1-wrap");
    const canvas=document.getElementById("c1-canvas");
    const ctx=canvas.getContext("2d");
    const empty=document.getElementById("c1-empty");
    const legend=document.getElementById("c1-legend");
    const tip=document.getElementById("c1-tip");
    if(!series.length){ empty.style.display="grid"; return; }
    empty.style.display="none";

    const visible=new Map(series.map(s=>[s.programa,true]));
    legend.innerHTML="";
    series.forEach((s,i)=>{
      const b=document.createElement("button");
      b.className="pill"; b.type="button"; b.setAttribute("aria-pressed","true");
      b.innerHTML=`<span class="dot" style="background:${colorFor(s.programa,i)}"></span>${s.programa}`;
      b.onclick=()=>{ const cur=visible.get(s.programa); visible.set(s.programa,!cur); b.setAttribute("aria-pressed",String(!cur)); draw(); };
      legend.appendChild(b);
    });

    let HIT=[];

    function draw(){
      const dpr=Math.max(1,window.devicePixelRatio||1);
      const W=wrap.clientWidth, H=wrap.clientHeight;
      canvas.width=W*dpr; canvas.height=H*dpr; canvas.style.width=W+"px"; canvas.style.height=H+"px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,W,H); HIT=[];
      ctx.font="12px system-ui";

      const yMaxData=Math.max(1,...series.flatMap(s=>visible.get(s.programa)?s.data:[0]));
      const yMax=Math.max(5,Math.ceil((yMaxData*1.12)/5)*5);
      const yTicks=[0,1,2,3,4,5].map(t=>Math.round(yMax/5*t));
      const yTickStrings=yTicks.map(v=>String(v));

      // Márgenes separados
      const { padLeft, labelCenterX } = computeLeftPads(ctx, yTickStrings, 12);
      const pad={t:26,r:12,b:48,l:padLeft};
      const xStep=(W-pad.l-pad.r)/(BINS.length-1);
      const x=i=>pad.l+xStep*i, y=v=>pad.t+(H-pad.t-pad.b)*(1-v/yMax);

      // Grilla + ticks
      ctx.textAlign="right"; ctx.textBaseline="middle"; ctx.fillStyle="#0b2532";
      yTicks.forEach(val=>{ const yy=y(val); ctx.strokeStyle=val===0?"#e5e7eb":"#f3f4f6"; ctx.beginPath(); ctx.moveTo(pad.l,yy); ctx.lineTo(W-pad.r,yy); ctx.stroke(); ctx.fillText(String(val),pad.l-12,yy); });
      ctx.textAlign="center"; ctx.textBaseline="top"; BINS.forEach((b,i)=> ctx.fillText(b.label,x(i),y(0)+8));

      // Nombres de ejes
      ctx.save(); ctx.font="700 12px system-ui"; ctx.textAlign="center"; ctx.textBaseline="top"; ctx.fillText("Avance físico",(pad.l+(W-pad.r))/2,y(0)+26); ctx.restore();
      ctx.save(); ctx.translate(labelCenterX, pad.t+(H-pad.t-pad.b)/2); ctx.rotate(-Math.PI/2); ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.font="700 12px system-ui"; ctx.fillText("Recuento por inversión",0,0); ctx.restore();

      // Series
      const R=3;
      series.forEach((s,idx)=>{
        if(!visible.get(s.programa)) return;
        const col=colorFor(s.programa,idx);
        const pts=s.data.map((v,i)=>({x:x(i),y:y(v),bin:BINS[i].label,val:v,programa:s.programa,color:col}));
        ctx.strokeStyle=col; ctx.lineWidth=2; ctx.beginPath(); drawCR(ctx,pts); ctx.stroke();
        ctx.fillStyle=col; pts.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,R,0,2*Math.PI); ctx.fill(); HIT.push({x:p.x,y:p.y,r:Math.max(R+5,9),data:p}); });
      });
    }

    function placeTip(wx,wy){
      tip.style.visibility="hidden"; tip.style.display="block"; tip.style.opacity=0;
      const rect=wrap.getBoundingClientRect(), trect=tip.getBoundingClientRect(), m=8;
      let left=wx+10, top=wy-trect.height-10; if(top<m) top=wy+12; if(left+trect.width>rect.width-m) left=wx-trect.width-10;
      left=Math.max(m,Math.min(rect.width-trect.width-m,left)); top=Math.max(m,Math.min(rect.height-trect.height-m,top));
      tip.style.left=left+"px"; tip.style.top=top+"px"; tip.style.visibility="visible"; tip.style.opacity=1;
    }

    canvas.addEventListener("mousemove",(e)=>{
      const cR=canvas.getBoundingClientRect(), wR=wrap.getBoundingClientRect();
      const cx=e.clientX-cR.left, cy=e.clientY-cR.top, wx=e.clientX-wR.left, wy=e.clientY-wR.top;
      let best=null, d2b=Infinity; for(const h of HIT){ const dx=cx-h.x, dy=cy-h.y, d2=dx*dx+dy*dy; if(d2<h.r*h.r&&d2<d2b){best=h; d2b=d2;} }
      if(best){
        const b=best.data;
        tip.innerHTML=`<h4>${b.programa}</h4><div class="row"><span>Rango</span><strong>${b.bin}</strong></div><div class="row"><span>Inversiones</span><strong>${b.val}</strong></div>`;
        placeTip(wx,wy);
      }else{ tip.style.opacity=0; }
    });
    canvas.addEventListener("mouseleave",()=> tip.style.opacity=0 );

    draw(); window.addEventListener("resize",draw,{passive:true});
  }

  (async function(){ try{ const s=await loadSeries(); makeChart(s); } catch(e){ console.error(e); document.getElementById("c1-empty").style.display="grid"; } })();
})();

/* ========= Gráfico 2 ========= */
(function(){
  const LYR13="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
  const LYR1 ="https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/story_monitoreo_inversiones/FeatureServer/1/query";
  const WHERE_13="monto_pim > 0 AND producto_proyecto IS NOT NULL AND producto_proyecto <> 2193247";
  const WHERE_1 ="etapa IN ('OBRA','OBRA (SALDO)') AND montoactualizadopip_decimal > 0 AND devengadoacumulado >= 0";

  const CATS=[{key:"Bajo (0%–30%)",short:"Bajo",color:"#dc2626",match:p=>p<=30},{key:"Medio (30%–70%)",short:"Medio",color:"#f59e0b",match:p=>p>30&&p<70},{key:"Alto (70%–100%)",short:"Alto",color:"#22c55e",match:p=>p>=70}];
  const pct=(d,i)=>{const x=+d,y=+i;return(!isFinite(x)||!isFinite(y)||y<=0)?0:(x/y)*100};
  const cat=p=>{for(const c of CATS){if(c.match(p))return c.short}return "Bajo";}
  const fmtMoney=n=>"S/. "+(Number(n)||0).toLocaleString("es-PE",{maximumFractionDigits:0,minimumFractionDigits:0});
  const fmtK=v=>{v=+v||0;const a=Math.abs(v);if(a>=1e9)return(v/1e9).toFixed(1).replace(/\.0$/,'')+" B";if(a>=1e6)return(v/1e6).toFixed(1).replace(/\.0$/,'')+" M";if(a>=1e3)return(v/1e3).toFixed(1).replace(/\.0$/,'')+" k";return v.toLocaleString('es-PE')}
  const fmtPct=p=>(Math.round(p*10)/10).toLocaleString('es-PE')+"%";
  const normProg=p=>(p??"(Sin programa)").toString().trim()||"(Sin programa)";

  async function loadPts(){
    const r13=await fetchAllPOST(LYR13,{where:WHERE_13,outFields:"producto_proyecto"});
    const ids=[...new Set(r13.map(r=>r.producto_proyecto).filter(v=>v!=null))];
    if(!ids.length) return [];
    const chunk=900; let r1=[];
    for(let i=0;i<ids.length;i+=chunk){
      const slice=ids.slice(i,i+chunk);
      const where=`${WHERE_1} AND icodunificado IN (${slice.join(",")})`;
      const part=await fetchAllPOST(LYR1,{where,outFields:"icodunificado,devengadoacumulado,montoactualizadopip_decimal,nombreproyecto,beneficiarios,programa"});
      r1.push(...part);
    }
    return r1.map(r=>{
      const x=+r.devengadoacumulado||0, y=+r.montoactualizadopip_decimal||0, b=+r.beneficiarios||0, p=pct(x,y);
      return {x,y,bens:b,pct:p,nivel:cat(p),icod:r.icodunificado??"",nombre:(r.nombreproyecto??"").toString().trim(),prog:normProg(r.programa)};
    }).filter(d=>d.y>0);
  }

  function makeChart(points){
    const wrap=document.getElementById("c2-wrap");
    const canvas=document.getElementById("c2-canvas");
    const ctx=canvas.getContext("2d");
    const empty=document.getElementById("c2-empty");
    const tip=document.getElementById("c2-tip");
    const legend=document.getElementById("c2-legend");
    if(!points.length){ empty.style.display="grid"; return; }
    empty.style.display="none";

    // Filtro por programa
    const progs=[...new Set(points.map(p=>p.prog))].sort((a,b)=>a.localeCompare(b,'es'));
    let selected=new Set(progs);

    const btn=document.getElementById('c2-progBtn');
    const panel=document.getElementById('c2-progPanel');
    const list=document.getElementById('c2-fpList');
    const all=document.getElementById('c2-fpAll');
    const none=document.getElementById('c2-fpNone');
    const cnt=document.getElementById('c2-fpCount');
    const upd=()=> cnt.textContent=selected.size;
    function render(){ list.innerHTML=""; for(const p of progs){ const id='p_'+btoa(encodeURIComponent(p)).replace(/=+/g,''); const el=document.createElement('label'); el.className='fi'; el.setAttribute('role','option'); el.innerHTML=`<input type="checkbox" id="${id}" ${selected.has(p)?'checked':''} data-prog="${p}"><span>${p}</span>`; list.appendChild(el);} }
    function open(){ panel.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); render(); upd(); }
    function close(){ panel.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); }
    btn.addEventListener('click', ()=> (panel.getAttribute('aria-hidden')==='false')?close():open());
    document.addEventListener('click',(e)=>{ if(!panel.contains(e.target)&&!btn.contains(e.target)) close(); });
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close(); });
    list.addEventListener('change',(e)=>{ const cb=e.target; if(cb && cb.matches('input[type="checkbox"][data-prog]')){ const p=cb.getAttribute('data-prog'); cb.checked?selected.add(p):selected.delete(p); upd(); draw(); }});
    all.addEventListener('click',()=>{ selected=new Set(progs); upd(); render(); draw(); });
    none.addEventListener('click',()=>{ selected.clear(); upd(); render(); draw(); });

    // Leyenda niveles
    const vis=new Map(CATS.map(c=>[c.short,true]));
    legend.innerHTML=""; CATS.forEach(c=>{
      const b=document.createElement("button"); b.className="pill"; b.type="button"; b.setAttribute("aria-pressed","true");
      b.innerHTML=`<span class="dot" style="background:${c.color}"></span>${c.key}`;
      b.onclick=()=>{ const cur=vis.get(c.short); vis.set(c.short,!cur); b.setAttribute("aria-pressed",String(!cur)); draw(); };
      legend.appendChild(b);
    });

    const maxB=Math.max(1,...points.map(p=>p.bens||0));
    const rScale=b=>{const t=Math.sqrt((b||0)/maxB); return 4 + t*18;};

    let dims={},scale={},plot={},HIT=[],view={minX:0,maxX:1,minY:0,maxY:1,dataMaxX:1,dataMaxY:1},hasAny=true;

    function ext(){ const act=points.filter(p=>selected.has(p.prog)&&vis.get(p.nivel)); hasAny=act.length>0; view.dataMaxX=Math.max(1,...act.map(p=>p.x),1); view.dataMaxY=Math.max(1,...act.map(p=>p.y),1); if(view.maxX===1&&view.maxY===1){view.minX=0;view.maxX=view.dataMaxX;view.minY=0;view.maxY=view.dataMaxY;} }

    function compute(){
      const dpr=Math.max(1,window.devicePixelRatio||1);
      const W=wrap.clientWidth,H=wrap.clientHeight;
      canvas.width=W*dpr; canvas.height=H*dpr; canvas.style.width=W+"px"; canvas.style.height=H+"px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
      dims={W,H}; ctx.font="12px system-ui";

      // Strings de ticks Y para medir ancho
      const numTicks=5; const yVals=[]; for(let i=0;i<=numTicks;i++){ const v=view.minY+(view.maxY-view.minY)*i/numTicks; yVals.push(v); }
      const yStrings=yVals.map(v=>fmtK(v));

      const { padLeft, labelCenterX } = computeLeftPads(ctx, yStrings, 12);

      const pad={t:24,r:14,b:56,l:padLeft};
      plot={x:pad.l,y:pad.t,w:W-pad.l-pad.r,h:H-pad.t-pad.b};
      scale={
        pad, plot, labelCenterX,
        x:v=>pad.l+plot.w*((v-view.minX)/((view.maxX-view.minX)||1)),
        y:v=>pad.t+plot.h*(1-(v-view.minY)/((view.maxY-view.minY)||1)),
        invX:px=>view.minX+(view.maxX-view.minX)*((px-pad.l)/(plot.w||1)),
        invY:py=>view.minY+(view.maxY-view.minY)*(1-(py-pad.t)/(plot.h||1))
      };
    }

    function axes(){
      const {pad,labelCenterX}=scale; const {W,H}=dims; ctx.clearRect(0,0,W,H);
      ctx.textAlign="right"; ctx.textBaseline="middle"; ctx.font="12px system-ui"; ctx.fillStyle="#0b2532";
      const yT=5;
      for(let i=0;i<=yT;i++){
        const v = view.minY + (view.maxY - view.minY) * i / yT;
        const yy = scale.y(v);
        ctx.strokeStyle = i===0 ? "#e5e7eb" : "#f3f4f6";
        ctx.beginPath(); ctx.moveTo(pad.l, yy); ctx.lineTo(pad.l + scale.plot.w, yy); ctx.stroke();
        ctx.fillText(fmtK(v), pad.l - 12, yy);
      }
      ctx.textAlign="center"; ctx.textBaseline="top"; const xT=5; const y0=H - pad.b;
      for(let i=0;i<=xT;i++){
        const v = view.minX + (view.maxX - view.minX) * i / xT;
        const xx = scale.x(v);
        ctx.strokeStyle="#e5e7eb";
        ctx.beginPath(); ctx.moveTo(xx, pad.t); ctx.lineTo(xx, y0); ctx.stroke();
        ctx.fillText(fmtK(v), xx, y0 + 14);
      }
      // Rótulo vertical centrado en su banda totalmente aparte de los ticks
      ctx.save(); ctx.fillStyle="#0b2532"; ctx.font="700 12px system-ui";
      ctx.translate(labelCenterX, pad.t + scale.plot.h/2);
      ctx.rotate(-Math.PI/2); ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText("Monto de inversión", 0, 0);
      ctx.restore();

      ctx.textAlign="center"; ctx.textBaseline="bottom"; ctx.font="700 12px system-ui";
      ctx.fillText("Devengado acumulado", pad.l + scale.plot.w/2, H - 8);
    }

    const inPlot=(px,py)=> px>=plot.x && px<=plot.x+plot.w && py>=plot.y && py<=plot.y+plot.h;

    function drawPts(){
      HIT=[]; ctx.save(); ctx.beginPath(); ctx.rect(plot.x,plot.y,plot.w,plot.h); ctx.clip();
      points.forEach(p=>{
        if(!selected.has(p.prog) || !vis.get(p.nivel)) return;
        const color = p.nivel==="Bajo" ? "#dc2626" : (p.nivel==="Medio" ? "#f59e0b" : "#22c55e");
        const x=scale.x(p.x), y=scale.y(p.y), r=rScale(p.bens);
        if(!isFinite(x)||!isFinite(y)) return;
        ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
        if(inPlot(x,y)) HIT.push({x,y,r:Math.max(r+2,9),data:p,color,key:p.nivel});
      });
      ctx.restore();
    }

    function clamp(){ const minX=(view.dataMaxX)/1000, minY=(view.dataMaxY)/1000; if(view.maxX-view.minX<minX){ const cx=(view.minX+view.maxX)/2; view.minX=cx-minX/2; view.maxX=cx+minX/2; } if(view.maxY-view.minY<minY){ const cy=(view.minY+view.maxY)/2; view.minY=cy-minY/2; view.maxY=cy+minY/2; } view.minX=Math.max(0,view.minX); view.maxX=Math.min(view.dataMaxX,view.maxX); view.minY=Math.max(0,view.minY); view.maxY=Math.min(view.dataMaxY,view.maxY); }
    function zoom(f,cx=null,cy=null){ if(cx===null) cx=(view.minX+view.maxX)/2; if(cy===null) cy=(view.minY+view.maxY)/2; const w=(view.maxX-view.minX)*f, h=(view.maxY-view.minY)*f; view.minX=cx-w/2; view.maxX=cx+w/2; view.minY=cy-h/2; view.maxY=cy+h/2; clamp(); draw(); }
    function pan(dx,dy){ const sx=view.maxX-view.minX, sy=view.maxY-view.minY; view.minX-=dx*sx; view.maxX-=dx*sx; view.minY+=dy*sy; view.maxY+=dy*sy; clamp(); draw(); }
    function reset(){ view.minX=0; view.maxX=view.dataMaxX; view.minY=0; view.maxY=view.dataMaxY; draw(); }

    function draw(){ ext(); empty.style.display=hasAny?'none':'grid'; compute(); axes(); if(hasAny) drawPts(); }

    /* Controles */
    document.getElementById('c2-zoomIn').addEventListener('click',()=>zoom(0.75));
    document.getElementById('c2-zoomOut').addEventListener('click',()=>zoom(1.25));
    document.getElementById('c2-zoomReset').addEventListener('click',reset);

    canvas.addEventListener('wheel',(e)=>{ e.preventDefault(); const r=canvas.getBoundingClientRect(); const mx=e.clientX-r.left,my=e.clientY-r.top; if(!inPlot(mx,my)) return; const dx=scale.invX(mx), dy=scale.invY(my); const f=e.deltaY>0?1.2:1/1.2; zoom(f,dx,dy); },{passive:false});

    let drag=false,lx=0,ly=0;
    canvas.addEventListener('mousedown',(e)=>{ const r=canvas.getBoundingClientRect(); const mx=e.clientX-r.left,my=e.clientY-r.top; if(!inPlot(mx,my)) return; drag=true; lx=e.clientX; ly=e.clientY; canvas.style.cursor='grabbing'; tip.style.opacity=0; });
    window.addEventListener('mousemove',(e)=>{ if(!drag) return; const dx=(e.clientX-lx)/(scale.plot.w||1), dy=(e.clientY-ly)/(scale.plot.h||1); pan(dx,dy); lx=e.clientX; ly=e.clientY; });
    window.addEventListener('mouseup',()=>{ drag=false; canvas.style.cursor='default'; });

    function hit(mx,my){ if(!inPlot(mx,my)) return null; for(let i=HIT.length-1;i>=0;i--){ const h=HIT[i],dx=mx-h.x,dy=my-h.y; if(dx*dx+dy*dy<=h.r*h.r) return h; } return null; }
    function placeTip(mx,my){ const wR=wrap.getBoundingClientRect(), tR=tip.getBoundingClientRect(), m=10; let left=mx+12, top=my-tR.height-12; if(left+tR.width>wR.width-m) left=mx-tR.width-12; if(left<m) left=m; if(top<m) top=my+18; if(top+tR.height>wR.height-m) top=wR.height-tR.height-m; tip.style.left=left+"px"; tip.style.top=top+"px"; }
    canvas.addEventListener('mousemove',(e)=>{ const r=canvas.getBoundingClientRect(); const mx=e.clientX-r.left,my=e.clientY-r.top; const h=hit(mx,my); canvas.style.cursor=h?'pointer':(inPlot(mx,my)?'crosshair':'default'); if(h){ const d=h.data; tip.innerHTML=`<span class="chip"><span class="d" style="background:${h.color}"></span>${h.key}</span><div class="grid"><div class="k">Devengado acumulado <span class="tag">(<b><i>X</i></b>)</span></div><div class="v">${fmtMoney(d.x)}</div><div class="k">Monto de inversión <span class="tag">(<b><i>Y</i></b>)</span></div><div class="v">${fmtMoney(d.y)}</div><div class="k">Beneficiarios <span class="tag">(<b><i>tamaño</i></b>)</span></div><div class="v">${(d.bens||0).toLocaleString('es-PE')}</div><div class="k">% Avance <span class="tag">(<b><i>color</i></b>)</span></div><div class="v">${fmtPct(d.pct)}</div>${d.prog?`<div class="k">Programa</div><div class="v">${d.prog}</div>`:''}${d.icod?`<div class="k">CUI</div><div class="v">${d.icod}</div>`:''}${d.nombre?`<div class="hr"></div><div class="long">${d.nombre}</div>`:''}</div>`; tip.style.display='block'; tip.style.opacity='0'; placeTip(mx,my); tip.style.opacity='1'; } else { tip.style.opacity='0'; tip.style.display='none'; } });
    canvas.addEventListener('mouseleave',()=>{ tip.style.opacity='0'; tip.style.display='none'; });

    draw(); window.addEventListener('resize',draw,{passive:true});
  }

  (async function(){ try{ const pts=await loadPts(); makeChart(pts); } catch(err){ console.error(err); const el=document.getElementById("c2-empty"); el.style.display="grid"; el.textContent="Error al cargar datos"; } })();
})();
</script>
</body>
</html>
