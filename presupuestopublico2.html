<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>¿Cómo vamos? – MVCS</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>

<style>
:root{
  --mvcs-azul:#1e6eb6;
  --txt-light:#ffffff;
  --gris-sec:#dbe2ea;
  --gris-borde:#d1d5db;
  --accent-red:#d00000;
  --card-bg:#ffffff;
  --card-shadow:0 20px 40px rgba(0,0,0,.08);
  --card-radius:8px;
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Nunito Sans',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:#e5e7eb;color:#111;line-height:1.5;
}

/* Espacio superior */
.status-spacer{
  height:40px;background:#fff;border-top:1px solid var(--gris-borde);
}

/* ===== Banner ¿Cómo vamos? ===== */
.status-hero{
  position:relative;
  width:100%;
  background-image:url("https://lh3.googleusercontent.com/d/1k1_vSVxnS7PYTiqV8M2Y5_Xli6qHmPzO=w1600");
  background-size:cover;
  background-position:center;
  color:var(--txt-light);
  overflow:visible;
  border-bottom:1px solid var(--gris-borde);
  padding:4rem 1rem 4rem;
}
.status-hero::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.45));
}

/* Contenido */
.status-inner{
  position:relative;z-index:2;
  max-width:1200px;margin:0 auto;
  display:flex;align-items:center;justify-content:space-between;
  gap:2rem;flex-wrap:wrap;
  padding-left:4vw; /* mueve el contador un poco a la izquierda */
}

/* Columna izquierda */
.status-left{
  flex:1 1 620px;
  text-align:left;
}

/* Título con subrayado animado */
.status-title{
  font-weight:900;
  font-size:clamp(24px,2.8vw,36px);
  color:#fff;
  line-height:1.2;
  margin-bottom:0.25rem;
  text-shadow:0 2px 4px rgba(0,0,0,.45);
}
.status-title .u{
  position:relative;display:inline-block;padding-bottom:6px;
}
.status-title .u::after{
  content:"";position:absolute;left:0;bottom:0;height:4px;
  background:var(--accent-red);
  width:0;animation:underline 1.8s ease-out forwards;
}
@keyframes underline{from{width:0}to{width:100%}}

/* Subtítulo */
.status-subtitle{
  font-size:.9rem;font-weight:800;opacity:.95;margin-bottom:1.2rem;color:#fff;
  text-shadow:0 2px 4px rgba(0,0,0,.45);
}

/* Número: S/ y monto en la misma línea */
.dev-row{
  display:flex;align-items:baseline;justify-content:flex-start;
  gap:.4rem;flex-wrap:nowrap;
}
.dev-prefix{
  font-weight:900;color:#fff;line-height:1;
  font-size:clamp(40px,5vw,70px);
  opacity:0;transform:translateY(8px);transition:.35s ease;
  text-shadow:0 4px 8px rgba(0,0,0,.55);
}
.dev-amount{
  font-weight:900;color:#fff;line-height:1.03;
  font-size:clamp(56px,8vw,110px);
  letter-spacing:.01em;white-space:nowrap;
  opacity:0;transform:translateY(8px);transition:.35s ease;
  text-shadow:0 4px 8px rgba(0,0,0,.55);
}

/* Porcentaje centrado bajo el monto */
.dev-percent{
  font-weight:900;color:#fff;margin-top:.85rem;
  font-size:clamp(18px,1.8vw,28px);
  opacity:0;transform:translateY(8px);transition:.35s ease;
  text-shadow:0 3px 6px rgba(0,0,0,.55);
}

/* Fuente/actualizado */
.dev-source{
  margin-top:1rem;font-size:.85rem;line-height:1.35;color:var(--gris-sec);
  text-shadow:0 2px 4px rgba(0,0,0,.7);
}
.dev-source b{color:#fff}
.dev-source em{color:#fff;font-style:italic}

/* Estado listo */
.ready{opacity:1 !important;transform:none !important}

/* Figura derecha (baja más) */
.status-figure{
  position:absolute;
  right:0;
  bottom:-20px; /* se baja más */
  z-index:3;
  width:min(40%,460px);
  max-width:480px;
  pointer-events:none;
  opacity:0;
  transform:translate(15%,5%);
  animation:ladyIn .9s ease-out .2s forwards;
}
.status-figure img{
  width:100%;height:auto;display:block;object-fit:contain;
  filter:drop-shadow(0 16px 26px rgba(0,0,0,.6));
}
@keyframes ladyIn{
  to{opacity:1;transform:translate(0,-4%)}
}

/* ===== Ranking ===== */
.rank-section{
  background:#f8f9fa;
  padding:2rem 1rem 3rem;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  flex-wrap:wrap;
  gap:1.5rem;
  border-top:1px solid var(--gris-borde);
  border-bottom:1px solid var(--gris-borde);
}
.rank-card{
  background:var(--card-bg);
  border:1px solid var(--gris-borde);
  border-radius:var(--card-radius);
  box-shadow:var(--card-shadow);
  flex:1 1 320px;
  max-width:480px;
  padding:1.5rem 1.25rem 1rem;
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
}
.rank-text{font-size:.95rem;line-height:1.45;color:#1f2937;margin-bottom:1rem;}
.rank-number{font-size:2.6rem;line-height:1.1;font-weight:900;color:var(--mvcs-azul);margin-bottom:1rem;}
.rank-actions{display:flex;gap:.75rem;flex-wrap:wrap;justify-content:center;}
.rank-btn{
  background:#fff;border:1px solid var(--mvcs-azul);color:var(--mvcs-azul);
  font-family:'Nunito Sans',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  font-size:.85rem;font-weight:800;padding:.55rem .95rem;line-height:1.2;border-radius:4px;cursor:pointer;
}
.rank-btn.filled{background:var(--mvcs-azul);color:#fff;}
.rank-btn:hover{filter:brightness(.93);}

/* ===== Responsive ===== */
@media(max-width:900px){
  .status-inner{flex-direction:column;align-items:center;text-align:center;padding-left:0;}
  .status-left{text-align:center;}
  .dev-row{justify-content:center;}
  .status-figure{width:250px;right:10px;bottom:-10px;}
}
@media(max-width:520px){
  .status-inner{padding-bottom:8rem;}
  .status-figure{width:200px;right:5px;bottom:-8px;}
  .rank-number{font-size:2.2rem;}
}
</style>
</head>
<body>

<div class="status-spacer"></div>

<section class="status-hero">
  <div class="status-figure">
    <img src="https://lh3.googleusercontent.com/d/16r2oP5b4bTadCXGsHO3EiiZbll7yrCdY=w1000" alt="Ciudadana beneficiaria">
  </div>

  <div class="status-inner">
    <div class="status-left">
      <h2 class="status-title"><span class="u">¿Cómo vamos?</span></h2>
      <div class="status-subtitle">Presupuesto Devengado 2025</div>

      <div class="dev-row">
        <span class="dev-prefix" id="cur">S/</span>
        <span class="dev-amount" id="val">0</span>
      </div>

      <div class="dev-percent" id="percent">0%</div>

      <div class="dev-source">
        <b>Fuente:</b> Ministerio de Economía y Finanzas – MEF<br>
        Portal de Datos Abiertos – <em id="lastUpdate">Actualizado al —</em>
      </div>
    </div>
  </div>
</section>

<section class="rank-section">
  <article class="rank-card">
    <p class="rank-text">El Ministerio de Vivienda, Construcción y Saneamiento se encuentra en el<br>ranking entre sectores en el:</p>
    <div class="rank-number">3° puesto</div>
    <div class="rank-actions">
      <button class="rank-btn filled">Ver tabla</button>
      <button class="rank-btn">Exportar a Excel</button>
    </div>
  </article>

  <article class="rank-card">
    <p class="rank-text">A nivel de inversiones, el ministerio se encuentra en el<br>ranking entre sectores en el:</p>
    <div class="rank-number">9° puesto</div>
    <div class="rank-actions">
      <button class="rank-btn filled">Ver tabla</button>
      <button class="rank-btn">Exportar a Excel</button>
    </div>
  </article>
</section>

<script>
/* Datos del servicio ArcGIS */
const SERVICE = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
const WHERE   = "sector_nombre = 'VIVIENDA CONSTRUCCION Y SANEAMIENTO' AND ano_eje = 2025";

async function fetchDevengadoData(){
  const outStats = JSON.stringify([
    { statisticType:"sum", onStatisticField:"monto_devengado", outStatisticFieldName:"sum_dev" },
    { statisticType:"sum", onStatisticField:"monto_pim", outStatisticFieldName:"sum_pim" },
    { statisticType:"max", onStatisticField:"fecha_proceso", outStatisticFieldName:"max_fp" }
  ]);
  const qs = new URLSearchParams({ where:WHERE, outStatistics:outStats, returnGeometry:"false", f:"json" });
  const res = await fetch(SERVICE+"?"+qs.toString(), { cache:"no-store" });
  const j = await res.json();
  const a = j.features?.[0]?.attributes || {};
  return { dev:Number(a.sum_dev||0), pim:Number(a.sum_pim||0), lastTs:(a.max_fp!=null)?Number(a.max_fp):null };
}

/* Animación tipo tragamonedas */
function animateNumber(el,target,ms=1700,fmt,suffix=""){
  const start=performance.now();
  function tick(t){
    const p=Math.min(1,(t-start)/ms);
    const eased=1-Math.pow(1-p,3);
    const cur=target*eased;
    el.textContent=fmt.format(cur)+suffix;
    if(p<1)requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

function formatEsDate(ts){
  if(!Number.isFinite(ts))return"—";
  const d=new Date(ts);
  return new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"long",year:"numeric"}).format(d);
}

(async function init(){
  const valEl=document.getElementById('val');
  const curEl=document.getElementById('cur');
  const pctEl=document.getElementById('percent');
  const lastEl=document.getElementById('lastUpdate');

  try{
    const {dev,pim,lastTs}=await fetchDevengadoData();
    const perc=pim>0?(dev/pim*100):0;
    [valEl,curEl,pctEl].forEach(el=>el.classList.add('ready'));

    const fmtInt=new Intl.NumberFormat('es-PE',{maximumFractionDigits:0});
    const fmtPct=new Intl.NumberFormat('es-PE',{minimumFractionDigits:1,maximumFractionDigits:1});

    animateNumber(valEl,dev,1700,fmtInt);
    animateNumber(pctEl,perc,1700,fmtPct,"%");
    lastEl.textContent="Actualizado al "+formatEsDate(lastTs);
  }catch(e){
    valEl.textContent="—";pctEl.textContent="—";lastEl.textContent="Actualizado al —";
    [valEl,curEl,pctEl].forEach(el=>el.classList.add('ready'));
  }
})();
</script>

</body>
</html>

