<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Map Tour ‚Äî Proyectos de Inversi√≥n MVCS</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.29/"></script>

<style>
  :root{
    --brand:#1e6eb6; --ink:#0b2532; --muted:#475569; --line:#e5e7eb; --card:#ffffff;
  }
  html,body{height:100%;margin:0;background:#eef3f8;color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

  .layout{
    display:grid;
    grid-template-columns:min(820px,58vw) 1fr;
    gap:18px; min-height:100vh;
  }
  .story{padding:clamp(12px,2.2vw,24px);}
  .intro{
    background:#fff;border:1px solid #dbe3ec;border-radius:16px;
    padding:16px 18px;margin-bottom:16px;
  }
  .intro h1{margin:0 0 6px;font-weight:900;color:var(--brand);}
  .intro p{margin:0;color:var(--muted);font-weight:600}
  .mapCol{position:sticky;top:0;height:100vh;border-left:1px solid #e6edf5}
  #viewDiv2D,#viewDiv3D{height:100%;width:100%}
  #viewDiv2D{display:none;}

  .step{margin:0 0 18px;scroll-margin-top:18px}
  .card{
    background:#fff;border:1px solid #dbe3ec;border-radius:16px;
    box-shadow:0 14px 36px rgba(2,6,23,.14);
    overflow:hidden;display:grid;grid-auto-rows:auto;
  }
  .img{height:260px;position:relative;overflow:hidden}
  .img img{width:100%;height:100%;object-fit:cover}
  .badge{
    position:absolute;top:10px;left:10px;width:32px;height:32px;
    border-radius:999px;background:var(--brand);color:#fff;
    display:grid;place-items:center;font-weight:900;
    outline:3px solid #ebf3ff;box-shadow:0 8px 18px rgba(30,110,182,.35);
  }
  .body{padding:14px 16px 16px}
  .title{margin:0 0 8px;font-weight:900;letter-spacing:.2px;font-size:1.3rem;line-height:1.15}
  .meta{margin:0 0 10px;color:#213547;font-weight:800}
  .links{display:flex;gap:14px;flex-wrap:wrap;margin-top:8px}
  .a{color:var(--brand);text-decoration:none;font-weight:900;border-bottom:2px solid #cfe3fb}
  .a:hover{filter:brightness(.96)}

  .step.is-active .card{outline:3px solid #e6f2ff}

  .nav{
    position:fixed;left:16px;bottom:16px;z-index:20;display:flex;gap:8px;
  }
  .btn{
    border:1px solid #dbe3ec;background:#fff;min-width:42px;height:42px;padding:0 10px;
    border-radius:12px;display:grid;place-items:center;cursor:pointer;font-weight:900;
    color:#1f2937;box-shadow:0 6px 16px rgba(0,0,0,.14);
  }
  .btn:hover{background:#f7fafc}
  .esri-popup,.esri-popup__main-container{display:none!important}

  @media(max-width:960px){
    .layout{grid-template-columns:1fr}
    .mapCol{order:-1;height:60vh}
    .img{height:220px}
  }
</style>
</head>
<body>

<div class="layout">
  <div class="story" id="story">
    <section class="intro">
      <h1>üõ∞Ô∏è Map Tour de Inversiones MVCS</h1>
      <p>Desliza hacia abajo: el mapa se mover√° autom√°ticamente seg√∫n el proyecto activo. Usa el bot√≥n 2D/3D para cambiar la vista.</p>
    </section>
  </div>

  <div class="mapCol">
    <div id="viewDiv3D"></div>
    <div id="viewDiv2D"></div>
  </div>
</div>

<div class="nav">
  <button id="toggleDimBtn" class="btn">2D / 3D</button>
  <button id="prevBtn" class="btn">‚Äπ</button>
  <button id="nextBtn" class="btn">‚Ä∫</button>
</div>

<script>
/* =================== DATOS REALES =================== */
const DATA = [
  {
    titulo:"AMPLIACION, RENOVACION Y MEJORAMIENTO DEL SISTEMA DE AGUA POTABLE Y ALCANTARILLADO DE LA LOCALIDAD DE CARAVELI",
    cui:"2107751", programa:"PNSU",
    foto:"https://images.unsplash.com/photo-1558980664-10a0ba81a2ff?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=47490",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=47029&idtipo=3&t=r"
  },
  {
    titulo:"MEJORAMIENTO Y AMPLIACION DEL SERVICIO DE DRENAJE PLUVIAL EN 4 DISTRITOS DE LA PROVINCIA DE CUSCO - DEPARTAMENTO DE CUSCO",
    cui:"2459017", programa:"PNSU",
    foto:"https://images.unsplash.com/photo-1538076542933-a701b98d8a0d?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=47490",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=47490&idtipo=3&t=r"
  },
  {
    titulo:"REPARACION DE PTAP EN EL SISTEMA DE AGUA POTABLE DE LA PTAP CURUMUY, DISTRITO DE PIURA",
    cui:"2668668", programa:"PNSU",
    foto:"https://images.unsplash.com/photo-1509228468518-180dd4864904?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=47490",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=48256&idtipo=3&t=r"
  },
  {
    titulo:"MEJORAMIENTO Y AMPLIACION DE LOS SISTEMAS DE AGUA POTABLE Y ALCANTARILLADO - SECTORES 273, 277, 278, 279, 280, 394, 395 - VENTANILLA, CALLAO",
    cui:"2309659", programa:"PASLC",
    foto:"https://images.unsplash.com/photo-1529101091764-c3526daf38fe?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=47534",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=47534&idtipo=3&t=r"
  },
  {
    titulo:"INSTALACION DE LOS SISTEMAS DE AGUA POTABLE Y SANEAMIENTO PARA EL CENTRO POBLADO DE KUYUNTZA - ANDOAS, LORETO",
    cui:"2235563", programa:"PNSR",
    foto:"https://images.unsplash.com/photo-1563453392212-326f5e854473?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=48177",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=48177&idtipo=3&t=r"
  },
  {
    titulo:"MEJORAMIENTO Y AMPLIACION DEL SISTEMA DE ALCANTARILLADO Y TRATAMIENTO DE AGUAS RESIDUALES EN 7 DISTRITOS DE TACNA",
    cui:"2428087", programa:"PNSU",
    foto:"https://images.unsplash.com/photo-1509395176047-4a66953fd231?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=47159",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=47159&idtipo=3&t=r"
  },
  {
    titulo:"AMPLIACION Y MEJORAMIENTO DE LOS SERVICIOS DE AGUA POTABLE Y ALCANTARILLADO DE LA CIUDAD DE JULIACA - PUNO",
    cui:"2331661", programa:"PNSU",
    foto:"https://images.unsplash.com/photo-1505751172876-fa1923c5c528?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=46812",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=46812&idtipo=3&t=r"
  },
  {
    titulo:"AMPLIACION DE LA PRODUCCION DE AGUA EN 6 DISTRITOS DE LA PROVINCIA DE CUSCO",
    cui:"2497598", programa:"PNSU",
    foto:"https://images.unsplash.com/photo-1518611012118-696072aa579a?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=47395",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=47395&idtipo=3&t=r"
  },
  {
    titulo:"MEJORAMIENTO Y AMPLIACION DEL SERVICIO DE ALCANTARILLADO Y TRATAMIENTO DE AGUAS RESIDUALES - NUEVO CHIMBOTE Y CHIMBOTE, ANCASH",
    cui:"2532566", programa:"PNSU",
    foto:"https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=46826",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=46826&idtipo=2&t=r"
  },
  {
    titulo:"AMPLIACION Y MEJORAMIENTO DEL SISTEMA DE AGUA POTABLE Y ALCANTARILLADO - PIURA Y CASTILLA, PIURA",
    cui:"2302373", programa:"PNSU",
    foto:"https://images.unsplash.com/photo-1545259741-2ea3ebf61fa6?q=80&w=1600&auto=format&fit=crop",
    lon:null, lat:null,
    url_detalle:"https://sspfront.vivienda.gob.pe/Geoportal/Dashboard/Dashboard1/?pIdProyecto=46810",
    url_pdf:"https://ssp.vivienda.gob.pe/Monitor/Ayuda_Memoria.aspx?id=46810&idtipo=3&t=r"
  }
];
/* =================================================== */

require([
  "esri/Map","esri/views/MapView","esri/views/SceneView","esri/layers/GraphicsLayer","esri/Graphic","esri/geometry/Point","esri/widgets/BasemapToggle"
], (Map,MapView,SceneView,GraphicsLayer,Graphic,Point,BasemapToggle)=>{

  const map = new Map({basemap:"satellite"});
  const layer = new GraphicsLayer(); map.add(layer);

  const view2D = new MapView({container:"viewDiv2D",map,center:[-75,-10],zoom:5});
  const view3D = new SceneView({container:"viewDiv3D",map,center:[-75,-10],zoom:5,tilt:65});
  view2D.ui.add(new BasemapToggle({view:view2D,nextBasemap:"osm"}),"bottom-right");
  view3D.ui.add(new BasemapToggle({view:view3D,nextBasemap:"osm"}),"bottom-right");

  let is3D=true; const activeView=()=>is3D?view3D:view2D;

  const baseSymbol={type:"simple-marker",size:18,color:[24,160,251,0.9],outline:{color:"white",width:2}};
  const dimSymbol={type:"simple-marker",size:12,color:[24,160,251,0.4],outline:{color:"white",width:1.5}};
  const hotSymbol={type:"simple-marker",size:26,color:[30,110,182,1],outline:{color:"white",width:3}};

  const graphics=DATA.map((d,i)=>new Graphic({
    geometry:new Point({longitude:d.lon||(-77+i),latitude:d.lat||(-10+i*0.5)}),
    attributes:{idx:i,...d},symbol:baseSymbol
  }));
  layer.addMany(graphics);

  const story=document.getElementById("story");
  DATA.forEach((d,i)=>{
    story.insertAdjacentHTML("beforeend",`
    <article class="step" data-idx="${i}">
      <div class="card">
        <div class="img"><span class="badge">${i+1}</span><img src="${d.foto}" alt=""></div>
        <div class="body">
          <h2 class="title">${d.titulo}</h2>
          <p class="meta">CUI: ${d.cui}<br>PROGRAMA: ${d.programa}</p>
          <div class="links">
            <a class="a" href="${d.url_detalle}" target="_blank">Detalle Proyecto</a>
            <a class="a" href="${d.url_pdf}" target="_blank">Ayuda Memoria</a>
          </div>
        </div>
      </div>
    </article>`);
  });

  let active=0;
  function applySymbols(idx){graphics.forEach((g,i)=>g.symbol=i===idx?hotSymbol:dimSymbol);}
  function flyTo(idx){const g=graphics[idx];if(!g)return;activeView().goTo({target:g.geometry,zoom:17,tilt:is3D?65:0},{duration:900});}
  function setActive(idx){active=idx;document.querySelectorAll(".step").forEach(s=>s.classList.remove("is-active"));
    document.querySelector(`.step[data-idx="${idx}"]`)?.classList.add("is-active");
    applySymbols(idx);flyTo(idx);}
  const obs=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting){setActive(Number(e.target.dataset.idx));}})},{threshold:0.55});
  document.querySelectorAll(".step").forEach(s=>obs.observe(s));

  document.getElementById("toggleDimBtn").onclick=()=>{
    const from=activeView();const to=is3D?view2D:view3D;
    to.goTo(from.viewpoint,{duration:0});
    document.getElementById("viewDiv3D").style.display=is3D?"none":"block";
    document.getElementById("viewDiv2D").style.display=is3D?"block":"none";
    is3D=!is3D;setActive(active);
  };
  document.getElementById("prevBtn").onclick=()=>{const i=(active-1+DATA.length)%DATA.length;
    document.querySelector(`.step[data-idx="${i}"]`)?.scrollIntoView({behavior:"smooth",block:"center"});}
  document.getElementById("nextBtn").onclick=()=>{const i=(active+1)%DATA.length;
    document.querySelector(`.step[data-idx="${i}"]`)?.scrollIntoView({behavior:"smooth",block:"center"});}
});
</script>
</body>
</html>
