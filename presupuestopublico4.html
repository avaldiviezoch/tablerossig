<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mapa · Inversiones MVCS</title>

  <!-- Fuente: Nunito Sans -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>

  <!-- ArcGIS JS 4.29 -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    :root{
      --ink:#0b2532; --muted:#6b7280; --line:#e5e7eb;
      --accent-blue:#1e6eb6; --accent-blue-2:#135a92;
      --card:#fff; --shadow:0 12px 28px rgba(2,6,23,.08);
      --underline:#e11d2e; --red:#e11d2e;
    }
    html,body{height:100%;margin:0;background:#fff;color:var(--ink);font-family:"Nunito Sans",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--accent-blue);text-decoration:none;font-weight:800}

    /* ===== TU TEXTO SUPERIOR ORIGINAL (INTACTO) ===== */
    .wrap{ max-width:1200px; margin:0 auto; padding:28px 20px 10px; box-sizing:border-box; }
    .intro{ text-align:center; margin:0 auto 18px; color:var(--ink); }
    .intro h2{
      color: var(--accent-blue);
      font-weight:900; font-size:clamp(22px,3.2vw,28px);
      display:inline-block; position:relative; margin:0 0 18px;
      padding-bottom:10px;
    }
    .intro h2::after{
      content:""; position:absolute; left:0; bottom:0; height:4px; width:100%;
      background:var(--underline); transform:scaleX(0); transform-origin:left center;
      transition:transform .7s cubic-bezier(.22,.9,.3,1); border-radius:999px;
    }
    .intro h2.in-view::after{ transform:scaleX(1); }
    .intro p{
      margin:0 auto 10px; max-width:900px; line-height:1.55; color:#4b5563;
      font-size:clamp(14px,1.5vw,16.5px);
    }

    /* ===== MAPA ===== */
    .page{ display:grid; place-items:center; padding:0 20px 28px; box-sizing:border-box; }
    .map-card{
      width:min(1200px, 92vw); height:min(72vh, 760px);
      background:var(--card); border:1px solid var(--line); border-radius:16px;
      box-shadow:var(--shadow); position:relative; overflow:hidden;
    }
    #viewDiv{ position:absolute; inset:0; }

    /* === BUSCADOR === */
    .search-wrap{ position:absolute; top:14px; right:14px; z-index:6; }
    .search-fab{
      width:44px; height:44px; border-radius:999px; cursor:pointer;
      border:1px solid #e5e7eb; background:#ffffff; display:grid; place-items:center;
      box-shadow:0 8px 20px rgba(2,6,23,.18);
    }
    .search-fab svg{ width:22px; height:22px; display:block }
    .search-fab .ring{ stroke:#d80000; stroke-width:3; fill:none }
    .search-fab .handle{ stroke:#d80000; stroke-width:3; stroke-linecap:round }
    .search-content{
      display:none; position:absolute; top:100%; right:0; margin-top:8px;
      background:#fff; border:1px solid var(--line); border-radius:14px;
      box-shadow:0 10px 24px rgba(2,6,23,.12); padding:10px; width:320px;
    }
    .search-content.open{ display:block; }
    .search-input-wrap{ display:flex; align-items:center; gap:8px; }
    .search-input{ flex:1; padding:10px; border:1px solid #d1d5db; border-radius:10px; font-weight:700; }
    .clear-btn{
      border:none; background:#f3f4f6; border:1px solid #e5e7eb;
      width:36px; height:36px; border-radius:10px; cursor:pointer; font-size:18px; line-height:0; display:grid; place-items:center;
    }
    .suggestions{ list-style:none; padding:6px 0 0; margin:6px 0 0; max-height:240px; overflow-y:auto; }
    .suggestions li{ padding:8px 10px; cursor:pointer; border-bottom:1px solid #f2f2f2; font-weight:700; color:var(--ink); }
    .suggestions li:hover{ background:#f0f7f6; }

    /* === POPUP (VERDE ORIGINAL) === */
    .esri-popup__header{ display:none !important; }
    .esri-popup__main-container{ padding-top:0 !important; border-radius:14px !important; overflow:hidden !important; }
    .pop-card{
      background:#ffffff; border:1px solid var(--line); border-radius:14px;
      box-shadow:0 12px 30px rgba(2,6,23,.12); overflow:hidden; color:var(--ink);
      font:12.5px/1.4 "Nunito Sans",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    }
    .pop-hdr{ background:#0b3b38; color:#e6fffb; padding:10px 12px; font-weight:900; letter-spacing:.2px; }
    .pop-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; padding:12px; }
    .pop-grid .lbl{ font-weight:800; color:#47606b; font-size:11.5px }
    .pop-grid .val{ font-weight:800; color:var(--ink) }
    .pop-chipwrap{ display:flex; gap:8px; padding:0 12px 10px }
    .chip{ background:#e8f5f3; color:#0b3b38; border:1px solid #cfe7e3; padding:5px 8px;
      border-radius:999px; font-weight:900; font-size:11px; }
    .pop-actions{ display:flex; gap:8px; justify-content:flex-end; padding:10px 12px 12px; border-top:1px solid var(--line); }
    .pop-btn{
      border:1px solid #0e4a43; background:#0b3b38; color:#e6fffb; padding:8px 10px; border-radius:10px;
      font-weight:800; text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    .pop-btn:hover{ filter:brightness(1.05) }

    /* === FILTRO PROGRAMA (PEQUEÑO, AUTOMÁTICO, SIN LIMPIAR) === */
    .filter-wrap{ position:absolute; top:14px; left:14px; z-index:6; }
    .filter-btn{
      background:#ffffff; color:var(--accent-blue);
      border:1px solid var(--line); padding:8px 12px; border-radius:10px;
      font-weight:900; cursor:pointer; box-shadow:0 8px 20px rgba(2,6,23,.12);
      font-size:14px;
    }
    .filter-btn:hover{ border-color:#d5dae1; color:var(--accent-blue-2); }
    .filter-panel{
      display:none; position:absolute; top:100%; left:0; margin-top:8px;
      background:#fff; border:1px solid var(--line); border-radius:14px;
      box-shadow:0 10px 24px rgba(2,6,23,.12);
      width:260px; overflow:hidden;
    }
    .filter-panel.open{ display:block; }
    .fp-head{
      background:var(--accent-blue); color:#ffffff; padding:8px 10px; font-weight:900; font-size:13px;
    }
    .fp-body{ padding:8px 10px; max-height:180px; overflow:auto; }
    .fp-body label{
      display:flex; align-items:center; gap:8px;
      padding:4px 0; font-size:12.5px; color:var(--ink); cursor:pointer;
    }
    .fp-body input[type="checkbox"]{ accent-color: var(--accent-blue); }
    .fp-body input[type="checkbox"]:checked + span{ color:var(--red); font-weight:900; }

    /* === BOTÓN RESTAURAR (FLECHA CIRCULAR) === */
    .reset-wrap{ position:absolute; bottom:14px; left:14px; z-index:6; }
    .reset-btn{
      width:44px; height:44px; border-radius:999px; cursor:pointer;
      border:1px solid #e5e7eb; background:#ffffff; display:grid; place-items:center;
      box-shadow:0 8px 20px rgba(2,6,23,.18); font-size:20px; color:#e11d2e;
      transition:transform .2s ease, background .2s ease;
    }
    .reset-btn:hover{ background:#fdf2f2; transform:scale(1.08); }
  </style>
</head>
<body>

  <!-- TU TEXTO SUPERIOR ORIGINAL -->
  <section class="wrap intro">
    <h2 id="introTitle">¿Dónde se ubican nuestras inversiones?</h2>
    <p>
      El mapa interactivo muestra la ubicación geográfica de los proyectos de inversión del ministerio a nivel nacional,
      clasificados por tipo y estado (en ejecución, concluidos o por iniciar). Puedes filtrar por región, provincia o distrito para
      identificar las intervenciones en tu localidad. Esta herramienta facilita la rendición de cuentas y la participación
      ciudadana en el seguimiento de obras públicas.
    </p>
    <p>
      La visualización facilita el análisis territorial, permitiendo detectar posibles brechas de infraestructura, priorizar zonas
      críticas y garantizar una cobertura equitativa de los servicios de agua y saneamiento en todas las regiones del país.
    </p>
    <p>
      <a href="#viewDiv">¡Explora el mapa y conoce cómo las inversiones del MVCS han mejorado la calidad de vida de tu comunidad!</a>
    </p>
  </section>

  <!-- MAPA -->
  <section class="page">
    <div class="map-card">
      <div id="viewDiv" aria-label="Mapa con límites y puntos"></div>

      <!-- FILTRO PROGRAMA (SIN LIMPIAR) -->
      <div class="filter-wrap">
        <button class="filter-btn" id="filterBtn">Programas</button>
        <div class="filter-panel" id="filterPanel">
          <div class="fp-head">
            <span>Filtrar por Programa</span>
          </div>
          <div class="fp-body" id="progList"></div>
        </div>
      </div>

      <!-- BUSCADOR -->
      <div class="search-wrap">
        <button class="search-fab" id="searchBtn" title="Buscar">
          <svg viewBox="0 0 24 24" aria-hidden="true"><circle class="ring" cx="10" cy="10" r="6.5"></circle><line class="handle" x1="14.8" y1="14.8" x2="20" y2="20"></line></svg>
        </button>
        <div class="search-content" id="searchContent">
          <div class="search-input-wrap">
            <input type="text" class="search-input" id="searchInput" placeholder="Buscar por nombre de proyecto…">
            <button class="clear-btn" id="clearSearch">X</button>
          </div>
          <ul class="suggestions" id="suggestions"></ul>
        </div>
      </div>

      <!-- BOTÓN RESTAURAR (FLECHA) -->
      <div class="reset-wrap">
        <button class="reset-btn" id="resetBtn" title="Restaurar mapa">↺</button>
      </div>
    </div>
  </section>

  <script>
    (function underlineOnView(){
      const title = document.getElementById('introTitle');
      const obs = new IntersectionObserver(e => e.forEach(en => en.isIntersecting && title.classList.add('in-view')), { threshold: 0.35 });
      obs.observe(title);
    })();

    const FS_URL = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_Coord_MEF/FeatureServer/0";
    const LIMITES_URL = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer/0";

    const moneyFmt = new Intl.NumberFormat("es-PE", { maximumFractionDigits: 0 });
    function money(n){ return "S/. " + moneyFmt.format(Number(n||0)); }
    function safe(v){ return (v==null || v==="") ? "—" : String(v); }
    function esc(v){ return String(v).replaceAll("'", "''"); }

    function esriPOST(url, paramsObj){
      const body = new URLSearchParams({ f:"json", returnGeometry:"false", ...paramsObj, __ts: Date.now() });
      return fetch(url, { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body, cache:"no-store" })
        .then(r => r.ok ? r.json() : Promise.reject())
        .catch(() => ({}));
    }

    async function loadDistinct(field, where = "1=1"){
      const page = 2000; let offset = 0; const vals = new Set();
      while(true){
        const j = await esriPOST(FS_URL + "/query", {
          where, outFields: field, orderByFields: field, returnDistinctValues: "true",
          resultRecordCount: page, resultOffset: offset
        });
        const rows = (j.features || []).map(f => (f.attributes || {})[field]).filter(v => v != null && v !== "");
        rows.forEach(v => vals.add(v));
        if (!j.exceededTransferLimit || rows.length < page) break;
        offset += page;
      }
      return [...vals];
    }

    require([
      "esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/widgets/BasemapToggle",
      "esri/widgets/ScaleBar","esri/geometry/Extent","esri/layers/GraphicsLayer","esri/Graphic"
    ], (Map, MapView, FeatureLayer, BasemapToggle, ScaleBar, Extent, GraphicsLayer, Graphic) => {

      const map = new Map({ basemap: "satellite" });
      const view = new MapView({
        container: "viewDiv", map, center: [-75.2, -9.3], zoom: 5,
        padding: { left:8, right:8, top:8, bottom:8 }, constraints: { minZoom: 3 }
      });

      view.ui.add(new BasemapToggle({ view, nextBasemap: "osm" }), "bottom-right");
      view.ui.add(new ScaleBar({ view, unit: "metric" }), "bottom-left");
      view.ui.move("zoom", "bottom-right");

      const peruExtent = new Extent({ xmin:-81.6, ymin:-18.5, xmax:-68.5, ymax:-0.03, spatialReference:{ wkid:4326 } });
      view.when(() => view.goTo({ target: peruExtent.expand(0.96) }));

      const fxLayer = new GraphicsLayer({ listMode: "hide" });
      map.add(fxLayer);

      const limites = new FeatureLayer({ url: LIMITES_URL, popupEnabled: false, listMode: "hide" });
      limites.when(() => {
        limites.renderer = { type: "simple", symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [255,255,255,230], width: 1.2 } } };
      });
      map.add(limites);

      const layer = new FeatureLayer({
        url: FS_URL, outFields: ["*"], title: "Proyectos MEF",
        renderer: { type: "simple", symbol: { type: "simple-marker", color: [255,234,0,0.95], size: 7, outline: { color: [0,0,0,220], width: 0.6 } } },
        popupTemplate: {
          title: "", content: e => {
            const a = e.graphic.attributes || {};
            const url1 = a.url_ssp?.trim(), url2 = a.url_pdf?.trim();
            return `
              <div class="pop-card">
                <div class="pop-hdr">${safe(a.producto_proyecto_nombre)}</div>
                <div class="pop-grid">
                  <div class="lbl">Programa</div><div class="val">${safe(a.programa)}</div>
                  <div class="lbl">Departamento</div><div class="val">${safe(a.departamento)}</div>
                  <div class="lbl">Provincia</div><div class="val">${safe(a.provincia)}</div>
                  <div class="lbl">Distrito</div><div class="val">${safe(a.distrito)}</div>
                  <div class="lbl">Monto PIM</div><div class="val">${money(a.monto_pim)}</div>
                  <div class="lbl">Monto Devengado</div><div class="val">${money(a.monto_devengado)}</div>
                </div>
                <div class="pop-chipwrap">
                  <div class="chip">Etapa: ${safe(a.etapa)}</div>
                  <div class="chip">Estado: ${safe(a.estado)}</div>
                </div>
                <div class="pop-actions">
                  ${url1 ? `<a class="pop-btn" href="${url1}" target="_blank" rel="noopener">Detalle</a>` : ""}
                  ${url2 ? `<a class="pop-btn" href="${url2}" target="_blank" rel="noopener">PDF</a>` : ""}
                </div>
              </div>`;
          }
        }
      });
      map.add(layer);

      // === FILTRO AUTOMÁTICO ===
      const filterBtn = document.getElementById('filterBtn');
      const filterPanel = document.getElementById('filterPanel');
      const progList = document.getElementById('progList');

      function buildWherePrograms(){
        const checked = progList.querySelectorAll('input[type="checkbox"]:checked');
        const progs = Array.from(checked).map(cb => cb.value.trim()).filter(Boolean);
        return progs.length === 0 ? "1=1" : `programa IN (${progs.map(p => `'${esc(p)}'`).join(",")})`;
      }

      async function loadPrograms(){
        progList.innerHTML = '<div style="padding:6px;font-size:12px;color:#6b7280;">Cargando...</div>';
        const progs = await loadDistinct("programa");
        progList.innerHTML = '';
        progs.forEach(p => {
          const id = 'p_' + Math.random().toString(36).substr(2, 6);
          const label = document.createElement('label');
          label.innerHTML = `<input id="${id}" type="checkbox" value="${p}"> <span>${p}</span>`;
          label.style.cursor = 'pointer';
          progList.appendChild(label);
        });
        progList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => {
            layer.definitionExpression = buildWherePrograms();
            view.whenLayerView(layer).then(lv => lv.queryExtent().then(r => r.count > 0 && view.goTo(r.extent)));
          });
        });
      }

      filterBtn.addEventListener('click', e => {
        e.stopPropagation();
        filterPanel.classList.toggle('open');
        if (filterPanel.classList.contains('open') && progList.children.length === 0) loadPrograms();
      });

      document.addEventListener('click', e => {
        if (!document.querySelector('.filter-wrap').contains(e.target)) filterPanel.classList.remove('open');
      });

      // === BOTÓN RESTAURAR ===
      const resetBtn = document.getElementById('resetBtn');
      resetBtn.addEventListener('click', () => {
        // Desmarcar todos
        progList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        // Restaurar capa
        layer.definitionExpression = "1=1";
        // Restaurar vista
        view.goTo(peruExtent.expand(0.96));
        // Limpiar búsqueda
        document.getElementById('searchInput').value = '';
        document.getElementById('suggestions').innerHTML = '';
        view.popup.close();
      });

      // === BUSCADOR ===
      const searchBtn = document.getElementById('searchBtn');
      const searchContent = document.getElementById('searchContent');
      const searchInput = document.getElementById('searchInput');
      const clearSearch = document.getElementById('clearSearch');
      const suggestions = document.getElementById('suggestions');
      let allProjects = [];

      searchBtn.addEventListener('click', e => { e.stopPropagation(); searchContent.classList.toggle('open'); searchContent.classList.contains('open') && searchInput.focus(); });
      document.addEventListener('click', e => { !document.querySelector('.search-wrap').contains(e.target) && searchContent.classList.remove('open'); });
      clearSearch.addEventListener('click', () => { searchInput.value = ''; suggestions.innerHTML = ''; searchInput.focus(); });

      searchInput.addEventListener('input', () => {
        const val = searchInput.value.toLowerCase().trim();
        suggestions.innerHTML = '';
        if (val.length < 2) return;
        const matches = allProjects.filter(n => n.toLowerCase().includes(val)).slice(0, 20);
        matches.forEach(name => {
          const li = document.createElement('li');
          li.textContent = name;
          li.onclick = () => { searchInput.value = name; suggestions.innerHTML = ''; searchContent.classList.remove('open'); performSearchExact(name); };
          suggestions.appendChild(li);
        });
      });

      searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && searchInput.value.trim().length >= 2) {
          performSearchLike(searchInput.value.trim());
          searchContent.classList.remove('open');
        }
      });

      let layerView = null, currentHighlight = null;
      view.when(async () => {
        layerView = await view.whenLayerView(layer);
        allProjects = (await loadDistinct("producto_proyecto_nombre")).filter(Boolean);
      });

      function rippleAt(point){
        [0,160,320].forEach((d,i) => setTimeout(() => {
          const g = new Graphic({ geometry: point, symbol: { type:"simple-marker", style:"circle", size:10, color:[255,255,0,0], outline:{ color:[255,255,0,1], width:2 } } });
          fxLayer.add(g);
          let s = 0;
          const iv = setInterval(() => {
            s++; const o = Math.max(0,1-s/14);
            g.symbol = { type:"simple-marker", style:"circle", size:10+s*6, color:[255,255,0,0], outline:{ color:[255,255,0,o], width:Math.max(1,2-s*0.08) } };
            if (s > 14) { clearInterval(iv); fxLayer.remove(g); }
          }, 40);
        }, d));
      }

      function doHighlight(g){ if (currentHighlight) currentHighlight.remove(); currentHighlight = layerView.highlight(g); setTimeout(() => currentHighlight?.remove(), 5000); }

      async function performSearchExact(name){
        const base = layer.definitionExpression || "1=1";
        const q = layer.createQuery();
        q.where = `(${base}) AND producto_proyecto_nombre = '${esc(name)}'`;
        q.returnGeometry = true; q.outFields = ['*'];
        const res = await layer.queryFeatures(q);
        if (res.features.length > 0) {
          const f = res.features[0];
          await view.goTo({ target: f.geometry, zoom: 15 });
          doHighlight(f); rippleAt(f.geometry);
          view.popup.open({ features: [f], location: f.geometry });
        }
      }

      async function performSearchLike(text){
        const base = layer.definitionExpression || "1=1";
        const q = layer.createQuery();
        q.where = `(${base}) AND producto_proyecto_nombre LIKE '%${esc(text)}%'`;
        q.returnGeometry = true; q.outFields = ['*']; q.num = 1;
        const res = await layer.queryFeatures(q);
        if (res.features.length > 0) {
          const f = res.features[0];
          await view.goTo({ target: f.geometry, zoom: 15 });
          doHighlight(f); rippleAt(f.geometry);
          view.popup.open({ features: [f], location: f.geometry });
        }
      }

    });
  </script>
</body>
</html>
